---
phase: 15-critical-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/AppVideoWizard/app/Livewire/VideoWizard.php
  - modules/AppVideoWizard/app/Services/VoiceoverService.php
autonomous: true

must_haves:
  truths:
    - "Narrator shots have voiceId for TTS generation"
    - "Empty text segments are skipped with warning"
    - "Missing segment type is logged before defaulting"
    - "TTS calls receive valid non-empty text"
  artifacts:
    - path: "modules/AppVideoWizard/app/Livewire/VideoWizard.php"
      provides: "Narrator voice assignment, empty text guards, type logging"
      contains: "narratorVoiceId"
    - path: "modules/AppVideoWizard/app/Services/VoiceoverService.php"
      provides: "Empty text guards before TTS"
      contains: "empty(trim("
  key_links:
    - from: "overlayNarratorSegments()"
      to: "getNarratorVoice()"
      via: "narratorVoiceId assignment"
      pattern: "narratorVoiceId.*getNarratorVoice"
    - from: "TTS calls"
      to: "AI::process"
      via: "empty text guard"
      pattern: "if.*empty.*trim.*text"
---

<objective>
Fix narrator voice assignment gap and add empty text validation to prevent TTS failures.

Purpose: VOC-01 and VOC-02 are critical fixes that prevent TTS errors. Narrator segments currently get text but not voiceId, and empty text can reach TTS calls causing failures.

Output: VideoWizard.php and VoiceoverService.php with narrator voice assignment and empty text guards.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-critical-fixes/15-CONTEXT.md

# Key files
@modules/AppVideoWizard/app/Livewire/VideoWizard.php (lines 23662-23719 for overlayNarratorSegments, lines 23979-24035 for TTS calls, lines 23491 and 23554 for type coercion)
@modules/AppVideoWizard/app/Services/VoiceoverService.php (lines 657-696 for TTS calls)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add narrator voice assignment in overlayNarratorSegments (VOC-01)</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
In the `overlayNarratorSegments()` method (lines 23662-23719), after line 23701 where `narratorText` is set:

```php
$shots[$shotIdx]['narratorText'] = $narratorText;
```

Add narrator voice assignment:

```php
$shots[$shotIdx]['narratorVoiceId'] = $this->getNarratorVoice();
```

The `getNarratorVoice()` method already exists (line 8470) and handles the fallback chain:
- Character Bible narrator voice
- animation.narrator.voice
- animation.voiceover.voice
- 'nova' default

This ensures every shot with narrator overlay has the voice ID needed for TTS generation.
  </action>
  <verify>
Search for `narratorVoiceId` in the overlayNarratorSegments method:
```bash
grep -n "narratorVoiceId" modules/AppVideoWizard/app/Livewire/VideoWizard.php | grep -A2 -B2 "23"
```
Should show narratorVoiceId assignment near line 23701-23702.
  </verify>
  <done>
Every shot with narrator overlay (`hasNarratorVoiceover: true`) also has `narratorVoiceId` set from `getNarratorVoice()`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add empty text validation and type logging before TTS (VOC-02)</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php, modules/AppVideoWizard/app/Services/VoiceoverService.php</files>
  <action>
**Part A: Empty text validation in VideoWizard.php**

1. Before narrator TTS call (~line 23979), add empty text guard:

```php
// Generate narrator audio (combined into single track)
if (!empty($narratorText)) {
    // Add empty text validation
    if (empty(trim($narratorText))) {
        Log::warning('Empty narrator text skipped before TTS', [
            'sceneIndex' => $sceneIndex,
            'sceneId' => $scene['id'] ?? null,
        ]);
    } else {
        $audioResult = \App\Facades\AI::process($narratorText, 'speech', [
            // ... existing code
        ], $teamId);
        // ... rest of existing block
    }
}
```

2. Before character TTS call (~line 24011), wrap with empty text guard:

```php
foreach ($characterSegments as $charSeg) {
    // Validate text before TTS
    if (empty(trim($charSeg['text'] ?? ''))) {
        Log::warning('Empty character segment text skipped before TTS', [
            'sceneIndex' => $sceneIndex,
            'speaker' => $charSeg['speaker'] ?? 'unknown',
            'segmentIndex' => $charSeg['segmentIndex'] ?? null,
        ]);
        continue;
    }

    $voice = $voiceoverService->getVoiceForSpeaker(
        // ... existing code
    );
    // ... rest of existing block
}
```

**Part B: Type validation logging in VideoWizard.php**

At lines 23491 and 23554 where type defaults silently:

```php
// Current (line 23491):
$segType = strtolower($segment['type'] ?? 'narrator');

// Change to:
$segType = $segment['type'] ?? null;
if ($segType === null) {
    Log::error('Missing segment type, defaulting to narrator', [
        'sceneIndex' => $sceneIndex,
        'segmentIndex' => $segmentIndex ?? null,
        'speaker' => $segment['speaker'] ?? 'unknown',
    ]);
    $segType = 'narrator';
}
$segType = strtolower($segType);
```

Apply same pattern at line 23554.

**Part C: Empty text validation in VoiceoverService.php**

1. Before narrator TTS call (~line 657), add guard:

```php
// Generate narrator audio (combined into single track)
if (!empty($narratorSegments)) {
    $narratorText = implode(' ', array_column($narratorSegments, 'text'));

    // Validate before TTS
    if (empty(trim($narratorText))) {
        Log::warning('Empty narrator text skipped in VoiceoverService', [
            'sceneId' => $scene['id'] ?? null,
        ]);
    } else {
        $audioResult = AI::process($narratorText, 'speech', [
            // ... existing code
        ], $teamId);
        // ... rest of block
    }
}
```

2. Before character TTS call (~line 679), add guard:

```php
foreach ($characterSegments as $index => $seg) {
    // Validate text before TTS
    if (empty(trim($seg['text'] ?? ''))) {
        Log::warning('Empty character segment text skipped in VoiceoverService', [
            'speaker' => $seg['speaker'] ?? 'unknown',
            'index' => $index,
        ]);
        continue;
    }

    $voice = $this->getVoiceForSpeaker($seg['speaker'], $characterBible, $narratorVoice);
    // ... existing code
}
```

**Logging pattern (per CONTEXT.md decisions):**
- `Log::warning()` for recoverable issues (empty text skipped)
- `Log::error()` for data integrity issues (missing segment type)
- Include context: scene index, segment index, speaker name
  </action>
  <verify>
1. Check empty text guards exist:
```bash
grep -n "empty(trim(" modules/AppVideoWizard/app/Livewire/VideoWizard.php | head -5
grep -n "empty(trim(" modules/AppVideoWizard/app/Services/VoiceoverService.php | head -5
```

2. Check type validation logging:
```bash
grep -n "Missing segment type" modules/AppVideoWizard/app/Livewire/VideoWizard.php
```

Should show warning/error log calls in both files.
  </verify>
  <done>
- Empty narrator text logged and skipped (not sent to TTS)
- Empty character segment text logged and skipped (not sent to TTS)
- Missing segment type logged as error before defaulting to 'narrator'
- All validations are non-blocking (log and continue, per M8 pattern)
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Code verification:**
```bash
# Narrator voice assignment
grep -n "narratorVoiceId.*getNarratorVoice" modules/AppVideoWizard/app/Livewire/VideoWizard.php

# Empty text guards
grep -c "empty(trim(" modules/AppVideoWizard/app/Livewire/VideoWizard.php
grep -c "empty(trim(" modules/AppVideoWizard/app/Services/VoiceoverService.php

# Type logging
grep -n "Missing segment type" modules/AppVideoWizard/app/Livewire/VideoWizard.php
```

2. **No syntax errors:**
```bash
cd modules/AppVideoWizard && php -l app/Livewire/VideoWizard.php && php -l app/Services/VoiceoverService.php
```

3. **Must-have truths verification:**
- [ ] Narrator shots have voiceId: `narratorVoiceId` set in overlayNarratorSegments
- [ ] Empty text skipped: Guards before all 4 TTS call sites
- [ ] Missing type logged: `Log::error()` at type coercion points
- [ ] TTS receives valid text: Guards prevent empty strings reaching AI::process
</verification>

<success_criteria>
1. `overlayNarratorSegments()` sets `narratorVoiceId` from `getNarratorVoice()` on each shot with narrator overlay
2. Empty segment text caught before reaching TTS generation (4 call sites protected)
3. Missing segment type logged as error before defaulting to 'narrator' (2 locations)
4. All validation is non-blocking (log and continue, same as M8 pattern)
5. No PHP syntax errors in modified files
</success_criteria>

<output>
After completion, create `.planning/phases/15-critical-fixes/15-01-SUMMARY.md`
</output>
