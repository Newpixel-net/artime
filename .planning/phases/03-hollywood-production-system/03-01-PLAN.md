---
phase: 03-hollywood-production-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/AppVideoWizard/app/Livewire/VideoWizard.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "decomposeSceneWithDynamicEngine calls generateHollywoodShotSequence instead of analyzeScene"
    - "getCollageDefaultShots calls generateHollywoodShotSequence instead of analyzeScene"
    - "Emotional arc data is passed to DynamicShotEngine"
    - "Character data is passed for dialogue coverage patterns"
  artifacts:
    - path: "modules/AppVideoWizard/app/Livewire/VideoWizard.php"
      provides: "Hollywood patterns activated in scene decomposition"
      contains: "generateHollywoodShotSequence"
  key_links:
    - from: "VideoWizard.php"
      to: "DynamicShotEngine::generateHollywoodShotSequence"
      via: "decomposeSceneWithDynamicEngine and getCollageDefaultShots"
      pattern: "generateHollywoodShotSequence"
---

<objective>
Activate Hollywood shot sequence generation in VideoWizard.

**CRITICAL FIX:** The Hollywood cinematography code EXISTS in DynamicShotEngine but is NEVER CALLED:
- `generateHollywoodShotSequence()` exists but VideoWizard calls `analyzeScene()` instead
- This means emotion-driven shot types, dialogue coverage patterns, and intensity-based framing are all UNUSED

Purpose: Make all the Hollywood cinematography features we implemented actually work. The code is there, it just needs to be connected.

Output: Every scene decomposition uses Hollywood patterns (emotional arc + dialogue coverage).
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/PIPELINE-AUDIT.md

# Key source files
@modules/AppVideoWizard/app/Livewire/VideoWizard.php
@modules/AppVideoWizard/app/Services/DynamicShotEngine.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix decomposeSceneWithDynamicEngine to use Hollywood patterns</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
In the `decomposeSceneWithDynamicEngine()` method (around line 16710-16800), find where it calls `analyzeScene()` and replace with `generateHollywoodShotSequence()`.

Find the current code (around line 16764-16766):
```php
// Use DynamicShotEngine for content-driven shot calculation
$engine = new DynamicShotEngine();
$analysis = $engine->analyzeScene($scene, $context);
```

Replace with:
```php
// Use DynamicShotEngine for Hollywood-standard shot sequencing
// PHASE 3: Activate Hollywood patterns (emotional arc + dialogue coverage)
$engine = new DynamicShotEngine();

// Ensure emotional arc is available from NarrativeMomentService
if (empty($context['emotionalArc']) && !empty($this->narrativeMomentService)) {
    $narration = $scene['narration'] ?? $scene['visualDescription'] ?? '';
    if (!empty($narration)) {
        $moments = $this->narrativeMomentService->decomposeNarrationIntoMoments(
            $narration,
            $context['shotCount'] ?? 5,
            ['mood' => $scene['mood'] ?? 'neutral']
        );
        if (!empty($moments)) {
            $context['emotionalArc'] = $this->narrativeMomentService->extractEmotionalArc($moments);
            $context['narrativeMoments'] = $moments;
        }
    }
}

// Ensure characters are passed for dialogue coverage patterns
if (empty($context['characters']) && !empty($this->characterBible['characters'])) {
    // Find characters in this scene
    $sceneCharacters = [];
    foreach ($this->characterBible['characters'] as $character) {
        if (in_array($sceneIndex, $character['scenes'] ?? [])) {
            $sceneCharacters[] = $character;
        }
    }
    $context['characters'] = $sceneCharacters;
}

// Generate Hollywood-standard shot sequence with emotional arc and dialogue patterns
$analysis = $engine->generateHollywoodShotSequence($scene, $context);

Log::info('VideoWizard: Hollywood shot sequence generated', [
    'scene_id' => $sceneId,
    'shot_count' => $analysis['shotCount'],
    'hollywood_patterns' => $analysis['hollywoodPatterns'] ?? [],
    'emotional_arc' => !empty($context['emotionalArc']),
    'dialogue_coverage' => count($context['characters'] ?? []) >= 2,
]);
```

Also update the log message that follows (around line 16768) to reflect the Hollywood patterns:
```php
// Remove or update the old log since we have a new one above
```

WHY: This is THE critical fix. The Hollywood cinematography analysis we did (Moon Knight 359 frames) resulted in code that was never connected. This connects it.
  </action>
  <verify>
    - `decomposeSceneWithDynamicEngine()` calls `generateHollywoodShotSequence()` instead of `analyzeScene()`
    - Context includes `emotionalArc` when narrativeMomentService is available
    - Context includes `characters` from characterBible
    - Log message shows `hollywood_patterns` in output
    - No PHP syntax errors: `php -l modules/AppVideoWizard/app/Livewire/VideoWizard.php`
  </verify>
  <done>Scene decomposition uses Hollywood patterns instead of basic analysis</done>
</task>

<task type="auto">
  <name>Task 2: Fix getCollageDefaultShots to use Hollywood patterns</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Find the second location where `analyzeScene()` is called (around line 22660-22663) in what appears to be `getCollageDefaultShots()` or similar method.

Find the current code:
```php
// Use DynamicShotEngine for content-driven shot calculation
$engine = new DynamicShotEngine();
$context = $this->buildDecompositionContext($sceneIndex, $scene);
$analysis = $engine->analyzeScene($scene, $context);
```

Replace with:
```php
// Use DynamicShotEngine for Hollywood-standard shot calculation
// PHASE 3: Activate Hollywood patterns consistently
$engine = new DynamicShotEngine();
$context = $this->buildDecompositionContext($sceneIndex, $scene);

// Ensure emotional arc for Hollywood patterns
if (empty($context['emotionalArc']) && !empty($this->narrativeMomentService)) {
    $narration = $scene['narration'] ?? $scene['visualDescription'] ?? '';
    if (!empty($narration)) {
        $moments = $this->narrativeMomentService->decomposeNarrationIntoMoments(
            $narration,
            $context['shotCount'] ?? 5,
            ['mood' => $scene['mood'] ?? 'neutral']
        );
        if (!empty($moments)) {
            $context['emotionalArc'] = $this->narrativeMomentService->extractEmotionalArc($moments);
        }
    }
}

// Include scene characters for dialogue patterns
if (empty($context['characters']) && !empty($this->characterBible['characters'])) {
    $sceneCharacters = [];
    foreach ($this->characterBible['characters'] as $character) {
        if (in_array($sceneIndex, $character['scenes'] ?? [])) {
            $sceneCharacters[] = $character;
        }
    }
    $context['characters'] = $sceneCharacters;
}

$analysis = $engine->generateHollywoodShotSequence($scene, $context);
```

WHY: This is the second place where scenes get decomposed (for collage generation). It must also use Hollywood patterns.
  </action>
  <verify>
    - The collage shot generation also calls `generateHollywoodShotSequence()`
    - Context includes emotional arc and characters
    - No PHP syntax errors: `php -l modules/AppVideoWizard/app/Livewire/VideoWizard.php`
  </verify>
  <done>Collage shot generation also uses Hollywood patterns</done>
</task>

<task type="auto">
  <name>Task 3: Ensure narrativeMomentService is available in VideoWizard</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Check if VideoWizard has access to NarrativeMomentService. If not, add it.

1. First, check if the service is imported at the top of the file. If not, add:
```php
use Modules\AppVideoWizard\Services\NarrativeMomentService;
```

2. Check if there's a property for the service. If not, add after other service properties:
```php
/**
 * Phase 3: Narrative moment service for Hollywood shot sequencing.
 */
protected ?NarrativeMomentService $narrativeMomentService = null;
```

3. Initialize the service in the mount() method or a boot method. Add after other service initializations:
```php
// Initialize NarrativeMomentService for Hollywood shot sequencing
$this->narrativeMomentService = new NarrativeMomentService();
```

WHY: The Hollywood shot sequence needs emotional arc data, which comes from NarrativeMomentService. Without this service available, the emotional arc won't be passed to DynamicShotEngine.
  </action>
  <verify>
    - `use Modules\AppVideoWizard\Services\NarrativeMomentService;` is in imports
    - `$this->narrativeMomentService` property exists
    - Service is initialized in mount() or similar
    - No PHP syntax errors: `php -l modules/AppVideoWizard/app/Livewire/VideoWizard.php`
  </verify>
  <done>NarrativeMomentService is available in VideoWizard for emotional arc extraction</done>
</task>

</tasks>

<verification>
1. PHP syntax check: `php -l modules/AppVideoWizard/app/Livewire/VideoWizard.php`
2. Grep for changes:
   - `grep -n "generateHollywoodShotSequence" modules/AppVideoWizard/app/Livewire/VideoWizard.php`
   - `grep -n "narrativeMomentService" modules/AppVideoWizard/app/Livewire/VideoWizard.php`
3. No remaining `analyzeScene` calls for decomposition (except in DynamicShotEngine itself)
4. Emotional arc is being extracted and passed
</verification>

<success_criteria>
- Every scene decomposition calls `generateHollywoodShotSequence()` instead of `analyzeScene()`
- Emotional arc data from NarrativeMomentService is passed to the engine
- Character data is passed for dialogue coverage patterns
- Log messages confirm Hollywood patterns are being applied
- PHP syntax valid
</success_criteria>

<output>
After completion, create `.planning/phases/03-hollywood-production-system/03-01-SUMMARY.md`
</output>
