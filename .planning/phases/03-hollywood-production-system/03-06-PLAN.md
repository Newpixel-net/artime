---
phase: 03-hollywood-production-system
plan: 06
type: execute
wave: 4
depends_on: ["03-04", "03-05"]
files_modified:
  - modules/AppVideoWizard/app/Livewire/VideoWizard.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Character reference images are extracted from Character Bible"
    - "Reference images are passed to EVERY image generation call"
    - "Characters maintain consistent appearance across shots"
  artifacts:
    - path: "modules/AppVideoWizard/app/Livewire/VideoWizard.php"
      provides: "Character consistency enforcement via reference images"
      contains: "getCharacterReferenceImages"
  key_links:
    - from: "VideoWizard.php"
      to: "ImageGenerationService"
      via: "reference images parameter"
      pattern: "characterReferences"
---

<objective>
Enforce character visual consistency across all generated images.

**PROBLEM:** Currently characters may look different in each shot:
- Character Bible has descriptions but not enforced visually
- No reference images passed to generation
- Each shot generates characters independently

Purpose: Characters should look the same throughout the entire video.

Output: Every image generation includes character reference images for consistency.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/PIPELINE-AUDIT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add method to extract character reference images</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Add a method to get reference images for characters in a scene:

```php
/**
 * PHASE 3: Get character reference images for a scene.
 * Returns reference images for characters that appear in the given scene.
 *
 * @param int $sceneIndex Scene index
 * @return array Character reference data for image generation
 */
protected function getCharacterReferenceImages(int $sceneIndex): array
{
    $references = [];

    // Get characters from Character Bible
    $characters = $this->characterBible['characters'] ?? [];

    if (empty($characters)) {
        return [];
    }

    foreach ($characters as $character) {
        // Check if character appears in this scene
        $appearsInScene = in_array($sceneIndex, $character['scenes'] ?? []);

        // Also check if character is mentioned in scene narration/description
        $scene = $this->script['scenes'][$sceneIndex] ?? [];
        $sceneText = strtolower(
            ($scene['narration'] ?? '') . ' ' .
            ($scene['visualDescription'] ?? '') . ' ' .
            json_encode($scene['speechSegments'] ?? [])
        );
        $characterName = strtolower($character['name'] ?? '');
        $mentionedInScene = !empty($characterName) && strpos($sceneText, $characterName) !== false;

        if ($appearsInScene || $mentionedInScene) {
            $ref = [
                'name' => $character['name'],
                'description' => $character['appearance'] ?? $character['description'] ?? '',
            ];

            // Add reference image if available
            if (!empty($character['referenceImageUrl'])) {
                $ref['referenceImageUrl'] = $character['referenceImageUrl'];
            }

            // Add portrait if generated
            if (!empty($character['portraitUrl'])) {
                $ref['portraitUrl'] = $character['portraitUrl'];
            }

            // Add face reference if available (from NanoBanana Pro)
            if (!empty($character['faceReferenceId'])) {
                $ref['faceReferenceId'] = $character['faceReferenceId'];
            }

            $references[] = $ref;
        }
    }

    Log::debug('VideoWizard: Character references for scene', [
        'scene_index' => $sceneIndex,
        'character_count' => count($references),
        'characters' => array_column($references, 'name'),
    ]);

    return $references;
}
```

WHY: We need to know which characters are in each scene and what they look like.
  </action>
  <verify>
    - `getCharacterReferenceImages()` method exists
    - Returns array of character data with names and references
    - Checks both scene list and text mentions
    - No PHP syntax errors
  </verify>
  <done>Character reference extraction method added</done>
</task>

<task type="auto">
  <name>Task 2: Integrate references into image generation</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Find where images are generated (likely `generateSceneImage` or similar) and ensure character references are passed. Look for the image generation call and add:

```php
// PHASE 3: Add character references for consistency
$characterReferences = $this->getCharacterReferenceImages($sceneIndex);
if (!empty($characterReferences)) {
    $options['characterReferences'] = $characterReferences;

    // Build character consistency prompt addition
    $characterPrompts = [];
    foreach ($characterReferences as $ref) {
        $name = $ref['name'];
        $desc = $ref['description'];
        if (!empty($desc)) {
            $characterPrompts[] = "{$name}: {$desc}";
        }
    }

    if (!empty($characterPrompts)) {
        $options['characterConsistencyPrompt'] = "IMPORTANT - Maintain character consistency:\n" .
            implode("\n", $characterPrompts);
    }
}
```

Also find where the prompt is built for the image generation service and add the consistency prompt:

```php
// If characterConsistencyPrompt exists, prepend it to the visual prompt
if (!empty($options['characterConsistencyPrompt'])) {
    $prompt = $options['characterConsistencyPrompt'] . "\n\n" . $prompt;
}
```

WHY: The image generation needs to know about character appearances to maintain consistency.
  </action>
  <verify>
    - Character references are gathered before image generation
    - References are passed to generation options
    - Consistency prompt is built and added
    - No PHP syntax errors
  </verify>
  <done>Character references integrated into image generation</done>
</task>

<task type="auto">
  <name>Task 3: Add method to generate/store character portraits</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Add a method to generate reference portraits for characters when entering storyboard:

```php
/**
 * PHASE 3: Generate character reference portraits.
 * Creates consistent reference images for each character in the Character Bible.
 */
public function generateCharacterPortraits(): void
{
    $characters = $this->characterBible['characters'] ?? [];

    if (empty($characters)) {
        Log::info('VideoWizard: No characters in Bible, skipping portrait generation');
        return;
    }

    foreach ($characters as $index => $character) {
        // Skip if portrait already exists
        if (!empty($character['portraitUrl'])) {
            continue;
        }

        // Build portrait prompt from character description
        $name = $character['name'] ?? 'Character';
        $appearance = $character['appearance'] ?? $character['description'] ?? '';

        if (empty($appearance)) {
            Log::warning('VideoWizard: Character has no appearance description', ['name' => $name]);
            continue;
        }

        $portraitPrompt = "Portrait photograph of {$name}. {$appearance}. " .
            "Professional headshot, neutral background, clear face visible, " .
            "consistent lighting, high quality reference portrait.";

        try {
            // Use the image service to generate portrait
            $result = $this->generatePortraitImage($portraitPrompt, [
                'characterIndex' => $index,
                'characterName' => $name,
                'purpose' => 'reference_portrait',
            ]);

            if (!empty($result['imageUrl'])) {
                $this->characterBible['characters'][$index]['portraitUrl'] = $result['imageUrl'];
                $this->saveProject();

                Log::info('VideoWizard: Generated character portrait', [
                    'character' => $name,
                    'url' => $result['imageUrl'],
                ]);
            }
        } catch (\Exception $e) {
            Log::error('VideoWizard: Failed to generate character portrait', [
                'character' => $name,
                'error' => $e->getMessage(),
            ]);
        }
    }
}

/**
 * Generate a portrait image for a character.
 */
protected function generatePortraitImage(string $prompt, array $options = []): array
{
    // Use existing image generation service
    $imageService = app(\Modules\AppVideoWizard\Services\ImageGenerationService::class);

    return $imageService->generate([
        'prompt' => $prompt,
        'aspectRatio' => '1:1', // Square for portraits
        'style' => $this->visualMode ?? 'cinematic-realistic',
        'purpose' => $options['purpose'] ?? 'portrait',
    ]);
}
```

Also add a trigger to generate portraits when entering storyboard step:

```php
// In the method that handles entering step 4 (storyboard):
// PHASE 3: Auto-generate character portraits for consistency
if (empty($this->characterPortraitsGenerated)) {
    $this->generateCharacterPortraits();
    $this->characterPortraitsGenerated = true;
}
```

WHY: Having reference portraits before generating scene images ensures consistency.
  </action>
  <verify>
    - `generateCharacterPortraits()` method exists
    - `generatePortraitImage()` helper exists
    - Portraits are generated on storyboard step entry
    - Portraits are saved to characterBible
    - No PHP syntax errors
  </verify>
  <done>Character portrait generation added</done>
</task>

<task type="auto">
  <name>Task 4: Add property to track portrait generation</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Add a property to track whether portraits have been generated:

```php
/**
 * PHASE 3: Track whether character portraits have been generated.
 */
public bool $characterPortraitsGenerated = false;
```

Also ensure this is saved and loaded with the project.

WHY: Avoid regenerating portraits on every step navigation.
  </action>
  <verify>
    - `$characterPortraitsGenerated` property exists
    - Property is saved/loaded with project
    - No PHP syntax errors
  </verify>
  <done>Portrait generation tracking added</done>
</task>

</tasks>

<verification>
1. PHP syntax check: `php -l modules/AppVideoWizard/app/Livewire/VideoWizard.php`
2. Grep for character consistency:
   - `grep -n "getCharacterReferenceImages" modules/AppVideoWizard/app/Livewire/VideoWizard.php`
   - `grep -n "characterReferences" modules/AppVideoWizard/app/Livewire/VideoWizard.php`
   - `grep -n "generateCharacterPortraits" modules/AppVideoWizard/app/Livewire/VideoWizard.php`
</verification>

<success_criteria>
- Character reference extraction method exists
- References are passed to every image generation
- Character portraits can be pre-generated
- Consistency prompt is added to image prompts
- PHP syntax valid
</success_criteria>

<output>
After completion, create `.planning/phases/03-hollywood-production-system/03-06-SUMMARY.md`
</output>
