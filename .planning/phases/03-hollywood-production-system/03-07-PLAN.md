---
phase: 03-hollywood-production-system
plan: 07
type: execute
wave: 4
depends_on: ["03-04", "03-05"]
files_modified:
  - modules/AppVideoWizard/app/Livewire/VideoWizard.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Concept analysis suggests platform based on content"
    - "Concept analysis suggests duration based on complexity"
    - "Concept analysis suggests production type based on keywords"
    - "Auto-fill settings reduce Step 1 configuration burden"
  artifacts:
    - path: "modules/AppVideoWizard/app/Livewire/VideoWizard.php"
      provides: "Smart defaults from concept analysis"
      contains: "analyzeConceptForDefaults"
  key_links:
    - from: "VideoWizard.php"
      to: "Step 1 configuration"
      via: "concept analysis"
      pattern: "analyzeConceptForDefaults"
---

<objective>
Add smart defaults that auto-configure Step 1 settings based on concept content.

**PROBLEM:** Users must manually configure many settings in Step 1:
- Platform (YouTube, TikTok, Instagram, etc.)
- Duration (15s to 20 minutes)
- Production type
- Aspect ratio
- Pacing

Purpose: Analyze concept text to suggest appropriate settings automatically.

Output: User enters concept â†’ settings are intelligently pre-filled.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/PIPELINE-AUDIT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add concept analysis method</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Add a method to analyze concept text and suggest settings:

```php
/**
 * PHASE 3: Analyze concept to suggest optimal settings.
 * Returns suggested platform, duration, production type, etc.
 *
 * @param string $concept The concept text to analyze
 * @return array Suggested settings
 */
public function analyzeConceptForDefaults(string $concept): array
{
    $concept = strtolower($concept);
    $suggestions = [
        'platform' => null,
        'duration' => null,
        'productionType' => null,
        'aspectRatio' => null,
        'pacing' => null,
        'visualMode' => null,
        'confidence' => [],
    ];

    // Platform detection
    $platformPatterns = [
        'tiktok' => ['tiktok', 'viral', 'trend', 'short form', 'quick', 'snappy', '15 second', '30 second', '60 second'],
        'youtube' => ['youtube', 'tutorial', 'documentary', 'long form', 'in-depth', 'detailed', 'comprehensive', 'explainer'],
        'instagram' => ['instagram', 'reel', 'story', 'aesthetic', 'lifestyle', 'fashion', 'beauty'],
        'linkedin' => ['linkedin', 'professional', 'business', 'corporate', 'b2b', 'enterprise'],
        'twitter' => ['twitter', 'x.com', 'breaking', 'news', 'announcement'],
    ];

    foreach ($platformPatterns as $platform => $keywords) {
        foreach ($keywords as $keyword) {
            if (strpos($concept, $keyword) !== false) {
                $suggestions['platform'] = $platform;
                $suggestions['confidence']['platform'] = 'high';
                break 2;
            }
        }
    }

    // Duration detection based on content complexity
    $durationIndicators = [
        'short' => ['quick', 'brief', 'short', 'teaser', 'trailer', 'promo', '15', '30', '60'],
        'medium' => ['story', 'narrative', 'explain', 'show', 'demonstrate', '2 minute', '3 minute'],
        'long' => ['documentary', 'comprehensive', 'in-depth', 'detailed', 'full', 'complete', '5 minute', '10 minute'],
    ];

    $wordCount = str_word_count($concept);

    // Word count heuristic
    if ($wordCount < 20) {
        $suggestions['duration'] = 30; // Short concept = short video
    } elseif ($wordCount < 50) {
        $suggestions['duration'] = 60;
    } elseif ($wordCount < 100) {
        $suggestions['duration'] = 120;
    } else {
        $suggestions['duration'] = 180; // Long concept = longer video
    }

    // Override with explicit indicators
    foreach ($durationIndicators as $type => $keywords) {
        foreach ($keywords as $keyword) {
            if (strpos($concept, $keyword) !== false) {
                if ($type === 'short') $suggestions['duration'] = 30;
                elseif ($type === 'medium') $suggestions['duration'] = 90;
                elseif ($type === 'long') $suggestions['duration'] = 180;
                $suggestions['confidence']['duration'] = 'high';
                break 2;
            }
        }
    }

    // Production type detection
    $productionPatterns = [
        'commercial' => ['ad', 'advertisement', 'commercial', 'product', 'brand', 'marketing', 'promo'],
        'narrative' => ['story', 'film', 'movie', 'drama', 'narrative', 'character', 'plot'],
        'documentary' => ['documentary', 'real', 'true', 'history', 'educational', 'informative'],
        'music_video' => ['music', 'song', 'band', 'artist', 'concert', 'performance'],
        'tutorial' => ['tutorial', 'how to', 'guide', 'learn', 'teach', 'step by step'],
        'vlog' => ['vlog', 'day in', 'behind the scenes', 'personal', 'journey'],
    ];

    foreach ($productionPatterns as $type => $keywords) {
        foreach ($keywords as $keyword) {
            if (strpos($concept, $keyword) !== false) {
                $suggestions['productionType'] = $type;
                $suggestions['confidence']['productionType'] = 'high';
                break 2;
            }
        }
    }

    // Visual mode detection
    $visualPatterns = [
        'cinematic-realistic' => ['realistic', 'cinematic', 'film', 'movie', 'photorealistic', 'real'],
        'stylized-animation' => ['animated', 'cartoon', 'anime', 'illustration', 'stylized', '3d', '2d'],
        'mixed-hybrid' => ['mixed', 'hybrid', 'both', 'combination'],
    ];

    foreach ($visualPatterns as $mode => $keywords) {
        foreach ($keywords as $keyword) {
            if (strpos($concept, $keyword) !== false) {
                $suggestions['visualMode'] = $mode;
                $suggestions['confidence']['visualMode'] = 'high';
                break 2;
            }
        }
    }

    // Pacing detection
    $pacingPatterns = [
        'fast' => ['fast', 'quick', 'energetic', 'dynamic', 'action', 'exciting', 'intense'],
        'contemplative' => ['slow', 'calm', 'peaceful', 'meditative', 'relaxing', 'gentle'],
        'balanced' => ['balanced', 'moderate', 'normal'],
    ];

    foreach ($pacingPatterns as $pacing => $keywords) {
        foreach ($keywords as $keyword) {
            if (strpos($concept, $keyword) !== false) {
                $suggestions['pacing'] = $pacing;
                $suggestions['confidence']['pacing'] = 'high';
                break 2;
            }
        }
    }

    // Set aspect ratio based on platform
    if (!empty($suggestions['platform'])) {
        $aspectRatioMap = [
            'tiktok' => '9:16',
            'instagram' => '9:16',
            'youtube' => '16:9',
            'linkedin' => '16:9',
            'twitter' => '16:9',
        ];
        $suggestions['aspectRatio'] = $aspectRatioMap[$suggestions['platform']] ?? '16:9';
    }

    // Apply defaults for anything not detected
    $suggestions['platform'] = $suggestions['platform'] ?? 'youtube';
    $suggestions['duration'] = $suggestions['duration'] ?? 60;
    $suggestions['productionType'] = $suggestions['productionType'] ?? 'narrative';
    $suggestions['aspectRatio'] = $suggestions['aspectRatio'] ?? '16:9';
    $suggestions['pacing'] = $suggestions['pacing'] ?? 'balanced';
    $suggestions['visualMode'] = $suggestions['visualMode'] ?? 'cinematic-realistic';

    Log::info('VideoWizard: Analyzed concept for defaults', [
        'word_count' => $wordCount,
        'suggestions' => $suggestions,
    ]);

    return $suggestions;
}
```

WHY: Intelligent analysis reduces manual configuration.
  </action>
  <verify>
    - `analyzeConceptForDefaults()` method exists
    - Returns all relevant settings (platform, duration, type, etc.)
    - Pattern matching for platforms, durations, types
    - Confidence levels tracked
    - No PHP syntax errors
  </verify>
  <done>Concept analysis method added</done>
</task>

<task type="auto">
  <name>Task 2: Add auto-apply suggestions trigger</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Add a method that can be called to apply suggested settings:

```php
/**
 * PHASE 3: Apply suggested settings from concept analysis.
 * Called when user enters or updates concept in Step 2.
 *
 * @param bool $overwrite Whether to overwrite existing non-default values
 */
public function applySuggestedSettings(bool $overwrite = false): void
{
    $concept = $this->concept['rawInput'] ?? $this->concept['refinedConcept'] ?? '';

    if (empty($concept)) {
        return;
    }

    $suggestions = $this->analyzeConceptForDefaults($concept);

    // Apply platform if not set or overwrite enabled
    if ($overwrite || empty($this->platform) || $this->platform === 'youtube') {
        $this->platform = $suggestions['platform'];
    }

    // Apply aspect ratio based on platform
    if ($overwrite || empty($this->aspectRatio)) {
        $this->aspectRatio = $suggestions['aspectRatio'];
    }

    // Apply duration if default or overwrite
    if ($overwrite || empty($this->targetDuration) || $this->targetDuration === 60) {
        $this->targetDuration = $suggestions['duration'];
    }

    // Apply production type
    if ($overwrite || empty($this->productionType)) {
        $this->productionType = $suggestions['productionType'];
    }

    // Apply visual mode
    if ($overwrite || empty($this->visualMode)) {
        $this->visualMode = $suggestions['visualMode'];
    }

    // Apply pacing
    if ($overwrite || empty($this->pacing) || $this->pacing === 'balanced') {
        $this->pacing = $suggestions['pacing'];
    }

    // Store suggestions for UI display
    $this->suggestedSettings = $suggestions;

    Log::info('VideoWizard: Applied suggested settings', [
        'platform' => $this->platform,
        'duration' => $this->targetDuration,
        'productionType' => $this->productionType,
    ]);
}

/**
 * PHASE 3: Store suggested settings for UI display.
 */
public array $suggestedSettings = [];
```

WHY: Separating analysis from application allows user control.
  </action>
  <verify>
    - `applySuggestedSettings()` method exists
    - Respects overwrite parameter
    - Stores suggestions for UI
    - No PHP syntax errors
  </verify>
  <done>Auto-apply suggestions method added</done>
</task>

<task type="auto">
  <name>Task 3: Hook into concept update flow</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Find where concept is updated (in `improveConcept()` or similar) and add a call to apply suggestions:

```php
// After concept is refined/updated:
// PHASE 3: Analyze and suggest settings based on concept
$this->applySuggestedSettings(false); // Don't overwrite user choices
```

Also add a public method for the UI to trigger re-analysis:

```php
/**
 * PHASE 3: Re-analyze concept and update suggestions.
 * Called from UI when user wants to refresh suggestions.
 */
public function refreshSuggestedSettings(): void
{
    $this->applySuggestedSettings(true); // Overwrite with new suggestions

    $this->dispatch('notify', [
        'type' => 'info',
        'message' => 'Settings updated based on your concept.',
    ]);
}
```

WHY: Automatic suggestion on concept change provides seamless UX.
  </action>
  <verify>
    - `applySuggestedSettings()` is called after concept updates
    - `refreshSuggestedSettings()` method exists for manual refresh
    - Notification shown on refresh
    - No PHP syntax errors
  </verify>
  <done>Concept update flow integrated</done>
</task>

<task type="auto">
  <name>Task 4: Add AI-enhanced concept analysis option</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Add an optional AI-enhanced analysis for more accurate suggestions:

```php
/**
 * PHASE 3: Use AI to analyze concept and suggest optimal settings.
 * More accurate than keyword matching but requires API call.
 */
public function analyzeConceptWithAI(): void
{
    $concept = $this->concept['rawInput'] ?? $this->concept['refinedConcept'] ?? '';

    if (empty($concept)) {
        return;
    }

    try {
        $geminiService = app(\App\Services\GeminiService::class);

        $prompt = <<<PROMPT
Analyze this video concept and suggest optimal production settings.

CONCEPT:
{$concept}

Respond with ONLY a JSON object (no markdown, no explanation):
{
    "platform": "youtube|tiktok|instagram|linkedin|twitter",
    "duration": <number in seconds, 15-600>,
    "productionType": "commercial|narrative|documentary|music_video|tutorial|vlog",
    "visualMode": "cinematic-realistic|stylized-animation|mixed-hybrid",
    "pacing": "fast|balanced|contemplative",
    "aspectRatio": "16:9|9:16|1:1|4:5",
    "reasoning": "brief explanation of choices"
}
PROMPT;

        $response = $geminiService->generateContent($prompt);
        $json = $this->extractJson($response);

        if (!empty($json)) {
            $this->suggestedSettings = array_merge($this->suggestedSettings, $json);
            $this->suggestedSettings['source'] = 'ai';
            $this->suggestedSettings['confidence'] = ['overall' => 'high'];

            // Apply the AI suggestions
            $this->applySuggestedSettings(true);

            $this->dispatch('notify', [
                'type' => 'success',
                'message' => 'AI analyzed your concept and updated settings.',
            ]);

            Log::info('VideoWizard: AI concept analysis complete', $json);
        }
    } catch (\Exception $e) {
        Log::error('VideoWizard: AI concept analysis failed', [
            'error' => $e->getMessage(),
        ]);

        // Fall back to keyword analysis
        $this->applySuggestedSettings(true);
    }
}

/**
 * Extract JSON from AI response that may contain markdown.
 */
protected function extractJson(string $response): ?array
{
    // Try direct parse
    $decoded = json_decode($response, true);
    if ($decoded !== null) {
        return $decoded;
    }

    // Extract from markdown code block
    if (preg_match('/```(?:json)?\s*(\{[\s\S]*?\})\s*```/', $response, $matches)) {
        return json_decode($matches[1], true);
    }

    // Extract bare JSON object
    if (preg_match('/(\{[\s\S]*\})/', $response, $matches)) {
        return json_decode($matches[1], true);
    }

    return null;
}
```

WHY: AI analysis is more accurate for complex or nuanced concepts.
  </action>
  <verify>
    - `analyzeConceptWithAI()` method exists
    - Uses GeminiService for analysis
    - `extractJson()` helper handles various response formats
    - Falls back to keyword analysis on failure
    - No PHP syntax errors
  </verify>
  <done>AI-enhanced concept analysis added</done>
</task>

</tasks>

<verification>
1. PHP syntax check: `php -l modules/AppVideoWizard/app/Livewire/VideoWizard.php`
2. Grep for smart defaults:
   - `grep -n "analyzeConceptForDefaults" modules/AppVideoWizard/app/Livewire/VideoWizard.php`
   - `grep -n "applySuggestedSettings" modules/AppVideoWizard/app/Livewire/VideoWizard.php`
   - `grep -n "suggestedSettings" modules/AppVideoWizard/app/Livewire/VideoWizard.php`
</verification>

<success_criteria>
- Concept analysis method exists and detects platform, duration, etc.
- Settings are auto-applied when concept changes
- AI-enhanced analysis available as option
- User can refresh suggestions manually
- PHP syntax valid
</success_criteria>

<output>
After completion, create `.planning/phases/03-hollywood-production-system/03-07-SUMMARY.md`
</output>
