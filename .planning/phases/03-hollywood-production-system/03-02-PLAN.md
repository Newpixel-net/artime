---
phase: 03-hollywood-production-system
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/AppVideoWizard/app/Services/NarrativeMomentService.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Placeholder moments are never returned when narration has actual content"
    - "Every moment has a unique action verb from the ACTION_EMOTION_MAP"
    - "fallbackMomentGeneration produces meaningful moments not 'continues the scene'"
  artifacts:
    - path: "modules/AppVideoWizard/app/Services/NarrativeMomentService.php"
      provides: "Real narrative moment extraction without useless placeholders"
      contains: "generateMeaningfulMoments"
  key_links:
    - from: "NarrativeMomentService.php"
      to: "fallbackMomentGeneration"
      via: "when AI extraction fails"
      pattern: "generateMeaningfulMoments"
---

<objective>
Fix NarrativeMomentService to NEVER return useless placeholder moments.

**CRITICAL FIX:** When moment extraction fails, the service returns useless placeholders like:
- action: "continues the scene"
- subject: "the subject"
- visualDescription: "Scene continues"

These placeholders provide ZERO value for shot generation. They need to be replaced with meaningful moment extraction.

Purpose: Ensure every narrative moment has a real, unique action that can drive shot selection.

Output: NarrativeMomentService always returns meaningful moments with specific actions.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/PIPELINE-AUDIT.md

# Key source files
@modules/AppVideoWizard/app/Services/NarrativeMomentService.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace placeholder generation with meaningful moment extraction</name>
  <files>modules/AppVideoWizard/app/Services/NarrativeMomentService.php</files>
  <action>
Find the fallback placeholder generation (around line 537-549) that returns useless moments:

```php
// Generate placeholder moments
$placeholders = [];
for ($i = 0; $i < $targetCount; $i++) {
    $progress = $i / max(1, $targetCount - 1);
    $placeholders[] = [
        'action' => 'continues the scene',  // ❌ Useless
        'subject' => 'the subject',         // ❌ Useless
        'emotion' => 'focus',
        'intensity' => 0.3 + ($progress * 0.4),
        'visualDescription' => 'Scene continues', // ❌ Useless
    ];
}
```

Replace the entire placeholder generation block with intelligent fallback:

```php
// PHASE 3: Generate meaningful moments from narration analysis
// Never return useless placeholders like "continues the scene"
$moments = $this->generateMeaningfulMomentsFromNarration($narration, $targetCount, $context);

if (!empty($moments)) {
    Log::info('NarrativeMomentService: Generated meaningful fallback moments', [
        'count' => count($moments),
        'actions' => array_column($moments, 'action'),
    ]);
    return $moments;
}

// LAST RESORT: If we still can't extract moments, use narrative arc structure
// This is better than "continues the scene" because it provides unique actions
$arcMoments = $this->generateNarrativeArcMoments($targetCount, $context);
Log::warning('NarrativeMomentService: Using narrative arc fallback', [
    'count' => count($arcMoments),
]);
return $arcMoments;
```

This replaces useless placeholders with a two-tier fallback:
1. Extract moments from narration text using keyword analysis
2. If that fails, use standard narrative arc structure (setup → confrontation → resolution)
  </action>
  <verify>
    - No code path returns "continues the scene" as an action
    - `generateMeaningfulMomentsFromNarration()` method exists
    - `generateNarrativeArcMoments()` method exists
    - Log messages show what was generated
    - No PHP syntax errors: `php -l modules/AppVideoWizard/app/Services/NarrativeMomentService.php`
  </verify>
  <done>Placeholder generation replaced with meaningful moment extraction</done>
</task>

<task type="auto">
  <name>Task 2: Add generateMeaningfulMomentsFromNarration method</name>
  <files>modules/AppVideoWizard/app/Services/NarrativeMomentService.php</files>
  <action>
Add a new method to extract meaningful moments from narration text. Place after the existing moment extraction methods:

```php
/**
 * Generate meaningful moments by analyzing narration text.
 * Uses keyword extraction and ACTION_EMOTION_MAP for valid actions.
 *
 * @param string $narration Raw narration text
 * @param int $targetCount Number of moments to generate
 * @param array $context Scene context
 * @return array Array of moment objects with unique actions
 */
protected function generateMeaningfulMomentsFromNarration(string $narration, int $targetCount, array $context = []): array
{
    $moments = [];
    $usedActions = [];

    // Split narration into sentences/chunks
    $chunks = preg_split('/[.!?]+/', $narration, -1, PREG_SPLIT_NO_EMPTY);
    $chunks = array_filter(array_map('trim', $chunks));

    if (empty($chunks)) {
        return [];
    }

    // Get available actions from ACTION_EMOTION_MAP
    $availableActions = array_keys(self::ACTION_EMOTION_MAP);

    // Extract actions from each chunk
    foreach ($chunks as $index => $chunk) {
        if (count($moments) >= $targetCount) {
            break;
        }

        // Try to find an action verb in this chunk
        $action = $this->extractActionFromText($chunk, $usedActions);

        if ($action) {
            $emotion = self::ACTION_EMOTION_MAP[$action] ?? 'focus';
            $progress = count($moments) / max(1, $targetCount - 1);

            $moments[] = [
                'action' => $action,
                'subject' => $this->extractSubject($chunk, $context),
                'emotion' => $emotion,
                'intensity' => $this->calculateIntensityFromEmotion($emotion, $progress),
                'visualDescription' => $this->summarizeChunk($chunk),
                'source' => 'narration_analysis',
            ];

            $usedActions[] = $action;
        }
    }

    // If we don't have enough moments, interpolate
    if (count($moments) < $targetCount && count($moments) > 0) {
        $moments = $this->interpolateMoments($moments, $targetCount);
        $moments = $this->deduplicateActions($moments);
    }

    return $moments;
}

/**
 * Extract an action verb from text chunk.
 *
 * @param string $text Text to analyze
 * @param array $usedActions Actions already used (to avoid duplicates)
 * @return string|null Action found or null
 */
protected function extractActionFromText(string $text, array $usedActions = []): ?string
{
    $text = strtolower($text);

    // Priority actions from ACTION_EMOTION_MAP
    $actionPriority = [
        // High-value actions (dramatic)
        'discovers', 'realizes', 'confronts', 'reveals', 'escapes', 'attacks',
        'defends', 'surrenders', 'sacrifices', 'transforms',
        // Movement actions
        'enters', 'arrives', 'approaches', 'retreats', 'chases', 'flees',
        'walks', 'runs', 'stops',
        // Perception actions
        'notices', 'spots', 'watches', 'observes', 'sees', 'looks',
        // Interaction actions
        'speaks', 'meets', 'greets', 'argues', 'agrees', 'refuses',
        // State actions
        'waits', 'stands', 'sits', 'hides', 'searches',
    ];

    foreach ($actionPriority as $action) {
        // Check if action appears in text and hasn't been used
        $patterns = [$action, rtrim($action, 's'), $action . 's', $action . 'ing', $action . 'ed'];
        foreach ($patterns as $pattern) {
            if (strpos($text, $pattern) !== false && !in_array($action, $usedActions)) {
                return $action;
            }
        }
    }

    return null;
}

/**
 * Extract subject from text chunk.
 *
 * @param string $text Text to analyze
 * @param array $context Scene context with characters
 * @return string Subject description
 */
protected function extractSubject(string $text, array $context = []): string
{
    // Check for known characters
    $characters = $context['characters'] ?? [];
    foreach ($characters as $character) {
        $name = $character['name'] ?? '';
        if (!empty($name) && stripos($text, $name) !== false) {
            return $name;
        }
    }

    // Check for common subject words
    $subjectPatterns = [
        '/\b(he|him|his)\b/i' => 'the protagonist',
        '/\b(she|her|hers)\b/i' => 'the protagonist',
        '/\b(they|them|their)\b/i' => 'the characters',
        '/\b(the (?:man|woman|person|figure|character))\b/i' => '$1',
    ];

    foreach ($subjectPatterns as $pattern => $replacement) {
        if (preg_match($pattern, $text)) {
            return $replacement;
        }
    }

    return 'the character';
}

/**
 * Summarize a text chunk for visual description.
 *
 * @param string $chunk Text chunk
 * @return string Summarized visual description
 */
protected function summarizeChunk(string $chunk): string
{
    // Remove common filler words and truncate
    $cleaned = preg_replace('/\b(the|a|an|is|are|was|were|has|have|had|been)\b/i', '', $chunk);
    $cleaned = preg_replace('/\s+/', ' ', trim($cleaned));

    // Truncate to reasonable length
    if (strlen($cleaned) > 100) {
        $cleaned = substr($cleaned, 0, 97) . '...';
    }

    return ucfirst($cleaned) ?: 'Scene moment';
}
```

WHY: This method extracts REAL actions from the narration text instead of returning useless "continues the scene" placeholders.
  </action>
  <verify>
    - `generateMeaningfulMomentsFromNarration()` method exists and is protected
    - `extractActionFromText()` method exists and finds actions from ACTION_EMOTION_MAP
    - `extractSubject()` method exists and uses character context
    - `summarizeChunk()` method exists and produces meaningful descriptions
    - No PHP syntax errors: `php -l modules/AppVideoWizard/app/Services/NarrativeMomentService.php`
  </verify>
  <done>Meaningful moment extraction from narration text is implemented</done>
</task>

<task type="auto">
  <name>Task 3: Add generateNarrativeArcMoments fallback</name>
  <files>modules/AppVideoWizard/app/Services/NarrativeMomentService.php</files>
  <action>
Add a last-resort fallback that generates moments based on standard narrative arc structure (better than "continues the scene"):

```php
/**
 * Generate moments based on standard narrative arc structure.
 * Used as last resort when text analysis fails.
 *
 * @param int $targetCount Number of moments
 * @param array $context Scene context
 * @return array Narrative arc moments
 */
protected function generateNarrativeArcMoments(int $targetCount, array $context = []): array
{
    // Standard narrative arc actions that tell a story
    $arcActions = [
        // Setup (first 20%)
        ['action' => 'observes', 'emotion' => 'curiosity', 'phase' => 'setup'],
        ['action' => 'approaches', 'emotion' => 'anticipation', 'phase' => 'setup'],
        // Rising action (20-50%)
        ['action' => 'discovers', 'emotion' => 'surprise', 'phase' => 'rising'],
        ['action' => 'confronts', 'emotion' => 'determination', 'phase' => 'rising'],
        ['action' => 'struggles', 'emotion' => 'tension', 'phase' => 'rising'],
        // Climax (50-70%)
        ['action' => 'faces', 'emotion' => 'intensity', 'phase' => 'climax'],
        ['action' => 'overcomes', 'emotion' => 'triumph', 'phase' => 'climax'],
        // Falling action (70-90%)
        ['action' => 'reflects', 'emotion' => 'contemplation', 'phase' => 'falling'],
        // Resolution (90-100%)
        ['action' => 'resolves', 'emotion' => 'resolution', 'phase' => 'resolution'],
    ];

    $moments = [];
    $subject = $context['mainCharacter'] ?? 'the protagonist';
    $mood = $context['mood'] ?? 'dramatic';

    // Select appropriate arc moments based on target count
    if ($targetCount <= 3) {
        // Short: setup → climax → resolution
        $selectedIndices = [0, 5, 8];
    } elseif ($targetCount <= 5) {
        // Medium: setup → rising → climax → falling → resolution
        $selectedIndices = [0, 2, 5, 7, 8];
    } else {
        // Long: use all arc points and interpolate
        $selectedIndices = range(0, min(count($arcActions) - 1, $targetCount - 1));
    }

    foreach ($selectedIndices as $i => $arcIndex) {
        if ($arcIndex >= count($arcActions)) {
            $arcIndex = count($arcActions) - 1;
        }

        $arc = $arcActions[$arcIndex];
        $progress = $i / max(1, count($selectedIndices) - 1);

        $moments[] = [
            'action' => $arc['action'],
            'subject' => $subject,
            'emotion' => $arc['emotion'],
            'intensity' => $this->calculateArcIntensity($arc['phase'], $progress),
            'visualDescription' => sprintf('%s %s the situation', ucfirst($subject), $arc['action']),
            'source' => 'narrative_arc',
            'arcPhase' => $arc['phase'],
        ];
    }

    // Interpolate if needed
    if (count($moments) < $targetCount) {
        $moments = $this->interpolateMoments($moments, $targetCount);
        $moments = $this->deduplicateActions($moments);
    }

    return $moments;
}

/**
 * Calculate intensity based on narrative arc phase.
 *
 * @param string $phase Arc phase
 * @param float $progress Overall progress (0-1)
 * @return float Intensity (0-1)
 */
protected function calculateArcIntensity(string $phase, float $progress): float
{
    // Intensity curves by phase
    $phaseIntensity = [
        'setup' => 0.3,
        'rising' => 0.5 + ($progress * 0.2),
        'climax' => 0.85,
        'falling' => 0.6,
        'resolution' => 0.4,
    ];

    return $phaseIntensity[$phase] ?? 0.5;
}
```

WHY: This provides a meaningful fallback when text analysis fails. Instead of "continues the scene", we get proper narrative arc actions like "observes", "discovers", "confronts", "overcomes".
  </action>
  <verify>
    - `generateNarrativeArcMoments()` method exists and is protected
    - Arc actions are meaningful verbs, not "continues"
    - Intensity varies by arc phase (setup=low, climax=high)
    - No PHP syntax errors: `php -l modules/AppVideoWizard/app/Services/NarrativeMomentService.php`
  </verify>
  <done>Narrative arc fallback generates meaningful moments instead of useless placeholders</done>
</task>

</tasks>

<verification>
1. PHP syntax check: `php -l modules/AppVideoWizard/app/Services/NarrativeMomentService.php`
2. Grep for removed placeholders:
   - `grep -n "continues the scene" modules/AppVideoWizard/app/Services/NarrativeMomentService.php` (should find 0 results)
   - `grep -n "the subject" modules/AppVideoWizard/app/Services/NarrativeMomentService.php` (should find 0 results in moment generation)
3. Grep for new methods:
   - `grep -n "generateMeaningfulMomentsFromNarration" modules/AppVideoWizard/app/Services/NarrativeMomentService.php`
   - `grep -n "generateNarrativeArcMoments" modules/AppVideoWizard/app/Services/NarrativeMomentService.php`
</verification>

<success_criteria>
- No moment ever has action "continues the scene"
- No moment ever has subject "the subject"
- Fallback moments use real verbs from ACTION_EMOTION_MAP or narrative arc
- Every moment has unique, meaningful action
- PHP syntax valid
</success_criteria>

<output>
After completion, create `.planning/phases/03-hollywood-production-system/03-02-SUMMARY.md`
</output>
