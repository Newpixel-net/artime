---
phase: 03-hollywood-production-system
plan: 05
type: execute
wave: 3
depends_on: ["03-01", "03-02", "03-03"]
files_modified:
  - modules/AppVideoWizard/app/Livewire/VideoWizard.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Failed image generations are automatically retried up to 3 times"
    - "Failed video generations are automatically retried up to 3 times"
    - "Progress tracking shows per-scene/shot status"
    - "Retry logic has exponential backoff"
  artifacts:
    - path: "modules/AppVideoWizard/app/Livewire/VideoWizard.php"
      provides: "Smart retry logic for batch generation"
      contains: "retryFailedGeneration"
  key_links:
    - from: "VideoWizard.php"
      to: "ImageGenerationService"
      via: "retry wrapper"
      pattern: "retryFailedGeneration"
---

<objective>
Add smart retry logic and improved progress tracking for batch generation.

**PROBLEM:** Current batch generation has issues:
- Failed generations require manual intervention
- No automatic retry with backoff
- Progress tracking is basic
- Users must babysit the generation process

Purpose: Make batch generation reliable and hands-off.

Output: Batch generation that handles failures gracefully and keeps users informed.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/PIPELINE-AUDIT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add retry tracking properties</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Add properties to track retry state. Find the properties section and add:

```php
/**
 * PHASE 3: Track generation retry attempts per scene/shot.
 * Structure: ['scene_0' => 1, 'scene_0_shot_1' => 2, ...]
 */
protected array $generationRetryCount = [];

/**
 * PHASE 3: Maximum retry attempts for failed generations.
 */
protected int $maxRetryAttempts = 3;

/**
 * PHASE 3: Track generation status per item.
 * Structure: ['scene_0' => 'generating', 'scene_0_shot_1' => 'failed', ...]
 */
public array $generationStatus = [];
```

WHY: Need to track how many times we've retried each item.
  </action>
  <verify>
    - `$generationRetryCount` property exists
    - `$maxRetryAttempts` property exists with value 3
    - `$generationStatus` property exists
    - No PHP syntax errors
  </verify>
  <done>Retry tracking properties added</done>
</task>

<task type="auto">
  <name>Task 2: Add smart retry method for image generation</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Add a wrapper method that handles image generation with retry logic:

```php
/**
 * PHASE 3: Generate image with automatic retry on failure.
 *
 * @param int $sceneIndex Scene index
 * @param int|null $shotIndex Shot index (null for single-shot mode)
 * @param array $options Generation options
 * @return bool True if generation succeeded or is in progress
 */
protected function generateImageWithRetry(int $sceneIndex, ?int $shotIndex = null, array $options = []): bool
{
    $itemKey = $shotIndex !== null
        ? "scene_{$sceneIndex}_shot_{$shotIndex}"
        : "scene_{$sceneIndex}";

    $retryCount = $this->generationRetryCount[$itemKey] ?? 0;

    if ($retryCount >= $this->maxRetryAttempts) {
        Log::warning('VideoWizard: Max retries reached for image generation', [
            'item' => $itemKey,
            'attempts' => $retryCount,
        ]);
        $this->generationStatus[$itemKey] = 'failed_permanent';
        return false;
    }

    try {
        $this->generationStatus[$itemKey] = 'generating';
        $this->generationRetryCount[$itemKey] = $retryCount + 1;

        // Add exponential backoff delay if this is a retry
        if ($retryCount > 0) {
            $delay = pow(2, $retryCount) * 1000; // 2s, 4s, 8s
            Log::info('VideoWizard: Retrying image generation with backoff', [
                'item' => $itemKey,
                'attempt' => $retryCount + 1,
                'delay_ms' => $delay,
            ]);
            usleep($delay * 1000); // Convert to microseconds
        }

        // Call the actual generation method
        if ($shotIndex !== null) {
            $result = $this->generateShotImage($sceneIndex, $shotIndex, $options);
        } else {
            $result = $this->generateSceneImage($sceneIndex, $options);
        }

        if ($result) {
            $this->generationStatus[$itemKey] = 'complete';
            return true;
        }

        // Generation returned false, schedule retry
        $this->scheduleImageRetry($sceneIndex, $shotIndex, $options);
        return false;

    } catch (\Exception $e) {
        Log::error('VideoWizard: Image generation failed', [
            'item' => $itemKey,
            'attempt' => $retryCount + 1,
            'error' => $e->getMessage(),
        ]);

        $this->generationStatus[$itemKey] = 'failed';
        $this->scheduleImageRetry($sceneIndex, $shotIndex, $options);
        return false;
    }
}

/**
 * Schedule a retry for failed image generation.
 */
protected function scheduleImageRetry(int $sceneIndex, ?int $shotIndex, array $options): void
{
    $itemKey = $shotIndex !== null
        ? "scene_{$sceneIndex}_shot_{$shotIndex}"
        : "scene_{$sceneIndex}";

    $retryCount = $this->generationRetryCount[$itemKey] ?? 0;

    if ($retryCount < $this->maxRetryAttempts) {
        // Dispatch event to retry after delay
        $delay = pow(2, $retryCount) * 1000;
        $this->dispatch('retry-image-generation', [
            'sceneIndex' => $sceneIndex,
            'shotIndex' => $shotIndex,
            'options' => $options,
            'delay' => $delay,
        ]);
    }
}
```

WHY: Automatic retries with exponential backoff handle transient failures.
  </action>
  <verify>
    - `generateImageWithRetry()` method exists
    - Exponential backoff implemented (2^n seconds)
    - Retry count is tracked per item
    - `scheduleImageRetry()` exists
    - No PHP syntax errors
  </verify>
  <done>Smart retry method for images added</done>
</task>

<task type="auto">
  <name>Task 3: Add smart retry method for video generation</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Add a similar wrapper for video generation:

```php
/**
 * PHASE 3: Generate video with automatic retry on failure.
 *
 * @param int $sceneIndex Scene index
 * @param array $options Generation options
 * @return bool True if generation succeeded or is in progress
 */
protected function generateVideoWithRetry(int $sceneIndex, array $options = []): bool
{
    $itemKey = "video_scene_{$sceneIndex}";

    $retryCount = $this->generationRetryCount[$itemKey] ?? 0;

    if ($retryCount >= $this->maxRetryAttempts) {
        Log::warning('VideoWizard: Max retries reached for video generation', [
            'item' => $itemKey,
            'attempts' => $retryCount,
        ]);
        $this->generationStatus[$itemKey] = 'failed_permanent';
        return false;
    }

    try {
        $this->generationStatus[$itemKey] = 'generating';
        $this->generationRetryCount[$itemKey] = $retryCount + 1;

        // Add exponential backoff delay if this is a retry
        if ($retryCount > 0) {
            $delay = pow(2, $retryCount) * 1000;
            Log::info('VideoWizard: Retrying video generation with backoff', [
                'item' => $itemKey,
                'attempt' => $retryCount + 1,
                'delay_ms' => $delay,
            ]);
            usleep($delay * 1000);
        }

        // Call the actual animation method
        $result = $this->animateScene($sceneIndex, $options);

        if ($result) {
            $this->generationStatus[$itemKey] = 'complete';
            return true;
        }

        // Generation returned false, schedule retry
        $this->scheduleVideoRetry($sceneIndex, $options);
        return false;

    } catch (\Exception $e) {
        Log::error('VideoWizard: Video generation failed', [
            'item' => $itemKey,
            'attempt' => $retryCount + 1,
            'error' => $e->getMessage(),
        ]);

        $this->generationStatus[$itemKey] = 'failed';
        $this->scheduleVideoRetry($sceneIndex, $options);
        return false;
    }
}

/**
 * Schedule a retry for failed video generation.
 */
protected function scheduleVideoRetry(int $sceneIndex, array $options): void
{
    $itemKey = "video_scene_{$sceneIndex}";

    $retryCount = $this->generationRetryCount[$itemKey] ?? 0;

    if ($retryCount < $this->maxRetryAttempts) {
        $delay = pow(2, $retryCount) * 1000;
        $this->dispatch('retry-video-generation', [
            'sceneIndex' => $sceneIndex,
            'options' => $options,
            'delay' => $delay,
        ]);
    }
}
```

WHY: Video generation is expensive; automatic retries save time and money.
  </action>
  <verify>
    - `generateVideoWithRetry()` method exists
    - Exponential backoff implemented
    - Retry count is tracked per video
    - `scheduleVideoRetry()` exists
    - No PHP syntax errors
  </verify>
  <done>Smart retry method for videos added</done>
</task>

<task type="auto">
  <name>Task 4: Add batch generation status summary</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Add a method to get a summary of batch generation status:

```php
/**
 * PHASE 3: Get summary of batch generation status.
 *
 * @param string $type 'images' or 'videos'
 * @return array Status summary
 */
public function getBatchGenerationStatus(string $type = 'images'): array
{
    $summary = [
        'total' => 0,
        'pending' => 0,
        'generating' => 0,
        'complete' => 0,
        'failed' => 0,
        'failed_permanent' => 0,
        'items' => [],
    ];

    $prefix = $type === 'videos' ? 'video_scene_' : 'scene_';

    foreach ($this->generationStatus as $key => $status) {
        if (strpos($key, $prefix) === 0 || ($type === 'images' && strpos($key, 'scene_') === 0 && strpos($key, 'video_') !== 0)) {
            $summary['total']++;
            $summary[$status] = ($summary[$status] ?? 0) + 1;
            $summary['items'][$key] = [
                'status' => $status,
                'retries' => $this->generationRetryCount[$key] ?? 0,
            ];
        }
    }

    // Calculate pending (items not yet started)
    if ($type === 'images') {
        $scenes = $this->storyboard['scenes'] ?? [];
        foreach ($scenes as $i => $scene) {
            $shots = $scene['shots'] ?? [];
            if (empty($shots)) {
                $key = "scene_{$i}";
                if (!isset($this->generationStatus[$key])) {
                    $summary['pending']++;
                }
            } else {
                foreach ($shots as $j => $shot) {
                    $key = "scene_{$i}_shot_{$j}";
                    if (!isset($this->generationStatus[$key])) {
                        $summary['pending']++;
                    }
                }
            }
        }
    } else {
        $scenes = $this->animation['scenes'] ?? [];
        foreach ($scenes as $i => $scene) {
            $key = "video_scene_{$i}";
            if (!isset($this->generationStatus[$key])) {
                $summary['pending']++;
            }
        }
    }

    $summary['total'] += $summary['pending'];
    $summary['percentage'] = $summary['total'] > 0
        ? round(($summary['complete'] / $summary['total']) * 100)
        : 0;

    return $summary;
}

/**
 * PHASE 3: Retry all failed generations.
 *
 * @param string $type 'images' or 'videos'
 */
public function retryAllFailed(string $type = 'images'): void
{
    $prefix = $type === 'videos' ? 'video_scene_' : 'scene_';

    foreach ($this->generationStatus as $key => $status) {
        if ($status === 'failed' || $status === 'failed_permanent') {
            // Reset retry count and status
            $this->generationRetryCount[$key] = 0;
            $this->generationStatus[$key] = 'pending';
        }
    }

    // Trigger batch generation
    if ($type === 'images') {
        $this->dispatch('start-batch-image-generation');
    } else {
        $this->dispatch('start-batch-video-generation');
    }

    Log::info('VideoWizard: Retrying all failed generations', ['type' => $type]);
}
```

WHY: Users need to see what's happening and have a way to retry all failures.
  </action>
  <verify>
    - `getBatchGenerationStatus()` method exists
    - Returns counts for pending, generating, complete, failed
    - `retryAllFailed()` method exists
    - No PHP syntax errors
  </verify>
  <done>Batch generation status summary added</done>
</task>

</tasks>

<verification>
1. PHP syntax check: `php -l modules/AppVideoWizard/app/Livewire/VideoWizard.php`
2. Grep for retry methods:
   - `grep -n "generateImageWithRetry" modules/AppVideoWizard/app/Livewire/VideoWizard.php`
   - `grep -n "generateVideoWithRetry" modules/AppVideoWizard/app/Livewire/VideoWizard.php`
3. All methods exist:
   - `scheduleImageRetry()`
   - `scheduleVideoRetry()`
   - `getBatchGenerationStatus()`
   - `retryAllFailed()`
</verification>

<success_criteria>
- Retry tracking properties exist
- Image generation has retry wrapper with backoff
- Video generation has retry wrapper with backoff
- Status summary method provides progress info
- Retry-all method exists for manual intervention
- PHP syntax valid
</success_criteria>

<output>
After completion, create `.planning/phases/03-hollywood-production-system/03-05-SUMMARY.md`
</output>
