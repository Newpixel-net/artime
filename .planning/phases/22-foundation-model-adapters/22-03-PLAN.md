---
phase: 22-foundation-model-adapters
plan: 03
type: execute
wave: 3
depends_on: ["22-02"]
files_modified:
  - modules/AppVideoWizard/app/Services/ImageGenerationService.php
  - modules/AppVideoWizard/app/Services/StructuredPromptBuilderService.php
autonomous: true

must_haves:
  truths:
    - "ImageGenerationService hooks adapter before model dispatch"
    - "HiDream prompts are compressed under 77 tokens before sending"
    - "NanoBanana/Pro prompts pass through unchanged"
    - "Adaptation is logged with token counts"
  artifacts:
    - path: "modules/AppVideoWizard/app/Services/ImageGenerationService.php"
      provides: "Model adapter integration in generateSceneImage"
      contains: "ModelPromptAdapterService"
    - path: "modules/AppVideoWizard/app/Services/StructuredPromptBuilderService.php"
      provides: "Template integration for shot-type-aware prompts"
      contains: "PromptTemplateLibrary"
  key_links:
    - from: "ImageGenerationService.php"
      to: "ModelPromptAdapterService.php"
      via: "adaptPrompt() call before model dispatch"
      pattern: "adaptPrompt.*\\$modelId"
    - from: "StructuredPromptBuilderService.php"
      to: "CinematographyVocabulary.php"
      via: "uses vocabulary for camera/lighting descriptions"
      pattern: "CinematographyVocabulary::"
---

<objective>
Integrate model adapter into ImageGenerationService and enhance StructuredPromptBuilder with vocabulary.

Purpose: This plan wires the model adapter into the image generation flow. After prompts are built, the adapter compresses them for CLIP-based models (HiDream) while passing Gemini prompts through unchanged. Also enhances existing prompt builder with new vocabulary.

Output:
- ImageGenerationService.php with ModelPromptAdapterService integration
- StructuredPromptBuilderService.php using CinematographyVocabulary for enhanced camera/lighting text
- End-to-end verification that HiDream gets short prompts, Gemini gets full prompts

Requirements covered: INF-01, IMG-01, IMG-02, IMG-03 (integration)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-foundation-model-adapters/22-RESEARCH.md
@.planning/phases/22-foundation-model-adapters/22-01-SUMMARY.md
@.planning/phases/22-foundation-model-adapters/22-02-SUMMARY.md
@modules/AppVideoWizard/app/Services/ImageGenerationService.php
@modules/AppVideoWizard/app/Services/StructuredPromptBuilderService.php
@modules/AppVideoWizard/app/Services/ModelPromptAdapterService.php
@modules/AppVideoWizard/app/Services/CinematographyVocabulary.php
@modules/AppVideoWizard/app/Services/PromptTemplateLibrary.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate ModelPromptAdapterService into ImageGenerationService</name>
  <files>modules/AppVideoWizard/app/Services/ImageGenerationService.php</files>
  <action>
Modify ImageGenerationService to use the model adapter:

1. **Add property and import:**
   ```php
   use Modules\AppVideoWizard\Services\ModelPromptAdapterService;

   protected ?ModelPromptAdapterService $promptAdapter = null;
   ```

2. **Initialize in constructor:**
   ```php
   public function __construct(...)
   {
       // ... existing code ...
       $this->promptAdapter = app(ModelPromptAdapterService::class);
   }
   ```

3. **Hook adapter in generateSceneImage():**
   Find the location after `$prompt = $this->buildImagePrompt(...)` (around line 218).
   Add BEFORE the model dispatch (before routing to HiDream or Gemini):

   ```php
   // Phase 22: Model-aware prompt adaptation
   // Compresses prompts for CLIP-based models (HiDream), passes through for Gemini
   $shotType = $shotContext['shot_type'] ?? 'medium';
   $adaptedPrompt = $this->promptAdapter->adaptPrompt($prompt, $modelId, [
       'shotType' => $shotType,
       'preserveCharacterDNA' => true,
   ]);

   // Log adaptation details for debugging
   $adaptationStats = $this->promptAdapter->getAdaptationStats($prompt, $adaptedPrompt, $modelId);
   Log::info('[ImageGeneration] Prompt adapted for model', [
       'modelId' => $modelId,
       'originalTokens' => $adaptationStats['originalTokens'],
       'adaptedTokens' => $adaptationStats['adaptedTokens'],
       'wasCompressed' => $adaptationStats['wasCompressed'],
       'shotType' => $shotType,
   ]);

   // Use adapted prompt for generation
   $prompt = $adaptedPrompt;
   ```

4. **Important:** Place this hook:
   - AFTER buildImagePrompt() (around line 218)
   - AFTER the cascade reference logic (around line 350)
   - BEFORE the provider routing (around line 400 where it calls generateWithHiDream or generateWithGemini)

   Look for the pattern where $prompt is finalized and used. The hook goes just before the actual generation call.

5. **Also update generateCollageMode()** if it has its own prompt building path - apply same pattern.
  </action>
  <verify>
```bash
# Check that the integration code exists
cd "C:\Users\VoltaPsy\Documents\GitHub\artime"
grep -n "ModelPromptAdapterService" modules/AppVideoWizard/app/Services/ImageGenerationService.php
grep -n "adaptPrompt" modules/AppVideoWizard/app/Services/ImageGenerationService.php
```
  </verify>
  <done>
- ImageGenerationService imports ModelPromptAdapterService
- adaptPrompt() is called after buildImagePrompt()
- Logging includes originalTokens, adaptedTokens, wasCompressed
- Adapted prompt is used for actual generation
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance StructuredPromptBuilderService with Vocabulary</name>
  <files>modules/AppVideoWizard/app/Services/StructuredPromptBuilderService.php</files>
  <action>
Enhance the prompt builder to use CinematographyVocabulary:

1. **Add imports:**
   ```php
   use Modules\AppVideoWizard\Services\CinematographyVocabulary;
   use Modules\AppVideoWizard\Services\PromptTemplateLibrary;
   ```

2. **Add properties:**
   ```php
   protected CinematographyVocabulary $vocabulary;
   protected PromptTemplateLibrary $templateLibrary;

   public function __construct()
   {
       $this->vocabulary = new CinematographyVocabulary();
       $this->templateLibrary = new PromptTemplateLibrary();
   }
   ```

3. **Enhance buildCameraLanguage() method** (or create if not exists):
   Replace/enhance the camera description to include psychology:
   ```php
   protected function buildCameraLanguage(string $shotType, array $options): string
   {
       $lens = $this->vocabulary->getLensForShotType($shotType);

       // Build camera description with psychology
       // "85mm lens creates intimate compression, isolating subject from background"
       return sprintf(
           '%s lens %s, %s',
           $lens['focal_length'],
           $lens['effect'],
           $lens['psychology']
       );
   }
   ```

4. **Enhance lighting descriptions:**
   Update lighting sections to use specific values:
   ```php
   protected function buildLightingDescription(array $options): string
   {
       $mood = $options['mood'] ?? 'natural';
       $timeOfDay = $options['time_of_day'] ?? 'daylight';

       $ratio = $this->vocabulary->getRatioForMood($mood);
       $temp = $this->vocabulary->getTemperatureDescription($timeOfDay);

       // "key light 45 degrees camera-left at 5600K, fill at -2 stops"
       return sprintf(
           'key light at %s, %s, %d stop difference key to fill',
           $temp,
           $ratio['description'],
           $ratio['stops_difference']
       );
   }
   ```

5. **Add framing descriptions:**
   In the subject/composition section:
   ```php
   protected function buildFramingDescription(array $options): string
   {
       $percentage = $options['subject_percentage'] ?? 40;
       $position = $options['subject_position'] ?? 'center frame';

       return $this->vocabulary->buildFramingDescription($percentage, $position);
   }
   ```

6. **Integrate into build() method:**
   When building creative_prompt, include:
   - Camera language with psychology
   - Lighting with Kelvin and ratios
   - Framing with percentages

Preserve existing functionality - EXTEND don't break.
  </action>
  <verify>
```bash
php artisan tinker --execute="
use Modules\AppVideoWizard\Services\StructuredPromptBuilderService;
\$builder = new StructuredPromptBuilderService();
\$result = \$builder->build([
    'visual_mode' => 'cinematic-realistic',
    'scene_description' => 'A woman sits at a cafe table',
    'shot_type' => 'close-up',
]);
\$prompt = \$builder->toPromptString(\$result);
echo 'Has lens psychology: ' . (str_contains(\$prompt, 'mm') ? 'YES' : 'NO') . PHP_EOL;
echo 'Has Kelvin value: ' . (preg_match('/\\d{4}K/', \$prompt) ? 'YES' : 'NO') . PHP_EOL;
echo 'Prompt preview: ' . substr(\$prompt, 0, 500) . '...' . PHP_EOL;
"
```
  </verify>
  <done>
- StructuredPromptBuilderService uses CinematographyVocabulary
- Generated prompts include lens with psychology (e.g., "85mm creates intimacy")
- Generated prompts include Kelvin values (e.g., "5600K daylight")
- Generated prompts include framing percentages (e.g., "40% of frame")
  </done>
</task>

<task type="auto">
  <name>Task 3: End-to-End Integration Test</name>
  <files>modules/AppVideoWizard/tests/Feature/PromptAdaptationIntegrationTest.php</files>
  <action>
Create feature test to verify full integration:

```php
<?php

namespace Modules\AppVideoWizard\Tests\Feature;

use Tests\TestCase;
use Modules\AppVideoWizard\Models\WizardProject;
use Modules\AppVideoWizard\Services\ImageGenerationService;
use Modules\AppVideoWizard\Services\ModelPromptAdapterService;
use Illuminate\Foundation\Testing\RefreshDatabase;

class PromptAdaptationIntegrationTest extends TestCase
{
    use RefreshDatabase;

    public function test_hidream_receives_compressed_prompt()
    {
        // Create a test project with HiDream model
        $project = WizardProject::factory()->create([
            'storyboard' => [
                'imageModel' => 'hidream',
            ],
        ]);

        // Get the image generation service
        $service = app(ImageGenerationService::class);
        $adapter = app(ModelPromptAdapterService::class);

        // Build a prompt that would exceed 77 tokens
        $longDescription = 'A serene woman with flowing auburn hair stands in a sunlit meadow, surrounded by wildflowers, golden hour lighting with warm rim light, 85mm lens with creamy bokeh, cinematic color grading, 8K resolution, photorealistic, ultra detailed';

        // Verify adapter compresses it
        $adapted = $adapter->adaptPrompt($longDescription, 'hidream');
        $tokenCount = $adapter->countTokens($adapted);

        $this->assertLessThanOrEqual(77, $tokenCount);
        $this->assertStringContainsString('woman', $adapted);
    }

    public function test_nanobanana_receives_full_prompt()
    {
        $adapter = app(ModelPromptAdapterService::class);

        $fullPrompt = 'Detailed cinematic scene with extensive description...';
        $adapted = $adapter->adaptPrompt($fullPrompt, 'nanobanana');

        $this->assertEquals($fullPrompt, $adapted);
    }

    public function test_prompt_includes_camera_psychology()
    {
        $builder = app(\Modules\AppVideoWizard\Services\StructuredPromptBuilderService::class);

        $result = $builder->build([
            'visual_mode' => 'cinematic-realistic',
            'scene_description' => 'A man looks out a window',
            'shot_type' => 'close-up',
        ]);

        $prompt = $builder->toPromptString($result);

        // Should include psychological reasoning
        $this->assertMatchesRegularExpression('/\d+mm/', $prompt);
    }

    public function test_prompt_includes_lighting_values()
    {
        $builder = app(\Modules\AppVideoWizard\Services\StructuredPromptBuilderService::class);

        $result = $builder->build([
            'visual_mode' => 'cinematic-realistic',
            'scene_description' => 'Morning coffee scene',
        ]);

        $prompt = $builder->toPromptString($result);

        // Should include Kelvin or lighting ratio terminology
        $hasLightingDetail = preg_match('/\d{4}K|stop|ratio|fill|key/i', $prompt);
        $this->assertTrue((bool)$hasLightingDetail, 'Prompt should include lighting details');
    }
}
```

Run: `php artisan test --filter=PromptAdaptationIntegration`
  </action>
  <verify>
```bash
cd "C:\Users\VoltaPsy\Documents\GitHub\artime" && php artisan test --filter=PromptAdaptationIntegration
```
  </verify>
  <done>
- test_hidream_receives_compressed_prompt passes (under 77 tokens)
- test_nanobanana_receives_full_prompt passes (unchanged)
- test_prompt_includes_camera_psychology passes (lens specs present)
- test_prompt_includes_lighting_values passes (Kelvin/ratio present)
  </done>
</task>

</tasks>

<verification>
```bash
# Run all Phase 22 tests
cd "C:\Users\VoltaPsy\Documents\GitHub\artime"
php artisan test --filter=Cinematography --filter=PromptTemplate --filter=ModelPromptAdapter --filter=PromptAdaptationIntegration

# Manual verification - check prompt output
php artisan tinker --execute="
use Modules\AppVideoWizard\Services\StructuredPromptBuilderService;
use Modules\AppVideoWizard\Services\ModelPromptAdapterService;

\$builder = new StructuredPromptBuilderService();
\$adapter = app(ModelPromptAdapterService::class);

\$result = \$builder->build([
    'visual_mode' => 'cinematic-realistic',
    'scene_description' => 'A detective examines evidence',
    'shot_type' => 'close-up',
]);
\$fullPrompt = \$builder->toPromptString(\$result);

echo '=== FULL PROMPT ===' . PHP_EOL;
echo \$fullPrompt . PHP_EOL;
echo 'Token count: ' . \$adapter->countTokens(\$fullPrompt) . PHP_EOL;

echo PHP_EOL . '=== HIDREAM ADAPTED ===' . PHP_EOL;
\$hidreamPrompt = \$adapter->adaptPrompt(\$fullPrompt, 'hidream');
echo \$hidreamPrompt . PHP_EOL;
echo 'Token count: ' . \$adapter->countTokens(\$hidreamPrompt) . PHP_EOL;
"

# Verify ImageGenerationService integration
grep -A5 "adaptPrompt" modules/AppVideoWizard/app/Services/ImageGenerationService.php | head -20
```
</verification>

<success_criteria>
1. ImageGenerationService calls adaptPrompt() before model dispatch
2. HiDream model receives prompts under 77 tokens
3. NanoBanana/Pro models receive full prompts unchanged
4. Prompts include camera psychology ("85mm creates intimacy")
5. Prompts include Kelvin values ("5600K daylight")
6. Prompts include framing ("40% of frame, left third")
7. All integration tests pass
8. Logs show adaptation stats (originalTokens, adaptedTokens, wasCompressed)
</success_criteria>

<output>
After completion, create `.planning/phases/22-foundation-model-adapters/22-03-SUMMARY.md`
</output>
