---
phase: 12-shot-reverse-shot-patterns
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - modules/AppVideoWizard/app/Livewire/VideoWizard.php
autonomous: true

must_haves:
  truths:
    - "Two-character dialogue alternates Character A -> Character B -> A -> B in generated shots"
    - "Each shot shows exactly one speaking character (validated before generation)"
    - "Camera stays on same side of action axis throughout scene"
    - "Validation runs in decomposeSceneWithDynamicEngine flow"
  artifacts:
    - path: "modules/AppVideoWizard/app/Livewire/VideoWizard.php"
      provides: "Shot/reverse-shot validation integration in main flow"
      contains: "validateShotReversePatternQuality"
  key_links:
    - from: "VideoWizard::decomposeSceneWithDynamicEngine"
      to: "validateShotReversePatternQuality"
      via: "method call after convertDialogueShotsToStandardFormat"
      pattern: "validateShotReversePatternQuality"
---

<objective>
Integrate shot/reverse-shot validation into VideoWizard's main scene decomposition flow and add quality checks.

Purpose: Plan 12-01 added validation methods to DialogueSceneDecomposerService. This plan integrates those validators into VideoWizard's scene decomposition flow and adds a quality summary method that reports shot/reverse-shot pattern health.

Output: Shot/reverse-shot patterns validated in the main VideoWizard flow with quality reporting.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-shot-reverse-shot-patterns/12-RESEARCH.md
@.planning/phases/12-shot-reverse-shot-patterns/12-01-PLAN.md
@modules/AppVideoWizard/app/Livewire/VideoWizard.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Shot/Reverse-Shot Quality Validation Method</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Add `validateShotReversePatternQuality(array $shots, int $sceneIndex): array` method in the shot decomposition section (near line 18100, after decomposeSceneWithDynamicEngine helper methods).

The method should:
1. Filter to dialogue shots (those with speakingCharacter)
2. If < 2 dialogue shots, return early (not a dialogue scene)
3. Check shot/reverse-shot coverage:
   - Count unique speakers
   - Count paired shots (those with spatial.pairId)
   - Calculate pairing ratio (paired / total dialogue shots)
4. Check 180-degree compliance:
   - Verify all dialogue shots have spatial.cameraPosition
   - Verify all shots have same cameraPosition value
5. Check single-character compliance:
   - Verify no shot has charactersInShot.length > 1
6. Return quality summary array:
```php
[
    'sceneIndex' => $sceneIndex,
    'totalShots' => count($shots),
    'dialogueShots' => count($dialogueShots),
    'uniqueSpeakers' => count($uniqueSpeakers),
    'pairedShots' => $pairedCount,
    'pairingRatio' => round($pairedCount / max(1, count($dialogueShots)), 2),
    'axisConsistent' => $axisConsistent,
    'singleCharacterCompliant' => $singleCharCompliant,
    'quality' => ($pairingRatio > 0.5 && $axisConsistent && $singleCharCompliant) ? 'good' : 'needs-review',
]
```
7. Log the quality summary

PHPDoc:
```php
/**
 * PHASE 12: Validate shot/reverse-shot pattern quality for a scene.
 * Checks pairing ratio, 180-degree axis consistency, and single-character compliance.
 *
 * @param array $shots Shots to validate
 * @param int $sceneIndex Scene index for logging
 * @return array Quality assessment summary
 */
```
  </action>
  <verify>Method exists. Grep for "validateShotReversePatternQuality" in file.</verify>
  <done>validateShotReversePatternQuality() method added with comprehensive quality checks.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate Validation into Scene Decomposition Flow</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Integrate the validation into `decomposeSceneWithDynamicEngine()` at two points:

1. **Speech-driven path** (around line 18030, after `$shots = $this->convertDialogueShotsToStandardFormat(...)`):
```php
// Phase 12: Validate shot/reverse-shot pattern quality
$patternQuality = $this->validateShotReversePatternQuality($shots, $sceneIndex);
if ($patternQuality['quality'] === 'needs-review') {
    Log::warning('VideoWizard: Shot/reverse-shot pattern needs review', $patternQuality);
}
```

2. **Fallback dialogue path** (around line 18070, after the fallback `$shots = $this->convertDialogueShotsToStandardFormat(...)`):
```php
// Phase 12: Validate shot/reverse-shot pattern quality (fallback path)
$patternQuality = $this->validateShotReversePatternQuality($shots, $sceneIndex);
if ($patternQuality['quality'] === 'needs-review') {
    Log::warning('VideoWizard: Shot/reverse-shot pattern needs review (fallback)', $patternQuality);
}
```

This ensures both the speech-driven PRIMARY path and exchange-based FALLBACK path run validation.
  </action>
  <verify>Grep for "validateShotReversePatternQuality" calls in decomposeSceneWithDynamicEngine.</verify>
  <done>Validation integrated into both speech-driven and fallback dialogue decomposition paths.</done>
</task>

<task type="auto">
  <name>Task 3: Add Shot Sequence Validation Logging</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Add enhanced logging to show the shot/reverse-shot sequence for debugging.

Add `logShotReverseSequence(array $shots, int $sceneIndex): void` method near validateShotReversePatternQuality:

The method should:
1. Build a sequence string showing speaker alternation: "A -> B -> A -> B" or "Marcus -> Sarah -> Marcus"
2. Show shot types in sequence: "medium -> ots -> close-up -> ots"
3. Show pair IDs if present: "pair_0, pair_0, pair_1, pair_1"
4. Log as debug-level (not info) to avoid noise

PHPDoc:
```php
/**
 * PHASE 12: Log shot/reverse-shot sequence for debugging.
 * Shows speaker alternation, shot types, and pair IDs.
 *
 * @param array $shots Shots to log
 * @param int $sceneIndex Scene index
 * @return void
 */
```

Call this method at the end of validateShotReversePatternQuality():
```php
// Log sequence for debugging
if (config('app.debug')) {
    $this->logShotReverseSequence($shots, $sceneIndex);
}
```
  </action>
  <verify>Method exists. Grep for "logShotReverseSequence" in file.</verify>
  <done>Debug logging method added and called from quality validation.</done>
</task>

</tasks>

<verification>
After all tasks:
1. VideoWizard has 2 new methods:
   - `validateShotReversePatternQuality(array $shots, int $sceneIndex): array`
   - `logShotReverseSequence(array $shots, int $sceneIndex): void`
2. Validation called in both speech-driven and fallback dialogue paths
3. Quality summary logged with pairing ratio, axis consistency, single-character compliance
4. No syntax errors: `php -l modules/AppVideoWizard/app/Livewire/VideoWizard.php`
</verification>

<success_criteria>
- FLOW-01 verified: Shot/reverse-shot pairing ratio tracked and logged
- FLOW-02 verified: Single-character compliance checked in quality summary
- FLOW-04 verified: Speaker alternation sequence logged for debugging
- SCNE-04 verified: 180-degree axis consistency checked in quality summary
- Both PRIMARY (speech-driven) and FALLBACK (exchange-based) paths run validation
</success_criteria>

<output>
After completion, create `.planning/phases/12-shot-reverse-shot-patterns/12-02-SUMMARY.md`
</output>
