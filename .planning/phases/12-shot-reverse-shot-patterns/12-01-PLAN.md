---
phase: 12-shot-reverse-shot-patterns
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php
autonomous: true

must_haves:
  truths:
    - "180-degree rule violations are detected and logged"
    - "Single-character constraint violations are detected and fixed"
    - "Character alternation issues are detected and reported"
    - "Each dialogue shot shows exactly one character (FLOW-02)"
  artifacts:
    - path: "modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php"
      provides: "Shot/reverse-shot validation methods"
      exports: ["validate180DegreeRule", "enforceSingleCharacterConstraint", "validateCharacterAlternation"]
  key_links:
    - from: "DialogueSceneDecomposerService::enhanceShotsWithDialoguePatterns"
      to: "validation methods"
      via: "method calls after pairReverseShots()"
      pattern: "validate180DegreeRule|enforceSingleCharacterConstraint"
---

<objective>
Add validation and enforcement methods to DialogueSceneDecomposerService for shot/reverse-shot patterns.

Purpose: Phase 11 created shots from speech segments (1:1) and enhanceShotsWithDialoguePatterns() already calls calculateSpatialData() and pairReverseShots(). This plan adds VALIDATION to ensure the patterns are correctly applied: 180-degree rule compliance, single-character constraint enforcement, and character alternation checks.

Output: Three validation methods in DialogueSceneDecomposerService that ensure Hollywood-standard shot/reverse-shot quality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-shot-reverse-shot-patterns/12-RESEARCH.md
@.planning/phases/11-speech-driven-shot-creation/11-01-SUMMARY.md
@modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 180-Degree Rule Validation</name>
  <files>modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php</files>
  <action>
Add `validate180DegreeRule(array $shots): array` method after `pairReverseShots()` (around line 580).

The method should:
1. Filter to dialogue shots only (those with speakingCharacter)
2. Track camera position from first shot - must stay consistent (always 'left' per $this->axisLockSide)
3. Check consecutive shots from different speakers have OPPOSITE eyeLineDirection (A=screen-left, B=screen-right)
4. Log violations with scene context
5. Return array of violation details (for debugging, not blocking)

Key checks:
- `$spatial['cameraPosition']` must equal `$this->axisLockSide` for all shots
- When `shots[i].speaker !== shots[i-1].speaker`, their `eyeLineDirection` must differ
- If both characters look same direction, that's an axis jump violation

Use existing patterns from research (lines 239-280 in RESEARCH.md).

PHPDoc:
```php
/**
 * PHASE 12: Validate 180-degree rule compliance across dialogue sequence.
 * Camera must stay on same side of axis; eyelines must oppose between speakers.
 *
 * @param array $shots Shots with spatial data
 * @return array Array of violations (empty if compliant)
 */
```
  </action>
  <verify>Method exists and has correct signature. Grep for "validate180DegreeRule" in file.</verify>
  <done>validate180DegreeRule() method added, checks camera position consistency and eyeline opposition.</done>
</task>

<task type="auto">
  <name>Task 2: Add Single-Character Constraint Enforcement</name>
  <files>modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php</files>
  <action>
Add `enforceSingleCharacterConstraint(array $shots): array` method after validate180DegreeRule().

The method should:
1. Loop through all shots
2. Check if shot type is 'two-shot' or 'establishing' with multiple charactersInShot
3. Convert to single-character 'wide' shot (keep only first character)
4. For 'over-the-shoulder' shots: ensure charactersInShot contains ONLY the focus character (listener is partial/blurred)
5. Add `otsData['foregroundVisible'] = 'shoulder and partial head'` and `otsData['foregroundBlur'] = true`
6. Log conversions for debugging
7. Return modified shots array

This enforces FLOW-02: "Single character visible per shot (model constraint enforced)" - the image generation model cannot render multiple characters reliably.

Use patterns from research (lines 329-363 in RESEARCH.md).

PHPDoc:
```php
/**
 * PHASE 12: Enforce single character per shot constraint (FLOW-02).
 * Image generation model cannot reliably render multiple characters.
 * Converts two-shots to wide shots; ensures OTS shows only focus character.
 *
 * @param array $shots Shots to enforce constraint on
 * @return array Modified shots with single-character constraint applied
 */
```
  </action>
  <verify>Method exists. Grep for "enforceSingleCharacterConstraint" in file.</verify>
  <done>enforceSingleCharacterConstraint() method added, converts multi-character shots to single-character.</done>
</task>

<task type="auto">
  <name>Task 3: Add Character Alternation Validation and Integrate All Validators</name>
  <files>modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php</files>
  <action>
1. Add `validateCharacterAlternation(array $shots): array` method after enforceSingleCharacterConstraint().

The method should:
- Track consecutive shots from same speaker
- If same speaker has 3+ consecutive shots, log warning suggesting reaction shot insertion
- Return array of issues (speaker, shot indices, count)
- Non-speaking shots (reaction, narrator) reset the consecutive counter

PHPDoc:
```php
/**
 * PHASE 12: Validate character alternation in dialogue sequences (FLOW-04).
 * Flags consecutive shots from same speaker as potential coverage issue.
 *
 * @param array $shots Shots to validate
 * @return array Array of alternation issues
 */
```

2. Integrate all three methods into `enhanceShotsWithDialoguePatterns()` (around line 1776-1787):

After `$shots = $this->pairReverseShots($shots);` (line 1776), add:

```php
// Phase 12: Enforce single-character constraint (FLOW-02)
$shots = $this->enforceSingleCharacterConstraint($shots);

// Phase 12: Validate 180-degree rule (SCNE-04)
$axisViolations = $this->validate180DegreeRule($shots);
if (!empty($axisViolations)) {
    Log::warning('DialogueSceneDecomposer: 180-degree rule violations', [
        'violations' => $axisViolations,
    ]);
}

// Phase 12: Validate character alternation (FLOW-04)
$alternationIssues = $this->validateCharacterAlternation($shots);
if (!empty($alternationIssues)) {
    Log::info('DialogueSceneDecomposer: Character alternation notes', [
        'issues' => $alternationIssues,
    ]);
}
```
  </action>
  <verify>All three methods integrated. Run: `grep -n "enforceSingleCharacterConstraint\|validate180DegreeRule\|validateCharacterAlternation" modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php`</verify>
  <done>All validation methods added and integrated into enhanceShotsWithDialoguePatterns() flow.</done>
</task>

</tasks>

<verification>
After all tasks:
1. DialogueSceneDecomposerService has 3 new methods:
   - `validate180DegreeRule(array $shots): array`
   - `enforceSingleCharacterConstraint(array $shots): array`
   - `validateCharacterAlternation(array $shots): array`
2. `enhanceShotsWithDialoguePatterns()` calls all three methods after `pairReverseShots()`
3. No syntax errors: `php -l modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php`
</verification>

<success_criteria>
- FLOW-02 enforced: Two-shots converted to single-character wide shots
- SCNE-04 validated: 180-degree rule violations logged
- FLOW-04 validated: Character alternation issues logged
- All methods integrated into speech-driven shot enhancement pipeline
</success_criteria>

<output>
After completion, create `.planning/phases/12-shot-reverse-shot-patterns/12-01-SUMMARY.md`
</output>
