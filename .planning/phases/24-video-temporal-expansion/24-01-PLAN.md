---
phase: 24-video-temporal-expansion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/AppVideoWizard/app/Services/VideoTemporalService.php
  - modules/AppVideoWizard/app/Services/MicroMovementService.php
  - tests/Unit/VideoWizard/VideoTemporalServiceTest.php
  - tests/Unit/VideoWizard/MicroMovementServiceTest.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Video prompts contain temporal beats with time ranges"
    - "Simple actions get 2-3 second beats, complex actions get 4-5 seconds"
    - "Micro-movements match shot type (face for close-up, body for wide)"
    - "Breathing vocabulary includes subtle, heavy, and held states"
  artifacts:
    - path: "modules/AppVideoWizard/app/Services/VideoTemporalService.php"
      provides: "Temporal beat structuring with timing markers"
      exports: ["buildTemporalBeats", "validateBeatsForDuration", "TEMPORAL_BEAT_GUIDELINES"]
    - path: "modules/AppVideoWizard/app/Services/MicroMovementService.php"
      provides: "Breathing, eye, head, hand micro-movement vocabulary"
      exports: ["buildMicroMovementLayer", "getMicroMovementsForShotType", "MICRO_MOVEMENT_LIBRARY"]
  key_links:
    - from: "VideoTemporalService"
      to: "TEMPORAL_BEAT_GUIDELINES"
      via: "buildTemporalBeats uses guidelines for duration validation"
      pattern: "self::TEMPORAL_BEAT_GUIDELINES"
    - from: "MicroMovementService"
      to: "shot type parameter"
      via: "getMicroMovementsForShotType filters by shot scale"
      pattern: "close-up|medium|wide"
---

<objective>
Create VideoTemporalService for beat-by-beat timing and MicroMovementService for subtle life motion vocabulary.

Purpose: VID-02 (temporal progression) and VID-06 (micro-movements) require dedicated services for structuring time-based actions and adding breathing/blinking to prevent "statue" effect in video generation.

Output: Two new services with constants and methods for temporal beat structuring and micro-movement vocabulary, with unit tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-video-temporal-expansion/24-RESEARCH.md

# Source for patterns
@modules/AppVideoWizard/app/Services/VideoPromptBuilderService.php (MOTION_INTENSITY pattern)
@modules/AppVideoWizard/app/Services/CharacterPsychologyService.php (EMOTION_MANIFESTATIONS pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VideoTemporalService</name>
  <files>
    modules/AppVideoWizard/app/Services/VideoTemporalService.php
    tests/Unit/VideoWizard/VideoTemporalServiceTest.php
  </files>
  <action>
Create VideoTemporalService with temporal beat structuring.

Constants to define:
```php
const TEMPORAL_BEAT_GUIDELINES = [
    'simple_action' => ['min_duration' => 2, 'max_duration' => 3, 'examples' => ['turn head', 'blink', 'nod']],
    'complex_motion' => ['min_duration' => 4, 'max_duration' => 5, 'examples' => ['walk across', 'sit down', 'gesture']],
    'emotional_beat' => ['min_duration' => 3, 'max_duration' => 4, 'examples' => ['realization', 'recognition', 'reaction']],
    'camera_movement' => ['min_duration' => 3, 'max_duration' => 8, 'examples' => ['dolly in', 'pan across', 'crane up']],
];

const MAX_ACTIONS_PER_DURATION = [
    5 => 2,   // 5 seconds: max 2 actions
    10 => 4,  // 10 seconds: max 4 actions
    15 => 5,  // 15 seconds: max 5 actions
];
```

Methods to implement:
1. `buildTemporalBeats(array $beats, int $totalDuration): string` - Takes array of ['action' => string, 'duration' => int] and formats as `[00:00-00:02] action. [00:02-00:05] next action.`
2. `validateBeatsForDuration(array $beats, int $totalDuration): array` - Returns ['valid' => bool, 'warnings' => array] if too many actions or durations don't fit
3. `suggestBeatDuration(string $actionType): int` - Returns recommended duration for action type
4. `formatTimeRange(int $startSeconds, int $endSeconds): string` - Returns `00:00-00:03` format

Unit tests (5 tests):
- testBuildTemporalBeatsFormatsCorrectly
- testValidateBeatsRejectsOverpackedClip
- testSuggestBeatDurationReturnsCorrectValues
- testBeatsDontExceedTotalDuration
- testFormatTimeRangeHandlesMinutesCorrectly

Follow CharacterPsychologyService pattern for constants structure.
  </action>
  <verify>
    grep -q "TEMPORAL_BEAT_GUIDELINES" modules/AppVideoWizard/app/Services/VideoTemporalService.php
    grep -q "buildTemporalBeats" modules/AppVideoWizard/app/Services/VideoTemporalService.php
    grep -q "class VideoTemporalServiceTest" tests/Unit/VideoWizard/VideoTemporalServiceTest.php
  </verify>
  <done>VideoTemporalService exists with TEMPORAL_BEAT_GUIDELINES constant and buildTemporalBeats method. Tests exist covering beat formatting and validation.</done>
</task>

<task type="auto">
  <name>Task 2: Create MicroMovementService</name>
  <files>
    modules/AppVideoWizard/app/Services/MicroMovementService.php
    tests/Unit/VideoWizard/MicroMovementServiceTest.php
  </files>
  <action>
Create MicroMovementService with micro-movement vocabulary for subtle life motion.

Constants to define (from research):
```php
const MICRO_MOVEMENT_LIBRARY = [
    'breathing' => [
        'subtle' => 'gentle chest rise and fall with natural breathing rhythm',
        'heavy' => 'deep visible breaths, shoulders rising and falling',
        'held' => 'breath held, chest still, tension visible in shoulders',
    ],
    'eyes' => [
        'natural' => 'natural blink pattern, eyes alive with micro-movements',
        'focused' => 'unblinking focused gaze, slight eye narrowing',
        'shifting' => 'eyes dart briefly to sides, returning to center',
        'softening' => 'eyes soften, gaze becomes warm and open',
    ],
    'head' => [
        'settle' => 'subtle head settling, micro-adjustments of position',
        'tilt' => 'slight head tilt indicating thought or curiosity',
        'nod' => 'almost imperceptible nod of acknowledgment',
        'turn' => 'gentle head turn toward point of interest',
    ],
    'hands' => [
        'fidget' => 'fingers tap lightly, hands shift position',
        'grip' => 'fingers tighten slightly on held object',
        'release' => 'hands gradually relax, fingers uncurl',
        'reach' => 'hand moves subtly toward another person',
    ],
];

const SHOT_TYPE_MICRO_MAPPING = [
    'extreme-close-up' => ['eyes', 'breathing'],
    'close-up' => ['eyes', 'breathing', 'head'],
    'medium-close-up' => ['breathing', 'head', 'hands'],
    'medium-shot' => ['breathing', 'hands'],
    'medium-wide-shot' => ['hands'],
    'wide-shot' => [],  // No visible micro-movements at this scale
    'extreme-wide-shot' => [],
];
```

Methods to implement:
1. `buildMicroMovementLayer(string $shotType, string $emotion, array $options = []): string` - Returns micro-movement prompt section appropriate for shot type
2. `getMicroMovementsForShotType(string $shotType): array` - Returns applicable micro-movement categories for shot scale
3. `selectMicroMovementVariant(string $category, string $emotion): string` - Selects appropriate variant (e.g., 'breathing' + 'tense' = 'held')

Add emotion-to-variant mapping:
```php
const EMOTION_MICRO_VARIANTS = [
    'tense' => ['breathing' => 'held', 'eyes' => 'focused', 'hands' => 'grip'],
    'relaxed' => ['breathing' => 'subtle', 'eyes' => 'natural', 'hands' => 'release'],
    'anxious' => ['breathing' => 'heavy', 'eyes' => 'shifting', 'hands' => 'fidget'],
    // ... etc
];
```

Unit tests (5 tests):
- testBuildMicroMovementLayerForCloseUp
- testBuildMicroMovementLayerForWideShot (should be empty/minimal)
- testGetMicroMovementsForShotTypeReturnsCorrectCategories
- testSelectMicroMovementVariantMatchesEmotion
- testMicroMovementLayerIncludesBreathingForMediumShots

Follow VideoPromptBuilderService pattern for emotion-based selection.
  </action>
  <verify>
    grep -q "MICRO_MOVEMENT_LIBRARY" modules/AppVideoWizard/app/Services/MicroMovementService.php
    grep -q "buildMicroMovementLayer" modules/AppVideoWizard/app/Services/MicroMovementService.php
    grep -q "SHOT_TYPE_MICRO_MAPPING" modules/AppVideoWizard/app/Services/MicroMovementService.php
    grep -q "class MicroMovementServiceTest" tests/Unit/VideoWizard/MicroMovementServiceTest.php
  </verify>
  <done>MicroMovementService exists with MICRO_MOVEMENT_LIBRARY, SHOT_TYPE_MICRO_MAPPING constants and buildMicroMovementLayer method. Tests verify shot-type-appropriate micro-movement selection.</done>
</task>

</tasks>

<verification>
1. VideoTemporalService.php exists with TEMPORAL_BEAT_GUIDELINES, buildTemporalBeats, validateBeatsForDuration methods
2. MicroMovementService.php exists with MICRO_MOVEMENT_LIBRARY, SHOT_TYPE_MICRO_MAPPING, buildMicroMovementLayer methods
3. Both services have unit tests
4. Constants follow established pattern from CharacterPsychologyService (nested arrays with descriptive keys)
5. No external dependencies added - pure PHP vocabulary/logic services
</verification>

<success_criteria>
- VideoTemporalService can format beats as `[00:00-00:02] action. [00:02-00:05] next action.`
- VideoTemporalService validates beat count against MAX_ACTIONS_PER_DURATION
- MicroMovementService returns appropriate micro-movements for shot type (close-up gets eyes+breathing, wide gets nothing)
- MicroMovementService selects emotion-appropriate variants (tense = held breath, anxious = heavy breath)
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/24-video-temporal-expansion/24-01-SUMMARY.md`
</output>
