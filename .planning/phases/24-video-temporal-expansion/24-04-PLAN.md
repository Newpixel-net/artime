---
phase: 24-video-temporal-expansion
plan: 04
type: execute
wave: 2
depends_on: ["24-01", "24-02", "24-03"]
files_modified:
  - modules/AppVideoWizard/app/Services/VideoPromptBuilderService.php
  - tests/Feature/VideoWizard/VideoTemporalIntegrationTest.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Video prompts contain all image prompt features (camera, lighting, psychology)"
    - "Video prompts contain temporal beat structure with timing"
    - "Video prompts contain camera movement with duration and psychology"
    - "Multi-character video prompts contain spatial dynamics"
    - "Close-up video shots include micro-movements"
    - "Video prompts include transition setup information"
  artifacts:
    - path: "modules/AppVideoWizard/app/Services/VideoPromptBuilderService.php"
      provides: "Complete video prompt with temporal layer"
      exports: ["buildTemporalVideoPrompt"]
    - path: "tests/Feature/VideoWizard/VideoTemporalIntegrationTest.php"
      provides: "Integration tests for video temporal features"
      min_lines: 200
  key_links:
    - from: "VideoPromptBuilderService"
      to: "VideoTemporalService"
      via: "buildTemporalVideoPrompt calls buildTemporalBeats"
      pattern: "videoTemporalService->buildTemporalBeats"
    - from: "VideoPromptBuilderService"
      to: "MicroMovementService"
      via: "buildTemporalVideoPrompt calls buildMicroMovementLayer for close-ups"
      pattern: "microMovementService->buildMicroMovementLayer"
    - from: "VideoPromptBuilderService"
      to: "CharacterDynamicsService"
      via: "buildTemporalVideoPrompt calls buildSpatialDynamics for multi-character"
      pattern: "characterDynamicsService->buildSpatialDynamics"
    - from: "VideoPromptBuilderService"
      to: "TransitionVocabulary"
      via: "buildTemporalVideoPrompt calls buildTransitionSetup"
      pattern: "transitionVocabulary->buildTransitionSetup"
    - from: "VideoPromptBuilderService"
      to: "CameraMovementService"
      via: "buildTemporalVideoPrompt calls buildTemporalMovementPrompt"
      pattern: "cameraMovementService->buildTemporalMovementPrompt"
---

<objective>
Integrate all Phase 24 temporal services into VideoPromptBuilderService to create complete Hollywood-quality video prompts.

Purpose: VID-01 (video prompts include all image features) requires integrating temporal beats, micro-movements, character dynamics, camera psychology, and transition vocabulary into a unified video prompt builder. This is the capstone plan that ties together Plans 01-03.

Output: Extended VideoPromptBuilderService with buildTemporalVideoPrompt method and comprehensive integration tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-video-temporal-expansion/24-RESEARCH.md

# Previous plan summaries
@.planning/phases/24-video-temporal-expansion/24-01-SUMMARY.md
@.planning/phases/24-video-temporal-expansion/24-02-SUMMARY.md
@.planning/phases/24-video-temporal-expansion/24-03-SUMMARY.md

# Services to integrate
@modules/AppVideoWizard/app/Services/VideoPromptBuilderService.php (existing)
@modules/AppVideoWizard/app/Services/VideoTemporalService.php (from 24-01)
@modules/AppVideoWizard/app/Services/MicroMovementService.php (from 24-01)
@modules/AppVideoWizard/app/Services/CharacterDynamicsService.php (from 24-02)
@modules/AppVideoWizard/app/Services/CharacterPathService.php (from 24-02)
@modules/AppVideoWizard/app/Services/TransitionVocabulary.php (from 24-03)

# Pattern reference
@modules/AppVideoWizard/app/Services/StructuredPromptBuilderService.php (psychology layer integration pattern from Phase 23)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Service Dependencies to VideoPromptBuilderService</name>
  <files>
    modules/AppVideoWizard/app/Services/VideoPromptBuilderService.php
  </files>
  <action>
Add imports and constructor injection for all Phase 24 services.

Add imports at top of file:
```php
use Modules\AppVideoWizard\Services\VideoTemporalService;
use Modules\AppVideoWizard\Services\MicroMovementService;
use Modules\AppVideoWizard\Services\CharacterDynamicsService;
use Modules\AppVideoWizard\Services\CharacterPathService;
use Modules\AppVideoWizard\Services\TransitionVocabulary;
```

Add protected properties:
```php
protected VideoTemporalService $videoTemporalService;
protected MicroMovementService $microMovementService;
protected CharacterDynamicsService $characterDynamicsService;
protected CharacterPathService $characterPathService;
protected TransitionVocabulary $transitionVocabulary;
```

Update constructor to inject new services:
```php
public function __construct(
    CameraMovementService $cameraMovementService,
    VideoTemporalService $videoTemporalService,
    MicroMovementService $microMovementService,
    CharacterDynamicsService $characterDynamicsService,
    CharacterPathService $characterPathService,
    TransitionVocabulary $transitionVocabulary
) {
    $this->cameraMovementService = $cameraMovementService;
    $this->videoTemporalService = $videoTemporalService;
    $this->microMovementService = $microMovementService;
    $this->characterDynamicsService = $characterDynamicsService;
    $this->characterPathService = $characterPathService;
    $this->transitionVocabulary = $transitionVocabulary;
}
```

DO NOT modify existing buildPrompt or buildHollywoodPrompt methods - we're adding a new method.
  </action>
  <verify>
    grep -q "use Modules\\\\AppVideoWizard\\\\Services\\\\VideoTemporalService" modules/AppVideoWizard/app/Services/VideoPromptBuilderService.php
    grep -q "use Modules\\\\AppVideoWizard\\\\Services\\\\MicroMovementService" modules/AppVideoWizard/app/Services/VideoPromptBuilderService.php
    grep -q "protected VideoTemporalService" modules/AppVideoWizard/app/Services/VideoPromptBuilderService.php
    grep -q "protected MicroMovementService" modules/AppVideoWizard/app/Services/VideoPromptBuilderService.php
  </verify>
  <done>VideoPromptBuilderService imports and injects all Phase 24 services (VideoTemporalService, MicroMovementService, CharacterDynamicsService, CharacterPathService, TransitionVocabulary).</done>
</task>

<task type="auto">
  <name>Task 2: Implement buildTemporalVideoPrompt Method</name>
  <files>
    modules/AppVideoWizard/app/Services/VideoPromptBuilderService.php
  </files>
  <action>
Add new buildTemporalVideoPrompt method that assembles complete video prompt with all temporal layers.

Method signature and docblock:
```php
/**
 * Build complete Hollywood-quality video prompt with temporal structure.
 * Implements VID-01 through VID-07 requirements.
 *
 * @param array $shot Shot data (type, duration, characters, action, emotion, etc.)
 * @param array $context Scene context (genre, mood, lighting, timeOfDay, etc.)
 * @param array $storyBibleContext Optional Story Bible data
 * @param array $temporalBeats Optional pre-defined temporal beats
 * @return array Complete prompt with components and metadata
 */
public function buildTemporalVideoPrompt(
    array $shot,
    array $context = [],
    array $storyBibleContext = [],
    array $temporalBeats = []
): array
```

Implementation structure:
1. **Start with base Hollywood prompt** (inherits all image features - VID-01)
   - Call existing buildHollywoodPrompt() to get base components
   - This gives us camera specs, lighting, subject, style from Phase 22-23

2. **Add temporal beat structure** (VID-02)
   - If temporalBeats provided, use videoTemporalService->buildTemporalBeats()
   - If not provided, auto-generate beats from shot action and duration
   - Validate beats don't exceed duration

3. **Enhance camera movement with duration and psychology** (VID-03)
   - Get movement from shot or context
   - Use cameraMovementService->buildTemporalMovementPrompt() instead of basic buildMovementPrompt
   - Match psychology to shot emotion

4. **Add character path description** (VID-04)
   - If shot has 'characterPath' or 'movement_intent', use characterPathService->buildCharacterPath()
   - Combine with camera movement coherently

5. **Add multi-character dynamics** (VID-05)
   - If shot has multiple characters, use characterDynamicsService->buildSpatialDynamics()
   - Determine relationship and proximity from context or defaults

6. **Add micro-movements** (VID-06)
   - Use microMovementService->buildMicroMovementLayer() with shot type
   - Only for close-up and medium shots (service handles filtering)

7. **Add transition setup** (VID-07)
   - Use transitionVocabulary->buildTransitionSetup() based on shot mood/intent
   - Include in metadata, not main prompt (editorial info)

Return structure:
```php
return [
    'success' => true,
    'prompt' => $fullPrompt,
    'components' => [
        // All base components from buildHollywoodPrompt
        'temporal_beats' => $temporalBeatsString,
        'camera_psychology' => $cameraWithPsychology,
        'character_path' => $characterPathString,
        'character_dynamics' => $dynamicsString,
        'micro_movements' => $microMovementsString,
    ],
    'transition_setup' => [
        'ending_state' => $endingState,
        'next_shot_suggestion' => $nextShotSuggestion,
    ],
    'metadata' => [
        // Base metadata plus:
        'temporal_structure' => true,
        'beat_count' => count($temporalBeats),
        'has_multi_character' => $isMultiCharacter,
        'has_micro_movements' => !empty($microMovementsString),
    ],
];
```

Prompt assembly order (natural reading):
1. Camera shot and movement (with duration/psychology)
2. Subject and character dynamics (if multi-character)
3. Temporal beats (action sequence with timing)
4. Micro-movements (for close-ups)
5. Environment and lighting (from base)
6. Style (from base)
  </action>
  <verify>
    grep -q "buildTemporalVideoPrompt" modules/AppVideoWizard/app/Services/VideoPromptBuilderService.php
    grep -q "videoTemporalService->buildTemporalBeats" modules/AppVideoWizard/app/Services/VideoPromptBuilderService.php
    grep -q "microMovementService->buildMicroMovementLayer" modules/AppVideoWizard/app/Services/VideoPromptBuilderService.php
    grep -q "characterDynamicsService->buildSpatialDynamics" modules/AppVideoWizard/app/Services/VideoPromptBuilderService.php
    grep -q "transitionVocabulary->buildTransitionSetup" modules/AppVideoWizard/app/Services/VideoPromptBuilderService.php
    grep -q "cameraMovementService->buildTemporalMovementPrompt" modules/AppVideoWizard/app/Services/VideoPromptBuilderService.php
  </verify>
  <done>VideoPromptBuilderService has buildTemporalVideoPrompt method that integrates all temporal services (VideoTemporalService, MicroMovementService, CharacterDynamicsService, CharacterPathService, TransitionVocabulary, CameraMovementService temporal extension).</done>
</task>

<task type="auto">
  <name>Task 3: Create Integration Tests</name>
  <files>
    tests/Feature/VideoWizard/VideoTemporalIntegrationTest.php
  </files>
  <action>
Create comprehensive integration tests for video temporal features.

Test class structure:
```php
namespace Tests\Feature\VideoWizard;

use Tests\TestCase;
use Modules\AppVideoWizard\Services\VideoPromptBuilderService;
// ... other imports

class VideoTemporalIntegrationTest extends TestCase
{
    protected VideoPromptBuilderService $service;

    protected function setUp(): void
    {
        parent::setUp();
        $this->service = app(VideoPromptBuilderService::class);
    }
    // ... tests
}
```

Tests to implement (12 tests covering all VID requirements):

**VID-01: All image features present**
1. `testTemporalVideoPromptIncludesCameraSpecs` - Verify lens, framing from base prompt
2. `testTemporalVideoPromptIncludesLighting` - Verify lighting vocabulary present

**VID-02: Temporal progression**
3. `testTemporalVideoPromptIncludesTimingBeats` - Check for `[00:00-00:02]` format
4. `testTemporalBeatsRespectDuration` - Beats don't exceed shot duration

**VID-03: Camera movement with duration and psychology**
5. `testCameraMovementIncludesDuration` - Check for "over X seconds" in prompt
6. `testCameraMovementIncludesPsychology` - Check for psychology phrase ("creating intimacy")

**VID-04: Character movement paths**
7. `testCharacterPathDescriptionIncluded` - When movement_intent provided, path appears

**VID-05: Multi-character dynamics**
8. `testMultiCharacterShotIncludesProximity` - Check for proxemic zone description
9. `testMultiCharacterShotIncludesPowerDynamics` - Check for positioning description

**VID-06: Micro-movements**
10. `testCloseUpIncludesMicroMovements` - Close-up shot has breathing/eyes
11. `testWideShortOmitsMicroMovements` - Wide shot doesn't have invisible micro-details

**VID-07: Transition suggestions**
12. `testTransitionSetupInMetadata` - transition_setup key has ending_state and next_shot_suggestion

Test data fixtures:
```php
protected function getCloseUpShot(): array
{
    return [
        'type' => 'close-up',
        'duration' => 6,
        'characters' => ['Elena'],
        'emotion' => 'tense',
        'subjectAction' => 'realizes the truth',
        'cameraMovement' => 'dolly-in',
    ];
}

protected function getMultiCharacterShot(): array
{
    return [
        'type' => 'two-shot',
        'duration' => 8,
        'characters' => ['Marcus', 'Elena'],
        'emotion' => 'conflict',
        'subjectAction' => 'confrontation',
        'relationship' => 'conflict',
        'proximity' => 'personal',
    ];
}
```
  </action>
  <verify>
    grep -q "class VideoTemporalIntegrationTest" tests/Feature/VideoWizard/VideoTemporalIntegrationTest.php
    grep -q "testTemporalVideoPromptIncludesTimingBeats" tests/Feature/VideoWizard/VideoTemporalIntegrationTest.php
    grep -q "testCameraMovementIncludesDuration" tests/Feature/VideoWizard/VideoTemporalIntegrationTest.php
    grep -q "testMultiCharacterShotIncludesProximity" tests/Feature/VideoWizard/VideoTemporalIntegrationTest.php
    grep -q "testCloseUpIncludesMicroMovements" tests/Feature/VideoWizard/VideoTemporalIntegrationTest.php
    grep -q "testTransitionSetupInMetadata" tests/Feature/VideoWizard/VideoTemporalIntegrationTest.php
  </verify>
  <done>VideoTemporalIntegrationTest exists with 12 tests covering all VID-01 through VID-07 requirements. Tests verify temporal beats, camera psychology, character dynamics, micro-movements, and transition setup.</done>
</task>

</tasks>

<verification>
1. VideoPromptBuilderService imports all Phase 24 services
2. buildTemporalVideoPrompt method exists and calls all integrated services
3. Return includes 'temporal_beats', 'camera_psychology', 'character_dynamics', 'micro_movements' components
4. Return includes 'transition_setup' with ending_state and next_shot_suggestion
5. Integration tests cover all 7 VID requirements
6. Existing buildPrompt and buildHollywoodPrompt methods unchanged (backward compatible)
</verification>

<success_criteria>
- buildTemporalVideoPrompt produces prompts containing:
  - All base Hollywood prompt features (camera, lighting, style)
  - Temporal beats with `[00:00-00:02]` format timing
  - Camera movement with "over X seconds" duration and psychology phrase
  - Character path descriptions when movement_intent provided
  - Spatial dynamics for multi-character shots
  - Micro-movements for close-up/medium shots
  - Transition setup in metadata
- All 12 integration tests pass
- Existing tests still pass (backward compatibility)
</success_criteria>

<output>
After completion, create `.planning/phases/24-video-temporal-expansion/24-04-SUMMARY.md`
</output>
