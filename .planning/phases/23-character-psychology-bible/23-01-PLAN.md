---
phase: 23-character-psychology-bible
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/AppVideoWizard/app/Services/CharacterPsychologyService.php
  - tests/Unit/VideoWizard/CharacterPsychologyServiceTest.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Emotion names map to specific physical manifestations"
    - "Physical descriptions include face, eyes, body, and breath"
    - "Intensity levels produce graduated physical descriptions"
    - "Subtext layer describes what character hides vs reveals"
  artifacts:
    - path: "modules/AppVideoWizard/app/Services/CharacterPsychologyService.php"
      provides: "Emotion to physical manifestation mapping"
      exports: ["getManifestationsForEmotion", "buildSubtextLayer", "buildEmotionDescription", "buildEnhancedEmotionDescription"]
    - path: "tests/Unit/VideoWizard/CharacterPsychologyServiceTest.php"
      provides: "Unit tests for psychology service"
      contains: "test_"
  key_links:
    - from: "CharacterPsychologyService.php"
      to: "EMOTION_MANIFESTATIONS constant"
      via: "getManifestationsForEmotion uses const lookup"
      pattern: "EMOTION_MANIFESTATIONS\\["
---

<objective>
Create CharacterPsychologyService that maps emotional states to physical manifestations for image prompts.

Purpose: Enable Hollywood-quality character depiction where emotions are expressed through visible physicality (brow tension, posture, breath) rather than abstract labels ("angry"). Research confirmed image models respond to physical descriptions, NOT FACS AU codes.

Output: CharacterPsychologyService.php with emotion mappings and subtext layer builder

Future integration: This service will later integrate with Character Bible defining_features to create character-specific physical manifestations (e.g., if Bible says "distinctive scar above left eyebrow", that scar appears in expressions when relevant). Plan 04 will wire `buildEnhancedEmotionDescription($emotion, $intensity, $characterTraits = [])` to merge Bible traits into psychology output.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 22 established vocabulary infrastructure
@modules/AppVideoWizard/app/Services/CinematographyVocabulary.php

# Existing character service patterns to follow
@modules/AppVideoWizard/app/Services/CharacterLookService.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CharacterPsychologyService with emotion mappings</name>
  <files>modules/AppVideoWizard/app/Services/CharacterPsychologyService.php</files>
  <action>
Create CharacterPsychologyService with:

1. EMOTION_MANIFESTATIONS constant (similar pattern to CinematographyVocabulary):
```php
const EMOTION_MANIFESTATIONS = [
    'suppressed_anger' => [
        'face' => 'jaw muscles visibly tensed, brow lowered creating vertical crease between eyebrows',
        'eyes' => 'narrowed gaze with slight lid tension, focused intensity',
        'body' => 'shoulders rigid and raised, hands clenched at sides or gripping nearby object',
        'breath' => 'controlled shallow breathing, chest barely moving',
    ],
    'anxiety' => [
        'face' => 'micro-tension around mouth, lips pressed slightly together',
        'eyes' => 'rapid small movements, slightly widened, frequent blinking',
        'body' => 'shoulders hunched forward, fingers fidgeting or gripping armrest',
        'breath' => 'shallow and quick, visible chest movement',
    ],
    'hidden_joy' => [
        'face' => 'slight upturn at corner of lips quickly suppressed, dimple forming',
        'eyes' => 'brightening with suppressed sparkle, crow\'s feet beginning to crinkle',
        'body' => 'subtle straightening of posture, weight shifting forward',
        'breath' => 'deeper inhale, slight catch',
    ],
    'grief' => [
        'face' => 'downturned mouth corners, trembling lower lip',
        'eyes' => 'glistening with unshed tears, heavy lids, distant focus',
        'body' => 'collapsed posture, shoulders rounded inward, head bowed',
        'breath' => 'irregular, shuddering inhales',
    ],
    'forced_composure' => [
        'face' => 'deliberately neutral expression, jaw held tight',
        'eyes' => 'slightly too wide, forced steadiness',
        'body' => 'rigid upright posture, hands clasped tightly',
        'breath' => 'consciously even, controlled',
    ],
    'fear' => [
        'face' => 'pale complexion, tension around mouth and jaw',
        'eyes' => 'widened, pupils dilated, whites visible',
        'body' => 'frozen stillness or trembling, pulled back posture',
        'breath' => 'held or rapid shallow gasps',
    ],
    'contempt' => [
        'face' => 'one corner of lip raised asymmetrically, slight nostril flare',
        'eyes' => 'half-lidded, looking down or sideways',
        'body' => 'slight backward lean, chin raised',
        'breath' => 'slow, dismissive exhale through nose',
    ],
    'genuine_happiness' => [
        'face' => 'full smile reaching cheeks, laugh lines visible',
        'eyes' => 'crinkled at corners, bright and engaged',
        'body' => 'open relaxed posture, animated gestures',
        'breath' => 'deep and easy',
    ],
];
```

2. INTENSITY_MODIFIERS for subtle/moderate/intense:
```php
const INTENSITY_MODIFIERS = [
    'subtle' => ['slightly', 'barely visible', 'hint of', 'trace of'],
    'moderate' => ['noticeably', 'clearly', 'visibly', 'apparent'],
    'intense' => ['deeply', 'dramatically', 'extremely', 'pronounced'],
];
```

3. Methods:
- `getManifestationsForEmotion(string $emotion): array` - Returns face/eyes/body/breath array
- `buildEmotionDescription(string $emotion, string $intensity = 'moderate'): string` - Full physical description
- `buildEnhancedEmotionDescription(string $emotion, string $intensity = 'moderate', array $characterTraits = []): string` - Full description with character-specific traits merged in (e.g., Bible defining_features like scars, facial structure)
- `buildSubtextLayer(string $surfaceEmotion, string $trueEmotion, float $leakageLevel = 0.3): array` - Hollywood "body betrays face"

`buildEnhancedEmotionDescription` signature (for Plan 04 integration):
```php
/**
 * Build emotion description enhanced with character-specific traits from Bible
 *
 * @param string $emotion Emotion key from EMOTION_MANIFESTATIONS
 * @param string $intensity One of: subtle, moderate, intense
 * @param array $characterTraits Character-specific traits from Bible ['defining_features' => [...], 'facial_structure' => '...']
 * @return string Full physical description with character traits woven in
 */
public function buildEnhancedEmotionDescription(string $emotion, string $intensity = 'moderate', array $characterTraits = []): string
{
    $base = $this->buildEmotionDescription($emotion, $intensity);

    if (empty($characterTraits)) {
        return $base;
    }

    // Weave in defining features (scar, birthmark, etc.)
    $definingFeatures = $characterTraits['defining_features'] ?? [];
    if (!empty($definingFeatures)) {
        $features = is_array($definingFeatures) ? implode(', ', $definingFeatures) : $definingFeatures;
        $base .= " Character distinctive features visible: {$features}.";
    }

    return $base;
}
```

Subtext layer format:
```php
return [
    'surface' => 'Face shows [surface emotion manifestation]',
    'leakage' => 'Eyes leak [true emotion] - [leakage description]',
    'body' => 'Body reveals [true emotion manifestation in posture/hands]',
];
```

Follow existing service patterns (constructor, logging, PHPDoc comments).
Namespace: Modules\AppVideoWizard\Services
  </action>
  <verify>File exists and contains EMOTION_MANIFESTATIONS constant, all three base methods, and buildEnhancedEmotionDescription method</verify>
  <done>CharacterPsychologyService maps at least 8 emotions to physical manifestations with face/eyes/body/breath, supports intensity modifiers, produces subtext layers, and has method signature ready for Bible trait integration</done>
</task>

<task type="auto">
  <name>Task 2: Write unit tests for CharacterPsychologyService</name>
  <files>tests/Unit/VideoWizard/CharacterPsychologyServiceTest.php</files>
  <action>
Create comprehensive unit tests:

1. `test_getManifestationsForEmotion_returns_all_physical_components()` - Verify face, eyes, body, breath keys exist
2. `test_getManifestationsForEmotion_returns_empty_for_unknown_emotion()` - Graceful handling
3. `test_buildEmotionDescription_includes_all_manifestations()` - Description contains all physical parts
4. `test_buildEmotionDescription_applies_intensity_modifiers()` - Subtle vs intense differ
5. `test_buildSubtextLayer_creates_three_layer_structure()` - Surface, leakage, body present
6. `test_buildSubtextLayer_body_reveals_true_emotion()` - Body shows different emotion than face
7. `test_suppressed_anger_has_jaw_and_brow_tension()` - Specific mapping verification
8. `test_anxiety_has_fidgeting_and_rapid_eye_movement()` - Specific mapping verification
9. `test_buildEnhancedEmotionDescription_includes_defining_features()` - Bible traits merge in

Test 9 should verify:
```php
public function test_buildEnhancedEmotionDescription_includes_defining_features()
{
    $service = new CharacterPsychologyService();
    $traits = [
        'defining_features' => ['distinctive scar above left eyebrow', 'deep-set eyes'],
    ];

    $result = $service->buildEnhancedEmotionDescription('suppressed_anger', 'moderate', $traits);

    $this->assertStringContainsString('scar', strtolower($result));
    $this->assertStringContainsString('eyebrow', strtolower($result));
}
```

Use PHPUnit patterns consistent with existing tests in tests/Unit/ or tests/Feature/.
  </action>
  <verify>`php artisan test --filter=CharacterPsychologyServiceTest` passes (or verify file syntax with `php -l`)</verify>
  <done>At least 7 unit tests cover emotion mapping, intensity modifiers, subtext layer generation, and Bible trait integration</done>
</task>

</tasks>

<verification>
1. CharacterPsychologyService exists in modules/AppVideoWizard/app/Services/
2. EMOTION_MANIFESTATIONS contains at least 8 emotions with face/eyes/body/breath
3. `buildEmotionDescription('suppressed_anger', 'moderate')` returns string containing "jaw" and "brow"
4. `buildSubtextLayer('forced_composure', 'anxiety', 0.3)` returns array with surface/leakage/body keys
5. `buildEnhancedEmotionDescription('grief', 'moderate', ['defining_features' => ['scar']])` returns string containing "scar"
6. Unit tests pass or syntax check clean
</verification>

<success_criteria>
- CharacterPsychologyService provides physical manifestations for all common emotions
- Descriptions use concrete physical terms (brow, jaw, shoulders) not abstract labels
- Subtext layer produces Hollywood "body betrays face" pattern
- buildEnhancedEmotionDescription ready to receive Bible defining_features
- Code follows existing service patterns (namespace, logging, PHPDoc)
- FACS AU codes are NOT used anywhere (research showed they don't work for image models)
</success_criteria>

<output>
After completion, create `.planning/phases/23-character-psychology-bible/23-01-SUMMARY.md`
</output>
