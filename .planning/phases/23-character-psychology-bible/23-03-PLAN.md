---
phase: 23-character-psychology-bible
plan: 03
type: execute
wave: 2
depends_on:
  - 23-01
files_modified:
  - modules/AppVideoWizard/app/Services/ContinuityAnchorService.php
  - modules/AppVideoWizard/app/Services/CharacterLookService.php
  - tests/Unit/VideoWizard/ContinuityAnchorServiceTest.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Visual details persist across related shots"
    - "Wardrobe details include specific descriptors (color, material, drape)"
    - "Continuity anchors extracted from first shot carry to subsequent shots"
    - "CharacterLookService provides expression presets"
  artifacts:
    - path: "modules/AppVideoWizard/app/Services/ContinuityAnchorService.php"
      provides: "Cross-shot persistence tracking"
      exports: ["extractAnchorsFromPrompt", "applyAnchorsToPrompt", "getAnchorsForCharacter"]
    - path: "modules/AppVideoWizard/app/Services/CharacterLookService.php"
      provides: "Expression presets for common emotional states"
      contains: "EXPRESSION_PRESETS"
    - path: "tests/Unit/VideoWizard/ContinuityAnchorServiceTest.php"
      provides: "Unit tests for continuity service"
      contains: "test_"
  key_links:
    - from: "ContinuityAnchorService.php"
      to: "CharacterPsychologyService.php"
      via: "Uses emotion manifestations for expression anchors"
      pattern: "CharacterPsychologyService"
---

<objective>
Create ContinuityAnchorService for tracking persistent visual details and extend CharacterLookService with expression presets.

Purpose: Ensure visual consistency across shots - if character wears "red wool scarf loosely draped over left shoulder" in shot 1, that exact description persists in shots 2-5. Satisfies IMG-09 (continuity anchors) and extends IMG-04/05/06 support via expression presets.

Output: ContinuityAnchorService.php and enhanced CharacterLookService with expression presets
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Plan 01 provides emotion-to-physical mappings
@modules/AppVideoWizard/app/Services/CharacterPsychologyService.php

# Existing character service to extend
@modules/AppVideoWizard/app/Services/CharacterLookService.php

# Wardrobe tracking patterns already exist
# CharacterLookService::trackWardrobe, getWardrobeForScene
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ContinuityAnchorService</name>
  <files>modules/AppVideoWizard/app/Services/ContinuityAnchorService.php</files>
  <action>
Create ContinuityAnchorService with:

1. ANCHOR_PRIORITY constant (what to preserve across shots):
```php
const ANCHOR_PRIORITY = [
    'primary' => [  // MUST persist - identity-defining
        'face' => 'facial structure, skin tone, distinctive features',
        'hair' => 'color, length, style, texture',
    ],
    'secondary' => [ // SHOULD persist - character continuity
        'wardrobe' => 'outfit, colors, fit, material texture',
        'accessories' => 'jewelry, glasses, watch, visible items',
        'makeup' => 'style, color palette, level',
    ],
    'tertiary' => [ // MAY persist - scene continuity
        'posture' => 'general body position',
        'props' => 'items being held or interacted with',
        'lighting_position' => 'direction of key light on face',
    ],
];
```

2. AnchorSet data structure:
```php
// Represents extracted anchors for a character/scene
[
    'character_id' => 'char_123',
    'scene_index' => 0,
    'anchors' => [
        'wardrobe' => 'red wool scarf loosely draped over left shoulder, charcoal peacoat unbuttoned',
        'hair' => 'dark brown hair in messy waves, falling past shoulders',
        'accessories' => 'silver hoop earrings, leather messenger bag strap across chest',
        'lighting_position' => 'soft key light from camera-left creating gentle shadow on right cheek',
    ],
    'extracted_from_shot' => 1, // First shot where these were established
]
```

3. Methods:
- `extractAnchorsFromPrompt(string $prompt, string $characterId): array` - Parse existing prompt for anchor details
- `applyAnchorsToPrompt(string $basePrompt, array $anchors, string $priority = 'secondary'): string` - Inject anchors into new prompt
- `getAnchorsForCharacter(string $characterId, int $sceneIndex, array $storedAnchors): array` - Retrieve anchors for character
- `buildAnchorDescription(array $character, int $shotIndex): string` - Generate anchor block from Bible character data
- `detectAnchorConflicts(array $newAnchors, array $existingAnchors): array` - Warn on conflicts

`extractAnchorsFromPrompt` looks for specific patterns:
- Wardrobe: color + material + item + position (e.g., "red wool scarf draped over left shoulder")
- Hair: color + texture + length + style
- Accessories: material + item + position

`applyAnchorsToPrompt` adds CONTINUITY ANCHORS block:
```
CONTINUITY ANCHORS (MUST MATCH previous shots):
- WARDROBE: red wool scarf loosely draped over left shoulder
- HAIR: dark brown waves falling past shoulders
- ACCESSORIES: silver hoop earrings, leather messenger bag
```

Follow existing service patterns.
Namespace: Modules\AppVideoWizard\Services
  </action>
  <verify>File exists and contains ANCHOR_PRIORITY constant and all extraction/application methods</verify>
  <done>ContinuityAnchorService extracts and applies visual anchors with priority levels</done>
</task>

<task type="auto">
  <name>Task 2: Extend CharacterLookService with expression presets</name>
  <files>modules/AppVideoWizard/app/Services/CharacterLookService.php</files>
  <action>
Add EXPRESSION_PRESETS constant and methods to existing CharacterLookService.

1. Add EXPRESSION_PRESETS constant (after existing CHARACTER_DNA_TEMPLATES):
```php
/**
 * Expression presets for common emotional states (Phase 23)
 *
 * These use physical descriptions, NOT FACS AU codes.
 * Based on research: image models respond to physical manifestations.
 */
const EXPRESSION_PRESETS = [
    'neutral' => [
        'description' => 'relaxed neutral expression, natural resting face',
        'face' => 'relaxed jaw and brow, natural lip position',
        'eyes' => 'calm direct gaze, natural eyelid position',
    ],
    'subtle_smile' => [
        'description' => 'gentle hint of smile, warmth without full grin',
        'face' => 'slight upturn at mouth corners, softened cheeks',
        'eyes' => 'slight crinkle at corners, brightened gaze',
    ],
    'concerned' => [
        'description' => 'worried concern showing in features',
        'face' => 'slight furrow between brows, lips pressed together',
        'eyes' => 'focused with slight tension, searching gaze',
    ],
    'determined' => [
        'description' => 'resolute determination visible in set of features',
        'face' => 'firm jaw, set mouth, defined brow line',
        'eyes' => 'intense focused gaze, narrowed with purpose',
    ],
    'vulnerable' => [
        'description' => 'open emotional vulnerability in expression',
        'face' => 'softened features, slight tremor in lip',
        'eyes' => 'glistening, wide and unguarded, exposed',
    ],
    'guarded' => [
        'description' => 'closed off, protective expression',
        'face' => 'tightened jaw, flattened expression',
        'eyes' => 'narrowed, assessing, revealing nothing',
    ],
    'surprised' => [
        'description' => 'genuine surprise captured in features',
        'face' => 'raised brows, parted lips, lifted cheeks',
        'eyes' => 'wide open, pupils dilated, alert',
    ],
    'contemplative' => [
        'description' => 'deep thought visible in distant expression',
        'face' => 'slightly furrowed brow, relaxed mouth',
        'eyes' => 'unfocused mid-distance gaze, inner reflection',
    ],
];
```

2. Add new methods:
```php
/**
 * Get expression preset by name (Phase 23)
 */
public function getExpressionPreset(string $preset): ?array

/**
 * Build expression description for prompt (Phase 23)
 * Combines preset with optional intensity modifier
 */
public function buildExpressionDescription(string $preset, string $intensity = 'moderate'): string

/**
 * Get all available expression presets (Phase 23)
 */
public function getExpressionPresets(): array
```

`buildExpressionDescription` returns formatted string:
"Expression: [intensity] [description]. [face detail]. [eyes detail]."

Place new constant after CHARACTER_DNA_TEMPLATES.
Place new methods after existing methods (before the private helper methods).
  </action>
  <verify>CharacterLookService contains EXPRESSION_PRESETS constant and getExpressionPreset method</verify>
  <done>CharacterLookService extended with 8 expression presets and builder method</done>
</task>

<task type="auto">
  <name>Task 3: Write unit tests for ContinuityAnchorService</name>
  <files>tests/Unit/VideoWizard/ContinuityAnchorServiceTest.php</files>
  <action>
Create comprehensive unit tests:

1. `test_extractAnchorsFromPrompt_finds_wardrobe_details()` - Extracts "red wool scarf" type details
2. `test_extractAnchorsFromPrompt_finds_hair_description()` - Extracts hair color/length/style
3. `test_applyAnchorsToPrompt_adds_continuity_block()` - Output contains "CONTINUITY ANCHORS"
4. `test_applyAnchorsToPrompt_respects_priority_levels()` - Primary anchors always included
5. `test_buildAnchorDescription_from_character_data()` - Bible data converts to anchor format
6. `test_detectAnchorConflicts_identifies_wardrobe_change()` - Conflict detected when outfit differs
7. `test_getAnchorsForCharacter_returns_correct_scene()` - Scene-specific anchor retrieval

Use PHPUnit patterns consistent with existing tests.
  </action>
  <verify>`php artisan test --filter=ContinuityAnchorServiceTest` passes (or verify file syntax with `php -l`)</verify>
  <done>At least 5 unit tests cover anchor extraction, application, and conflict detection</done>
</task>

</tasks>

<verification>
1. ContinuityAnchorService exists in modules/AppVideoWizard/app/Services/
2. ANCHOR_PRIORITY constant defines primary/secondary/tertiary levels
3. CharacterLookService has EXPRESSION_PRESETS with at least 8 presets
4. `buildAnchorDescription($character, 0)` returns string with wardrobe/hair details
5. Unit tests pass or syntax check clean
</verification>

<success_criteria>
- ContinuityAnchorService extracts specific details (color + material + item + position)
- Anchors persist across shots with clear priority (primary = face/hair, secondary = wardrobe)
- CharacterLookService expression presets use physical descriptions (not emotion labels)
- Anchor conflicts are detected and can trigger warnings
- All descriptions are concrete enough for image model consistency
</success_criteria>

<output>
After completion, create `.planning/phases/23-character-psychology-bible/23-03-SUMMARY.md`
</output>
