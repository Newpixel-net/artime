---
phase: 23-character-psychology-bible
plan: 04
type: execute
wave: 3
depends_on:
  - 23-01
  - 23-02
  - 23-03
files_modified:
  - modules/AppVideoWizard/app/Services/StructuredPromptBuilderService.php
  - tests/Feature/VideoWizard/PsychologyPromptIntegrationTest.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Generated prompts include character psychology layer"
    - "Generated prompts include mise-en-scene emotional overlay"
    - "Generated prompts include continuity anchors from Bible"
    - "Shot type affects which psychology details are emphasized"
  artifacts:
    - path: "modules/AppVideoWizard/app/Services/StructuredPromptBuilderService.php"
      provides: "Psychology layer integration into prompts"
      contains: "buildPsychologyLayer"
    - path: "tests/Feature/VideoWizard/PsychologyPromptIntegrationTest.php"
      provides: "Integration tests for full prompt pipeline"
      contains: "test_"
  key_links:
    - from: "StructuredPromptBuilderService.php"
      to: "CharacterPsychologyService.php"
      via: "Constructor injection and buildPsychologyLayer calls"
      pattern: "characterPsychology->build"
    - from: "StructuredPromptBuilderService.php"
      to: "MiseEnSceneService.php"
      via: "Constructor injection and buildEnvironmentalMood calls"
      pattern: "miseEnScene->build"
    - from: "StructuredPromptBuilderService.php"
      to: "ContinuityAnchorService.php"
      via: "Constructor injection and anchor application"
      pattern: "continuityAnchor->apply"
---

<objective>
Integrate CharacterPsychologyService, MiseEnSceneService, and ContinuityAnchorService into StructuredPromptBuilderService.

Purpose: Complete the psychology layer by assembling all Phase 23 components into the prompt generation pipeline. Prompts will now include character emotional state (physical manifestations), environmental mood (mise-en-scene), and continuity anchors (persistent details).

Output: Enhanced StructuredPromptBuilderService with psychology layer integration
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Services to integrate (from Plans 01-03)
@modules/AppVideoWizard/app/Services/CharacterPsychologyService.php
@modules/AppVideoWizard/app/Services/MiseEnSceneService.php
@modules/AppVideoWizard/app/Services/ContinuityAnchorService.php

# Service to extend
@modules/AppVideoWizard/app/Services/StructuredPromptBuilderService.php

# Phase 22 summary - vocabulary integration pattern
@.planning/phases/22-foundation-model-adapters/22-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add service dependencies to StructuredPromptBuilderService</name>
  <files>modules/AppVideoWizard/app/Services/StructuredPromptBuilderService.php</files>
  <action>
Update StructuredPromptBuilderService to inject and use new services.

1. Add imports at top of file (after existing use statements):
```php
use Modules\AppVideoWizard\Services\CharacterPsychologyService;
use Modules\AppVideoWizard\Services\MiseEnSceneService;
use Modules\AppVideoWizard\Services\ContinuityAnchorService;
```

2. Add protected properties (after existing $vocabulary and $templateLibrary):
```php
/**
 * CharacterPsychologyService for emotion-to-physical mapping (Phase 23)
 */
protected CharacterPsychologyService $characterPsychology;

/**
 * MiseEnSceneService for environment-emotion integration (Phase 23)
 */
protected MiseEnSceneService $miseEnScene;

/**
 * ContinuityAnchorService for cross-shot persistence (Phase 23)
 */
protected ContinuityAnchorService $continuityAnchor;
```

3. Update constructor to initialize services:
```php
public function __construct()
{
    $this->vocabulary = new CinematographyVocabulary();
    $this->templateLibrary = new PromptTemplateLibrary();
    // Phase 23: Psychology services
    $this->characterPsychology = new CharacterPsychologyService();
    $this->miseEnScene = new MiseEnSceneService();
    $this->continuityAnchor = new ContinuityAnchorService();
}
```

4. Add new methods for psychology layer building:

```php
/**
 * Build psychology layer for character expression (Phase 23)
 *
 * Converts emotional state to physical manifestations suitable for image generation.
 * Uses shot type to determine emphasis (close-up = face detail, wide = body language).
 *
 * @param array $options Options including emotion, intensity, shot_type
 * @return array Psychology layer with expression and body_language keys
 */
protected function buildPsychologyLayer(array $options): array
{
    $emotion = $options['emotion'] ?? null;
    $intensity = $options['intensity'] ?? 'moderate';
    $shotType = $options['shot_type'] ?? 'medium';
    $subtext = $options['subtext'] ?? null; // ['surface' => 'calm', 'true' => 'anxious']

    if (!$emotion) {
        return [];
    }

    $manifestations = $this->characterPsychology->getManifestationsForEmotion($emotion);
    if (empty($manifestations)) {
        return [];
    }

    // Shot type determines emphasis
    $emphasis = $this->getPsychologyEmphasisForShotType($shotType);

    $layer = [
        'expression' => '',
        'body_language' => '',
        'breath_micro' => '',
    ];

    // Build expression based on shot emphasis
    if ($emphasis['face']) {
        $layer['expression'] = $this->characterPsychology->buildEmotionDescription($emotion, $intensity);
    }

    if ($emphasis['body'] && !empty($manifestations['body'])) {
        $layer['body_language'] = $manifestations['body'];
    }

    if ($emphasis['breath'] && !empty($manifestations['breath'])) {
        $layer['breath_micro'] = $manifestations['breath'];
    }

    // Add subtext layer if present (Hollywood "body betrays face")
    if ($subtext && isset($subtext['surface'], $subtext['true'])) {
        $subtextLayer = $this->characterPsychology->buildSubtextLayer(
            $subtext['surface'],
            $subtext['true'],
            $subtext['leakage'] ?? 0.3
        );
        $layer['subtext'] = $subtextLayer;
    }

    return $layer;
}

/**
 * Determine psychology emphasis based on shot type (Phase 23)
 */
protected function getPsychologyEmphasisForShotType(string $shotType): array
{
    $emphasisMap = [
        'extreme-close-up' => ['face' => true, 'body' => false, 'breath' => true],
        'close-up' => ['face' => true, 'body' => false, 'breath' => true],
        'medium-close' => ['face' => true, 'body' => true, 'breath' => false],
        'medium' => ['face' => true, 'body' => true, 'breath' => false],
        'medium-wide' => ['face' => false, 'body' => true, 'breath' => false],
        'wide' => ['face' => false, 'body' => true, 'breath' => false],
        'establishing' => ['face' => false, 'body' => true, 'breath' => false],
    ];

    return $emphasisMap[strtolower($shotType)] ?? ['face' => true, 'body' => true, 'breath' => false];
}

/**
 * Build mise-en-scene environmental overlay (Phase 23)
 *
 * @param array $baseEnvironment Base environment from location Bible
 * @param string $emotion Dominant emotional state
 * @param int $tensionLevel Tension level 1-10
 * @return array Enhanced environment with emotional overlay
 */
protected function buildMiseEnSceneOverlay(array $baseEnvironment, string $emotion, int $tensionLevel = 5): array
{
    $emotionalMood = $this->miseEnScene->getMiseEnSceneForEmotion($emotion);
    $spatialTension = $this->miseEnScene->getSpacialTension($tensionLevel);

    // Blend base environment with emotional overlay
    return $this->miseEnScene->buildEnvironmentalMood($emotion, $baseEnvironment);
}

/**
 * Build continuity anchors block (Phase 23)
 *
 * @param array $character Character data from Bible
 * @param int $shotIndex Current shot index
 * @param array $priorAnchors Anchors from previous shots
 * @return string Formatted continuity anchors block
 */
protected function buildContinuityAnchorsBlock(array $character, int $shotIndex, array $priorAnchors = []): string
{
    if ($shotIndex === 0) {
        // First shot - establish anchors
        return $this->continuityAnchor->buildAnchorDescription($character, $shotIndex);
    }

    // Subsequent shots - apply prior anchors
    $anchors = $this->continuityAnchor->getAnchorsForCharacter(
        $character['id'] ?? 'unknown',
        $shotIndex,
        $priorAnchors
    );

    if (empty($anchors)) {
        return '';
    }

    return $this->continuityAnchor->applyAnchorsToPrompt('', $anchors);
}
```
  </action>
  <verify>StructuredPromptBuilderService constructor initializes CharacterPsychologyService, MiseEnSceneService, ContinuityAnchorService</verify>
  <done>Service dependencies added with buildPsychologyLayer, buildMiseEnSceneOverlay, buildContinuityAnchorsBlock methods</done>
</task>

<task type="auto">
  <name>Task 2: Integrate psychology layer into buildCreativePrompt</name>
  <files>modules/AppVideoWizard/app/Services/StructuredPromptBuilderService.php</files>
  <action>
Modify both buildCreativePrompt and buildCreativePromptFromSceneDNA to include psychology layer.

1. In buildCreativePrompt method (around line 357-457), add after building characterDNA:

```php
// Phase 23: Build psychology layer if emotion specified
$psychologyLayer = [];
$emotion = $options['emotion'] ?? null;
if ($emotion) {
    $psychologyLayer = $this->buildPsychologyLayer([
        'emotion' => $emotion,
        'intensity' => $options['emotion_intensity'] ?? 'moderate',
        'shot_type' => $shotType,
        'subtext' => $options['subtext'] ?? null,
    ]);
}

// Phase 23: Build mise-en-scene overlay if emotion affects environment
$miseEnSceneOverlay = [];
if ($emotion) {
    $miseEnSceneOverlay = $this->buildMiseEnSceneOverlay(
        $environment,
        $emotion,
        $options['tension_level'] ?? 5
    );
}

// Phase 23: Build continuity anchors
$continuityAnchors = '';
if ($characterBible && ($characterBible['enabled'] ?? false)) {
    $characters = $characterBible['characters'] ?? [];
    $mainCharacter = $characters[0] ?? [];
    $shotIndex = $options['shot_index'] ?? 0;
    $priorAnchors = $options['prior_anchors'] ?? [];

    $continuityAnchors = $this->buildContinuityAnchorsBlock(
        $mainCharacter,
        $shotIndex,
        $priorAnchors
    );
}
```

2. Add these to the return array (after existing fields):
```php
// Phase 23: Psychology layer additions
'psychology_layer' => $psychologyLayer,           // Emotion physical manifestations
'mise_en_scene_overlay' => $miseEnSceneOverlay,   // Environmental emotional mood
'continuity_anchors' => $continuityAnchors,       // Cross-shot persistence
```

3. Apply same pattern to buildCreativePromptFromSceneDNA method:
- Extract emotion from sceneDNAEntry if present: `$emotion = $sceneDNAEntry['emotion'] ?? null;`
- Build psychology layer, mise-en-scene overlay, and continuity anchors
- Add to return array

4. Update the Log::debug statements to include new fields:
```php
'hasPsychologyLayer' => !empty($psychologyLayer),
'hasMiseEnSceneOverlay' => !empty($miseEnSceneOverlay),
'hasContinuityAnchors' => !empty($continuityAnchors),
```
  </action>
  <verify>buildCreativePrompt return array includes psychology_layer, mise_en_scene_overlay, continuity_anchors keys</verify>
  <done>Both buildCreativePrompt paths integrate psychology services and return psychology layer data</done>
</task>

<task type="auto">
  <name>Task 3: Write integration tests for psychology prompt pipeline</name>
  <files>tests/Feature/VideoWizard/PsychologyPromptIntegrationTest.php</files>
  <action>
Create feature tests that verify end-to-end psychology integration:

```php
<?php

namespace Tests\Feature\VideoWizard;

use Tests\TestCase;
use Modules\AppVideoWizard\Services\StructuredPromptBuilderService;

class PsychologyPromptIntegrationTest extends TestCase
{
    protected StructuredPromptBuilderService $builder;

    protected function setUp(): void
    {
        parent::setUp();
        $this->builder = new StructuredPromptBuilderService();
    }

    /** @test */
    public function test_build_includes_psychology_layer_when_emotion_specified()
    {
        $result = $this->builder->build([
            'visual_mode' => 'cinematic-realistic',
            'scene_description' => 'A woman sits alone at a cafe table',
            'emotion' => 'anxiety',
            'emotion_intensity' => 'moderate',
        ]);

        $creative = $result['creative_prompt'];

        $this->assertArrayHasKey('psychology_layer', $creative);
        $this->assertNotEmpty($creative['psychology_layer']);
    }

    /** @test */
    public function test_psychology_layer_contains_physical_manifestations_not_labels()
    {
        $result = $this->builder->build([
            'visual_mode' => 'cinematic-realistic',
            'scene_description' => 'A man receives bad news',
            'emotion' => 'suppressed_anger',
            'shot_type' => 'close-up',
        ]);

        $psychology = $result['creative_prompt']['psychology_layer'];

        // Should contain physical descriptions
        $expressionStr = $psychology['expression'] ?? '';
        $this->assertStringContainsString('jaw', strtolower($expressionStr),
            'Expression should describe physical manifestation like jaw tension');

        // Should NOT contain emotion labels
        $this->assertStringNotContainsString('angry', strtolower($expressionStr),
            'Expression should not use emotion label');
    }

    /** @test */
    public function test_close_up_emphasizes_face_over_body()
    {
        $result = $this->builder->build([
            'visual_mode' => 'cinematic-realistic',
            'scene_description' => 'Character reacts to news',
            'emotion' => 'grief',
            'shot_type' => 'close-up',
        ]);

        $psychology = $result['creative_prompt']['psychology_layer'];

        $this->assertNotEmpty($psychology['expression'] ?? '',
            'Close-up should include facial expression');
    }

    /** @test */
    public function test_wide_shot_emphasizes_body_over_face()
    {
        $result = $this->builder->build([
            'visual_mode' => 'cinematic-realistic',
            'scene_description' => 'Character walks through empty room',
            'emotion' => 'grief',
            'shot_type' => 'wide',
        ]);

        $psychology = $result['creative_prompt']['psychology_layer'];

        $this->assertNotEmpty($psychology['body_language'] ?? '',
            'Wide shot should include body language');
    }

    /** @test */
    public function test_mise_en_scene_overlay_modifies_environment()
    {
        $result = $this->builder->build([
            'visual_mode' => 'cinematic-realistic',
            'scene_description' => 'Office interior during tense meeting',
            'emotion' => 'tension',
            'tension_level' => 8,
        ]);

        $creative = $result['creative_prompt'];

        $this->assertArrayHasKey('mise_en_scene_overlay', $creative);
    }

    /** @test */
    public function test_subtext_layer_creates_body_betrays_face()
    {
        $result = $this->builder->build([
            'visual_mode' => 'cinematic-realistic',
            'scene_description' => 'Character pretends to be calm',
            'emotion' => 'forced_composure',
            'subtext' => [
                'surface' => 'forced_composure',
                'true' => 'anxiety',
                'leakage' => 0.4,
            ],
        ]);

        $psychology = $result['creative_prompt']['psychology_layer'];

        $this->assertArrayHasKey('subtext', $psychology);
        $this->assertArrayHasKey('surface', $psychology['subtext']);
        $this->assertArrayHasKey('body', $psychology['subtext']);
    }

    /** @test */
    public function test_continuity_anchors_included_with_character_bible()
    {
        $characterBible = [
            'enabled' => true,
            'characters' => [
                [
                    'id' => 'char_1',
                    'name' => 'Elena',
                    'wardrobe' => [
                        'outfit' => 'red wool scarf over charcoal peacoat',
                        'colors' => 'red, charcoal gray',
                    ],
                    'hair' => [
                        'color' => 'dark brown',
                        'style' => 'messy waves',
                        'length' => 'past shoulders',
                    ],
                ],
            ],
        ];

        $result = $this->builder->build([
            'visual_mode' => 'cinematic-realistic',
            'scene_description' => 'Elena walks through the park',
            'character_bible' => $characterBible,
            'shot_index' => 0,
        ]);

        $creative = $result['creative_prompt'];

        $this->assertArrayHasKey('continuity_anchors', $creative);
    }
}
```
  </action>
  <verify>`php artisan test --filter=PsychologyPromptIntegrationTest` passes (or verify file syntax with `php -l`)</verify>
  <done>At least 6 integration tests verify psychology layer, mise-en-scene, subtext, and continuity anchor integration</done>
</task>

</tasks>

<verification>
1. StructuredPromptBuilderService imports and constructs all three new services
2. buildCreativePrompt returns array with psychology_layer, mise_en_scene_overlay, continuity_anchors keys
3. Close-up shots emphasize face/expression; wide shots emphasize body language
4. Subtext creates three-layer structure (surface, leakage, body)
5. Integration tests verify end-to-end prompt generation with psychology
</verification>

<success_criteria>
- Psychology layer integrated into both buildCreativePrompt code paths
- Shot type correctly determines which psychology elements are emphasized
- Mise-en-scene overlay blends with existing environment description
- Continuity anchors persist character details across shots
- All tests pass demonstrating physical descriptions (not emotion labels)
- FACS AU codes are NOT present anywhere in output (research: image models don't understand them)
</success_criteria>

<output>
After completion, create `.planning/phases/23-character-psychology-bible/23-04-SUMMARY.md`
</output>
