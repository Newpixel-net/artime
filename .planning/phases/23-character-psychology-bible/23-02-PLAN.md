---
phase: 23-character-psychology-bible
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/AppVideoWizard/app/Services/MiseEnSceneService.php
  - tests/Unit/VideoWizard/MiseEnSceneServiceTest.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Emotional states map to environmental modifications"
    - "Lighting suggestions reflect character emotional state"
    - "Color palette shifts based on scene tension"
    - "Space/framing adjusts to emotional context"
  artifacts:
    - path: "modules/AppVideoWizard/app/Services/MiseEnSceneService.php"
      provides: "Environment-emotion integration"
      exports: ["getMiseEnSceneForEmotion", "buildEnvironmentalMood", "getSpacialTension"]
    - path: "tests/Unit/VideoWizard/MiseEnSceneServiceTest.php"
      provides: "Unit tests for mise-en-scene service"
      contains: "test_"
  key_links:
    - from: "MiseEnSceneService.php"
      to: "MISE_EN_SCENE_MAPPINGS constant"
      via: "getMiseEnSceneForEmotion uses const lookup"
      pattern: "MISE_EN_SCENE_MAPPINGS\\["
---

<objective>
Create MiseEnSceneService that modifies environment descriptions to reflect character emotional states.

Purpose: Implement Hollywood technique where environment reflects inner psychology - anxious scenes have cramped framing and harsh shadows, peaceful scenes have soft lighting and open space. This satisfies IMG-08: mise-en-scene integration.

Output: MiseEnSceneService.php with emotion-to-environment mappings
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 22 vocabulary for lighting/color integration
@modules/AppVideoWizard/app/Services/CinematographyVocabulary.php

# Location service pattern to follow
@modules/AppVideoWizard/app/Services/StoryBibleService.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MiseEnSceneService with environment-emotion mappings</name>
  <files>modules/AppVideoWizard/app/Services/MiseEnSceneService.php</files>
  <action>
Create MiseEnSceneService with:

1. MISE_EN_SCENE_MAPPINGS constant (environment reflects emotional state):
```php
const MISE_EN_SCENE_MAPPINGS = [
    'anxiety' => [
        'lighting' => 'harsh overhead creating unflattering shadows under eyes, flickering or unstable light source',
        'colors' => 'desaturated with sickly yellow-green undertone, washed out highlights',
        'space' => 'cramped framing, cluttered background pressing in, low ceiling visible',
        'atmosphere' => 'thick air, visible dust particles, sense of walls closing in',
    ],
    'tension' => [
        'lighting' => 'dramatic side lighting, deep shadows obscuring half the scene, unstable flickering',
        'colors' => 'high contrast, deep blacks against sharp highlights, red or amber accents',
        'space' => 'diagonal compositions, tilted horizon, foreground obstructions partially blocking view',
        'atmosphere' => 'heavy stillness, pregnant pause, something about to break',
    ],
    'peace' => [
        'lighting' => 'soft diffused natural light, gentle golden hour warmth, no harsh shadows',
        'colors' => 'warm earth tones, soft pastels, harmonious palette',
        'space' => 'open airy composition, breathing room around subject, clear sightlines',
        'atmosphere' => 'gentle movement of curtains or leaves, calm settled quality',
    ],
    'isolation' => [
        'lighting' => 'single pool of light in darkness, subject illuminated but surroundings lost in shadow',
        'colors' => 'cool blues and grays, muted and distant',
        'space' => 'vast negative space around subject, distant horizon, empty surroundings',
        'atmosphere' => 'quiet emptiness, stillness without warmth',
    ],
    'danger' => [
        'lighting' => 'harsh underlit or backlit silhouette, dramatic rim light, deep impenetrable shadows',
        'colors' => 'saturated reds, deep blacks, warning colors',
        'space' => 'constricted escape routes, walls or obstacles hemming in, no clear exit',
        'atmosphere' => 'thick tension, predatory stillness, imminent threat',
    ],
    'hope' => [
        'lighting' => 'shaft of light breaking through darkness, dawn light on horizon, volumetric rays',
        'colors' => 'warm gold emerging from cool shadows, gradient from dark to light',
        'space' => 'opening vista, path forward visible, expanding horizon',
        'atmosphere' => 'sense of emergence, dawn breaking, weight lifting',
    ],
    'intimacy' => [
        'lighting' => 'warm close lighting, soft key with gentle fill, candlelight warmth',
        'colors' => 'warm amber and honey tones, skin-flattering palette',
        'space' => 'tight two-shot framing, subjects close together, background softened away',
        'atmosphere' => 'private enclosed world, outside world excluded',
    ],
    'chaos' => [
        'lighting' => 'strobing or rapidly changing, multiple conflicting sources, harsh mixed temperatures',
        'colors' => 'clashing discordant palette, oversaturated and jarring',
        'space' => 'dutch angle, motion blur, fragmented composition, multiple planes of action',
        'atmosphere' => 'sensory overload, disorientation, loss of control',
    ],
];
```

2. TENSION_SCALE for gradual environmental shift:
```php
const TENSION_SCALE = [
    1 => ['space_modifier' => 'open and comfortable', 'light_modifier' => 'even and natural'],
    3 => ['space_modifier' => 'slightly confined', 'light_modifier' => 'subtle shadows forming'],
    5 => ['space_modifier' => 'noticeably compressed', 'light_modifier' => 'pronounced shadow areas'],
    7 => ['space_modifier' => 'claustrophobic and pressing', 'light_modifier' => 'dramatic contrast'],
    10 => ['space_modifier' => 'oppressively tight, no escape', 'light_modifier' => 'harsh chiaroscuro'],
];
```

3. Methods:
- `getMiseEnSceneForEmotion(string $emotion): array` - Returns lighting/colors/space/atmosphere
- `buildEnvironmentalMood(string $emotion, array $baseEnvironment): array` - Modifies environment with emotional overlay
- `getSpacialTension(int $tensionLevel): array` - Returns space and light modifiers for 1-10 scale
- `blendEnvironments(array $base, array $emotional, float $intensity = 0.5): array` - Blends base location with emotional overlay

`buildEnvironmentalMood` merges emotional atmosphere with location description:
- Takes existing location (from Bible) as base
- Overlays emotional lighting, color shifts, atmospheric details
- Returns enhanced environment description

Follow existing service patterns (namespace, logging, PHPDoc).
Namespace: Modules\AppVideoWizard\Services
  </action>
  <verify>File exists and contains MISE_EN_SCENE_MAPPINGS constant with at least 8 emotions</verify>
  <done>MiseEnSceneService maps at least 8 emotional states to lighting/colors/space/atmosphere with tension scale</done>
</task>

<task type="auto">
  <name>Task 2: Write unit tests for MiseEnSceneService</name>
  <files>tests/Unit/VideoWizard/MiseEnSceneServiceTest.php</files>
  <action>
Create comprehensive unit tests:

1. `test_getMiseEnSceneForEmotion_returns_all_components()` - Verify lighting, colors, space, atmosphere keys
2. `test_getMiseEnSceneForEmotion_anxiety_has_cramped_space()` - Specific: space contains "cramped" or "cluttered"
3. `test_getMiseEnSceneForEmotion_peace_has_soft_lighting()` - Specific: lighting contains "soft" or "diffused"
4. `test_buildEnvironmentalMood_preserves_base_location()` - Base location info retained
5. `test_buildEnvironmentalMood_adds_emotional_overlay()` - Emotional elements added
6. `test_getSpacialTension_level_1_is_comfortable()` - Low tension = open space
7. `test_getSpacialTension_level_10_is_oppressive()` - High tension = claustrophobic
8. `test_blendEnvironments_respects_intensity()` - 0.0 = pure base, 1.0 = pure emotional

Use PHPUnit patterns consistent with existing tests.
  </action>
  <verify>`php artisan test --filter=MiseEnSceneServiceTest` passes (or verify file syntax with `php -l`)</verify>
  <done>At least 6 unit tests cover emotion mapping, environmental blending, and tension scale</done>
</task>

</tasks>

<verification>
1. MiseEnSceneService exists in modules/AppVideoWizard/app/Services/
2. MISE_EN_SCENE_MAPPINGS contains at least 8 emotional states
3. `getMiseEnSceneForEmotion('anxiety')` returns array with lighting/colors/space/atmosphere
4. `getSpacialTension(10)` returns array with claustrophobic descriptors
5. Unit tests pass or syntax check clean
</verification>

<success_criteria>
- MiseEnSceneService provides environment modifications for all common emotional states
- Lighting, color, and space descriptions are concrete and image-generation ready
- Tension scale provides gradual environmental shift (1=comfortable to 10=oppressive)
- Environmental overlay can blend with existing location data
- Code follows existing service patterns
</success_criteria>

<output>
After completion, create `.planning/phases/23-character-psychology-bible/23-02-SUMMARY.md`
</output>
