---
phase: 26-llm-powered-expansion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/AppVideoWizard/app/Services/ComplexityDetectorService.php
  - tests/Unit/VideoWizard/ComplexityDetectorServiceTest.php
autonomous: true

must_haves:
  truths:
    - "Shots with 2+ characters are detected as complex"
    - "Shots with high emotional complexity (subtext, multiple emotions) are detected as complex"
    - "Shots with unusual environments not covered by templates are detected as complex"
    - "Simple shots (single character, known template coverage) are NOT flagged as complex"
  artifacts:
    - path: "modules/AppVideoWizard/app/Services/ComplexityDetectorService.php"
      provides: "Multi-dimensional complexity detection"
      exports: ["calculateComplexity", "isComplex", "getComplexityReasons"]
      min_lines: 150
    - path: "tests/Unit/VideoWizard/ComplexityDetectorServiceTest.php"
      provides: "Unit tests for complexity detection"
      min_lines: 100
  key_links:
    - from: "ComplexityDetectorService"
      to: "PromptTemplateLibrary"
      via: "Template coverage check"
      pattern: "PromptTemplateLibrary"
---

<objective>
Create ComplexityDetectorService for multi-dimensional shot complexity scoring.

Purpose: Detect when shots exceed template capability and require LLM expansion. This prevents over-triggering LLM (expensive, slow) while ensuring complex shots get AI enhancement.

Output: ComplexityDetectorService.php with unit tests covering all complexity dimensions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-llm-powered-expansion/26-RESEARCH.md

# Existing services to integrate
@modules/AppVideoWizard/app/Services/PromptTemplateLibrary.php
@modules/AppVideoWizard/app/Services/CharacterDynamicsService.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ComplexityDetectorService</name>
  <files>modules/AppVideoWizard/app/Services/ComplexityDetectorService.php</files>
  <action>
Create ComplexityDetectorService with multi-dimensional complexity scoring.

COMPLEXITY DIMENSIONS (from research):
1. **multi_character** - 2+ characters requires spatial dynamics vocabulary
   - Score 0.0 for 1 character
   - Score 0.7 for 2 characters
   - Score 1.0 for 3+ characters

2. **emotional_complexity** - High subtext or layered emotions
   - +0.5 if subtext field is non-empty
   - +0.3 if multiple emotions specified
   - +0.2 if tension_level >= 8

3. **environment_novelty** - Environment not covered by template keywords
   - Check if environment matches SHOT_TEMPLATES emphasis keywords
   - Score 0.0-1.0 based on template match confidence

4. **combination_novelty** - Novel combination of elements
   - Check if shot_type + emotion + environment combo exists in typical patterns
   - Higher score for unusual combinations

5. **token_budget_risk** - Would exceed 80% of target budget with template approach
   - Estimate template output length
   - Score based on proximity to budget limit

THRESHOLDS:
- Any single dimension >= 0.7 triggers complexity
- Total weighted score >= 0.6 triggers complexity
- ALWAYS return is_complex: true if character_count >= 3

METHODS TO IMPLEMENT:
```php
public function calculateComplexity(array $shotData): array
// Returns: ['scores' => [...], 'total_score' => float, 'is_complex' => bool, 'complexity_reasons' => [...]]

public function isComplex(array $shotData): bool
// Convenience method

public function getComplexityReasons(array $scores): array
// Returns human-readable reasons for complexity

protected function scoreMultiCharacter(array $shot): float
protected function scoreEmotionalComplexity(array $shot): float
protected function scoreEnvironmentNovelty(array $shot): float
protected function scoreCombinationNovelty(array $shot): float
protected function scoreTokenBudgetRisk(array $shot): float
```

EXPECTED INPUT (shotData array):
```php
[
    'characters' => [['name' => 'Marcus'], ['name' => 'Elena']],
    'shot_type' => 'two-shot',
    'emotion' => 'tension',
    'emotions' => ['anxiety', 'hidden_joy'],
    'subtext' => 'She hides her fear behind forced composure',
    'tension_level' => 8,
    'environment' => 'abandoned warehouse',
    'relationship' => 'enemies',
]
```

Inject PromptTemplateLibrary to check template coverage for environment_novelty.
  </action>
  <verify>Run `php artisan tinker` and test:
```php
$detector = app(\Modules\AppVideoWizard\Services\ComplexityDetectorService::class);
// Simple shot - should NOT be complex
$simple = $detector->calculateComplexity(['characters' => [['name' => 'Marcus']], 'shot_type' => 'close-up', 'emotion' => 'grief']);
var_dump($simple['is_complex']); // false
// Complex shot - should BE complex
$complex = $detector->calculateComplexity(['characters' => [['name' => 'A'], ['name' => 'B'], ['name' => 'C']], 'shot_type' => 'wide', 'subtext' => 'hidden agenda']);
var_dump($complex['is_complex']); // true
```</verify>
  <done>ComplexityDetectorService exists with all 5 scoring dimensions, correctly identifies simple vs complex shots</done>
</task>

<task type="auto">
  <name>Task 2: Create ComplexityDetectorService unit tests</name>
  <files>tests/Unit/VideoWizard/ComplexityDetectorServiceTest.php</files>
  <action>
Create comprehensive unit tests for ComplexityDetectorService.

TEST CASES:
1. **test_single_character_not_complex** - 1 character, known shot type, single emotion = NOT complex
2. **test_two_characters_triggers_complexity** - 2 characters = complex (multi_character >= 0.7)
3. **test_three_plus_characters_always_complex** - 3+ characters = always complex
4. **test_subtext_triggers_complexity** - Non-empty subtext field adds emotional complexity
5. **test_high_tension_triggers_complexity** - tension_level >= 8 adds to emotional complexity
6. **test_multiple_emotions_triggers_complexity** - 2+ emotions in emotions array
7. **test_novel_environment_triggers_complexity** - Environment not in template keywords
8. **test_known_environment_not_complex** - Environment matching template emphasis keywords
9. **test_combined_low_scores_not_complex** - Multiple low scores don't accidentally trigger
10. **test_complexity_reasons_populated** - complexity_reasons array contains human-readable strings

Use PHPUnit with `#[Test]` attributes.
Follow existing test patterns in tests/Unit/VideoWizard/.
  </action>
  <verify>Run `php artisan test --filter=ComplexityDetectorServiceTest` - all tests pass</verify>
  <done>10+ unit tests pass covering all complexity dimensions and edge cases</done>
</task>

</tasks>

<verification>
1. ComplexityDetectorService correctly scores multi-character shots (2+ = complex)
2. Emotional complexity detected from subtext, multiple emotions, high tension
3. Environment novelty scores based on template coverage
4. Simple single-character shots with known templates NOT flagged as complex
5. All unit tests pass
</verification>

<success_criteria>
- ComplexityDetectorService::calculateComplexity returns proper score structure
- 2+ characters triggers complexity (multi_character score >= 0.7)
- Subtext field triggers complexity (emotional_complexity increases)
- 3+ characters ALWAYS triggers complexity regardless of other factors
- Simple shots (1 character, known template) return is_complex: false
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/26-llm-powered-expansion/26-01-SUMMARY.md`
</output>
