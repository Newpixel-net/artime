---
phase: 21-data-normalization
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - modules/AppVideoWizard/app/Console/Commands/NormalizeProjectData.php
  - modules/AppVideoWizard/app/Providers/AppVideoWizardServiceProvider.php
  - modules/AppVideoWizard/app/Livewire/VideoWizard.php
autonomous: true

must_haves:
  truths:
    - "Artisan command wizard:normalize-data exists and runs"
    - "Command can migrate JSON data to normalized tables"
    - "VideoWizard loads scenes from normalized tables when available"
    - "VideoWizard falls back to JSON for non-migrated projects"
  artifacts:
    - path: "modules/AppVideoWizard/app/Console/Commands/NormalizeProjectData.php"
      provides: "Data migration artisan command"
      contains: "wizard:normalize-data"
    - path: "modules/AppVideoWizard/app/Providers/AppVideoWizardServiceProvider.php"
      provides: "Command registration"
      contains: "NormalizeProjectData"
  key_links:
    - from: "modules/AppVideoWizard/app/Console/Commands/NormalizeProjectData.php"
      to: "modules/AppVideoWizard/app/Models/WizardScene.php"
      via: "model creation"
      pattern: "WizardScene::create"
    - from: "modules/AppVideoWizard/app/Livewire/VideoWizard.php"
      to: "modules/AppVideoWizard/app/Models/WizardProject.php"
      via: "usesNormalizedData check"
      pattern: "usesNormalizedData\\(\\)"
---

<objective>
Create data migration infrastructure and update VideoWizard for dual-mode operation

Purpose: Enable migrating existing JSON data to normalized tables and update VideoWizard to work with both data formats (PERF-06 continuation)
Output: Artisan command for data migration, VideoWizard updated to read from normalized tables with JSON fallback
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-data-normalization/21-RESEARCH.md

# Prior plan created models
@.planning/phases/21-data-normalization/21-01-SUMMARY.md

# Reference VideoWizard structure
@modules/AppVideoWizard/app/Livewire/VideoWizard.php
@modules/AppVideoWizard/app/Models/WizardProject.php
@modules/AppVideoWizard/app/Providers/AppVideoWizardServiceProvider.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create data migration artisan command</name>
  <files>
    modules/AppVideoWizard/app/Console/Commands/NormalizeProjectData.php
    modules/AppVideoWizard/app/Providers/AppVideoWizardServiceProvider.php
  </files>
  <action>
    **Create Console/Commands directory if needed:**
    ```
    mkdir -p modules/AppVideoWizard/app/Console/Commands
    ```

    **Create NormalizeProjectData.php command** following the pattern from 21-RESEARCH.md:

    - Namespace: Modules\AppVideoWizard\Console\Commands
    - Signature: wizard:normalize-data {--project=} {--dry-run} {--force}
    - Description: Migrate JSON scene data to normalized tables

    **Command logic:**
    1. Query WizardProject(s) - single if --project=ID, otherwise all
    2. For each project:
       a. Skip if already normalized (scenes exist) unless --force
       b. Extract scenes from $project->script['scenes']
       c. Match with $project->storyboard['scenes'] by index
       d. Match with $project->animation['scenes'] if exists
       e. For each scene:
          - Create WizardScene with merged data
          - Create WizardShot for each shot in storyboard['scenes'][$i]['shots']
          - Create WizardSpeechSegment for each speechSegment in script['scenes'][$i]['speechSegments']
       f. Output progress to console

    **Field mappings (JSON key -> database column):**
    Script scene:
    - narration -> narration
    - visualPrompt -> visual_prompt
    - duration -> duration
    - speechType -> speech_type
    - transition -> transition
    - speechSegments -> create WizardSpeechSegment records
    - voiceover -> store in scene_metadata

    Storyboard scene:
    - imageUrl -> image_url
    - status / imageStatus -> image_status
    - prompt / imagePrompt -> image_prompt
    - jobId -> image_job_id
    - shots -> create WizardShot records

    Animation scene:
    - videoUrl -> video_url
    - videoStatus -> video_status
    - voiceoverUrl -> voiceover_url

    SpeechSegment:
    - id (if string UUID, store in segment_metadata)
    - type -> type
    - text -> text
    - speaker -> speaker
    - characterId -> character_id
    - voiceId -> voice_id
    - startTime -> start_time
    - duration -> duration
    - audioUrl -> audio_url
    - emotion -> emotion
    - needsLipSync -> needs_lip_sync

    Shot:
    - imagePrompt -> image_prompt
    - videoPrompt -> video_prompt
    - cameraMovement -> camera_movement
    - duration -> duration
    - durationClass -> duration_class
    - imageUrl -> image_url
    - imageStatus -> image_status
    - videoUrl -> video_url
    - videoStatus -> video_status
    - dialogue -> dialogue
    - speakingCharacters -> store in shot_metadata

    **Wrap in database transaction.** Rollback if any error occurs.

    **Output:** Show progress bar for large batches, info message per project.

    **Update AppVideoWizardServiceProvider.php:**
    - In boot() or register(), add: $this->commands([Commands\NormalizeProjectData::class]);
    - Add use statement: use Modules\AppVideoWizard\Console\Commands\NormalizeProjectData;
  </action>
  <verify>
    Command is registered and help works:
    ```bash
    php artisan wizard:normalize-data --help
    ```
    Should show: wizard:normalize-data [--project=] [--dry-run] [--force]
  </verify>
  <done>
    Artisan command exists and can be invoked with options for single/all projects, dry-run mode, and force flag
  </done>
</task>

<task type="auto">
  <name>Task 2: Update VideoWizard for dual-mode data access</name>
  <files>
    modules/AppVideoWizard/app/Livewire/VideoWizard.php
  </files>
  <action>
    Update VideoWizard.php to support both JSON and normalized data access. This is a MINIMAL change - only modify scene access patterns, not UI rendering.

    **Add use statements at top:**
    ```php
    use Modules\AppVideoWizard\Models\WizardScene;
    use Modules\AppVideoWizard\Models\WizardShot;
    use Modules\AppVideoWizard\Models\WizardSpeechSegment;
    ```

    **Add computed property for scene IDs (using Livewire 3 #[Computed]):**
    ```php
    #[Computed(persist: true, seconds: 300)]
    public function sceneIds(): array
    {
        if ($this->project && $this->project->usesNormalizedData()) {
            return $this->project->scenes()->pluck('id')->toArray();
        }

        // Fallback to JSON indices
        return array_keys($this->script['scenes'] ?? []);
    }
    ```

    **Add computed property for scene count:**
    ```php
    #[Computed]
    public function normalizedSceneCount(): int
    {
        if ($this->project && $this->project->usesNormalizedData()) {
            return $this->project->scenes()->count();
        }
        return count($this->script['scenes'] ?? []);
    }
    ```

    **Add helper method to get single scene:**
    ```php
    public function getSceneData(int $index): ?array
    {
        if ($this->project && $this->project->usesNormalizedData()) {
            $scene = $this->project->scenes()
                ->where('order', $index)
                ->with(['shots', 'speechSegments'])
                ->first();

            if (!$scene) {
                return null;
            }

            // Transform to array format for backward compatibility
            return $this->normalizedSceneToArray($scene);
        }

        // JSON fallback
        return $this->script['scenes'][$index] ?? null;
    }

    protected function normalizedSceneToArray(WizardScene $scene): array
    {
        return [
            'id' => $scene->id,
            'narration' => $scene->narration,
            'visualPrompt' => $scene->visual_prompt,
            'duration' => $scene->duration,
            'speechType' => $scene->speech_type,
            'transition' => $scene->transition,
            'imageUrl' => $scene->image_url,
            'imageStatus' => $scene->image_status,
            'prompt' => $scene->image_prompt,
            'videoUrl' => $scene->video_url,
            'videoStatus' => $scene->video_status,
            'speechSegments' => $scene->speechSegments->map(fn($s) => [
                'id' => $s->id,
                'type' => $s->type,
                'text' => $s->text,
                'speaker' => $s->speaker,
                'characterId' => $s->character_id,
                'voiceId' => $s->voice_id,
                'startTime' => $s->start_time,
                'duration' => $s->duration,
                'audioUrl' => $s->audio_url,
            ])->toArray(),
            'shots' => $scene->shots->map(fn($shot) => [
                'id' => $shot->id,
                'imagePrompt' => $shot->image_prompt,
                'videoPrompt' => $shot->video_prompt,
                'cameraMovement' => $shot->camera_movement,
                'duration' => $shot->duration,
                'imageUrl' => $shot->image_url,
                'videoUrl' => $shot->video_url,
            ])->toArray(),
        ];
    }
    ```

    **Add check method:**
    ```php
    public function usesNormalizedData(): bool
    {
        return $this->project && $this->project->usesNormalizedData();
    }
    ```

    **DO NOT change existing $script, $storyboard, $animation properties** - they remain for backward compatibility. The normalized path is opt-in via computed properties.

    **DO NOT modify blade templates yet** - that's Plan 03 with lazy-loaded components.

    Place new methods near the top of the class, after property declarations, in a section with comment:
    ```php
    // =========================================================================
    // NORMALIZED DATA ACCESS (PERF-06)
    // =========================================================================
    ```
  </action>
  <verify>
    VideoWizard has new methods:
    ```bash
    grep -n "sceneIds\|normalizedSceneCount\|getSceneData\|usesNormalizedData\|normalizedSceneToArray" modules/AppVideoWizard/app/Livewire/VideoWizard.php
    ```
    Should show 5 method definitions.
  </verify>
  <done>
    VideoWizard can access scene data from normalized tables with automatic fallback to JSON, backward compatibility maintained
  </done>
</task>

</tasks>

<verification>
Test data migration command:
```bash
# Dry run on a test project
php artisan wizard:normalize-data --project=1 --dry-run

# Actually migrate one project
php artisan wizard:normalize-data --project=1

# Verify data was created
php artisan tinker
>>> \Modules\AppVideoWizard\Models\WizardProject::find(1)->scenes()->count()
>>> \Modules\AppVideoWizard\Models\WizardProject::find(1)->usesNormalizedData()
```

Test VideoWizard dual-mode:
```bash
# Load wizard and check computed properties work
php artisan tinker
>>> $wizard = new \Modules\AppVideoWizard\Livewire\VideoWizard();
>>> $wizard->mount(1); // Load project 1
>>> $wizard->usesNormalizedData()
>>> $wizard->sceneIds
>>> $wizard->getSceneData(0)
```
</verification>

<success_criteria>
1. wizard:normalize-data command exists with --project, --dry-run, --force options
2. Command successfully migrates JSON data to normalized tables
3. VideoWizard::sceneIds() returns correct IDs from either source
4. VideoWizard::getSceneData() returns array in consistent format
5. Existing $script/$storyboard properties still work (backward compatibility)
</success_criteria>

<output>
After completion, create `.planning/phases/21-data-normalization/21-02-SUMMARY.md`
</output>
