---
phase: 21-data-normalization
plan: 03
type: execute
wave: 3
depends_on: ["21-02"]
files_modified:
  - modules/AppVideoWizard/app/Livewire/Components/SceneCard.php
  - modules/AppVideoWizard/resources/views/livewire/components/scene-card.blade.php
  - modules/AppVideoWizard/resources/views/livewire/components/scene-card-placeholder.blade.php
  - modules/AppVideoWizard/resources/views/livewire/steps/storyboard.blade.php
autonomous: false

must_haves:
  truths:
    - "Scene data is loaded only when scene card enters viewport"
    - "Placeholder shows while scene is loading"
    - "Loaded scene displays correct data (narration, image, status)"
    - "Non-migrated projects still display scenes from JSON"
  artifacts:
    - path: "modules/AppVideoWizard/app/Livewire/Components/SceneCard.php"
      provides: "Lazy-loaded scene card component"
      contains: "#[Lazy]"
    - path: "modules/AppVideoWizard/resources/views/livewire/components/scene-card.blade.php"
      provides: "Scene card template"
      min_lines: 30
    - path: "modules/AppVideoWizard/resources/views/livewire/components/scene-card-placeholder.blade.php"
      provides: "Loading placeholder template"
      min_lines: 10
  key_links:
    - from: "modules/AppVideoWizard/app/Livewire/Components/SceneCard.php"
      to: "modules/AppVideoWizard/app/Models/WizardScene.php"
      via: "computed property query"
      pattern: "WizardScene::with"
    - from: "modules/AppVideoWizard/resources/views/livewire/steps/storyboard.blade.php"
      to: "modules/AppVideoWizard/app/Livewire/Components/SceneCard.php"
      via: "livewire component"
      pattern: "<livewire:app-video-wizard::components.scene-card"
---

<objective>
Implement lazy-loaded scene cards for on-demand scene data loading

Purpose: Load scene data only when visible in viewport, reducing initial payload from ~2MB to ~50KB for large projects (PERF-07)
Output: SceneCard Livewire component with #[Lazy] attribute, placeholder view, and updated storyboard blade
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-data-normalization/21-RESEARCH.md

# Prior plans
@.planning/phases/21-data-normalization/21-01-SUMMARY.md
@.planning/phases/21-data-normalization/21-02-SUMMARY.md

# Reference existing modal component patterns
@modules/AppVideoWizard/app/Livewire/Modals/CharacterBibleModal.php
@modules/AppVideoWizard/resources/views/livewire/steps/storyboard.blade.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lazy-loaded SceneCard component</name>
  <files>
    modules/AppVideoWizard/app/Livewire/Components/SceneCard.php
    modules/AppVideoWizard/resources/views/livewire/components/scene-card.blade.php
    modules/AppVideoWizard/resources/views/livewire/components/scene-card-placeholder.blade.php
  </files>
  <action>
    **Create Components directory if needed:**
    ```
    mkdir -p modules/AppVideoWizard/app/Livewire/Components
    mkdir -p modules/AppVideoWizard/resources/views/livewire/components
    ```

    **Create SceneCard.php** following the Livewire 3 lazy loading pattern from 21-RESEARCH.md:

    ```php
    <?php

    namespace Modules\AppVideoWizard\Livewire\Components;

    use Livewire\Attributes\Lazy;
    use Livewire\Attributes\Locked;
    use Livewire\Attributes\Computed;
    use Livewire\Component;
    use Modules\AppVideoWizard\Models\WizardScene;
    use Modules\AppVideoWizard\Models\WizardProject;

    #[Lazy]
    class SceneCard extends Component
    {
        // Scene identifier - either database ID (normalized) or array index (JSON)
        #[Locked]
        public int|string $sceneId;

        #[Locked]
        public int $projectId;

        // Whether this scene uses normalized data
        #[Locked]
        public bool $isNormalized = false;

        // Scene index for display (0-based)
        #[Locked]
        public int $sceneIndex;

        // JSON scene data passed from parent (for non-normalized projects)
        public ?array $jsonSceneData = null;

        public function mount(
            int|string $sceneId,
            int $projectId,
            int $sceneIndex,
            bool $isNormalized = false,
            ?array $jsonSceneData = null
        ): void {
            $this->sceneId = $sceneId;
            $this->projectId = $projectId;
            $this->sceneIndex = $sceneIndex;
            $this->isNormalized = $isNormalized;
            $this->jsonSceneData = $jsonSceneData;
        }

        #[Computed]
        public function scene(): ?array
        {
            if ($this->isNormalized) {
                $scene = WizardScene::with(['shots', 'speechSegments'])
                    ->find($this->sceneId);

                if (!$scene) {
                    return null;
                }

                return $this->normalizedToArray($scene);
            }

            // Return JSON data directly
            return $this->jsonSceneData;
        }

        protected function normalizedToArray(WizardScene $scene): array
        {
            return [
                'id' => $scene->id,
                'narration' => $scene->narration,
                'visualPrompt' => $scene->visual_prompt,
                'duration' => $scene->duration,
                'speechType' => $scene->speech_type,
                'transition' => $scene->transition,
                'imageUrl' => $scene->image_url,
                'imageStatus' => $scene->image_status,
                'prompt' => $scene->image_prompt,
                'videoUrl' => $scene->video_url,
                'videoStatus' => $scene->video_status,
                'voiceoverUrl' => $scene->voiceover_url,
                'speechSegments' => $scene->speechSegments->map(fn($s) => [
                    'id' => $s->id,
                    'type' => $s->type,
                    'text' => $s->text,
                    'speaker' => $s->speaker,
                    'characterId' => $s->character_id,
                    'voiceId' => $s->voice_id,
                ])->toArray(),
                'shots' => $scene->shots->map(fn($shot) => [
                    'id' => $shot->id,
                    'imagePrompt' => $shot->image_prompt,
                    'videoPrompt' => $shot->video_prompt,
                    'cameraMovement' => $shot->camera_movement,
                    'duration' => $shot->duration,
                    'imageUrl' => $shot->image_url,
                    'videoUrl' => $shot->video_url,
                    'imageStatus' => $shot->image_status,
                    'videoStatus' => $shot->video_status,
                ])->toArray(),
            ];
        }

        public function placeholder(): \Illuminate\Contracts\View\View
        {
            return view('appvideowizard::livewire.components.scene-card-placeholder', [
                'sceneIndex' => $this->sceneIndex,
            ]);
        }

        public function render(): \Illuminate\Contracts\View\View
        {
            return view('appvideowizard::livewire.components.scene-card');
        }
    }
    ```

    **Create scene-card.blade.php** - Extract scene card markup from storyboard.blade.php:

    The view should display:
    - Scene number header (Scene {{ $sceneIndex + 1 }})
    - Scene image (or placeholder if no imageUrl)
    - Image status indicator (pending/generating/ready/error)
    - Narration text (truncated with ellipsis)
    - Duration badge
    - Shots count badge (if multi-shot mode and shots exist)
    - Action buttons (regenerate, edit, etc.) - dispatch events to parent

    Use `$this->scene` computed property to access scene data.
    If `$this->scene` is null, show error state.

    Structure:
    ```blade
    <div class="scene-card bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden"
         wire:key="scene-card-{{ $sceneId }}">
        @if($this->scene)
            {{-- Scene image --}}
            <div class="aspect-video relative">
                @if($this->scene['imageUrl'])
                    <img src="{{ $this->scene['imageUrl'] }}"
                         alt="Scene {{ $sceneIndex + 1 }}"
                         class="w-full h-full object-cover">
                @else
                    <div class="w-full h-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
                        <span class="text-gray-400">No image</span>
                    </div>
                @endif

                {{-- Status badge --}}
                <div class="absolute top-2 right-2">
                    <span class="px-2 py-1 text-xs rounded-full
                        @if($this->scene['imageStatus'] === 'ready') bg-green-500 text-white
                        @elseif($this->scene['imageStatus'] === 'generating') bg-yellow-500 text-white
                        @elseif($this->scene['imageStatus'] === 'error') bg-red-500 text-white
                        @else bg-gray-500 text-white @endif">
                        {{ ucfirst($this->scene['imageStatus'] ?? 'pending') }}
                    </span>
                </div>
            </div>

            {{-- Scene info --}}
            <div class="p-4">
                <h4 class="font-semibold text-sm text-gray-900 dark:text-white mb-2">
                    Scene {{ $sceneIndex + 1 }}
                </h4>
                <p class="text-sm text-gray-600 dark:text-gray-300 line-clamp-2">
                    {{ $this->scene['narration'] ?? 'No narration' }}
                </p>

                {{-- Badges --}}
                <div class="mt-3 flex items-center gap-2 text-xs">
                    <span class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded">
                        {{ $this->scene['duration'] ?? 8 }}s
                    </span>
                    @if(count($this->scene['shots'] ?? []) > 0)
                        <span class="bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 px-2 py-1 rounded">
                            {{ count($this->scene['shots']) }} shots
                        </span>
                    @endif
                </div>
            </div>
        @else
            <div class="p-4 text-center text-gray-500">
                Scene data unavailable
            </div>
        @endif
    </div>
    ```

    **Create scene-card-placeholder.blade.php** - Loading skeleton:
    ```blade
    <div class="scene-card bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden animate-pulse"
         wire:key="scene-card-placeholder-{{ $sceneIndex }}">
        {{-- Skeleton image --}}
        <div class="aspect-video bg-gray-200 dark:bg-gray-700"></div>

        {{-- Skeleton content --}}
        <div class="p-4">
            <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-1/4 mb-2"></div>
            <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-full mb-1"></div>
            <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-3/4"></div>

            <div class="mt-3 flex items-center gap-2">
                <div class="h-5 w-12 bg-gray-200 dark:bg-gray-700 rounded"></div>
            </div>
        </div>
    </div>
    ```

    Note: The SceneCard is a READ-ONLY display component. Scene editing still happens through the parent VideoWizard's existing mechanisms. The SceneCard dispatches events like `$dispatch('edit-scene', ['index' => $sceneIndex])` that the parent handles.
  </action>
  <verify>
    Component and views exist:
    ```bash
    ls -la modules/AppVideoWizard/app/Livewire/Components/SceneCard.php
    ls -la modules/AppVideoWizard/resources/views/livewire/components/scene-card*.blade.php
    grep "#\[Lazy\]" modules/AppVideoWizard/app/Livewire/Components/SceneCard.php
    ```
  </verify>
  <done>
    SceneCard Livewire component with #[Lazy] attribute, placeholder view, and main view displaying scene data
  </done>
</task>

<task type="auto">
  <name>Task 2: Update storyboard blade to use SceneCard components</name>
  <files>
    modules/AppVideoWizard/resources/views/livewire/steps/storyboard.blade.php
  </files>
  <action>
    Update the storyboard step blade template to use lazy-loaded SceneCard components instead of inline scene rendering.

    **Find the scene grid/list section** in storyboard.blade.php that iterates over scenes. This is typically a @foreach loop rendering scene cards.

    **Replace inline scene cards with SceneCard component:**

    Before (example pattern):
    ```blade
    @foreach($script['scenes'] ?? [] as $index => $scene)
        <div class="scene-card ...">
            {{-- inline scene rendering --}}
        </div>
    @endforeach
    ```

    After (using lazy SceneCard):
    ```blade
    @php
        $isNormalized = $this->usesNormalizedData();
        $sceneCount = $isNormalized
            ? $this->normalizedSceneCount
            : count($script['scenes'] ?? []);
    @endphp

    @if($isNormalized)
        {{-- Normalized data: pass scene IDs for lazy loading --}}
        @foreach($this->sceneIds as $index => $sceneId)
            <livewire:app-video-wizard::components.scene-card
                :scene-id="$sceneId"
                :project-id="$project->id"
                :scene-index="$index"
                :is-normalized="true"
                :json-scene-data="null"
                lazy
                wire:key="scene-card-{{ $sceneId }}"
            />
        @endforeach
    @else
        {{-- JSON fallback: pass scene data directly --}}
        @foreach($script['scenes'] ?? [] as $index => $scene)
            <livewire:app-video-wizard::components.scene-card
                :scene-id="$index"
                :project-id="$project->id"
                :scene-index="$index"
                :is-normalized="false"
                :json-scene-data="$scene"
                lazy
                wire:key="scene-card-json-{{ $index }}"
            />
        @endforeach
    @endif
    ```

    **Important considerations:**
    1. Keep existing scene card styling/grid layout - only replace the inner content
    2. The `lazy` attribute on the livewire component triggers viewport-based loading
    3. wire:key must be unique and stable (use database ID for normalized, index for JSON)
    4. If storyboard has pagination, apply to sceneIds array before iteration
    5. Keep any existing empty state handling ("No scenes generated yet")

    **DO NOT remove other storyboard functionality:**
    - Scene inspector modal triggers
    - Bulk action buttons
    - Generation controls
    - Scene ordering/drag-drop (if exists)

    These continue to work through the parent VideoWizard's existing mechanisms. SceneCard is display-only.

    **If the storyboard has complex conditional rendering** (e.g., multi-shot vs single-shot modes), ensure both modes use SceneCard with appropriate data.
  </action>
  <verify>
    Storyboard uses SceneCard component:
    ```bash
    grep -n "livewire:app-video-wizard::components.scene-card\|SceneCard" modules/AppVideoWizard/resources/views/livewire/steps/storyboard.blade.php
    grep -n "lazy\|isNormalized" modules/AppVideoWizard/resources/views/livewire/steps/storyboard.blade.php
    ```
  </verify>
  <done>
    Storyboard blade updated to render scenes via lazy-loaded SceneCard components with normalized/JSON dual-mode support
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify lazy loading behavior</name>
  <what-built>
    Lazy-loaded scene cards that load data on-demand as they enter the viewport. This should significantly reduce initial page load for projects with many scenes.
  </what-built>
  <how-to-verify>
    1. Open browser DevTools Network tab
    2. Load a migrated project with 10+ scenes in the Storyboard step
    3. Observe:
       - Initial page load should NOT include all scene data
       - Scroll down - additional Livewire requests should fire as cards enter viewport
       - Each request should be small (~1-5KB per scene)
    4. Verify scene data displays correctly:
       - Scene numbers are correct
       - Images load properly
       - Status badges show correct state
       - Narration text appears
    5. Test JSON fallback:
       - Load a non-migrated project
       - Scenes should still display (from JSON data)
    6. Test placeholder:
       - On slow connection, placeholders should show while loading
  </how-to-verify>
  <resume-signal>Type "approved" if lazy loading works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Functional verification:
1. Load project in Storyboard step
2. Open DevTools Network tab
3. Confirm lazy loading (requests fire on scroll)
4. Confirm scene data displays correctly
5. Confirm non-migrated projects still work

Performance verification:
- Compare initial payload size before/after
- Target: 90% reduction for large projects (100+ scenes)
</verification>

<success_criteria>
1. SceneCard component exists with #[Lazy] attribute
2. Placeholder displays during load
3. Scene data loads only when card enters viewport
4. Both normalized and JSON data modes work
5. User approves visual and functional behavior
</success_criteria>

<output>
After completion, create `.planning/phases/21-data-normalization/21-03-SUMMARY.md`
</output>
