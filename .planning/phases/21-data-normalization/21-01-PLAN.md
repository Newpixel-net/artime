---
phase: 21-data-normalization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/AppVideoWizard/database/migrations/2026_01_27_000001_create_wizard_scenes_table.php
  - modules/AppVideoWizard/database/migrations/2026_01_27_000002_create_wizard_shots_table.php
  - modules/AppVideoWizard/database/migrations/2026_01_27_000003_create_wizard_speech_segments_table.php
  - modules/AppVideoWizard/app/Models/WizardScene.php
  - modules/AppVideoWizard/app/Models/WizardShot.php
  - modules/AppVideoWizard/app/Models/WizardSpeechSegment.php
  - modules/AppVideoWizard/app/Models/WizardProject.php
autonomous: true

must_haves:
  truths:
    - "WizardScene model can be created and queried"
    - "WizardShot model can be created and queried"
    - "WizardSpeechSegment model can be created and queried"
    - "Relationships work: Project hasMany Scenes, Scene hasMany Shots/SpeechSegments"
  artifacts:
    - path: "modules/AppVideoWizard/database/migrations/2026_01_27_000001_create_wizard_scenes_table.php"
      provides: "wizard_scenes table schema"
      contains: "Schema::create('wizard_scenes'"
    - path: "modules/AppVideoWizard/database/migrations/2026_01_27_000002_create_wizard_shots_table.php"
      provides: "wizard_shots table schema"
      contains: "Schema::create('wizard_shots'"
    - path: "modules/AppVideoWizard/database/migrations/2026_01_27_000003_create_wizard_speech_segments_table.php"
      provides: "wizard_speech_segments table schema"
      contains: "Schema::create('wizard_speech_segments'"
    - path: "modules/AppVideoWizard/app/Models/WizardScene.php"
      provides: "WizardScene Eloquent model"
      exports: ["WizardScene"]
    - path: "modules/AppVideoWizard/app/Models/WizardShot.php"
      provides: "WizardShot Eloquent model"
      exports: ["WizardShot"]
    - path: "modules/AppVideoWizard/app/Models/WizardSpeechSegment.php"
      provides: "WizardSpeechSegment Eloquent model"
      exports: ["WizardSpeechSegment"]
  key_links:
    - from: "modules/AppVideoWizard/app/Models/WizardScene.php"
      to: "modules/AppVideoWizard/app/Models/WizardProject.php"
      via: "belongsTo relationship"
      pattern: "belongsTo\\(WizardProject::class"
    - from: "modules/AppVideoWizard/app/Models/WizardShot.php"
      to: "modules/AppVideoWizard/app/Models/WizardScene.php"
      via: "belongsTo relationship"
      pattern: "belongsTo\\(WizardScene::class"
    - from: "modules/AppVideoWizard/app/Models/WizardProject.php"
      to: "modules/AppVideoWizard/app/Models/WizardScene.php"
      via: "hasMany relationship"
      pattern: "hasMany\\(WizardScene::class"
---

<objective>
Create database schema and Eloquent models for normalized scene/shot data

Purpose: Replace nested JSON arrays with proper relational database tables to enable lazy loading and reduce Livewire payload size (PERF-06)
Output: Three migrations creating wizard_scenes, wizard_shots, wizard_speech_segments tables, plus three Eloquent models with proper relationships
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-data-normalization/21-RESEARCH.md

# Reference existing model structure
@modules/AppVideoWizard/app/Models/WizardProject.php
@modules/AppVideoWizard/database/migrations/2026_01_05_000001_create_wizard_projects_table.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migrations</name>
  <files>
    modules/AppVideoWizard/database/migrations/2026_01_27_000001_create_wizard_scenes_table.php
    modules/AppVideoWizard/database/migrations/2026_01_27_000002_create_wizard_shots_table.php
    modules/AppVideoWizard/database/migrations/2026_01_27_000003_create_wizard_speech_segments_table.php
  </files>
  <action>
    Create three migration files following the patterns from 21-RESEARCH.md:

    **wizard_scenes table:**
    - id, project_id (FK to wizard_projects with cascade delete)
    - order (unsigned integer for scene position)
    - Script fields: narration (text), visual_prompt (text), duration (smallint default 8), speech_type (varchar 20 default 'voiceover'), transition (varchar 20 default 'cut')
    - Storyboard fields: image_url (varchar 500), image_status (varchar 20 default 'pending'), image_prompt (text), image_job_id (varchar 100)
    - Animation fields: video_url (varchar 500), video_status (varchar 20 default 'pending'), voiceover_url (varchar 500)
    - scene_metadata (JSON for less-frequent fields like voiceover settings, character associations)
    - timestamps
    - Indexes: [project_id, order], image_status, video_status

    **wizard_shots table:**
    - id, scene_id (FK to wizard_scenes with cascade delete)
    - order (unsigned tinyint for shot position within scene)
    - Prompts: image_prompt (text), video_prompt (text)
    - Technical: camera_movement (varchar 50), duration (tinyint default 5), duration_class (varchar 20 default 'short')
    - Assets: image_url (varchar 500), image_status (varchar 20), video_url (varchar 500), video_status (varchar 20)
    - dialogue (text for shot-specific dialogue)
    - shot_metadata (JSON for speaking_characters, etc.)
    - timestamps
    - Indexes: [scene_id, order], image_status, video_status

    **wizard_speech_segments table:**
    - id, scene_id (FK to wizard_scenes with cascade delete)
    - order (unsigned tinyint for segment position)
    - Segment data: type (varchar 20 default 'narrator'), text (text), speaker (varchar 100), character_id (varchar 50), voice_id (varchar 50)
    - Timing: start_time (float), duration (float)
    - Audio: audio_url (varchar 500)
    - Attributes: emotion (varchar 50), needs_lip_sync (boolean default false)
    - timestamps
    - Indexes: [scene_id, order], type

    Use the exact column types and default values from the research document.
  </action>
  <verify>
    Migration files exist and have valid PHP syntax:
    - ls modules/AppVideoWizard/database/migrations/2026_01_27_*.php
    - Each file should be ~60-80 lines
  </verify>
  <done>
    Three migration files created with correct schema including foreign keys, indexes, and appropriate column types
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Eloquent models with relationships</name>
  <files>
    modules/AppVideoWizard/app/Models/WizardScene.php
    modules/AppVideoWizard/app/Models/WizardShot.php
    modules/AppVideoWizard/app/Models/WizardSpeechSegment.php
    modules/AppVideoWizard/app/Models/WizardProject.php
  </files>
  <action>
    Create three new Eloquent models following Laravel conventions and the patterns from 21-RESEARCH.md:

    **WizardScene.php:**
    - Namespace: Modules\AppVideoWizard\Models
    - Table: wizard_scenes
    - Fillable: all columns except id and timestamps
    - Casts: order (integer), duration (integer), scene_metadata (array)
    - Relationships:
      - project(): BelongsTo WizardProject (project_id)
      - shots(): HasMany WizardShot (scene_id), ordered by order
      - speechSegments(): HasMany WizardSpeechSegment (scene_id), ordered by order

    **WizardShot.php:**
    - Namespace: Modules\AppVideoWizard\Models
    - Table: wizard_shots
    - Fillable: all columns except id and timestamps
    - Casts: order (integer), duration (integer), shot_metadata (array)
    - Relationships:
      - scene(): BelongsTo WizardScene (scene_id)

    **WizardSpeechSegment.php:**
    - Namespace: Modules\AppVideoWizard\Models
    - Table: wizard_speech_segments
    - Fillable: all columns except id and timestamps
    - Casts: order (integer), start_time (float), duration (float), needs_lip_sync (boolean)
    - Relationships:
      - scene(): BelongsTo WizardScene (scene_id)

    **Update WizardProject.php** - Add new relationship and helper methods:
    - Add `use` statement for WizardScene at top
    - Add scenes() relationship: HasMany WizardScene (project_id), ordered by order
    - Add usesNormalizedData(): bool - returns $this->scenes()->exists()
    - Update getSceneCount(): int - check normalized first, fallback to JSON
    - DO NOT remove existing methods (backward compatibility)

    Follow existing model conventions in the codebase (see WizardProject.php for reference).
  </action>
  <verify>
    Model files exist and have correct structure:
    - ls modules/AppVideoWizard/app/Models/Wizard*.php
    - grep "belongsTo\|hasMany" modules/AppVideoWizard/app/Models/WizardScene.php
    - grep "scenes()" modules/AppVideoWizard/app/Models/WizardProject.php
  </verify>
  <done>
    Three new Eloquent models created with proper relationships, WizardProject updated with scenes() relationship and dual-mode helpers
  </done>
</task>

</tasks>

<verification>
Run migrations to verify schema is valid:
```bash
php artisan migrate --path=modules/AppVideoWizard/database/migrations
```

Test relationships work (tinker or simple test):
```php
// In tinker or test
$project = WizardProject::first();
$project->scenes; // Should return empty collection
$project->usesNormalizedData(); // Should return false

$scene = WizardScene::create([
    'project_id' => $project->id,
    'order' => 0,
    'narration' => 'Test scene',
]);
$scene->project; // Should return the project
$project->usesNormalizedData(); // Should return true now
```
</verification>

<success_criteria>
1. wizard_scenes, wizard_shots, wizard_speech_segments tables exist in database
2. WizardScene, WizardShot, WizardSpeechSegment models work with Eloquent
3. All BelongsTo and HasMany relationships query correctly
4. WizardProject->scenes() returns ordered collection
5. WizardProject->usesNormalizedData() correctly detects normalized vs JSON data
</success_criteria>

<output>
After completion, create `.planning/phases/21-data-normalization/21-01-SUMMARY.md`
</output>
