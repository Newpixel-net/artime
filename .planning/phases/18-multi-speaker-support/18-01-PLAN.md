---
phase: 18-multi-speaker-support
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/AppVideoWizard/app/Livewire/VideoWizard.php
autonomous: true

must_haves:
  truths:
    - "Shots with multiple speakers have all speakers tracked in speakers array"
    - "Each speaker entry includes name, voiceId, text, and order"
    - "Backward compatibility: speakingCharacter and voiceId fields remain populated with first speaker"
    - "Voice lookups use VoiceRegistryService for consistency"
    - "Empty speaker text is filtered out"
  artifacts:
    - path: "modules/AppVideoWizard/app/Livewire/VideoWizard.php"
      provides: "Multi-speaker shot data structure"
      contains: "speakers"
      contains: "isMultiSpeaker"
      contains: "speakerCount"
  key_links:
    - from: "VideoWizard.php shot population"
      to: "VoiceRegistryService"
      via: "getVoiceForCharacter() callback pattern"
      pattern: "voiceRegistry->getVoiceForCharacter"
---

<objective>
Expand shot data structure in VideoWizard.php to support multiple speakers per shot.

Purpose: Currently only the first speaker is extracted from shots with multiple speakers. This refactors the two locations (~lines 23335 and 23865) to build a complete `speakers` array containing all speakers with their voice IDs and text, enabling downstream TTS processing to handle multi-voice dialogue.

Output: VideoWizard.php modified to populate `speakers` array with full speaker data while maintaining backward compatibility with existing single-speaker fields.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-multi-speaker-support/18-RESEARCH.md
@.planning/phases/17-voice-registry/17-02-SUMMARY.md

# VoiceRegistryService for voice lookups
@modules/AppVideoWizard/app/Services/VoiceRegistryService.php

# Target file - focus on lines 23320-23345 and 23850-23895
@modules/AppVideoWizard/app/Livewire/VideoWizard.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add helper method for building speaker entries</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Add a new protected method `buildSpeakersArray()` after the `getVoiceForCharacterName()` method (around line 23388).

```php
/**
 * Build speakers array from shot speakers data (VOC-06).
 *
 * Creates structured speaker entries for multi-speaker shots, using
 * VoiceRegistryService for voice lookups to ensure consistency.
 *
 * @param array $shotSpeakers Array of speaker => text mappings
 * @return array Array of speaker entries with name, voiceId, text, order
 */
protected function buildSpeakersArray(array $shotSpeakers): array
{
    $speakersArray = [];
    $order = 0;

    foreach ($shotSpeakers as $speakerName => $speakerText) {
        // Skip empty text (VOC-02 pattern)
        if (empty(trim($speakerText))) {
            Log::debug('Skipping speaker with empty text in multi-speaker array (VOC-06)', [
                'speaker' => $speakerName,
            ]);
            continue;
        }

        // Use VoiceRegistryService if available, fallback to direct lookup
        if ($this->voiceRegistry !== null) {
            $voiceId = $this->voiceRegistry->getVoiceForCharacter(
                $speakerName,
                fn($name) => $this->getVoiceForCharacterName($name)
            );
        } else {
            $voiceId = $this->getVoiceForCharacterName($speakerName);
        }

        $speakersArray[] = [
            'name' => $speakerName,
            'voiceId' => $voiceId,
            'text' => $speakerText,
            'order' => $order,
        ];

        $order++;
    }

    return $speakersArray;
}
```

This method:
- Iterates all speakers (not just first)
- Uses VoiceRegistryService with fallback (null-check pattern from Phase 17)
- Filters empty text (VOC-02 pattern)
- Returns structured array matching research specification
  </action>
  <verify>
Grep: `grep -n "function buildSpeakersArray" modules/AppVideoWizard/app/Livewire/VideoWizard.php` - method exists
Grep: `grep "VOC-06" modules/AppVideoWizard/app/Livewire/VideoWizard.php` - VOC-06 tag present
  </verify>
  <done>
buildSpeakersArray() method exists and handles voice registry integration with fallback
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor first speaker extraction in assignDialogueToShots</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Locate the code block around lines 23334-23340 in `assignDialogueToShots()` method:

```php
// BEFORE (current ~line 23334-23340):
// Assign voice based on first speaking character
$firstSpeaker = array_keys($shotSpeakers)[0] ?? null;
if ($firstSpeaker) {
    $voice = $this->getVoiceForCharacterName($firstSpeaker);
    $this->multiShotMode['decomposedScenes'][$sceneIndex]['shots'][$shotIndex]['voiceId'] = $voice;
}
```

Replace with multi-speaker array population:

```php
// Build multi-speaker array (VOC-06)
$speakersArray = $this->buildSpeakersArray($shotSpeakers);

if (!empty($speakersArray)) {
    // Set multi-speaker data
    $this->multiShotMode['decomposedScenes'][$sceneIndex]['shots'][$shotIndex]['speakers'] = $speakersArray;
    $this->multiShotMode['decomposedScenes'][$sceneIndex]['shots'][$shotIndex]['speakerCount'] = count($speakersArray);
    $this->multiShotMode['decomposedScenes'][$sceneIndex]['shots'][$shotIndex]['isMultiSpeaker'] = count($speakersArray) > 1;

    // Backward compatibility: populate single-speaker fields from first speaker
    $this->multiShotMode['decomposedScenes'][$sceneIndex]['shots'][$shotIndex]['speakingCharacter'] = $speakersArray[0]['name'];
    $this->multiShotMode['decomposedScenes'][$sceneIndex]['shots'][$shotIndex]['voiceId'] = $speakersArray[0]['voiceId'];
}
```

This maintains backward compatibility while adding multi-speaker support.
  </action>
  <verify>
Grep: `grep -n "isMultiSpeaker" modules/AppVideoWizard/app/Livewire/VideoWizard.php` - new field populated
Grep: `grep -n "speakerCount" modules/AppVideoWizard/app/Livewire/VideoWizard.php` - count field exists
Grep: `grep -A5 "Build multi-speaker array" modules/AppVideoWizard/app/Livewire/VideoWizard.php` - VOC-06 comment present
  </verify>
  <done>
assignDialogueToShots() builds speakers array and maintains speakingCharacter/voiceId for backward compatibility
  </done>
</task>

<task type="auto">
  <name>Task 3: Refactor first speaker extraction in distributeSegmentsToShots</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Locate the code block around lines 23864-23870 in `distributeSegmentsToShots()` method (or similar shot population method):

```php
// BEFORE (current ~line 23864-23870):
// Assign voice from first speaking character
$firstSpeaker = array_keys($speakers)[0] ?? null;
if ($firstSpeaker) {
    $voice = $this->getVoiceForCharacterName($firstSpeaker);
    $this->multiShotMode['decomposedScenes'][$sceneIndex]['shots'][$shotIdx]['voiceId'] = $voice;
    $this->multiShotMode['decomposedScenes'][$sceneIndex]['shots'][$shotIdx]['speakingCharacter'] = $firstSpeaker;
}
```

Replace with multi-speaker array population (same pattern as Task 2):

```php
// Build multi-speaker array (VOC-06)
$speakersArray = $this->buildSpeakersArray($speakers);

if (!empty($speakersArray)) {
    // Set multi-speaker data
    $this->multiShotMode['decomposedScenes'][$sceneIndex]['shots'][$shotIdx]['speakers'] = $speakersArray;
    $this->multiShotMode['decomposedScenes'][$sceneIndex]['shots'][$shotIdx]['speakerCount'] = count($speakersArray);
    $this->multiShotMode['decomposedScenes'][$sceneIndex]['shots'][$shotIdx]['isMultiSpeaker'] = count($speakersArray) > 1;

    // Backward compatibility: populate single-speaker fields from first speaker
    $this->multiShotMode['decomposedScenes'][$sceneIndex]['shots'][$shotIdx]['speakingCharacter'] = $speakersArray[0]['name'];
    $this->multiShotMode['decomposedScenes'][$sceneIndex]['shots'][$shotIdx]['voiceId'] = $speakersArray[0]['voiceId'];
}
```

Ensure the variable name matches the method context (`$speakers` vs `$shotSpeakers`, `$shotIdx` vs `$shotIndex`).
  </action>
  <verify>
Grep: `grep -c "buildSpeakersArray" modules/AppVideoWizard/app/Livewire/VideoWizard.php` - returns 3 (1 definition + 2 calls)
Grep: `grep -c "isMultiSpeaker" modules/AppVideoWizard/app/Livewire/VideoWizard.php` - returns 2 (both locations)
  </verify>
  <done>
Both speaker extraction locations refactored to use buildSpeakersArray(), both populate speakers array and maintain backward compatibility
  </done>
</task>

</tasks>

<verification>
1. Method exists: `grep "function buildSpeakersArray" modules/AppVideoWizard/app/Livewire/VideoWizard.php`
2. VOC-06 tagged: `grep -c "VOC-06" modules/AppVideoWizard/app/Livewire/VideoWizard.php` - at least 3 occurrences
3. Both locations updated: `grep -c "buildSpeakersArray" modules/AppVideoWizard/app/Livewire/VideoWizard.php` - returns 3
4. Multi-speaker fields: `grep "isMultiSpeaker\|speakerCount" modules/AppVideoWizard/app/Livewire/VideoWizard.php`
5. Backward compat: `grep "Backward compatibility" modules/AppVideoWizard/app/Livewire/VideoWizard.php`
6. No syntax errors: `php -l modules/AppVideoWizard/app/Livewire/VideoWizard.php`
</verification>

<success_criteria>
- buildSpeakersArray() helper method exists with VoiceRegistry integration
- Both speaker extraction locations (assignDialogueToShots, distributeSegmentsToShots) refactored
- Shots with speakers have: speakers array, speakerCount, isMultiSpeaker fields
- Backward compatibility maintained: speakingCharacter and voiceId still populated from first speaker
- Empty speaker text filtered out (VOC-02 pattern)
- VoiceRegistryService used for voice lookups when available
- No PHP syntax errors
</success_criteria>

<output>
After completion, create `.planning/phases/18-multi-speaker-support/18-01-SUMMARY.md`
</output>
