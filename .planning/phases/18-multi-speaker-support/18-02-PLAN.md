---
phase: 18-multi-speaker-support
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php
  - modules/AppVideoWizard/app/Services/VoiceoverService.php
autonomous: true

must_haves:
  truths:
    - "DialogueSceneDecomposerService creates shots with speakers array initialized"
    - "VoiceoverService can process multi-speaker shots sequentially"
    - "Each speaker's audio is generated individually with their voice"
    - "Combined audio timing is calculated from actual durations"
    - "Backward compatibility: single-speaker shots still process correctly"
  artifacts:
    - path: "modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php"
      provides: "Multi-speaker shot initialization"
      contains: "speakers"
      contains: "speakerCount"
    - path: "modules/AppVideoWizard/app/Services/VoiceoverService.php"
      provides: "Multi-speaker TTS processing"
      contains: "processMultiSpeakerShot"
  key_links:
    - from: "DialogueSceneDecomposerService::createDialogueShot"
      to: "shot speakers array"
      via: "speakers field initialization"
      pattern: "'speakers' =>"
    - from: "VoiceoverService::processMultiSpeakerShot"
      to: "generateSceneVoiceover"
      via: "per-speaker TTS calls"
      pattern: "generateSceneVoiceover.*speaker"
---

<objective>
Integrate multi-speaker support into DialogueSceneDecomposerService and VoiceoverService.

Purpose: Complete the multi-speaker pipeline by:
1. Having DialogueSceneDecomposerService initialize shots with speakers array structure
2. Adding VoiceoverService method to process multi-speaker shots for TTS generation

Output: DialogueSceneDecomposerService initializes speakers array in createDialogueShot(); VoiceoverService has processMultiSpeakerShot() method for sequential TTS.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-multi-speaker-support/18-RESEARCH.md
@.planning/phases/18-multi-speaker-support/18-01-SUMMARY.md

# Target files
@modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php
@modules/AppVideoWizard/app/Services/VoiceoverService.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize speakers array in createDialogueShot</name>
  <files>modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php</files>
  <action>
Locate the `createDialogueShot()` method (around line 1393). Find the shot array construction (around line 1423-1442) and add speakers array initialization.

After the existing shot fields and before the return, add multi-speaker structure:

```php
// Existing shot array construction ends around line 1441
// Add after 'spatial' => $spatial line:

// VOC-06: Initialize speakers array for multi-speaker support
// Single dialogue shot = single speaker in array (VideoWizard may merge multiple)
$shot['speakers'] = [[
    'name' => $speaker,
    'voiceId' => $charData['voiceId'] ?? 'echo',
    'text' => $exchange['text'],
    'order' => 0,
]];
$shot['speakerCount'] = 1;
$shot['isMultiSpeaker'] = false;
```

This ensures every dialogue shot has a consistent `speakers` array structure, even for single-speaker shots. The VideoWizard may later merge additional speakers via `buildSpeakersArray()` when processing multiple speech segments per shot.

Note: Do NOT change the existing `speakingCharacter`, `voiceId`, `dialogue`, or `monologue` fields - those remain for backward compatibility.
  </action>
  <verify>
Grep: `grep -A8 "VOC-06: Initialize speakers array" modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php` - initialization present
Grep: `grep "'speakers' =>" modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php` - speakers field exists
Grep: `grep "speakerCount" modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php` - count field added
  </verify>
  <done>
createDialogueShot() initializes speakers array with single speaker entry, speakerCount=1, isMultiSpeaker=false
  </done>
</task>

<task type="auto">
  <name>Task 2: Add getSpeakersFromShot helper to VoiceoverService</name>
  <files>modules/AppVideoWizard/app/Services/VoiceoverService.php</files>
  <action>
Add a protected helper method to VoiceoverService that extracts speakers from a shot, handling both new multi-speaker format and legacy single-speaker format:

```php
/**
 * Get speakers array from shot data (VOC-06).
 *
 * Handles both new multi-speaker format and legacy single-speaker format
 * for backward compatibility.
 *
 * @param array $shot Shot data
 * @return array Array of speaker entries with name, voiceId, text, order
 */
protected function getSpeakersFromShot(array $shot): array
{
    // Prefer new multi-speaker array if present
    if (!empty($shot['speakers']) && is_array($shot['speakers'])) {
        return $shot['speakers'];
    }

    // Fall back to single speaker for legacy shots
    if (!empty($shot['speakingCharacter'])) {
        return [[
            'name' => $shot['speakingCharacter'],
            'voiceId' => $shot['voiceId'] ?? null,
            'text' => $shot['dialogue'] ?? $shot['monologue'] ?? '',
            'order' => 0,
        ]];
    }

    return [];
}
```

Add this method after the existing helper methods (around line 400-450 area, or wherever helper methods are grouped).
  </action>
  <verify>
Grep: `grep -n "function getSpeakersFromShot" modules/AppVideoWizard/app/Services/VoiceoverService.php` - method exists
Grep: `grep "VOC-06" modules/AppVideoWizard/app/Services/VoiceoverService.php` - VOC-06 tag present
  </verify>
  <done>
getSpeakersFromShot() helper exists with backward compatibility for legacy single-speaker shots
  </done>
</task>

<task type="auto">
  <name>Task 3: Add processMultiSpeakerShot method to VoiceoverService</name>
  <files>modules/AppVideoWizard/app/Services/VoiceoverService.php</files>
  <action>
Add a new public method `processMultiSpeakerShot()` that generates TTS audio for each speaker in sequence:

```php
/**
 * Process a multi-speaker shot, generating TTS for each speaker (VOC-06).
 *
 * Generates audio for each speaker sequentially with their assigned voice,
 * tracking timing for audio concatenation.
 *
 * @param WizardProject $project The project
 * @param array $shot Shot data with speakers array
 * @param array $options Additional options (sceneIndex, etc.)
 * @return array Result with speakers array (each with audioUrl, duration, startTime) and totalDuration
 */
public function processMultiSpeakerShot(WizardProject $project, array $shot, array $options = []): array
{
    $speakers = $this->getSpeakersFromShot($shot);

    if (empty($speakers)) {
        Log::warning('processMultiSpeakerShot called with no speakers (VOC-06)', [
            'shotId' => $shot['id'] ?? 'unknown',
        ]);
        return [
            'success' => false,
            'error' => 'No speakers in shot',
            'speakers' => [],
            'totalDuration' => 0,
        ];
    }

    $audioSegments = [];
    $currentTime = 0;
    $successCount = 0;

    foreach ($speakers as $index => $speaker) {
        $speakerText = trim($speaker['text'] ?? '');

        // Skip empty text (VOC-02 validation)
        if (empty($speakerText)) {
            Log::debug('Skipping speaker with empty text in processMultiSpeakerShot', [
                'speaker' => $speaker['name'] ?? 'unknown',
                'order' => $index,
            ]);
            continue;
        }

        try {
            // Generate TTS for this speaker using their voice
            $result = $this->generateSceneVoiceover($project, [
                'id' => ($shot['id'] ?? 'shot') . '-speaker-' . $index,
                'narration' => $speakerText,
            ], [
                'voice' => $speaker['voiceId'] ?? 'echo',
                'sceneIndex' => $options['sceneIndex'] ?? null,
            ]);

            if (isset($result['url']) || isset($result['audioUrl'])) {
                $audioUrl = $result['url'] ?? $result['audioUrl'];
                $duration = $result['duration'] ?? $this->estimateDuration($speakerText);

                $audioSegments[] = [
                    'name' => $speaker['name'],
                    'voiceId' => $speaker['voiceId'],
                    'text' => $speakerText,
                    'order' => $index,
                    'startTime' => $currentTime,
                    'duration' => $duration,
                    'audioUrl' => $audioUrl,
                ];

                $currentTime += $duration;
                $successCount++;
            }
        } catch (\Exception $e) {
            Log::error('Failed to generate TTS for speaker in multi-speaker shot (VOC-06)', [
                'speaker' => $speaker['name'] ?? 'unknown',
                'error' => $e->getMessage(),
            ]);
        }
    }

    Log::info('Multi-speaker shot TTS complete (VOC-06)', [
        'shotId' => $shot['id'] ?? 'unknown',
        'speakersProcessed' => $successCount,
        'totalSpeakers' => count($speakers),
        'totalDuration' => $currentTime,
    ]);

    return [
        'success' => $successCount > 0,
        'speakers' => $audioSegments,
        'totalDuration' => $currentTime,
        'isMultiSpeaker' => count($audioSegments) > 1,
        'speakerCount' => $successCount,
    ];
}

/**
 * Estimate duration for text based on word count.
 *
 * @param string $text Text to estimate
 * @return float Estimated duration in seconds
 */
protected function estimateDuration(string $text): float
{
    $wordCount = str_word_count($text);
    // Average speaking rate: 150 words per minute = 2.5 words per second
    return max(1.0, $wordCount / 2.5);
}
```

Place this after `generateSceneVoiceover()` method.
  </action>
  <verify>
Grep: `grep -n "function processMultiSpeakerShot" modules/AppVideoWizard/app/Services/VoiceoverService.php` - method exists
Grep: `grep "Multi-speaker shot TTS complete" modules/AppVideoWizard/app/Services/VoiceoverService.php` - log message present
Grep: `grep "function estimateDuration" modules/AppVideoWizard/app/Services/VoiceoverService.php` - helper exists
  </verify>
  <done>
processMultiSpeakerShot() method exists, processes each speaker sequentially, calculates timing, returns structured result
  </done>
</task>

</tasks>

<verification>
1. DialogueSceneDecomposerService has speakers initialization:
   `grep "'speakers' =>" modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php`
2. VoiceoverService has getSpeakersFromShot helper:
   `grep "function getSpeakersFromShot" modules/AppVideoWizard/app/Services/VoiceoverService.php`
3. VoiceoverService has processMultiSpeakerShot method:
   `grep "function processMultiSpeakerShot" modules/AppVideoWizard/app/Services/VoiceoverService.php`
4. VOC-06 tags present:
   `grep -c "VOC-06" modules/AppVideoWizard/app/Services/VoiceoverService.php` - at least 3
5. Syntax valid:
   `php -l modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php`
   `php -l modules/AppVideoWizard/app/Services/VoiceoverService.php`
</verification>

<success_criteria>
- DialogueSceneDecomposerService::createDialogueShot() initializes speakers array, speakerCount, isMultiSpeaker
- VoiceoverService::getSpeakersFromShot() handles both multi-speaker and legacy single-speaker formats
- VoiceoverService::processMultiSpeakerShot() generates TTS for each speaker with timing
- VOC-06 tags document multi-speaker support additions
- Backward compatibility: single-speaker shots work without changes
- No PHP syntax errors in either file
</success_criteria>

<output>
After completion, create `.planning/phases/18-multi-speaker-support/18-02-SUMMARY.md`
</output>
