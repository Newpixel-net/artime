---
phase: 14-cinematic-flow-action-scenes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php
autonomous: true

must_haves:
  truths:
    - "Consecutive shots with same type are flagged as potential jump cuts"
    - "Shot scale changes by at least one step between consecutive shots"
    - "Jump cut violations logged but video generation not halted"
  artifacts:
    - path: "modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php"
      provides: "Transition validation methods"
      contains: "validateAndFixTransitions"
  key_links:
    - from: "DialogueSceneDecomposerService.validateAndFixTransitions"
      to: "DialogueSceneDecomposerService.getShotSizeForType"
      via: "local method call for jump cut detection"
      pattern: "getShotSizeForType"
    - from: "DialogueSceneDecomposerService.getShotSizeForType"
      to: "shot scale numeric mapping"
      via: "local implementation matching ShotContinuityService"
      pattern: "getShotSizeForType.*extreme-close-up.*1"
---

<objective>
Add transition validation to prevent jarring cuts between consecutive shots

Purpose: Implement FLOW-03 requirement - shots build cinematically on each other. Uses local implementation of scale mapping to avoid cross-service dependency in the shot generation flow.

Output: validateAndFixTransitions() method that checks jump cuts and enforces scale changes
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-cinematic-flow-action-scenes/14-RESEARCH.md

# Key source files
@modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php
@modules/AppVideoWizard/app/Services/ShotContinuityService.php (reference only - line 1163 getShotSize for scale mapping reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add shot size mapping method</name>
  <files>modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php</files>
  <action>
Add a protected method `getShotSizeForType(string $type): int` that maps shot types to numeric scale values.

This mirrors ShotContinuityService.getShotSize() logic to avoid cross-service dependency:
```
extreme-close-up => 1
close-up => 1
medium-close-up => 2
medium-close => 2  (alias in $dialogueShotTypes)
medium => 2
over-the-shoulder => 3  (OTS is medium-ish distance)
medium-wide => 3
wide => 4
two-shot => 4  (typically wide framing)
extreme-wide => 5
establishing => 5
```

Add PHPDoc explaining this is for jump cut detection and scale change validation.
Place method near other utility methods (after selectShotTypeForIntensity or near end of class).
  </action>
  <verify>
Grep for "getShotSizeForType" confirms method exists with proper return values for extreme-close-up (1) and establishing (5).
  </verify>
  <done>Method returns correct numeric scale (1-5) for all shot types in $dialogueShotTypes plus common aliases.</done>
</task>

<task type="auto">
  <name>Task 2: Add validateAndFixTransitions method</name>
  <files>modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php</files>
  <action>
Add a public method `validateAndFixTransitions(array $shots): array` that:

1. Iterates through shots (starting at index 1 to compare with previous)
2. For each consecutive pair:
   a. Get previous and current shot types
   b. Call getShotSizeForType() on both
   c. Check for jump cut: same type OR adjacent size (diff < 1) with no movement change
   d. If jump cut detected:
      - Log warning with shot indices and types (non-blocking per prior decision)
      - Attempt fix: adjust current shot type to be at least one scale step different
   e. Check scale change requirement: if abs(currSize - prevSize) < 1:
      - Adjust current shot to be at least one step different (prefer stepping OUT, e.g., medium -> wide rather than medium -> close-up)

3. Return modified shots array with any adjustments

Add property `$scaleAdjusted = true` to any shot whose type was modified.

Log summary at end: total shots, jump cuts detected, scale adjustments made.

Example logic for scale adjustment:
```php
if ($currSize === $prevSize) {
    // Step out (to wider) if possible, else step in (to tighter)
    if ($currSize < 5) {
        $shots[$i]['type'] = $this->getWiderShotType($shots[$i]['type']);
    } else {
        $shots[$i]['type'] = $this->getTighterShotType($shots[$i]['type']);
    }
    $shots[$i]['scaleAdjusted'] = true;
}
```

Add helper methods getWiderShotType(string $type): string and getTighterShotType(string $type): string that step one level on the scale.
  </action>
  <verify>
Grep for "validateAndFixTransitions" confirms method exists.
Grep for "scaleAdjusted" confirms the flag is being set.
Grep for "Jump cut detected" or similar log message confirms logging is in place.
  </verify>
  <done>Method validates shot transitions, logs jump cuts (non-blocking), and adjusts shots to ensure minimum one-step scale change.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate validation into enhanceShotsWithDialoguePatterns</name>
  <files>modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php</files>
  <action>
In the `enhanceShotsWithDialoguePatterns()` method (around line 2078), add a call to validateAndFixTransitions() AFTER all shot type assignments are complete but BEFORE returning.

Find the return statement at the end of enhanceShotsWithDialoguePatterns() and insert just before it:
```php
// Phase 14: Validate and fix transitions (FLOW-03)
$shots = $this->validateAndFixTransitions($shots);
```

This ensures:
1. All shot types are assigned by position/emotion logic (Phase 13)
2. Single character constraint enforced (Phase 12)
3. THEN transition validation adjusts any jump cuts

The order matters: validation comes last so it can see the final shot types and make minimal adjustments.

Add PHPDoc comment referencing FLOW-03 requirement.
  </action>
  <verify>
Grep for "validateAndFixTransitions" in enhanceShotsWithDialoguePatterns confirms integration.
  </verify>
  <done>Transition validation runs on all speech-driven shots before return, completing FLOW-03 implementation.</done>
</task>

</tasks>

<verification>
1. All methods exist: getShotSizeForType, validateAndFixTransitions, getWiderShotType, getTighterShotType
2. validateAndFixTransitions is called in enhanceShotsWithDialoguePatterns
3. Log messages exist for jump cut detection (grep for "jump cut" case-insensitive)
4. Scale adjustment flag exists (grep for "scaleAdjusted")
</verification>

<success_criteria>
1. Consecutive shots with same type are detected as potential jump cuts and logged
2. Shot types are adjusted to ensure at least one-step scale change
3. Video generation continues (non-blocking validation per prior decision)
4. Modified shots have scaleAdjusted=true flag for debugging
</success_criteria>

<output>
After completion, create `.planning/phases/14-cinematic-flow-action-scenes/14-01-SUMMARY.md`
</output>
