---
phase: 13-dynamic-camera-intelligence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php
autonomous: true

must_haves:
  truths:
    - "High-intensity dialogue (anger, fear) uses close-up or tighter framing"
    - "Conversation opening uses wide or medium shots, never close-ups"
    - "Conversation climax uses tight close-ups"
    - "Each speaker's shot type reflects their emotional state from dialogue text"
    - "Neutral dialogue uses medium shots with OTS variety"
  artifacts:
    - path: "modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php"
      provides: "Position-enforced shot selection, speaker emotion analysis"
      contains: "analyzeSpeakerEmotion"
      exports: ["analyzeSpeakerEmotion", "selectShotTypeForIntensity"]
  key_links:
    - from: "enhanceShotsWithDialoguePatterns()"
      to: "analyzeSpeakerEmotion()"
      via: "method call in foreach loop"
      pattern: "analyzeSpeakerEmotion.*dialogue"
    - from: "selectShotTypeForIntensity()"
      to: "switch statement by position"
      via: "position-first logic"
      pattern: "switch.*position"
---

<objective>
Add dynamic camera intelligence that responds to emotion and conversation position.

Purpose: Implement CAM-01 through CAM-04 requirements so shot types automatically match emotional intensity, speaker emotion, and conversation position following Hollywood cinematography patterns.

Output: Enhanced DialogueSceneDecomposerService with position-enforced shot selection and per-speaker emotion analysis.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-dynamic-camera-intelligence/13-RESEARCH.md

# Phase 12 established validation integration point
@.planning/phases/12-shot-reverse-shot-patterns/12-01-SUMMARY.md

# Primary file to modify
@modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add speaker emotion analysis method (CAM-03)</name>
  <files>modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php</files>
  <action>
Add a new protected method `analyzeSpeakerEmotion(string $dialogueText): array` that analyzes the speaker's emotional state from their dialogue text.

The method should:
1. Convert text to lowercase for matching
2. Check for high-intensity emotions first (0.75+ intensity):
   - 'angry': keywords like 'yell', 'scream', 'hate', 'kill', 'furious', 'rage', or 2+ exclamation marks
   - 'fearful': keywords like 'afraid', 'scared', 'terrified', 'help me', "please don't"
   - 'loving': keywords like 'love', 'adore', 'marry', 'forever'
3. Check for medium-intensity emotions (0.5-0.7):
   - 'remorseful': 'sorry', 'regret', 'forgive', 'apologize'
   - 'excited': 'amazing', 'incredible', 'yes!', 'finally'
   - 'pleading': 'please', 'beg', 'need', 'must'
4. Check for low-intensity emotions (0.3-0.5):
   - 'contemplative': 'think', 'consider', 'wonder', 'perhaps'
   - 'sad': '...', trailing off indicators
5. Default to ['emotion' => 'neutral', 'intensity' => 0.5]

Return array: ['emotion' => string, 'intensity' => float]

Use the existing `$emotionIntensityMap` property values for consistency where applicable.

Add PHPDoc documenting CAM-03 requirement.

Place this method near the existing `calculateEmotionalIntensity()` method (around line 478).
  </action>
  <verify>
Grep for 'analyzeSpeakerEmotion' in the file confirms method exists.
Method signature matches: `protected function analyzeSpeakerEmotion(string $dialogueText): array`
  </verify>
  <done>
New method `analyzeSpeakerEmotion()` added that returns emotion and intensity for speaker's dialogue text, covering angry, fearful, loving, remorseful, excited, pleading, contemplative, sad, and neutral emotions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance selectShotTypeForIntensity with position enforcement (CAM-02, CAM-04)</name>
  <files>modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php</files>
  <action>
Modify the existing `selectShotTypeForIntensity(float $intensity, string $position): string` method (lines 1326-1344) to add a third optional parameter for speaker emotion and implement position-enforced shot selection rules.

New signature: `selectShotTypeForIntensity(float $intensity, string $position, ?string $speakerEmotion = null): string`

Replace the method body with position-first logic using a switch statement:

```php
// PHASE 13 CAM-04: Position-enforced rules take priority
switch ($position) {
    case 'opening':
        // Opening ALWAYS uses wide framing (CAM-04)
        // Never close-up at conversation start
        if ($intensity >= 0.5) return 'medium';
        if ($intensity >= 0.3) return 'wide';
        return 'establishing';

    case 'climax':
        // Climax ALWAYS uses tight framing (CAM-04)
        if ($intensity >= 0.8 || $speakerEmotion === 'angry' || $speakerEmotion === 'fearful') {
            return 'extreme-close-up';
        }
        return 'close-up';

    case 'resolution':
        // Resolution eases back to medium framing
        if ($intensity >= 0.65) return 'medium-close';
        if ($intensity >= 0.4) return 'medium';
        return 'wide';
}

// 'building' phase uses full intensity range (CAM-01)
// Speaker emotion adjusts threshold (CAM-03)
$adjustedIntensity = $intensity;
if ($speakerEmotion === 'angry' || $speakerEmotion === 'fearful') {
    $adjustedIntensity = min(1.0, $intensity + 0.15);
}

if ($adjustedIntensity >= 0.75) {
    return 'close-up';
} elseif ($adjustedIntensity >= 0.55) {
    return 'medium-close';
} elseif ($adjustedIntensity >= 0.4) {
    return 'over-the-shoulder';
} elseif ($adjustedIntensity >= 0.25) {
    return 'medium';
}

return 'wide';
```

Update the PHPDoc to document:
- CAM-01: Dynamic CU/MS/OTS selection based on emotional intensity
- CAM-02: Camera variety based on position in conversation
- CAM-04: Establishing shot at start, tight framing at climax
- The new optional `$speakerEmotion` parameter

IMPORTANT: Existing callers pass 2 parameters. The third parameter must be optional with default null for backward compatibility.
  </action>
  <verify>
Grep for 'switch.*position' in the method confirms position-first logic.
Method signature has 3 parameters with third optional: `selectShotTypeForIntensity(float $intensity, string $position, ?string $speakerEmotion = null)`
  </verify>
  <done>
`selectShotTypeForIntensity()` now enforces position rules: opening returns wide/medium/establishing (never close-up), climax returns close-up/extreme-close-up, resolution eases back, and building phase uses intensity with speaker emotion adjustment.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate speaker emotion into shot enhancement loop (CAM-01, CAM-03)</name>
  <files>modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php</files>
  <action>
Modify the `enhanceShotsWithDialoguePatterns()` method (starting around line 1973) to integrate speaker emotion analysis.

In the foreach loop (around line 1990-2038), add the following changes:

1. After getting position and before calculating intensity, analyze speaker emotion:
```php
// PHASE 13 CAM-03: Analyze speaker's emotion from their dialogue
$speakerEmotion = $this->analyzeSpeakerEmotion($shot['dialogue'] ?? $shot['monologue'] ?? '');
```

2. Store the speaker emotion in the shot data:
```php
$shot['speakerEmotion'] = $speakerEmotion;
```

3. Update the `selectShotTypeForIntensity` call to pass speaker emotion:
```php
$shotType = $this->selectShotTypeForIntensity($emotionalIntensity, $position, $speakerEmotion['emotion'] ?? null);
```

4. Add debug logging after shot type selection:
```php
Log::debug('DialogueSceneDecomposer: PHASE 13 camera intelligence applied', [
    'shot_index' => $index,
    'position' => $position,
    'speaker_emotion' => $speakerEmotion['emotion'] ?? 'neutral',
    'intensity' => $emotionalIntensity,
    'shot_type' => $shotType,
]);
```

Also update the call to `selectShotTypeForIntensity` in `createDialogueShot()` method (around line 1185) if it doesn't pass speaker emotion. The call should analyze the exchange text and pass the emotion:
```php
$speakerEmotion = $this->analyzeSpeakerEmotion($exchange['text'] ?? '');
$shotType = $this->selectShotTypeForIntensity($emotionalIntensity, $position, $speakerEmotion['emotion'] ?? null);
```

Do NOT modify `createShotFromSegment()` - it can use the existing 2-parameter call since speaker emotion flows through `enhanceShotsWithDialoguePatterns()` which processes all shots afterward.
  </action>
  <verify>
Grep for 'analyzeSpeakerEmotion' in enhanceShotsWithDialoguePatterns confirms integration.
Grep for 'speakerEmotion.*emotion' in selectShotTypeForIntensity call confirms emotion passed to shot selection.
  </verify>
  <done>
`enhanceShotsWithDialoguePatterns()` now analyzes each speaker's emotion from their dialogue, stores it on the shot, and passes it to shot type selection. Camera selection responds to both emotion and position per CAM-01/CAM-03.
  </done>
</task>

</tasks>

<verification>
Run the following checks after completion:

1. **Syntax check:**
   ```bash
   php -l modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php
   ```
   Expected: No syntax errors

2. **Method existence:**
   - `analyzeSpeakerEmotion` method exists with correct signature
   - `selectShotTypeForIntensity` has 3 parameters (third optional)

3. **Position enforcement:**
   - 'opening' position NEVER returns 'close-up' or 'extreme-close-up'
   - 'climax' position ALWAYS returns 'close-up' or 'extreme-close-up'

4. **Integration:**
   - enhanceShotsWithDialoguePatterns calls analyzeSpeakerEmotion
   - Shot data includes speakerEmotion field
</verification>

<success_criteria>
1. High-intensity dialogue (anger, fear keywords) results in close-up or tighter framing
2. Conversation opening (0-20% progress) returns establishing, wide, or medium - never close-up
3. Conversation climax (50-80% progress) returns close-up or extreme-close-up
4. Neutral dialogue uses medium shots with OTS variety in building phase
5. Each shot has speakerEmotion data stored for downstream use
6. No breaking changes - existing code continues to work (backward compatible)
</success_criteria>

<output>
After completion, create `.planning/phases/13-dynamic-camera-intelligence/13-01-SUMMARY.md` following the summary template.
</output>
