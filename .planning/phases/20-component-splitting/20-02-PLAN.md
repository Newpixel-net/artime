---
phase: 20-component-splitting
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - modules/AppVideoWizard/app/Livewire/Modals/CharacterBibleModal.php
  - modules/AppVideoWizard/resources/views/livewire/modals/character-bible-modal.blade.php
  - modules/AppVideoWizard/app/Livewire/VideoWizard.php
  - modules/AppVideoWizard/resources/views/livewire/steps/storyboard.blade.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Character Bible modal is a separate Livewire child component"
    - "Parent VideoWizard coordinates modal via events"
    - "Modal opens when user clicks Character Bible button"
    - "Changes in modal sync back to parent sceneMemory"
    - "Image generation callbacks work through events"
  artifacts:
    - path: "modules/AppVideoWizard/app/Livewire/Modals/CharacterBibleModal.php"
      provides: "Character Bible child component"
      min_lines: 200
    - path: "modules/AppVideoWizard/resources/views/livewire/modals/character-bible-modal.blade.php"
      provides: "Character Bible modal view"
      min_lines: 700
  key_links:
    - from: "modules/AppVideoWizard/resources/views/livewire/steps/storyboard.blade.php"
      to: "CharacterBibleModal component"
      via: "livewire component tag"
      pattern: "<livewire:app-video-wizard::modals.character-bible-modal"
    - from: "modules/AppVideoWizard/app/Livewire/Modals/CharacterBibleModal.php"
      to: "modules/AppVideoWizard/app/Livewire/VideoWizard.php"
      via: "$dispatch events"
      pattern: "\\$this->dispatch\\("
---

<objective>
Extract Character Bible modal from VideoWizard into a dedicated Livewire child component.

Purpose: Reduce parent component complexity by isolating Character Bible functionality into its own component. This follows Livewire 3's "island architecture" where child components manage their own requests while coordinating with parents via events.

Output: CharacterBibleModal.php child component with its own view, integrated into VideoWizard via events and props.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-component-splitting/20-01-SUMMARY.md

# Key source files
@modules/AppVideoWizard/app/Livewire/VideoWizard.php
@modules/AppVideoWizard/app/Livewire/Traits/WithCharacterBible.php
@modules/AppVideoWizard/resources/views/livewire/modals/character-bible.blade.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CharacterBibleModal child component</name>
  <files>modules/AppVideoWizard/app/Livewire/Modals/CharacterBibleModal.php</files>
  <action>
Create the Modals directory at `modules/AppVideoWizard/app/Livewire/Modals/` if it doesn't exist.

Create CharacterBibleModal.php as a Livewire child component:

```php
namespace Modules\AppVideoWizard\Livewire\Modals;

use Livewire\Component;
use Livewire\Attributes\On;
use Livewire\Attributes\Modelable;
use Livewire\Attributes\Locked;
use Livewire\WithFileUploads;
use Modules\AppVideoWizard\Services\ReferenceImageStorageService;
// ... other service imports as needed
```

**Props from parent (received via wire:model or attributes):**
- `$characterBible` - array of characters (modelable for two-way binding)
- `$projectId` - for storage operations
- `$visualMode` - for generation prompts
- `$contentLanguage` - for generation prompts

**Local state:**
- `$show` = false - modal visibility (controlled via events)
- `$editingCharacterIndex` - which character is being edited
- `$characterImageUpload` - file upload for portraits

**Methods to include (from WithCharacterBible trait or adapt):**
- Modal control: open/close via events
- CRUD: addCharacter, removeCharacter, updateCharacter
- Traits/Accessories management
- Voice settings updates
- Portrait generation (dispatch to parent for long-running jobs)

**Event dispatching pattern:**
- When character data changes: `$this->dispatch('character-bible-updated', characterBible: $this->characterBible)`
- When portrait generation needed: `$this->dispatch('generate-character-portrait', characterIndex: $index)`
- When modal closes: `$this->dispatch('character-bible-closed')`

**Event listening pattern (from parent):**
- `#[On('open-character-bible')]` - opens modal
- `#[On('character-portrait-generated')]` - updates portrait after parent generates

IMPORTANT:
- Use `#[Modelable]` on $characterBible for wire:model binding from parent
- Do NOT duplicate complex service orchestration - dispatch events to parent for heavy operations
- Keep image generation callbacks in parent (they access multiple properties)
- Use ReferenceImageStorageService for image loading/storage
  </action>
  <verify>
1. File exists at `modules/AppVideoWizard/app/Livewire/Modals/CharacterBibleModal.php`
2. Has $characterBible with #[Modelable] attribute
3. Has event listeners for open/close
4. No syntax errors: `php -l modules/AppVideoWizard/app/Livewire/Modals/CharacterBibleModal.php`
  </verify>
  <done>CharacterBibleModal.php child component created with props, local state, and event patterns</done>
</task>

<task type="auto">
  <name>Task 2: Create CharacterBibleModal blade view</name>
  <files>modules/AppVideoWizard/resources/views/livewire/modals/character-bible-modal.blade.php</files>
  <action>
Create the blade view for CharacterBibleModal component.

1. Copy content from existing `character-bible.blade.php` as starting point
2. Update wire:model bindings:
   - Change `wire:model="sceneMemory.characterBible.X.Y"` to `wire:model="characterBible.X.Y"`
   - Remove `sceneMemory.` prefix from all character bible references
3. Update wire:click handlers:
   - Keep local methods (addCharacter, removeCharacter, etc.)
   - Change generation methods to dispatch events: `$dispatch('generate-character-portrait', { characterIndex: {{ $index }} })`
4. Update modal visibility:
   - Use `$show` property: `x-show="$wire.show"` or Alpine integration
5. Add close button event: `wire:click="$dispatch('character-bible-closed')"`

IMPORTANT:
- The modal wrapper should use Alpine for visibility toggle
- All wire:model bindings now reference component's $characterBible directly
- Portrait display should use the same ReferenceImageStorageService pattern
- Preserve all existing CSS classes (vw-* naming)
- Preserve all existing Alpine x-data and x-init blocks
  </action>
  <verify>
1. File exists at `modules/AppVideoWizard/resources/views/livewire/modals/character-bible-modal.blade.php`
2. No `sceneMemory.characterBible` references (only `characterBible`)
3. Has event dispatch for parent operations
  </verify>
  <done>CharacterBibleModal blade view created with proper bindings and event dispatching</done>
</task>

<task type="auto">
  <name>Task 3: Integrate CharacterBibleModal into parent</name>
  <files>
    modules/AppVideoWizard/app/Livewire/VideoWizard.php
    modules/AppVideoWizard/resources/views/livewire/steps/storyboard.blade.php
  </files>
  <action>
**In VideoWizard.php:**

1. Add event listeners for child component events:
   ```php
   #[On('character-bible-updated')]
   public function handleCharacterBibleUpdated(array $characterBible): void
   {
       $this->sceneMemory['characterBible'] = $characterBible;
       $this->buildSceneDNA(); // or debouncedBuildSceneDNA
       $this->saveProject();
   }

   #[On('generate-character-portrait')]
   public function handleGenerateCharacterPortraitFromChild(int $characterIndex): void
   {
       // Use existing portrait generation logic
       $this->generateSingleCharacterPortrait($characterIndex);
   }

   #[On('character-bible-closed')]
   public function handleCharacterBibleClosed(): void
   {
       $this->showCharacterBibleModal = false;
   }
   ```

2. Update toggleCharacterBible() to dispatch event to child:
   ```php
   public function toggleCharacterBible(): void
   {
       $this->showCharacterBibleModal = !$this->showCharacterBibleModal;
       if ($this->showCharacterBibleModal) {
           $this->dispatch('open-character-bible');
       }
   }
   ```

**In storyboard.blade.php:**

1. Replace the Character Bible modal include with Livewire component:
   ```blade
   {{-- Character Bible Modal (Child Component) --}}
   <livewire:app-video-wizard::modals.character-bible-modal
       wire:model="sceneMemory.characterBible"
       :project-id="$projectId"
       :visual-mode="$content['visualMode'] ?? 'cinematic-realistic'"
       :content-language="$content['language'] ?? 'en'"
       wire:key="character-bible-modal-{{ $projectId }}"
   />
   ```

2. Remove the old @include for character-bible.blade.php (if still present)

IMPORTANT:
- Keep the trait methods for any operations still needed in parent
- The child component handles UI interactions
- Parent handles data persistence and cross-component operations
  </action>
  <verify>
1. VideoWizard.php has #[On('character-bible-updated')] listener
2. storyboard.blade.php has `<livewire:app-video-wizard::modals.character-bible-modal` tag
3. No syntax errors on all modified files
4. Character Bible modal opens when clicking the Character Bible button
  </verify>
  <done>CharacterBibleModal integrated as child component with event-based communication</done>
</task>

</tasks>

<verification>
1. PHP syntax check passes on all modified files
2. Application starts without errors
3. Navigate to Video Wizard, open a project with characters
4. Click "Character Bible" button - modal opens
5. Add a character - character appears in list
6. Edit character name - change persists after closing modal
7. Trigger portrait generation - image generates successfully
8. Close modal - changes reflected in parent component
</verification>

<success_criteria>
- CharacterBibleModal.php exists as child Livewire component
- character-bible-modal.blade.php renders Character Bible UI
- Modal opens/closes correctly via events
- Character CRUD operations work
- Portrait generation works (dispatched to parent)
- Changes sync back to parent sceneMemory
- All Phase 19 optimizations preserved
</success_criteria>

<output>
After completion, create `.planning/phases/20-component-splitting/20-02-SUMMARY.md`
</output>
