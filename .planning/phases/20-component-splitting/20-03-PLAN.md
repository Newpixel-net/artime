---
phase: 20-component-splitting
plan: 03
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - modules/AppVideoWizard/app/Livewire/Modals/LocationBibleModal.php
  - modules/AppVideoWizard/resources/views/livewire/modals/location-bible-modal.blade.php
  - modules/AppVideoWizard/app/Livewire/VideoWizard.php
  - modules/AppVideoWizard/resources/views/livewire/steps/storyboard.blade.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Location Bible modal is a separate Livewire child component"
    - "Parent VideoWizard coordinates modal via events"
    - "Modal opens when user clicks Location Bible button"
    - "Changes in modal sync back to parent sceneMemory"
    - "Scene-location one-to-one enforcement works"
  artifacts:
    - path: "modules/AppVideoWizard/app/Livewire/Modals/LocationBibleModal.php"
      provides: "Location Bible child component"
      min_lines: 150
    - path: "modules/AppVideoWizard/resources/views/livewire/modals/location-bible-modal.blade.php"
      provides: "Location Bible modal view"
      min_lines: 500
  key_links:
    - from: "modules/AppVideoWizard/resources/views/livewire/steps/storyboard.blade.php"
      to: "LocationBibleModal component"
      via: "livewire component tag"
      pattern: "<livewire:app-video-wizard::modals.location-bible-modal"
    - from: "modules/AppVideoWizard/app/Livewire/Modals/LocationBibleModal.php"
      to: "modules/AppVideoWizard/app/Livewire/VideoWizard.php"
      via: "$dispatch events"
      pattern: "\\$this->dispatch\\("
---

<objective>
Extract Location Bible modal from VideoWizard into a dedicated Livewire child component.

Purpose: Complete the modal extraction pattern started with Character Bible. Location Bible has similar structure but simpler logic (fewer methods). This further reduces parent component complexity.

Output: LocationBibleModal.php child component with its own view, integrated into VideoWizard via events and props.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-component-splitting/20-01-SUMMARY.md

# Key source files
@modules/AppVideoWizard/app/Livewire/VideoWizard.php
@modules/AppVideoWizard/app/Livewire/Traits/WithLocationBible.php
@modules/AppVideoWizard/resources/views/livewire/modals/location-bible.blade.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LocationBibleModal child component</name>
  <files>modules/AppVideoWizard/app/Livewire/Modals/LocationBibleModal.php</files>
  <action>
Create LocationBibleModal.php as a Livewire child component in the existing Modals directory.

```php
namespace Modules\AppVideoWizard\Livewire\Modals;

use Livewire\Component;
use Livewire\Attributes\On;
use Livewire\Attributes\Modelable;
use Livewire\Attributes\Locked;
use Livewire\WithFileUploads;
use Modules\AppVideoWizard\Services\ReferenceImageStorageService;
```

**Props from parent (received via wire:model or attributes):**
- `$locationBible` - array of locations (modelable for two-way binding)
- `$scenes` - scene data for scene-location mapping
- `$projectId` - for storage operations
- `$visualMode` - for generation prompts
- `$contentLanguage` - for generation prompts

**Local state:**
- `$show` = false - modal visibility
- `$editingLocationIndex` - which location is being edited
- `$locationImageUpload` - file upload for references

**Methods to include (from WithLocationBible trait or adapt):**
- Modal control: open/close via events
- CRUD: addLocation, removeLocation
- State management: addLocationState, removeLocationState, applyLocationStatePreset
- Scene-location mapping (one-to-one enforcement)
- Reference generation (dispatch to parent)

**Event patterns (same as Character Bible):**
- `$this->dispatch('location-bible-updated', locationBible: $this->locationBible)`
- `$this->dispatch('generate-location-reference', locationIndex: $index)`
- `$this->dispatch('location-bible-closed')`

**Event listeners:**
- `#[On('open-location-bible')]`
- `#[On('location-reference-generated')]`

IMPORTANT:
- Use `#[Modelable]` on $locationBible for wire:model binding
- Location Bible has scene-location one-to-one rule - each scene has one location
- Keep reference generation in parent (uses multiple services)
  </action>
  <verify>
1. File exists at `modules/AppVideoWizard/app/Livewire/Modals/LocationBibleModal.php`
2. Has $locationBible with #[Modelable] attribute
3. Has $scenes prop for scene mapping
4. No syntax errors: `php -l modules/AppVideoWizard/app/Livewire/Modals/LocationBibleModal.php`
  </verify>
  <done>LocationBibleModal.php child component created with props, local state, and event patterns</done>
</task>

<task type="auto">
  <name>Task 2: Create LocationBibleModal blade view</name>
  <files>modules/AppVideoWizard/resources/views/livewire/modals/location-bible-modal.blade.php</files>
  <action>
Create the blade view for LocationBibleModal component.

1. Copy content from existing `location-bible.blade.php` as starting point
2. Update wire:model bindings:
   - Change `wire:model="sceneMemory.locationBible.X.Y"` to `wire:model="locationBible.X.Y"`
   - Remove `sceneMemory.` prefix from all location bible references
3. Update wire:click handlers:
   - Keep local methods (addLocation, removeLocation, etc.)
   - Change generation methods to dispatch events
4. Update scene references:
   - Scene data comes from `$scenes` prop, not `$script['scenes']`
5. Update modal visibility:
   - Use `$show` property with Alpine
6. Add close button event dispatch

IMPORTANT:
- Preserve scene-location assignment UI
- Preserve location state per-scene UI
- Preserve all vw-* CSS classes
- Preserve Alpine x-data blocks for accordion behavior
  </action>
  <verify>
1. File exists at `modules/AppVideoWizard/resources/views/livewire/modals/location-bible-modal.blade.php`
2. No `sceneMemory.locationBible` references
3. Scene data accessed via `$scenes` prop
  </verify>
  <done>LocationBibleModal blade view created with proper bindings and event dispatching</done>
</task>

<task type="auto">
  <name>Task 3: Integrate LocationBibleModal into parent</name>
  <files>
    modules/AppVideoWizard/app/Livewire/VideoWizard.php
    modules/AppVideoWizard/resources/views/livewire/steps/storyboard.blade.php
  </files>
  <action>
**In VideoWizard.php:**

1. Add event listeners for Location Bible child component:
   ```php
   #[On('location-bible-updated')]
   public function handleLocationBibleUpdated(array $locationBible): void
   {
       $this->sceneMemory['locationBible'] = $locationBible;
       $this->buildSceneDNA(); // or debouncedBuildSceneDNA
       $this->saveProject();
   }

   #[On('generate-location-reference')]
   public function handleGenerateLocationReferenceFromChild(int $locationIndex): void
   {
       // Use existing reference generation logic
       $this->generateSingleLocationReference($locationIndex);
   }

   #[On('location-bible-closed')]
   public function handleLocationBibleClosed(): void
   {
       $this->showLocationBibleModal = false;
   }
   ```

2. Update toggleLocationBible() to dispatch event:
   ```php
   public function toggleLocationBible(): void
   {
       $this->showLocationBibleModal = !$this->showLocationBibleModal;
       if ($this->showLocationBibleModal) {
           $this->dispatch('open-location-bible');
       }
   }
   ```

**In storyboard.blade.php:**

1. Replace the Location Bible modal include with Livewire component:
   ```blade
   {{-- Location Bible Modal (Child Component) --}}
   <livewire:app-video-wizard::modals.location-bible-modal
       wire:model="sceneMemory.locationBible"
       :scenes="$script['scenes'] ?? []"
       :project-id="$projectId"
       :visual-mode="$content['visualMode'] ?? 'cinematic-realistic'"
       :content-language="$content['language'] ?? 'en'"
       wire:key="location-bible-modal-{{ $projectId }}"
   />
   ```

2. Remove the old @include for location-bible.blade.php

IMPORTANT:
- Scenes prop passes scene data for location mapping
- Parent handles reference generation (uses ImageGenerationService)
- Scene-location enforcement logic stays in child
  </action>
  <verify>
1. VideoWizard.php has #[On('location-bible-updated')] listener
2. storyboard.blade.php has `<livewire:app-video-wizard::modals.location-bible-modal` tag
3. No syntax errors on all modified files
4. Location Bible modal opens when clicking the Location Bible button
  </verify>
  <done>LocationBibleModal integrated as child component with event-based communication</done>
</task>

</tasks>

<verification>
1. PHP syntax check passes on all modified files
2. Application starts without errors
3. Navigate to Video Wizard, open a project with locations
4. Click "Location Bible" button - modal opens
5. Add a location - location appears in list
6. Assign location to scene - assignment persists
7. Add location state for scene - state saves correctly
8. Trigger reference generation - image generates successfully
9. Close modal - changes reflected in parent component
</verification>

<success_criteria>
- LocationBibleModal.php exists as child Livewire component
- location-bible-modal.blade.php renders Location Bible UI
- Modal opens/closes correctly via events
- Location CRUD operations work
- Scene-location assignment works (one-to-one enforcement)
- Location states per scene work
- Reference generation works (dispatched to parent)
- Changes sync back to parent sceneMemory
- All Phase 19 optimizations preserved
</success_criteria>

<output>
After completion, create `.planning/phases/20-component-splitting/20-03-SUMMARY.md`
</output>
