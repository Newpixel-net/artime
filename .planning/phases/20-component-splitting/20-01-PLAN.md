---
phase: 20-component-splitting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/AppVideoWizard/app/Livewire/Traits/WithCharacterBible.php
  - modules/AppVideoWizard/app/Livewire/Traits/WithLocationBible.php
  - modules/AppVideoWizard/app/Livewire/VideoWizard.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Character Bible methods are organized in a dedicated trait"
    - "Location Bible methods are organized in a dedicated trait"
    - "VideoWizard.php uses both traits without behavior change"
    - "All existing functionality continues to work"
  artifacts:
    - path: "modules/AppVideoWizard/app/Livewire/Traits/WithCharacterBible.php"
      provides: "Character Bible method organization"
      min_lines: 800
    - path: "modules/AppVideoWizard/app/Livewire/Traits/WithLocationBible.php"
      provides: "Location Bible method organization"
      min_lines: 300
  key_links:
    - from: "modules/AppVideoWizard/app/Livewire/VideoWizard.php"
      to: "WithCharacterBible trait"
      via: "use statement"
      pattern: "use WithCharacterBible"
    - from: "modules/AppVideoWizard/app/Livewire/VideoWizard.php"
      to: "WithLocationBible trait"
      via: "use statement"
      pattern: "use WithLocationBible"
---

<objective>
Extract Character Bible and Location Bible methods from VideoWizard.php into dedicated PHP traits.

Purpose: Organize the 32,331-line VideoWizard.php into logical units without changing any state management or behavior. This is zero-risk code organization that makes the codebase more maintainable and prepares for future component extraction.

Output: Two PHP traits containing Bible-related methods, with VideoWizard using these traits transparently.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key source files
@modules/AppVideoWizard/app/Livewire/VideoWizard.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WithCharacterBible trait</name>
  <files>modules/AppVideoWizard/app/Livewire/Traits/WithCharacterBible.php</files>
  <action>
Create the Traits directory at `modules/AppVideoWizard/app/Livewire/Traits/` if it doesn't exist.

Create `WithCharacterBible.php` trait containing ALL Character Bible related methods from VideoWizard.php. These methods include (grep for exact names):

1. Modal control: `toggleCharacterBible()`
2. CRUD operations: `addCharacter()`, `removeCharacter()`, `editBibleCharacter()`, `addBibleCharacter()`
3. Traits/Accessories: `addCharacterTrait()`, `removeCharacterTrait()`, `addCharacterAccessory()`, `removeCharacterAccessory()`
4. Voice management: `updateCharacterVoice()`, `setCharacterAsNarrator()`, `updateCharacterSpeakingRole()`, `getNarratorCharacter()`, `applyCharacterVoicePreset()`
5. Portrait generation: `generateCharacterPortraits()`, `handleGenerateCharacterPortraits()`, `queueAutoCharacterPortraits()`, `generateNextPendingCharacterPortrait()`, `countPendingCharacterPortraits()`, `generateAllMissingCharacterReferences()`, `getCharactersNeedingReferences()`
6. DNA/Templates: `buildCharacterDNA()`, `getCharacterDNATemplates()`, `applyCharacterDNATemplate()`, `autoPopulateCharacterDNA()`, `batchAutoPopulateAllCharactersDNA()`
7. Look presets: `applyCharacterLookPreset()`
8. Wardrobe: `setCharacterWardrobeChange()`, `getCharacterWardrobeForScene()`
9. Intelligence: `updateCharacterIntelligence()`, `getCharacterStateForScene()`, `getCharacterImageChain()`, `validateShotCharacters()`, `getCharacterConsistencyOptions()`
10. Sync: `syncDetectedSpeakersToCharacterBible()`
11. Sorting: `getSortedCharacters()`
12. Updated hook: `updatedSceneMemoryCharacterBible()`

The trait namespace: `Modules\AppVideoWizard\Livewire\Traits`

IMPORTANT:
- Do NOT move any properties - keep all state in VideoWizard
- Methods access $this->sceneMemory, $this->script, etc. from parent component
- Add proper PHPDoc blocks indicating this trait provides Character Bible functionality
- Include `use Livewire\Attributes\On;` if any methods have #[On] attributes
- Add trait initialization method `initializeWithCharacterBible()` if needed for Livewire lifecycle hooks
  </action>
  <verify>
1. File exists at `modules/AppVideoWizard/app/Livewire/Traits/WithCharacterBible.php`
2. Contains all character-related methods (grep count should match extraction)
3. No syntax errors: `php -l modules/AppVideoWizard/app/Livewire/Traits/WithCharacterBible.php`
  </verify>
  <done>WithCharacterBible.php trait exists with all Character Bible methods extracted from VideoWizard.php</done>
</task>

<task type="auto">
  <name>Task 2: Create WithLocationBible trait</name>
  <files>modules/AppVideoWizard/app/Livewire/Traits/WithLocationBible.php</files>
  <action>
Create `WithLocationBible.php` trait containing ALL Location Bible related methods from VideoWizard.php. These methods include:

1. Modal control: `toggleLocationBible()`
2. CRUD operations: `addLocation()`, `removeLocation()`
3. States: `addLocationState()`, `removeLocationState()`, `applyLocationStatePreset()`
4. Generation: `queueAutoLocationReferences()`, `generateNextPendingLocationReference()`, `countPendingLocationReferences()`, `generateAllMissingLocationReferences()`, `getLocationsNeedingReferences()`
5. Sorting: `getSortedLocations()`
6. Updated hook: `updatedSceneMemoryLocationBible()`

The trait namespace: `Modules\AppVideoWizard\Livewire\Traits`

IMPORTANT:
- Do NOT move any properties - keep all state in VideoWizard
- Methods access $this->sceneMemory, $this->loadedBase64Cache, etc. from parent component
- Add proper PHPDoc blocks
- Include necessary use statements for Livewire attributes
  </action>
  <verify>
1. File exists at `modules/AppVideoWizard/app/Livewire/Traits/WithLocationBible.php`
2. Contains all location-related methods
3. No syntax errors: `php -l modules/AppVideoWizard/app/Livewire/Traits/WithLocationBible.php`
  </verify>
  <done>WithLocationBible.php trait exists with all Location Bible methods extracted from VideoWizard.php</done>
</task>

<task type="auto">
  <name>Task 3: Integrate traits into VideoWizard</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Modify VideoWizard.php to use the new traits:

1. Add use statements at top of class:
   ```php
   use Modules\AppVideoWizard\Livewire\Traits\WithCharacterBible;
   use Modules\AppVideoWizard\Livewire\Traits\WithLocationBible;
   ```

2. Add trait usage inside class (after `use WithFileUploads;`):
   ```php
   use WithCharacterBible;
   use WithLocationBible;
   ```

3. REMOVE the extracted methods from VideoWizard.php (all methods now in traits)

4. Verify all #[On] listeners still work - trait methods should retain their attributes

IMPORTANT:
- Do NOT remove any properties - they stay in VideoWizard
- Do NOT modify any blade templates
- The net result should be: VideoWizard line count reduced by ~1,200-1,500 lines
- All functionality remains identical - just organized differently
  </action>
  <verify>
1. VideoWizard.php has `use WithCharacterBible;` and `use WithLocationBible;`
2. No duplicate methods exist (methods only in traits, not in main class)
3. No syntax errors: `php -l modules/AppVideoWizard/app/Livewire/VideoWizard.php`
4. Application loads without errors: `php artisan view:clear && php artisan route:list --path=video-wizard 2>/dev/null | head -5`
  </verify>
  <done>VideoWizard.php uses both Bible traits, extracted methods removed from main class, all functionality preserved</done>
</task>

</tasks>

<verification>
1. PHP syntax check passes on all modified files
2. Application starts without errors
3. Character Bible modal opens and closes correctly
4. Location Bible modal opens and closes correctly
5. VideoWizard line count reduced (from ~32,331 to ~30,800-31,100)
</verification>

<success_criteria>
- WithCharacterBible.php trait contains ~50 Character Bible methods
- WithLocationBible.php trait contains ~10 Location Bible methods
- VideoWizard.php uses both traits
- Zero behavior changes - pure code organization
- All Phase 19 optimizations preserved (#[Locked], #[Computed], wire:model.blur, ReferenceImageStorageService, debouncedBuildSceneDNA)
</success_criteria>

<output>
After completion, create `.planning/phases/20-component-splitting/20-01-SUMMARY.md`
</output>
