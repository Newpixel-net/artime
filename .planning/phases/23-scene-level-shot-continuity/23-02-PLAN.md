---
phase: 23-scene-level-shot-continuity
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - modules/AppVideoWizard/app/Livewire/VideoWizard.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "GlobalRules flags are passed to shot generation context"
    - "enforce180Rule, enforceEyeline, enforceMatchCuts flags flow to ShotIntelligenceService"
    - "Continuity enforcement can be toggled via storyBible cinematography settings"
  artifacts:
    - path: "modules/AppVideoWizard/app/Livewire/VideoWizard.php"
      provides: "GlobalRules passed to shot decomposition context"
      contains: "globalRules.*enforce"
  key_links:
    - from: "VideoWizard::decomposeSceneWithDynamicEngine()"
      to: "ShotIntelligenceService::analyzeScene()"
      via: "context array with globalRules"
      pattern: "globalRules.*context|context.*globalRules"
---

<objective>
Wire globalRules flags into shot generation context

Purpose: The storyBible already defines `globalRules` with `enforce180Rule`, `enforceEyeline`, and `enforceMatchCuts` flags, but these are never passed to the shot generation pipeline. This plan wires them through so continuity enforcement respects user settings.

Output: Modified VideoWizard that passes globalRules to ShotIntelligenceService via context.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-scene-level-shot-continuity/23-RESEARCH.md
@.planning/phases/23-scene-level-shot-continuity/23-01-SUMMARY.md
@modules/AppVideoWizard/app/Livewire/VideoWizard.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pass globalRules to shot decomposition context</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Find the `decomposeSceneWithDynamicEngine()` method and locate where `$context` is built for ShotIntelligenceService.

1. The method already extracts globalRules around line 18719:
   ```php
   $globalRules = $cinematography['globalRules'] ?? [];
   ```

2. Find where context is built for shot analysis (likely when calling ShotIntelligenceService or building scene context array).

3. Add globalRules to the context array passed to shot analysis:
   ```php
   $context['globalRules'] = $globalRules;
   ```

4. Ensure the context array includes these specific flags:
   - `enforce180Rule` (boolean, default true)
   - `enforceEyeline` (boolean, default true)
   - `enforceMatchCuts` (boolean, default true)
   - `minShotVariety` (integer, default 3)
   - `maxSimilarityThreshold` (float, default 0.7)

Look for the `analyzeScene()` call on ShotIntelligenceService and ensure the context passed includes globalRules.

If context is not explicitly built, find where scene decomposition returns results and add globalRules to whatever context object flows through.
  </action>
  <verify>
Check globalRules is added to context: `grep -n "context.*globalRules\|globalRules.*context" modules/AppVideoWizard/app/Livewire/VideoWizard.php`

Check in decomposeSceneWithDynamicEngine: `grep -A5 -B5 "globalRules" modules/AppVideoWizard/app/Livewire/VideoWizard.php | head -40`
  </verify>
  <done>globalRules array is included in context passed to shot analysis pipeline</done>
</task>

<task type="auto">
  <name>Task 2: Honor globalRules in ShotIntelligenceService continuity check</name>
  <files>modules/AppVideoWizard/app/Services/ShotIntelligenceService.php</files>
  <action>
Modify `addContinuityAnalysis()` to respect globalRules:

1. Extract globalRules from context:
   ```php
   $globalRules = $context['globalRules'] ?? [];
   ```

2. Pass relevant flags to Hollywood analysis options:
   ```php
   $continuityResult = $this->continuityService->analyzeHollywoodContinuity($shots, [
       'sceneType' => $sceneType,
       'progressionType' => $progressionType,
       'enforce180Rule' => $globalRules['enforce180Rule'] ?? true,
       'enforceEyeline' => $globalRules['enforceEyeline'] ?? true,
       'enforceMatchCuts' => $globalRules['enforceMatchCuts'] ?? true,
   ]);
   ```

3. Add conditional filtering of issues based on enforcement flags:
   - If enforce180Rule is false, filter out '180_degree_rule' issues from result
   - If enforceEyeline is false, filter out 'eyeline_match' issues
   - If enforceMatchCuts is false, filter out 'match_on_action' issues

   ```php
   // After getting continuity result, filter based on enforcement flags
   if (!($globalRules['enforce180Rule'] ?? true)) {
       $continuityResult['issues'] = array_filter(
           $continuityResult['issues'] ?? [],
           fn($issue) => ($issue['type'] ?? '') !== '180_degree_rule'
       );
   }
   // Similar for other flags...
   ```

This allows the Hollywood methods to run and detect issues, but respects user's choice to ignore specific rule types.
  </action>
  <verify>
Check globalRules extraction: `grep -n "context\['globalRules'\]" modules/AppVideoWizard/app/Services/ShotIntelligenceService.php`

Check flags passed to analyzeHollywoodContinuity: `grep -A5 "analyzeHollywoodContinuity" modules/AppVideoWizard/app/Services/ShotIntelligenceService.php`

PHP syntax valid: `php -l modules/AppVideoWizard/app/Services/ShotIntelligenceService.php`
  </verify>
  <done>ShotIntelligenceService respects globalRules enforcement flags when processing continuity issues</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. globalRules is extracted from storyBible and added to context in VideoWizard
2. Context with globalRules flows to ShotIntelligenceService::addContinuityAnalysis()
3. Enforcement flags (enforce180Rule, enforceEyeline, enforceMatchCuts) are respected
4. Issues can be filtered based on which rules are enabled
5. PHP syntax validation passes for both files
</verification>

<success_criteria>
- User can toggle continuity rules via storyBible cinematography settings
- Settings flow from VideoWizard → ShotIntelligenceService → continuity analysis
- Disabled rules don't produce warnings/issues
- Enabled rules (default) enforce Hollywood film grammar
</success_criteria>

<output>
After completion, create `.planning/phases/23-scene-level-shot-continuity/23-02-SUMMARY.md`
</output>
