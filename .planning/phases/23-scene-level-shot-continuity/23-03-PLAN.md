---
phase: 23-scene-level-shot-continuity
plan: 03
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - modules/AppVideoWizard/app/Services/ShotContinuityService.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "analyzeHollywoodContinuity() accepts and uses enforcement flag options"
    - "Disabled rules skip their respective checks"
    - "Scores are adjusted when rules are skipped (don't penalize for unchecked rules)"
  artifacts:
    - path: "modules/AppVideoWizard/app/Services/ShotContinuityService.php"
      provides: "Enforcement-aware Hollywood continuity analysis"
      exports: ["analyzeHollywoodContinuity"]
  key_links:
    - from: "ShotContinuityService::analyzeHollywoodContinuity()"
      to: "check180DegreeRule, checkEyelineMatch, checkMatchOnAction"
      via: "conditional calls based on options"
      pattern: "enforce.*Rule.*check|options.*enforce"
---

<objective>
Make Hollywood continuity analysis respect enforcement options

Purpose: The `analyzeHollywoodContinuity()` method should respect the enforcement flags passed in options so users can selectively enable/disable 180-degree rule, eyeline matching, and match-on-action checks.

Output: Modified ShotContinuityService that conditionally runs Hollywood checks based on enforcement options.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-scene-level-shot-continuity/23-RESEARCH.md
@.planning/phases/23-scene-level-shot-continuity/23-01-SUMMARY.md
@modules/AppVideoWizard/app/Services/ShotContinuityService.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract enforcement options in analyzeHollywoodContinuity</name>
  <files>modules/AppVideoWizard/app/Services/ShotContinuityService.php</files>
  <action>
Modify `analyzeHollywoodContinuity()` (around line 961) to extract enforcement options:

1. At the start of the method, after extracting sceneType and progressionType, add:
   ```php
   $enforce180Rule = $options['enforce180Rule'] ?? true;
   $enforceEyeline = $options['enforceEyeline'] ?? true;
   $enforceMatchCuts = $options['enforceMatchCuts'] ?? true;
   ```

2. Wrap the 180-degree rule check in a conditional:
   ```php
   // 180-degree rule
   if ($enforce180Rule) {
       $rule180 = $this->check180DegreeRule($prevShot, $shot);
       if (!$rule180['valid']) {
           $rule180Issues++;
           $result['issues'][] = [
               'type' => '180_degree_rule',
               'position' => $i + 1,
               'message' => $rule180['message'],
               'suggestion' => $rule180['suggestion'] ?? 'Maintain camera on same side of action line',
           ];
       }
   }
   ```

3. Wrap the match-on-action check in a conditional:
   ```php
   // Match on action
   if ($enforceMatchCuts) {
       $actionMatch = $this->checkMatchOnAction($prevShot, $shot);
       // ... rest of logic
   }
   ```

4. Wrap the eyeline match check in a conditional:
   ```php
   // Eyeline match
   if ($enforceEyeline) {
       $eyeline = $this->checkEyelineMatch($prevShot, $shot);
       // ... rest of logic
   }
   ```
  </action>
  <verify>
Check enforce flags extracted: `grep -n "enforce180Rule\|enforceEyeline\|enforceMatchCuts" modules/AppVideoWizard/app/Services/ShotContinuityService.php | head -10`

Check conditional wrapping: `grep -B2 "check180DegreeRule\|checkEyelineMatch\|checkMatchOnAction" modules/AppVideoWizard/app/Services/ShotContinuityService.php | grep -E "if.*enforce"`
  </verify>
  <done>analyzeHollywoodContinuity extracts and respects enforce180Rule, enforceEyeline, enforceMatchCuts options</done>
</task>

<task type="auto">
  <name>Task 2: Adjust scoring for skipped rules</name>
  <files>modules/AppVideoWizard/app/Services/ShotContinuityService.php</files>
  <action>
In `analyzeHollywoodContinuity()`, adjust the scoring logic to handle skipped rules fairly:

1. Track which rules were enforced (around line 980 area):
   ```php
   $rulesChecked = [
       '180DegreeRule' => $enforce180Rule,
       'matchOnAction' => $enforceMatchCuts,
       'eyelineMatch' => $enforceEyeline,
   ];
   ```

2. When calculating final scores (around line 1050+), set skipped rule scores to null instead of penalizing:
   ```php
   // Adjust scores based on what was checked
   if (!$enforce180Rule) {
       $result['scores']['180DegreeRule'] = null;  // Not checked, not counted
   } else {
       $result['scores']['180DegreeRule'] = max(0, 100 - ($rule180Issues * 25));
   }

   if (!$enforceMatchCuts) {
       $result['scores']['matchOnAction'] = null;
   } else {
       $result['scores']['matchOnAction'] = max(0, 100 - ($actionIssues * 20));
   }

   if (!$enforceEyeline) {
       $result['scores']['eyelineMatch'] = null;
   } else {
       $result['scores']['eyelineMatch'] = max(0, 100 - ($eyelineIssues * 20));
   }
   ```

3. When calculating overall score, only count enforced rules:
   ```php
   // Calculate overall from only the enforced rules
   $scoresToAverage = array_filter($result['scores'], fn($s) => $s !== null);
   $result['overall'] = count($scoresToAverage) > 0
       ? array_sum($scoresToAverage) / count($scoresToAverage)
       : 100;  // All rules disabled = perfect score
   ```

4. Add 'rulesEnforced' to result for transparency:
   ```php
   $result['rulesEnforced'] = $rulesChecked;
   ```
  </action>
  <verify>
Check rulesChecked tracking: `grep -n "rulesChecked\|rulesEnforced" modules/AppVideoWizard/app/Services/ShotContinuityService.php`

Check null handling for skipped scores: `grep -n "scores.*null\|null.*scores" modules/AppVideoWizard/app/Services/ShotContinuityService.php`

PHP syntax valid: `php -l modules/AppVideoWizard/app/Services/ShotContinuityService.php`
  </verify>
  <done>Scoring logic correctly handles skipped rules (null scores, weighted average of enforced rules only)</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Enforcement flags are extracted from options with sensible defaults (true)
2. Each Hollywood check (180-rule, eyeline, match-cuts) is wrapped in conditional
3. Skipped rules produce null scores, not 0 or 100
4. Overall score is calculated from only enforced rules
5. rulesEnforced metadata included in result for debugging
6. PHP syntax validation passes
</verification>

<success_criteria>
- When enforce180Rule: false, 180-degree checks are skipped entirely
- When enforceEyeline: false, eyeline matching is skipped
- When enforceMatchCuts: false, match-on-action is skipped
- Overall score reflects only the rules that were actually checked
- No false penalties for rules user intentionally disabled
</success_criteria>

<output>
After completion, create `.planning/phases/23-scene-level-shot-continuity/23-03-SUMMARY.md`
</output>
