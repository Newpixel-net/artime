---
phase: 23-scene-level-shot-continuity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/AppVideoWizard/app/Services/ShotIntelligenceService.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Shots are enriched with lookDirection field before continuity analysis"
    - "Shots are enriched with screenDirection field before continuity analysis"
    - "analyzeHollywoodContinuity() is called instead of analyzeSequence()"
    - "Hollywood continuity checks can function with enriched shot data"
  artifacts:
    - path: "modules/AppVideoWizard/app/Services/ShotIntelligenceService.php"
      provides: "Enrichment + Hollywood integration in addContinuityAnalysis()"
      exports: ["enrichShotsWithSpatialData", "addContinuityAnalysis"]
  key_links:
    - from: "ShotIntelligenceService::enrichShotsWithSpatialData()"
      to: "shot['eyeline']"
      via: "field mapping"
      pattern: "lookDirection.*eyeline|screenDirection.*eyeline"
    - from: "ShotIntelligenceService::addContinuityAnalysis()"
      to: "ShotContinuityService::analyzeHollywoodContinuity()"
      via: "method call replacement"
      pattern: "analyzeHollywoodContinuity"
---

<objective>
Enrich shots with spatial metadata and switch to Hollywood continuity analysis

Purpose: Enable existing ShotContinuityService Hollywood methods to function by providing the data fields they expect (lookDirection, screenDirection) and calling analyzeHollywoodContinuity() instead of the basic analyzeSequence().

Output: Modified ShotIntelligenceService that enriches shots before analysis and uses comprehensive Hollywood continuity checks.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-scene-level-shot-continuity/23-RESEARCH.md
@modules/AppVideoWizard/app/Services/ShotIntelligenceService.php
@modules/AppVideoWizard/app/Services/ShotContinuityService.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add enrichShotsWithSpatialData() method</name>
  <files>modules/AppVideoWizard/app/Services/ShotIntelligenceService.php</files>
  <action>
Add a new protected method `enrichShotsWithSpatialData(array $shots): array` that:

1. Maps eyeline to lookDirection:
   - `$shot['lookDirection'] = $shot['eyeline']` (same values: 'screen-left', 'screen-right', 'camera')
   - Also set `$shot['gaze_direction'] = $shot['eyeline']` (alternative field name)

2. Maps eyeline to screenDirection:
   - 'screen-left' → 'left_to_right'
   - 'screen-right' → 'right_to_left'
   - 'camera' → 'center'
   - null → 'center' (default)

3. Preserves all existing shot fields (just adds new ones).

Example implementation:
```php
protected function enrichShotsWithSpatialData(array $shots): array
{
    $directionMapping = [
        'screen-left' => 'left_to_right',
        'screen-right' => 'right_to_left',
        'camera' => 'center',
    ];

    foreach ($shots as &$shot) {
        // Map eyeline to lookDirection (what checkEyelineMatch expects)
        if (isset($shot['eyeline']) && !isset($shot['lookDirection'])) {
            $shot['lookDirection'] = $shot['eyeline'];
            $shot['gaze_direction'] = $shot['eyeline'];
        }

        // Map eyeline to screenDirection (what check180DegreeRule expects)
        if (isset($shot['eyeline'])) {
            $shot['screenDirection'] = $directionMapping[$shot['eyeline']] ?? 'center';
        } else {
            $shot['screenDirection'] = $shot['screenDirection'] ?? 'center';
        }
    }

    return $shots;
}
```

Place this method near the existing addContinuityAnalysis() method (around line 1484).
  </action>
  <verify>
Method exists: `grep -n "function enrichShotsWithSpatialData" modules/AppVideoWizard/app/Services/ShotIntelligenceService.php`

Method maps eyeline correctly: `grep -A10 "directionMapping" modules/AppVideoWizard/app/Services/ShotIntelligenceService.php`
  </verify>
  <done>enrichShotsWithSpatialData() method exists that maps eyeline to lookDirection and screenDirection fields</done>
</task>

<task type="auto">
  <name>Task 2: Modify addContinuityAnalysis() to enrich and use Hollywood analysis</name>
  <files>modules/AppVideoWizard/app/Services/ShotIntelligenceService.php</files>
  <action>
Modify the existing `addContinuityAnalysis()` method (currently around line 1484) to:

1. Enrich shots with spatial data BEFORE analysis:
   ```php
   $shots = $this->enrichShotsWithSpatialData($analysis['shots'] ?? []);
   ```

2. Replace the analyzeSequence() call with analyzeHollywoodContinuity():
   ```php
   // OLD:
   // $continuityResult = $this->continuityService->analyzeSequence($shots);

   // NEW:
   $sceneType = $context['sceneType'] ?? VwSetting::getValue('shot_continuity_default_scene_type', 'dialogue');
   $progressionType = $context['progressionType'] ?? 'building';

   $continuityResult = $this->continuityService->analyzeHollywoodContinuity($shots, [
       'sceneType' => $sceneType,
       'progressionType' => $progressionType,
   ]);
   ```

3. Store enriched shots back to analysis if auto-optimization is NOT triggered:
   - After continuity analysis, update `$analysis['shots'] = $shots;` to preserve enrichment
   - The auto-optimization block (if triggered) already replaces shots

4. Add logging for Hollywood analysis result:
   ```php
   Log::debug('ShotIntelligenceService: Hollywood continuity analysis', [
       'overall_score' => $continuityResult['overall'] ?? null,
       'issues_count' => count($continuityResult['issues'] ?? []),
       'scene_type' => $sceneType,
   ]);
   ```

Keep all existing auto-optimization logic intact. The change is:
- Enrich first
- Call Hollywood method instead of basic method
- Store enriched shots
  </action>
  <verify>
Check analyzeHollywoodContinuity is called: `grep -n "analyzeHollywoodContinuity" modules/AppVideoWizard/app/Services/ShotIntelligenceService.php`

Check enrichment call exists: `grep -n "enrichShotsWithSpatialData" modules/AppVideoWizard/app/Services/ShotIntelligenceService.php`

Check sceneType is passed: `grep -C3 "analyzeHollywoodContinuity" modules/AppVideoWizard/app/Services/ShotIntelligenceService.php`
  </verify>
  <done>addContinuityAnalysis() enriches shots before analysis and calls analyzeHollywoodContinuity() with scene context</done>
</task>

<task type="auto">
  <name>Task 3: Verify integration end-to-end</name>
  <files>modules/AppVideoWizard/app/Services/ShotIntelligenceService.php</files>
  <action>
Verify the complete integration by:

1. Ensure VwSetting import exists at top of file (should already be there from line 6):
   ```php
   use Modules\AppVideoWizard\Models\VwSetting;
   ```

2. Ensure Log import exists (should already be there from line 5):
   ```php
   use Illuminate\Support\Facades\Log;
   ```

3. Test the code parses correctly:
   ```bash
   php -l modules/AppVideoWizard/app/Services/ShotIntelligenceService.php
   ```

4. Run existing tests to ensure no regressions:
   ```bash
   php artisan test --filter=ShotIntelligence 2>/dev/null || echo "No specific tests found"
   ```

5. Verify the flow by checking the method chain:
   - analyzeScene() calls addContinuityAnalysis()
   - addContinuityAnalysis() calls enrichShotsWithSpatialData()
   - addContinuityAnalysis() calls analyzeHollywoodContinuity()
  </action>
  <verify>
PHP syntax valid: `php -l modules/AppVideoWizard/app/Services/ShotIntelligenceService.php` returns "No syntax errors"

VwSetting import exists: `grep -n "use.*VwSetting" modules/AppVideoWizard/app/Services/ShotIntelligenceService.php`

Log import exists: `grep -n "use.*Log" modules/AppVideoWizard/app/Services/ShotIntelligenceService.php`
  </verify>
  <done>ShotIntelligenceService parses without errors and has all required imports for Hollywood continuity integration</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. `enrichShotsWithSpatialData()` method exists and maps eyeline → lookDirection/screenDirection
2. `addContinuityAnalysis()` enriches shots before analysis
3. `analyzeHollywoodContinuity()` is called instead of `analyzeSequence()`
4. Scene type is passed to Hollywood analysis for context-aware continuity
5. PHP syntax validation passes
6. All required imports present
</verification>

<success_criteria>
- Shot data flows from eyeline → lookDirection AND screenDirection before continuity analysis
- Hollywood continuity methods receive properly structured shot data
- check180DegreeRule(), checkEyelineMatch(), checkMatchOnAction() can now function (previously early-exited due to missing fields)
- Scene type context passed to analysis for dialogue/action/montage-specific rules
</success_criteria>

<output>
After completion, create `.planning/phases/23-scene-level-shot-continuity/23-01-SUMMARY.md`
</output>
