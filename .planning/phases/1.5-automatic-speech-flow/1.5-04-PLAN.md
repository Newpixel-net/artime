---
phase: 1.5-automatic-speech-flow
plan: 04
type: execute
wave: 3
depends_on: ["1.5-01", "1.5-02", "1.5-03"]
files_modified:
  - modules/AppVideoWizard/app/Livewire/VideoWizard.php
  - modules/AppVideoWizard/app/Services/ShotIntelligenceService.php
autonomous: true

must_haves:
  truths:
    - "Shot generation receives speechSegments data from scenes"
    - "Shots know which segments they contain"
    - "Shot needsLipSync is determined by segment types"
    - "Video generation routes correctly based on segment needsLipSync"
  artifacts:
    - path: "modules/AppVideoWizard/app/Services/ShotIntelligenceService.php"
      provides: "Segment-aware shot generation"
      contains: "speechSegments"
    - path: "modules/AppVideoWizard/app/Livewire/VideoWizard.php"
      provides: "Segment data flow to shots"
      contains: "speechSegments"
  key_links:
    - from: "ShotIntelligenceService"
      to: "scene['speechSegments']"
      via: "array access"
      pattern: "scene\\['speechSegments'\\]"
---

<objective>
Ensure segment data flows correctly to shots and video generation.

Purpose: The automatic speech flow needs to connect all the way through to video generation. Shots should know their speech segments and route to the correct video model (Minimax for voiceover-only, Multitalk for lip-sync).

Output: End-to-end segment data flow from script to video generation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/1.5-automatic-speech-flow/1.5-CONTEXT.md
@.planning/phases/1.5-automatic-speech-flow/1.5-RESEARCH.md
@.planning/phases/1.5-automatic-speech-flow/1.5-01-SUMMARY.md
@.planning/phases/1.5-automatic-speech-flow/1.5-02-SUMMARY.md
@.planning/phases/1.5-automatic-speech-flow/1.5-03-SUMMARY.md
@modules/AppVideoWizard/app/Services/ShotIntelligenceService.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify ShotIntelligenceService uses speechSegments</name>
  <files>modules/AppVideoWizard/app/Services/ShotIntelligenceService.php</files>
  <action>
Examine `ShotIntelligenceService.php` and verify it correctly reads `speechSegments` from scene data.

Look for the `sceneRequiresLipSync` method (around line 933-960) and verify it:
1. Reads speechSegments from the scene
2. Checks each segment's needsLipSync flag
3. Returns true if ANY segment requires lip-sync

The method should look like this (verify or update if needed):

```php
/**
 * Determine if a scene requires lip-sync video generation.
 * For scenes with speechSegments (mixed speech types), this returns true
 * if ANY segment requires lip-sync (dialogue or monologue).
 *
 * @param array $scene Scene data with voiceover/speechSegments
 * @return bool True if any segment needs lip-sync
 */
public function sceneRequiresLipSync(array $scene): bool
{
    // Check speechSegments first (new segment-based system)
    $speechSegments = $scene['voiceover']['speechSegments'] ?? $scene['speechSegments'] ?? [];

    if (!empty($speechSegments)) {
        // Check if any segment needs lip-sync
        foreach ($speechSegments as $segment) {
            $needsLipSync = $segment['needsLipSync'] ?? false;
            if ($needsLipSync) {
                return true;
            }
        }
        return false;
    }

    // Fallback to legacy speechType check
    $speechType = $scene['voiceover']['speechType'] ?? $scene['speechType'] ?? 'narrator';

    // Dialogue and monologue require lip-sync
    return in_array($speechType, ['dialogue', 'monologue'], true);
}
```

Also verify the `distributeDialogueToShots` method (around line 1002-1055) correctly handles speechSegments.
  </action>
  <verify>
Search for `speechSegments` in ShotIntelligenceService.php - should be found in sceneRequiresLipSync.
Search for `needsLipSync.*true` - should check segment's flag.
Verify method returns correct value for mixed scenes.
  </verify>
  <done>
ShotIntelligenceService correctly handles speechSegments:
- sceneRequiresLipSync reads speechSegments array
- Checks each segment's needsLipSync flag
- Returns true if any segment needs lip-sync
- Fallback to legacy speechType for old data
  </done>
</task>

<task type="auto">
  <name>Task 2: Ensure shots inherit segment data</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Search for where shots are created or assigned speech data. This is likely in a method like `generateShots`, `assignVoiceoversToShots`, or similar.

Verify that when shots are created:
1. They receive the scene's speechSegments array
2. They can determine their own needsLipSync based on segments

Look for code that assigns voiceover data to shots and ensure it includes speechSegments:

```php
// When assigning scene data to shots, ensure speechSegments are included:
$shot['speechSegments'] = $scene['speechSegments'] ?? [];
$shot['needsLipSync'] = $this->shotRequiresLipSync($shot);

// Or when inheriting from scene:
$shot['voiceover'] = [
    'text' => $segmentText,
    'speechType' => $scene['speechType'] ?? 'mixed',
    'speechSegments' => $scene['speechSegments'] ?? [],
    // ... other voiceover data
];
```

Also add/verify a helper method:

```php
/**
 * Determine if a shot requires lip-sync based on its speech segments.
 *
 * @param array $shot Shot data
 * @return bool
 */
protected function shotRequiresLipSync(array $shot): bool
{
    $segments = $shot['speechSegments'] ?? $shot['voiceover']['speechSegments'] ?? [];

    if (empty($segments)) {
        // Fallback to speechType
        $speechType = $shot['speechType'] ?? $shot['voiceover']['speechType'] ?? 'narrator';
        return in_array($speechType, ['dialogue', 'monologue'], true);
    }

    // Check if any segment needs lip-sync
    foreach ($segments as $segment) {
        if ($segment['needsLipSync'] ?? false) {
            return true;
        }
    }

    return false;
}
```
  </action>
  <verify>
Search for `speechSegments` assignment to shots in VideoWizard.php.
Search for `shotRequiresLipSync` method.
Verify shots can determine lip-sync need from their segments.
  </verify>
  <done>
Shots correctly inherit segment data:
- Shot creation includes speechSegments from scene
- shotRequiresLipSync method determines lip-sync need
- Fallback to legacy speechType for compatibility
  </done>
</task>

<task type="auto">
  <name>Task 3: Add end-to-end flow verification</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Add a diagnostic method to verify the complete data flow. This helps with debugging and ensures all connections work.

```php
/**
 * Verify automatic speech flow from script to shots.
 * Returns diagnostic information about the speech segment pipeline.
 *
 * @return array Diagnostic data
 */
public function verifySpeechFlow(): array
{
    $diagnostics = [
        'scenes' => [],
        'issues' => [],
        'summary' => [
            'totalScenes' => 0,
            'scenesWithSegments' => 0,
            'totalSegments' => 0,
            'segmentsNeedingLipSync' => 0,
            'charactersLinked' => 0,
            'charactersUnlinked' => 0,
        ],
    ];

    foreach ($this->script['scenes'] ?? [] as $idx => $scene) {
        $diagnostics['summary']['totalScenes']++;

        $segments = $scene['speechSegments'] ?? [];
        $sceneData = [
            'index' => $idx,
            'hasSegments' => !empty($segments),
            'segmentCount' => count($segments),
            'speechType' => $scene['speechType'] ?? 'unknown',
            'segments' => [],
        ];

        if (!empty($segments)) {
            $diagnostics['summary']['scenesWithSegments']++;

            foreach ($segments as $segment) {
                $diagnostics['summary']['totalSegments']++;

                $segData = [
                    'type' => $segment['type'] ?? 'unknown',
                    'speaker' => $segment['speaker'] ?? null,
                    'characterId' => $segment['characterId'] ?? null,
                    'voiceId' => $segment['voiceId'] ?? null,
                    'needsLipSync' => $segment['needsLipSync'] ?? false,
                ];

                if ($segData['needsLipSync']) {
                    $diagnostics['summary']['segmentsNeedingLipSync']++;
                }

                if (!empty($segData['characterId'])) {
                    $diagnostics['summary']['charactersLinked']++;
                } elseif (!empty($segData['speaker'])) {
                    $diagnostics['summary']['charactersUnlinked']++;
                    $diagnostics['issues'][] = "Scene {$idx}: Speaker '{$segData['speaker']}' not linked to Character Bible";
                }

                $sceneData['segments'][] = $segData;
            }
        } else {
            // Scene has no segments - check if it should
            if (!empty($scene['narration'])) {
                $diagnostics['issues'][] = "Scene {$idx}: Has narration but no speechSegments - needs parsing";
            }
        }

        $diagnostics['scenes'][] = $sceneData;
    }

    Log::info('VideoWizard: Speech flow verification', $diagnostics['summary']);

    return $diagnostics;
}
```

This method can be called from debug tools or admin panel to verify the pipeline is working correctly.
  </action>
  <verify>
Search for `verifySpeechFlow` in VideoWizard.php - method should exist.
Method should return diagnostic array with scene/segment details.
  </verify>
  <done>
Diagnostic verification method added:
- verifySpeechFlow returns complete pipeline status
- Identifies scenes missing segments
- Identifies speakers not linked to Character Bible
- Provides summary statistics
- Logs summary for debugging
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Data Flow Check:
   - Generate a script with dialogue
   - Verify scenes have speechSegments populated
   - Verify segments have characterId linked
   - Verify shots inherit segment data

2. Lip-sync Routing Check:
   - Dialogue segments have needsLipSync = true
   - Narrator segments have needsLipSync = false
   - Shots correctly determine their lip-sync requirement

3. Diagnostic Check:
   - Call verifySpeechFlow()
   - No issues in the issues array
   - Summary statistics are accurate
</verification>

<success_criteria>
- [ ] ShotIntelligenceService.sceneRequiresLipSync reads speechSegments
- [ ] Shots receive speechSegments from their scenes
- [ ] shotRequiresLipSync method exists and works
- [ ] verifySpeechFlow diagnostic method added
- [ ] Dialogue segments route to lip-sync video generation
- [ ] Narrator segments route to standard video generation
- [ ] End-to-end data flow verified
</success_criteria>

<output>
After completion, create `.planning/phases/1.5-automatic-speech-flow/1.5-04-SUMMARY.md`
</output>
