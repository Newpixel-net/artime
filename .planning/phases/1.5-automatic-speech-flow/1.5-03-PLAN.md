---
phase: 1.5-automatic-speech-flow
plan: 03
type: execute
wave: 2
depends_on: ["1.5-01"]
files_modified:
  - modules/AppVideoWizard/app/Livewire/VideoWizard.php
autonomous: true

must_haves:
  truths:
    - "characterIntelligence property kept for backward compatibility"
    - "Old projects with characterIntelligence load without errors"
    - "characterIntelligence values migrate to segment-based system on load"
    - "updateCharacterIntelligence method deprecated but functional"
  artifacts:
    - path: "modules/AppVideoWizard/app/Livewire/VideoWizard.php"
      provides: "Backward compatibility for characterIntelligence"
      contains: "migrateCharacterIntelligence"
  key_links:
    - from: "VideoWizard::mount"
      to: "migrateCharacterIntelligence"
      via: "method call on project load"
      pattern: "migrateCharacterIntelligence"
---

<objective>
Refactor characterIntelligence for backward compatibility.

Purpose: Keep the characterIntelligence property for backward compatibility with old projects, but deprecate its active use. Old projects should load without errors and automatically migrate to the segment-based system.

Output: Backward-compatible VideoWizard that handles legacy data gracefully.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/1.5-automatic-speech-flow/1.5-CONTEXT.md
@.planning/phases/1.5-automatic-speech-flow/1.5-RESEARCH.md
@.planning/phases/1.5-automatic-speech-flow/1.5-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add migrateCharacterIntelligence method</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Add a new method to migrate old characterIntelligence data to the segment-based system.

Location: Add after the existing `autoDetectCharacterIntelligence()` method.

```php
/**
 * Migrate legacy characterIntelligence data to segment-based system.
 * Called on project load for backward compatibility.
 *
 * @deprecated Phase 1.5 - characterIntelligence replaced with automatic speech flow
 */
protected function migrateCharacterIntelligence(): void
{
    // Check if migration is needed
    $hasLegacyData = !empty($this->characterIntelligence['narrationStyle'])
        && $this->characterIntelligence['narrationStyle'] !== 'voiceover';

    $hasScenesWithoutSegments = false;
    foreach ($this->script['scenes'] ?? [] as $scene) {
        if (!empty($scene['narration']) && empty($scene['speechSegments'])) {
            $hasScenesWithoutSegments = true;
            break;
        }
    }

    if (!$hasLegacyData && !$hasScenesWithoutSegments) {
        return; // No migration needed
    }

    Log::info('VideoWizard: Migrating legacy characterIntelligence', [
        'project_id' => $this->projectId,
        'narrationStyle' => $this->characterIntelligence['narrationStyle'] ?? 'unknown',
    ]);

    // Parse scenes that don't have segments yet
    if ($hasScenesWithoutSegments) {
        $this->parseScriptIntoSegments();
    }

    // Reset characterIntelligence to defaults (data is now in segments)
    $this->characterIntelligence = array_merge($this->characterIntelligence, [
        'migrated' => true,
        'migratedAt' => now()->toISOString(),
    ]);

    // Save migration state
    $this->saveProject();

    $this->dispatch('vw-debug', [
        'action' => 'character-intelligence-migrated',
        'message' => 'Legacy character intelligence migrated to speech segments',
    ]);
}
```
  </action>
  <verify>
Search for `migrateCharacterIntelligence` in VideoWizard.php - method should exist.
Search for `migrated.*true` pattern - migration flag should be set.
  </verify>
  <done>
migrateCharacterIntelligence method added that:
- Detects legacy characterIntelligence data
- Detects scenes without speechSegments
- Triggers parseScriptIntoSegments for migration
- Marks data as migrated
- Logs migration for debugging
  </done>
</task>

<task type="auto">
  <name>Task 2: Call migration in mount/loadProject</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Find the `mount()` method or the method that loads project data (likely around line 1600-1700 where `loadProjectFromDatabase` or similar exists).

Add migration call after project data is loaded:

Look for code that loads `characterIntelligence` from the project config (search for `config['characterIntelligence']`), and add migration call after it:

```php
// After loading characterIntelligence from project config:
if (isset($config['characterIntelligence'])) {
    $this->characterIntelligence = array_merge($this->characterIntelligence, $config['characterIntelligence']);
}

// ADD THIS: Migrate legacy data if needed (Phase 1.5)
if (!($this->characterIntelligence['migrated'] ?? false)) {
    $this->migrateCharacterIntelligence();
}
```

Also add migration check in `hydrate()` or `boot()` if those methods handle state restoration:

```php
/**
 * Called when component hydrates from session.
 */
public function hydrate(): void
{
    // Migrate legacy data if needed (Phase 1.5 backward compatibility)
    if (!($this->characterIntelligence['migrated'] ?? false) && !empty($this->script['scenes'])) {
        $this->migrateCharacterIntelligence();
    }
}
```
  </action>
  <verify>
Search for `migrateCharacterIntelligence()` call - should be called during project load.
Search for `characterIntelligence\['migrated'\]` - migration flag check should exist.
  </verify>
  <done>
Migration is triggered:
- On project load (if characterIntelligence not yet migrated)
- On component hydration (if has scenes but no migration flag)
- Migration only runs once per project (flag prevents re-run)
  </done>
</task>

<task type="auto">
  <name>Task 3: Deprecate updateCharacterIntelligence method</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Find the `updateCharacterIntelligence` method (search for `public function updateCharacterIntelligence`).

Modify it to be a no-op with deprecation warning:

```php
/**
 * Update Character Intelligence settings.
 *
 * @deprecated Phase 1.5 - Character Intelligence UI removed.
 * Settings are now auto-detected from speech segments.
 * This method kept for backward compatibility but has no effect.
 */
public function updateCharacterIntelligence(string $field, $value): void
{
    // Log deprecation warning (development only)
    if (config('app.debug')) {
        Log::warning('VideoWizard: updateCharacterIntelligence is deprecated (Phase 1.5)', [
            'field' => $field,
            'value' => $value,
        ]);
    }

    // Keep the property update for backward compatibility
    // (old UI elements might still call this)
    if (isset($this->characterIntelligence[$field])) {
        $this->characterIntelligence[$field] = $value;
    }

    // Note: This no longer affects script generation.
    // Speech segments are auto-parsed and control speech type per segment.
}
```

Also add a deprecation notice to the `$characterIntelligence` property definition:

```php
/**
 * Step 2: Character Intelligence (affects script generation)
 *
 * @deprecated Phase 1.5 - Replaced with automatic speech flow.
 * Kept for backward compatibility with old projects.
 * New system uses speechSegments array per scene instead.
 */
public array $characterIntelligence = [
    'enabled' => true,
    'narrationStyle' => 'voiceover', // voiceover, dialogue, narrator, none
    'characterCount' => 4,
    'suggestedCount' => 4,
    'characters' => [], // Will be populated after script generation
    'migrated' => false, // Phase 1.5: Set to true after migration
];
```
  </action>
  <verify>
Search for `@deprecated Phase 1.5` in characterIntelligence method - deprecation notice should exist.
Search for `updateCharacterIntelligence.*deprecated` - method should have deprecation comment.
  </verify>
  <done>
updateCharacterIntelligence method deprecated:
- Marked with @deprecated annotation
- Logs warning in debug mode
- Still updates property for compatibility
- No longer affects actual behavior
- characterIntelligence property also marked deprecated
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Backward Compatibility Check:
   - Load an old project (if available) - should not error
   - Check logs for migration message

2. Deprecation Check:
   - characterIntelligence property has @deprecated tag
   - updateCharacterIntelligence has @deprecated tag
   - Debug logs show deprecation warnings

3. Migration Check:
   - Projects without speechSegments get them populated
   - Migration flag prevents re-migration
</verification>

<success_criteria>
- [ ] migrateCharacterIntelligence method added
- [ ] Migration called on project load
- [ ] Migration flag prevents duplicate runs
- [ ] updateCharacterIntelligence marked deprecated
- [ ] characterIntelligence property marked deprecated
- [ ] Old projects load without errors
- [ ] Scenes get speechSegments populated on migration
</success_criteria>

<output>
After completion, create `.planning/phases/1.5-automatic-speech-flow/1.5-03-SUMMARY.md`
</output>
