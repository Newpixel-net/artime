---
phase: 1.5-automatic-speech-flow
plan: 01
subsystem: speech-flow
tags: [speech-segments, auto-parse, character-bible, livewire]
dependency-graph:
  requires: [dynamic-speech-segments]
  provides: [auto-speech-parsing, character-auto-link, detection-summary]
  affects: [script-generation, narration-editing, character-bible]
tech-stack:
  added: []
  patterns: [auto-parse-on-generation, auto-link-speakers, fuzzy-name-matching]
key-files:
  created: []
  modified:
    - modules/AppVideoWizard/app/Livewire/VideoWizard.php
decisions:
  - Auto-parse script into segments immediately after AI generation
  - Auto-link speakers to Character Bible using fuzzy matching (exact, partial, Levenshtein)
  - Auto-create Character Bible entries for unknown speakers
  - Re-parse individual scenes when narration is manually edited
  - Use isParsing flag to prevent re-entry loops
metrics:
  duration: ~15min
  completed: 2026-01-23
---

# Phase 1.5 Plan 01: Automatic Speech Segment Parsing Summary

**One-liner:** Auto-parse script narration into speech segments with speaker-to-Character-Bible linking using fuzzy name matching.

## What Was Done

### Task 1: Add parseScriptIntoSegments method to VideoWizard
- Added `parseScriptIntoSegments()` method that iterates through all scenes and parses narration into speech segments
- Added `autoLinkAndCreateCharacters()` method that links segment speakers to Character Bible entries or creates new entries for unknown speakers
- Added `findCharacterByNameFuzzy()` helper with three matching strategies: exact match, partial match (contains), and Levenshtein distance (<=2 characters)
- Added `getCharacterVoiceIdFromBible()` helper to retrieve voice ID for linked characters
- Added `buildDetectionSummary()` method to populate UI summary statistics
- Added `parseSceneNarration()` method for individual scene parsing on manual edits
- Added `$isParsing` flag property to prevent re-entry loops
- Added `$detectionSummary` property for UI display

**Commit:** ca01291

### Task 2: Integrate auto-parse into generateScript flow
- Modified `generateScript()` method to call `parseScriptIntoSegments()` after `recalculateVoiceStatus()`
- Added call to `buildDetectionSummary()` to populate UI detection data
- Added `vw-debug` dispatch event for debugging
- Wrapped auto-parse in try/catch for graceful error handling (non-critical operation)

**Commit:** 24840ac

### Task 3: Add auto-parse on manual narration edit
- Modified `updated()` lifecycle hook to detect `script.scenes.N.narration` property changes
- Added regex pattern matching to extract scene index from property path
- Added `isParsing` check to prevent re-entry during parsing
- Calls `parseSceneNarration()` for the specific scene that changed

**Commit:** 0b59341

## Technical Details

### Parsing Flow
```
AI generates script
    -> parseScriptIntoSegments() called
    -> For each scene with narration:
        -> SpeechSegmentParser::parse() parses into segments
        -> autoLinkAndCreateCharacters() links speakers
        -> scene['speechSegments'] = array of segments
        -> scene['speechType'] = 'mixed'
    -> buildDetectionSummary() populates UI data
```

### Character Linking Strategy (Fuzzy Matching)
1. **Exact match:** `strtoupper(speaker) === strtoupper(characterName)`
2. **Partial match:** speaker name contains character name or vice versa
3. **Levenshtein:** `levenshtein(speaker, characterName) <= 2` (allows 2-character typo tolerance)

### Auto-Create Unknown Speakers
When a speaker is not found in Character Bible:
- Creates new entry with unique ID: `char_{timestamp}_{random4}`
- Sets `autoDetected: true` flag
- Leaves `voiceId: null` for user to configure later

## Files Modified

| File | Changes |
|------|---------|
| `modules/AppVideoWizard/app/Livewire/VideoWizard.php` | +288 lines: 8 new methods, 2 new properties |

## Deviations from Plan

None - plan executed exactly as written.

## Success Criteria Met

- [x] parseScriptIntoSegments method added to VideoWizard
- [x] autoLinkAndCreateCharacters method added with fuzzy name matching
- [x] generateScript calls parseScriptIntoSegments after script generation
- [x] buildDetectionSummary method creates summary for UI
- [x] updated method handles script.scenes.N.narration changes
- [x] parseSceneNarration method parses individual scene on edit
- [x] isParsing flag prevents re-entry loops
- [x] No PHP errors (syntax validated)

## Next Phase Readiness

The auto-parsing infrastructure is complete. Next steps:
- Plan 02: Remove Character Intelligence UI section
- Plan 03: Add read-only Detection Summary panel
- Plan 04: Update downstream components to use speechSegments

---

*Generated: 2026-01-23*
*Phase: 1.5-automatic-speech-flow*
