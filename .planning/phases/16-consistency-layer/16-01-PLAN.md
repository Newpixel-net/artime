---
phase: 16-consistency-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/AppVideoWizard/app/Livewire/VideoWizard.php
autonomous: true

must_haves:
  truths:
    - "Internal thought text distributes evenly across all shots (no empty shots)"
    - "Internal thought uses same word-split algorithm as narrator"
    - "Every shot receives approximately equal word count for internal thoughts"
  artifacts:
    - path: "modules/AppVideoWizard/app/Livewire/VideoWizard.php"
      provides: "Refactored markInternalThoughtAsVoiceover() with word-split algorithm"
      contains: "wordsPerShot"
  key_links:
    - from: "markInternalThoughtAsVoiceover()"
      to: "word-split distribution pattern"
      via: "preg_split and array_slice logic"
      pattern: "preg_split.*\\\\s\\+.*wordsPerShot"
---

<objective>
Unify internal thought distribution to use the same word-split algorithm as narrator overlay (VOC-03).

Purpose: The narrator overlay uses word-split distribution (text evenly distributed across all shots), while internal thought uses segment-split (whole segments, some shots may be empty). This asymmetry causes inconsistent behavior. Aligning both methods ensures predictable, even distribution.

Output: Refactored `markInternalThoughtAsVoiceover()` method that distributes internal thought text evenly across all shots using word-split, matching the narrator overlay behavior.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-consistency-layer/16-RESEARCH.md

Key reference from research:
- Current segment-split algorithm: lines 24115-24176 in VideoWizard.php
- Narrator word-split algorithm to copy: lines 23921-23945 in VideoWizard.php
- Speaker voice lookup: getVoiceForCharacterName() at line 23187
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor markInternalThoughtAsVoiceover() to use word-split distribution</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Locate `markInternalThoughtAsVoiceover()` method (around line 24115).

Replace the segment-split algorithm with word-split algorithm matching overlayNarratorSegments():

1. **Combine all internal thought text:**
   ```php
   $allInternalText = implode(' ', array_column($internalSegments, 'text'));
   $words = preg_split('/\s+/', trim($allInternalText));
   $totalWords = count($words);
   $wordsPerShot = max(1, ceil($totalWords / $shotCount));
   ```

2. **Extract speaker from first segment** (internal thoughts typically have one speaker):
   ```php
   $speaker = $internalSegments[0]['speaker'] ?? null;
   $voiceId = $speaker ? $this->getVoiceForCharacterName($speaker) : $this->getNarratorVoice();
   ```

3. **Add logging for visibility (VOC-03):**
   ```php
   Log::info('Distributing internal thought text across all shots (VOC-03)', [
       'sceneIndex' => $sceneIndex,
       'totalWords' => $totalWords,
       'shotCount' => $shotCount,
       'wordsPerShot' => $wordsPerShot,
       'speaker' => $speaker,
   ]);
   ```

4. **Distribute words evenly across shots:**
   ```php
   $wordIndex = 0;
   foreach ($shots as $shotIdx => $shot) {
       $shotWords = array_slice($words, $wordIndex, $wordsPerShot);
       $wordIndex += $wordsPerShot;

       // Last shot gets remaining words
       if ($shotIdx === $shotCount - 1 && $wordIndex < $totalWords) {
           $shotWords = array_merge($shotWords, array_slice($words, $wordIndex));
       }

       $shotInternalText = implode(' ', $shotWords);

       if (!empty($shotInternalText)) {
           // Create internal thought segment for this shot
           $shotInternals = [[
               'id' => 'seg-internal-shot-' . $shotIdx . '-' . uniqid(),
               'type' => SpeechSegment::TYPE_INTERNAL,
               'text' => $shotInternalText,
               'speaker' => $speaker,
               'needsLipSync' => false,
               'order' => $shotIdx,
           ]];

           $shots[$shotIdx]['internalThoughtOverlay'] = $shotInternals;
           $shots[$shotIdx]['hasInternalVoiceover'] = true;
           $shots[$shotIdx]['internalThoughtText'] = $shotInternalText;
           $shots[$shotIdx]['internalVoiceId'] = $voiceId;

           if ($speaker) {
               $shots[$shotIdx]['internalThoughtSpeaker'] = $speaker;
           }
       }
   }
   ```

5. **Keep early returns unchanged:**
   - Return early if `$shots` or `$speechSegments` empty
   - Return early if no internal thought segments found after filtering

Key changes from old to new:
- OLD: `$internalsPerShot = ceil($internalCount / $shotCount)` (whole segments)
- NEW: `$wordsPerShot = ceil($totalWords / $shotCount)` (words)
- OLD: Some shots may have no segments
- NEW: Every shot gets approximately equal words
- OLD: Reuses original segment objects
- NEW: Creates new segment objects per shot (like narrator)

Do NOT change method signature or return type.
  </action>
  <verify>
1. Verify method compiles: `php -l modules/AppVideoWizard/app/Livewire/VideoWizard.php`
2. Search for word-split pattern: `grep -n "wordsPerShot" modules/AppVideoWizard/app/Livewire/VideoWizard.php` should show it in markInternalThoughtAsVoiceover
3. Verify logging present: `grep -n "VOC-03" modules/AppVideoWizard/app/Livewire/VideoWizard.php`
  </verify>
  <done>
- markInternalThoughtAsVoiceover() uses word-split algorithm identical to overlayNarratorSegments()
- All shots receive approximately equal portion of internal thought text
- No shots are left without internal thought text when internal thoughts exist
- VOC-03 logging provides visibility into distribution
  </done>
</task>

<task type="auto">
  <name>Task 2: Add word distribution verification test</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
After the distribution loop (before the final return), add a verification check that logs if any shot was unexpectedly left without internal thought:

```php
// VOC-03: Verify distribution completeness
$shotsWithInternal = 0;
foreach ($shots as $shot) {
    if (!empty($shot['hasInternalVoiceover'])) {
        $shotsWithInternal++;
    }
}

if ($shotsWithInternal < $shotCount && $totalWords >= $shotCount) {
    Log::warning('Internal thought distribution incomplete (VOC-03)', [
        'sceneIndex' => $sceneIndex,
        'totalShots' => $shotCount,
        'shotsWithInternal' => $shotsWithInternal,
        'totalWords' => $totalWords,
    ]);
}
```

This ensures we catch any edge cases where the word-split algorithm might fail to distribute evenly.

Also add a comment block at the top of the method documenting the VOC-03 change:
```php
/**
 * Mark shots with internal thought voiceover overlay.
 *
 * VOC-03: Uses word-split distribution (same as overlayNarratorSegments)
 * to distribute internal thought text evenly across all shots.
 * This ensures every shot receives approximately equal word count
 * and no shots are left empty when internal thoughts exist.
 *
 * @param int $sceneIndex Scene index for logging
 * @param array $shots Array of shot data
 * @param array $speechSegments Speech segments including internal thoughts
 * @return array Modified shots with internal thought overlay
 */
```
  </action>
  <verify>
1. Verify method compiles: `php -l modules/AppVideoWizard/app/Livewire/VideoWizard.php`
2. Verify verification check present: `grep -n "distribution incomplete" modules/AppVideoWizard/app/Livewire/VideoWizard.php`
3. Verify docblock present: `grep -n "word-split distribution" modules/AppVideoWizard/app/Livewire/VideoWizard.php`
  </verify>
  <done>
- Method has docblock explaining VOC-03 word-split distribution
- Verification check logs warning if distribution is incomplete
- Complete audit trail for debugging distribution issues
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Syntax check:** `php -l modules/AppVideoWizard/app/Livewire/VideoWizard.php` returns no errors

2. **Word-split pattern present:** Method contains `preg_split`, `wordsPerShot`, `array_slice` pattern matching narrator overlay

3. **No segment-split remnants:** Method no longer uses `$internalsPerShot = ceil($internalCount / $shotCount)` pattern

4. **Logging present:** VOC-03 tagged logging for distribution and completeness verification

5. **Documentation:** Method has docblock explaining word-split approach
</verification>

<success_criteria>
1. Internal thought text distributes evenly across all shots (word-split, not segment-split)
2. Algorithm matches overlayNarratorSegments() exactly (combine text -> split words -> distribute)
3. Every shot receives approximately equal word count when internal thoughts exist
4. VOC-03 logging provides visibility into distribution
5. No shots left empty when total words >= shot count
</success_criteria>

<output>
After completion, create `.planning/phases/16-consistency-layer/16-01-SUMMARY.md` using the summary template.

Include in frontmatter:
- subsystem: voice-production
- tags: [tts, internal-thought, distribution, word-split, voc-03]
- provides: "Unified word-split distribution for internal thoughts"
- affects: [voice-production, tts-generation, 17-voice-registry]
</output>
