---
phase: 16-consistency-layer
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/AppVideoWizard/app/Livewire/VideoWizard.php
autonomous: true

must_haves:
  truths:
    - "Same character maintains same voice across all scenes"
    - "Voice mismatches are logged as warnings (non-blocking)"
    - "Character-to-voice mapping is tracked and validated"
  artifacts:
    - path: "modules/AppVideoWizard/app/Livewire/VideoWizard.php"
      provides: "validateVoiceContinuity() method following M8 pattern"
      contains: "function validateVoiceContinuity"
  key_links:
    - from: "validateVoiceContinuity()"
      to: "scene processing flow"
      via: "call after shot decomposition"
      pattern: "validateVoiceContinuity.*scenes"
---

<objective>
Add voice continuity validation to ensure same character maintains same voice across all scenes (VOC-04).

Purpose: Currently there is no validation that a character's voice remains consistent throughout the video. If the same character appears in multiple scenes, they could theoretically receive different voices due to fallback logic. This validation catches and logs any mismatches without halting generation (following M8 non-blocking pattern).

Output: `validateVoiceContinuity()` method that tracks character-to-voice mapping across all scenes, logs warnings for mismatches, and returns validation results with statistics.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-consistency-layer/16-RESEARCH.md

Key reference from research:
- M8 non-blocking validation pattern: validateAndFixTransitions() in DialogueSceneDecomposerService.php lines 2260-2334
- Voice data in shots: speakingCharacter/character, voiceId, internalThoughtSpeaker, internalVoiceId
- Name normalization pattern: strtoupper(trim($name)) for consistent matching
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create validateVoiceContinuity() method</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Add a new method `validateVoiceContinuity()` following the M8 non-blocking validation pattern. Place it near other validation methods or near voice-related methods (getVoiceForCharacterName, getNarratorVoice).

```php
/**
 * VOC-04: Validate voice continuity across scenes.
 * Same character must maintain same voice throughout the video.
 * Non-blocking validation: logs warnings but doesn't halt generation.
 *
 * @param array $scenes All decomposed scenes
 * @return array Validation result with warnings
 */
protected function validateVoiceContinuity(array $scenes): array
{
    $characterVoices = [];  // Track: character => first assigned voice
    $mismatches = [];
    $validated = 0;

    foreach ($scenes as $sceneIndex => $scene) {
        $shots = $scene['shots'] ?? [];

        foreach ($shots as $shotIndex => $shot) {
            // Check dialogue/monologue speaker
            $speaker = $shot['speakingCharacter'] ?? $shot['character'] ?? null;
            $voiceId = $shot['voiceId'] ?? null;

            if ($speaker && $voiceId) {
                $speakerKey = strtoupper(trim($speaker));

                if (!isset($characterVoices[$speakerKey])) {
                    // First occurrence - register this voice
                    $characterVoices[$speakerKey] = [
                        'voiceId' => $voiceId,
                        'firstScene' => $sceneIndex,
                        'firstShot' => $shotIndex,
                    ];
                } else {
                    // Check for mismatch
                    $expected = $characterVoices[$speakerKey]['voiceId'];
                    if ($voiceId !== $expected) {
                        $mismatches[] = [
                            'character' => $speaker,
                            'sceneIndex' => $sceneIndex,
                            'shotIndex' => $shotIndex,
                            'expected' => $expected,
                            'actual' => $voiceId,
                            'firstAssigned' => $characterVoices[$speakerKey],
                        ];

                        Log::warning('Voice continuity mismatch detected (VOC-04)', [
                            'character' => $speaker,
                            'scene' => $sceneIndex,
                            'shot' => $shotIndex,
                            'expected' => $expected,
                            'actual' => $voiceId,
                        ]);
                    }
                }
                $validated++;
            }

            // Check internal thought speaker
            $internalSpeaker = $shot['internalThoughtSpeaker'] ?? null;
            $internalVoice = $shot['internalVoiceId'] ?? null;

            if ($internalSpeaker && $internalVoice) {
                $speakerKey = strtoupper(trim($internalSpeaker));

                if (!isset($characterVoices[$speakerKey])) {
                    $characterVoices[$speakerKey] = [
                        'voiceId' => $internalVoice,
                        'firstScene' => $sceneIndex,
                        'firstShot' => $shotIndex,
                        'type' => 'internal',
                    ];
                } else {
                    $expected = $characterVoices[$speakerKey]['voiceId'];
                    if ($internalVoice !== $expected) {
                        $mismatches[] = [
                            'character' => $internalSpeaker,
                            'sceneIndex' => $sceneIndex,
                            'shotIndex' => $shotIndex,
                            'expected' => $expected,
                            'actual' => $internalVoice,
                            'type' => 'internal',
                        ];

                        Log::warning('Voice continuity mismatch in internal thought (VOC-04)', [
                            'character' => $internalSpeaker,
                            'scene' => $sceneIndex,
                            'shot' => $shotIndex,
                            'expected' => $expected,
                            'actual' => $internalVoice,
                        ]);
                    }
                }
                $validated++;
            }
        }
    }

    // Log summary (same as M8 pattern)
    Log::info('Voice continuity validation complete (VOC-04)', [
        'charactersTracked' => count($characterVoices),
        'assignmentsValidated' => $validated,
        'mismatchesFound' => count($mismatches),
    ]);

    return [
        'valid' => empty($mismatches),
        'characterVoices' => $characterVoices,
        'mismatches' => $mismatches,
        'statistics' => [
            'characters' => count($characterVoices),
            'validated' => $validated,
            'mismatches' => count($mismatches),
        ],
    ];
}
```

Key pattern elements (from M8 validateAndFixTransitions):
1. Early structure for edge cases (method handles empty scenes gracefully)
2. Counter variables for statistics (`$validated`, `$mismatches`)
3. Iterate through items checking conditions
4. `Log::warning()` for issues detected
5. `Log::info()` summary at end with statistics
6. Return structured array (generation continues regardless of mismatches)
  </action>
  <verify>
1. Verify method compiles: `php -l modules/AppVideoWizard/app/Livewire/VideoWizard.php`
2. Verify method exists: `grep -n "function validateVoiceContinuity" modules/AppVideoWizard/app/Livewire/VideoWizard.php`
3. Verify M8 pattern elements: `grep -n "VOC-04" modules/AppVideoWizard/app/Livewire/VideoWizard.php` shows multiple hits (warnings + info summary)
  </verify>
  <done>
- validateVoiceContinuity() method exists with M8 non-blocking pattern
- Tracks character-to-voice mapping across all scenes
- Logs warnings for mismatches without halting generation
- Returns validation results with statistics
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate validateVoiceContinuity() into decomposition flow</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Find the appropriate integration point after all scenes have been decomposed with voice assignments. This is typically after the scene decomposition loop completes and before TTS generation begins.

Search for where scenes are assembled (look for patterns like storing decomposed scenes, or final scene array building). Common patterns to look for:
- `$this->animation['scenes']` being finalized
- Scene decomposition completion logging
- Pre-TTS processing hooks

Add the validation call at this integration point:

```php
// VOC-04: Validate voice continuity across all scenes
$voiceContinuityResult = $this->validateVoiceContinuity($scenes);

// Store validation result for potential debugging/reporting
$this->voiceContinuityValidation = $voiceContinuityResult;

// If mismatches found, they're already logged as warnings
// Generation continues (non-blocking per M8 pattern)
if (!$voiceContinuityResult['valid']) {
    Log::info('Voice continuity issues detected - continuing generation (VOC-04)', [
        'mismatchCount' => $voiceContinuityResult['statistics']['mismatches'],
    ]);
}
```

If decomposition happens scene-by-scene and scenes aren't all available at once, the integration point may need to be:
1. After all scenes are collected (e.g., after a `foreach` that builds `$scenes`)
2. In a finalization method that has access to all scene data
3. As a separate validation pass before TTS generation

Look for methods like:
- `processAllScenes()`
- `finalizeDecomposition()`
- `prepareForTTS()`
- Or the main decomposition method that calls scene processing

If no clear integration point exists, add a note in the method docblock about when to call it:
```php
/**
 * ...
 * Integration: Call this method after all scenes are decomposed with voice assignments,
 * before TTS generation begins. Example:
 *
 * $result = $this->validateVoiceContinuity($this->animation['scenes'] ?? []);
 *
 * The validation is non-blocking - generation continues regardless of result.
 */
```
  </action>
  <verify>
1. Verify method compiles: `php -l modules/AppVideoWizard/app/Livewire/VideoWizard.php`
2. Search for integration: `grep -n "validateVoiceContinuity" modules/AppVideoWizard/app/Livewire/VideoWizard.php` should show call site
3. Verify non-blocking: integration code should NOT throw or halt on mismatches
  </verify>
  <done>
- validateVoiceContinuity() is called at appropriate point in decomposition flow
- Validation runs after voice assignments are complete
- Generation continues regardless of validation result (non-blocking)
- Validation results stored for debugging if needed
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Syntax check:** `php -l modules/AppVideoWizard/app/Livewire/VideoWizard.php` returns no errors

2. **Method exists:** `validateVoiceContinuity()` method is present with correct signature

3. **M8 pattern followed:**
   - Log::warning for individual mismatches
   - Log::info for summary statistics
   - Returns array (never throws)
   - Generation not halted by mismatches

4. **Integration present:** Method is called somewhere in the decomposition flow

5. **Name normalization:** Uses `strtoupper(trim($name))` for consistent character matching

6. **Both voice types checked:** Validates both regular `voiceId` and `internalVoiceId`
</verification>

<success_criteria>
1. validateVoiceContinuity() method exists following M8 non-blocking pattern
2. Tracks character-to-voice mapping (first occurrence wins)
3. Logs warnings for any character with inconsistent voice assignments
4. Validates both dialogue voices and internal thought voices
5. Returns structured result with statistics
6. Integration point identified and method called after decomposition
7. Generation continues regardless of validation result (never throws)
</success_criteria>

<output>
After completion, create `.planning/phases/16-consistency-layer/16-02-SUMMARY.md` using the summary template.

Include in frontmatter:
- subsystem: voice-production
- tags: [tts, voice-continuity, validation, voc-04, non-blocking]
- provides: "Voice continuity validation across scenes"
- affects: [voice-production, 17-voice-registry]
</output>
