---
phase: 11-speech-driven-shot-creation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/AppVideoWizard/app/Livewire/VideoWizard.php
  - modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php
autonomous: true

must_haves:
  truths:
    - "Scene with 5 dialogue segments produces 5 shots (1:1 mapping)"
    - "Each shot contains exactly one speech segment (dialogue or monologue)"
    - "Scene with 12 speech segments produces 12 shots without artificial limit"
  artifacts:
    - path: "modules/AppVideoWizard/app/Livewire/VideoWizard.php"
      provides: "createShotsFromSpeechSegments() method"
      min_lines: 50
    - path: "modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php"
      provides: "Enhanced decomposeDialogueScene() with 1:1 segment-to-shot mapping"
      min_lines: 100
  key_links:
    - from: "createShotsFromSpeechSegments()"
      to: "shot creation in multiShotMode"
      via: "1:1 segment iteration"
      pattern: "foreach.*speechSegments.*createShot"
    - from: "decomposeDialogueScene()"
      to: "speech segments"
      via: "direct segment-to-shot mapping"
      pattern: "segments.*shots.*1:1"
---

<objective>
Invert the speech-to-shot relationship: speech segments CREATE shots instead of being distributed proportionally TO existing shots.

Purpose: Fix the fundamental cinematic issue where 8 dialogue segments get divided across 4 shots (2 segments each) instead of creating 8 shots (1 segment each). This enables proper shot/reverse-shot patterns and removes artificial shot count limitations.

Output: Refactored `createShotsFromSpeechSegments()` method that creates one shot per dialogue/monologue segment, with enhanced `DialogueSceneDecomposerService` supporting unlimited shot creation from speech.
</objective>

<execution_context>
@C:\Users\VoltaPsy\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\VoltaPsy\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Users\VoltaPsy\Documents\GitHub\artime\.planning\PROJECT.md
@C:\Users\VoltaPsy\Documents\GitHub\artime\.planning\ROADMAP.md
@C:\Users\VoltaPsy\Documents\GitHub\artime\.planning\STATE.md

## Relevant Prior Work

Phase 1.5 Plan 01 established automatic speech segment parsing with fuzzy character linking.
Phase 4 Plans 01-04 established DialogueSceneDecomposerService with shot/reverse-shot patterns, 180-degree rule enforcement.

## Key Files

@C:\Users\VoltaPsy\Documents\GitHub\artime\modules\AppVideoWizard\app\Livewire\VideoWizard.php
@C:\Users\VoltaPsy\Documents\GitHub\artime\modules\AppVideoWizard\app\Services\DialogueSceneDecomposerService.php
</context>

<tasks>

<task type="auto">
  <name>Replace distributeSpeechSegmentsToShots with createShotsFromSpeechSegments</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
**CORE INVERSION:** Replace the proportional distribution logic with 1:1 shot creation.

**1. Locate and analyze current implementation:**
- Find `distributeSpeechSegmentsToShots()` method (line ~23157)
- Note how it uses `ceil($segmentCount / $shotCount)` to divide segments across existing shots
- Identify where it's called from (line ~23068 in scene decomposition flow)

**2. Create new `createShotsFromSpeechSegments()` method:**

```php
/**
 * Create shots FROM speech segments (1:1 mapping for dialogue/monologue).
 * Each dialogue or monologue segment becomes its own shot.
 * Narrator and internal thought segments are handled separately (Plan 02).
 *
 * @param int $sceneIndex Scene index
 * @param array $speechSegments Scene's speech segments array
 * @return array Array of created shots
 */
protected function createShotsFromSpeechSegments(int $sceneIndex, array $speechSegments): array
{
    $shots = [];
    $lipSyncTypes = ['dialogue', 'monologue'];

    foreach ($speechSegments as $segmentIndex => $segment) {
        $segType = strtolower($segment['type'] ?? 'narrator');

        // Skip narrator and internal thought (handled in Plan 02)
        if (!in_array($segType, $lipSyncTypes)) {
            continue;
        }

        // Create one shot for this segment
        $shot = [
            'id' => uniqid('shot_'),
            'speechSegments' => [$segment], // Single segment per shot
            'needsLipSync' => true,
            'dialogue' => $segment['text'] ?? '',
            'speakingCharacters' => [($segment['speaker'] ?? 'Unknown')],
            'selectedVideoModel' => 'multitalk',
            'type' => 'dialogue', // Will be refined by DialogueSceneDecomposerService
            'duration' => 3, // Default, will be calculated based on text length
        ];

        // Assign voice from character
        if (!empty($segment['speaker'])) {
            $voice = $this->getVoiceForCharacterName($segment['speaker']);
            $shot['voiceId'] = $voice;
        }

        $shots[] = $shot;
    }

    Log::info('Created shots from speech segments (1:1 mapping)', [
        'sceneIndex' => $sceneIndex,
        'totalSegments' => count($speechSegments),
        'shotsCreated' => count($shots),
        'ratio' => '1:1',
    ]);

    return $shots;
}
```

**3. Replace calls to old method:**
- Find where `distributeSpeechSegmentsToShots()` is called (line ~23068)
- Replace with `createShotsFromSpeechSegments()` returning shots array
- Update surrounding code to use returned shots instead of proportional distribution

**4. IMPORTANT - Preserve backward compatibility:**
- Keep old `distributeSpeechSegmentsToShots()` method but mark as deprecated
- Add comment: `// DEPRECATED: Use createShotsFromSpeechSegments() - speech now creates shots, not distributed to them`
- This allows rollback if needed during testing

**5. Update shot count logic:**
- Find any hardcoded shot count caps (search for `min(10`, `max.*shotCount`)
- Remove artificial limits on dialogue/monologue scenes
- Allow 10+ shots per scene when speech segments demand it
  </action>
  <verify>
```bash
cd "C:\Users\VoltaPsy\Documents\GitHub\artime"
# Verify new method exists
grep -n "createShotsFromSpeechSegments" modules/AppVideoWizard/app/Livewire/VideoWizard.php

# Verify 1:1 mapping logic
grep -A 20 "function createShotsFromSpeechSegments" modules/AppVideoWizard/app/Livewire/VideoWizard.php

# Verify old method is deprecated
grep -B 2 "distributeSpeechSegmentsToShots" modules/AppVideoWizard/app/Livewire/VideoWizard.php | grep -i deprecated

# Check for removed shot count caps
grep -n "min(10" modules/AppVideoWizard/app/Livewire/VideoWizard.php
```
  </verify>
  <done>
- `createShotsFromSpeechSegments()` method exists and creates one shot per dialogue/monologue segment
- Method skips narrator and internal thought segments (for Plan 02)
- Old `distributeSpeechSegmentsToShots()` marked as deprecated
- No artificial shot count limits for dialogue/monologue scenes
- Logs show "1:1 mapping" confirmation
  </done>
</task>

<task type="auto">
  <name>Enhance DialogueSceneDecomposerService for unlimited speech-driven shots</name>
  <files>modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php</files>
  <action>
**GOAL:** Enable DialogueSceneDecomposerService to handle 10+ shots per scene when speech demands it.

**1. Locate `decomposeDialogueScene()` method:**
- Find method definition (line ~199)
- Review current shot creation logic based on dialogue exchanges
- Identify any shot count limitations

**2. Remove shot count caps:**
- Search for hardcoded limits like `min(8`, `max(10`, etc.
- Remove any artificial ceilings on shot count
- Allow shot count to scale with number of speech segments

**3. Enhance 1:1 segment-to-shot mapping:**

Add logic to create shots directly from speech segments (if available):

```php
// In decomposeDialogueScene() method, after parsing exchanges:

// SPEECH-DRIVEN: If scene has speechSegments, create shots from them directly
$speechSegments = $scene['speechSegments'] ?? [];
$dialogueSegments = array_filter($speechSegments, function($seg) {
    return in_array(strtolower($seg['type'] ?? ''), ['dialogue', 'monologue']);
});

if (!empty($dialogueSegments)) {
    // Create one shot per dialogue/monologue segment
    $shots = [];
    foreach ($dialogueSegments as $segment) {
        $shots[] = $this->createShotFromSegment($segment, $scene, $characterBible);
    }

    // Apply shot/reverse-shot patterns to created shots
    $shots = $this->applyShotReverseShotPatterns($shots);

    return $shots;
}

// Fallback to exchange-based logic if no speech segments
```

**4. Add `createShotFromSegment()` helper method:**

```php
/**
 * Create a single shot from a speech segment.
 *
 * @param array $segment Speech segment data
 * @param array $scene Scene data for context
 * @param array $characterBible Character Bible for character lookup
 * @return array Shot data
 */
protected function createShotFromSegment(array $segment, array $scene, array $characterBible): array
{
    $speaker = $segment['speaker'] ?? 'Unknown';
    $text = $segment['text'] ?? '';

    // Base shot structure
    $shot = [
        'id' => uniqid('shot_'),
        'type' => 'medium-close', // Default, will be refined by emotional intensity
        'duration' => $this->calculateDurationFromText($text),
        'dialogue' => $text,
        'speaker' => $speaker,
        'speakingCharacters' => [$speaker],
        'needsLipSync' => true,
        'speechSegments' => [$segment],
    ];

    // Add character context from Character Bible
    $character = $this->findCharacterByName($speaker, $characterBible);
    if ($character) {
        $shot['characterId'] = $character['id'] ?? null;
        $shot['characterName'] = $character['name'] ?? $speaker;
    }

    return $shot;
}
```

**5. Add `calculateDurationFromText()` helper:**

```php
/**
 * Calculate shot duration based on text length.
 * ~150 words per minute speaking pace = ~2.5 words per second.
 *
 * @param string $text Dialogue text
 * @return int Duration in seconds (minimum 2s)
 */
protected function calculateDurationFromText(string $text): int
{
    $wordCount = str_word_count($text);
    $duration = ceil($wordCount / 2.5); // 2.5 words per second
    return max(2, $duration); // Minimum 2 seconds
}
```

**6. Preserve existing patterns:**
- Keep 180-degree rule enforcement intact
- Keep shot/reverse-shot pairing logic
- Keep spatial continuity tracking
- Add speech-driven creation as the PRIMARY path, exchange-based as fallback
  </action>
  <verify>
```bash
cd "C:\Users\VoltaPsy\Documents\GitHub\artime"
# Verify new methods exist
grep -n "createShotFromSegment\|calculateDurationFromText" modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php

# Verify speech-driven logic in decomposeDialogueScene
grep -A 30 "speechSegments.*dialogue.*monologue" modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php

# Check for removed shot count caps
grep -n "min(8\|max(10" modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php

# Verify 180-degree rule preserved
grep -n "180.*degree\|action.*axis" modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php
```
  </verify>
  <done>
- `createShotFromSegment()` method exists and creates shot from single segment
- `calculateDurationFromText()` calculates duration based on word count
- `decomposeDialogueScene()` prioritizes speech segments over parsed exchanges
- No artificial shot count caps in DialogueSceneDecomposerService
- 180-degree rule and shot/reverse-shot patterns preserved
- Service can handle 10+ shots per scene
  </done>
</task>

<task type="auto">
  <name>Update scene decomposition flow to use speech-driven shot creation</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
**INTEGRATION:** Wire the new speech-driven shot creation into the main scene decomposition flow.

**1. Find main decomposition entry point:**
- Locate where scenes are decomposed (search for `decomposeScene` or `generateShots`)
- Identify where DialogueSceneDecomposerService is called
- Map the flow: scene detection → shot creation → speech distribution

**2. Update dialogue scene path:**

Replace old flow:
```
1. DialogueSceneDecomposerService creates N shots from exchanges
2. distributeSpeechSegmentsToShots() divides segments across N shots
```

With new flow:
```
1. createShotsFromSpeechSegments() creates M shots from segments (1:1)
2. DialogueSceneDecomposerService enhances shots with patterns/camera positions
```

**3. Modify scene decomposition logic:**

Find where dialogue scenes are detected and decomposed:

```php
// OLD (line ~23000-23100):
if ($isDialogueScene) {
    $shots = $decomposer->decomposeDialogueScene($scene, $characterBible);
    // Then distribute speech segments TO shots...
}

// NEW:
if ($isDialogueScene && !empty($scene['speechSegments'])) {
    // Speech-driven: Create shots FROM segments first
    $shotsFromSpeech = $this->createShotsFromSpeechSegments($sceneIndex, $scene['speechSegments']);

    if (!empty($shotsFromSpeech)) {
        // Enhance with DialogueSceneDecomposerService patterns
        $shots = $decomposer->enhanceShotsWithDialoguePatterns($shotsFromSpeech, $scene, $characterBible);
    } else {
        // Fallback: Use exchange-based decomposition if no lip-sync segments
        $shots = $decomposer->decomposeDialogueScene($scene, $characterBible);
    }
} else {
    // Non-dialogue scene: use existing DynamicShotEngine
    $shots = $this->generateDynamicShots($scene);
}
```

**4. Handle edge cases:**
- Scene with only narrator segments → Use DynamicShotEngine (no lip-sync shots)
- Scene with mixed dialogue + narrator → Create shots from dialogue, overlay narrator (Plan 02)
- Scene with no speech segments → Use existing logic

**5. Update logging:**
- Log "Speech-driven shot creation: M shots from N segments" for transparency
- Track which path was taken (speech-driven vs exchange-based vs dynamic)

**6. Test backwards compatibility:**
- Scenes without speechSegments should use existing logic
- Old method still available for any edge cases
  </action>
  <verify>
```bash
cd "C:\Users\VoltaPsy\Documents\GitHub\artime"
# Verify new flow integration
grep -B 5 -A 10 "createShotsFromSpeechSegments" modules/AppVideoWizard/app/Livewire/VideoWizard.php | grep -A 10 "isDialogueScene"

# Check logging
grep "Speech-driven shot creation" modules/AppVideoWizard/app/Livewire/VideoWizard.php

# Verify fallback logic exists
grep -A 5 "empty.*shotsFromSpeech" modules/AppVideoWizard/app/Livewire/VideoWizard.php

# Test file syntax
php -l modules/AppVideoWizard/app/Livewire/VideoWizard.php
php -l modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php
```
  </verify>
  <done>
- Scene decomposition flow prioritizes speech-driven shot creation
- Dialogue scenes with speechSegments create shots via `createShotsFromSpeechSegments()`
- Fallback to exchange-based logic if no lip-sync segments
- Edge cases handled (narrator-only, no segments, etc.)
- Logging confirms which shot creation path was used
- PHP syntax valid for both modified files
  </done>
</task>

</tasks>

<verification>
**Test Scenario 1: Five dialogue exchanges**
1. Create test scene with 5 dialogue segments (alternating speakers)
2. Trigger scene decomposition
3. Verify 5+ shots created (not 2-3 shots with segments distributed)
4. Check logs for "1:1 mapping" confirmation

**Test Scenario 2: Twelve speech segments**
1. Create test scene with 12 dialogue/monologue segments
2. Trigger scene decomposition
3. Verify 12 shots created without error
4. Confirm no artificial cap was hit

**Test Scenario 3: Monologue scene**
1. Create scene with single character, 4 monologue segments
2. Trigger scene decomposition
3. Verify 4 shots created (one per segment)
4. Check each shot has exactly one segment

**Code verification:**
```bash
cd "C:\Users\VoltaPsy\Documents\GitHub\artime"
# Verify 1:1 ratio in logs after test
tail -100 storage/logs/laravel.log | grep "1:1 mapping"

# Verify no proportional distribution in active code paths
grep -n "segmentsPerShot.*ceil" modules/AppVideoWizard/app/Livewire/VideoWizard.php
```
</verification>

<success_criteria>
**Requirements met:**
- ✓ CSA-01: Each dialogue segment creates its own shot (1:1 mapping)
- ✓ CSA-02: Each monologue segment creates its own shot (1:1 mapping)
- ✓ SCNE-01: No artificial limit on shots per scene (10+ supported)

**Observable behaviors:**
1. Scene with 5 dialogue segments → 5 shots created (verified in logs)
2. Scene with 12 segments → 12 shots created without error
3. Monologue scene → shots match segment count exactly
4. Logs show "1:1 mapping" and shot creation ratio
5. Old proportional distribution deprecated but preserved for rollback
</success_criteria>

<output>
After completion, create:

`C:\Users\VoltaPsy\Documents\GitHub\artime\.planning\phases\11-speech-driven-shot-creation\11-01-SUMMARY.md`

Include:
- One-liner: Speech segments now CREATE shots (1:1) instead of being distributed proportionally
- Key changes: `createShotsFromSpeechSegments()` method, enhanced DialogueSceneDecomposerService
- Code locations: VideoWizard.php (new method ~line 23200), DialogueSceneDecomposerService.php (enhanced methods)
- Test results: 5-segment scene → 5 shots, 12-segment scene → 12 shots
- Decisions: Speech-driven PRIMARY, exchange-based FALLBACK, old method deprecated but kept
</output>
