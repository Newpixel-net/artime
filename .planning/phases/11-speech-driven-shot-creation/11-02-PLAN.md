---
phase: 11-speech-driven-shot-creation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/AppVideoWizard/app/Livewire/VideoWizard.php
autonomous: true

must_haves:
  truths:
    - "Narrator text appears as metadata on shots, not as dedicated shots"
    - "Internal thought segments flagged as voiceover-only with no visual shot"
    - "Narrator segments overlay across multiple existing shots"
  artifacts:
    - path: "modules/AppVideoWizard/app/Livewire/VideoWizard.php"
      provides: "overlayNarratorSegments() method"
      min_lines: 40
    - path: "modules/AppVideoWizard/app/Livewire/VideoWizard.php"
      provides: "markInternalThoughtAsVoiceover() method"
      min_lines: 20
  key_links:
    - from: "overlayNarratorSegments()"
      to: "shot metadata"
      via: "narratorOverlay array on each shot"
      pattern: "shot.*narratorOverlay.*append"
    - from: "markInternalThoughtAsVoiceover()"
      to: "shot voiceover flag"
      via: "voiceoverOnly property"
      pattern: "voiceoverOnly.*true.*internal"
---

<objective>
Handle narrator and internal thought speech segments as overlays/voiceovers rather than creating dedicated visual shots.

Purpose: Narrator is voiceover that spans multiple shots (like documentary narration), not an on-screen character. Internal thoughts are character voiceover without lip movement. This prevents creating empty visual shots for non-visual speech.

Output: Narrator segments distributed as metadata across existing dialogue/action shots. Internal thought segments flagged for voiceover-only processing without visual generation.
</objective>

<execution_context>
@C:\Users\VoltaPsy\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\VoltaPsy\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Users\VoltaPsy\Documents\GitHub\artime\.planning\PROJECT.md
@C:\Users\VoltaPsy\Documents\GitHub\artime\.planning\ROADMAP.md
@C:\Users\VoltaPsy\Documents\GitHub\artime\.planning\STATE.md

## Key Distinction

**Narrator segments:** Documentary-style voiceover (e.g., "And so, the hero began his journey...") that plays OVER visual shots. No visual shot needed.

**Internal thought segments:** Character thinking (e.g., "*This doesn't feel right*") - voiceover from character's perspective. No lip movement, no visual shot.

**Dialogue/Monologue segments:** Character speaking on-screen. Requires visual shot with lip-sync (handled in Plan 01).

## Key File

@C:\Users\VoltaPsy\Documents\GitHub\artime\modules\AppVideoWizard\app\Livewire\VideoWizard.php
</context>

<tasks>

<task type="auto">
  <name>Create narrator overlay distribution system</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
**GOAL:** Distribute narrator segments as metadata across existing shots instead of creating dedicated shots.

**1. Create `overlayNarratorSegments()` method:**

```php
/**
 * Overlay narrator segments across existing shots as voiceover metadata.
 * Narrator segments don't create visual shots - they span multiple shots.
 *
 * @param int $sceneIndex Scene index
 * @param array $shots Existing shots (from dialogue/monologue/action)
 * @param array $speechSegments All speech segments for the scene
 * @return array Shots with narrator overlays added
 */
protected function overlayNarratorSegments(int $sceneIndex, array $shots, array $speechSegments): array
{
    if (empty($shots) || empty($speechSegments)) {
        return $shots;
    }

    // Extract narrator segments
    $narratorSegments = array_filter($speechSegments, function($seg) {
        return strtolower($seg['type'] ?? '') === 'narrator';
    });

    if (empty($narratorSegments)) {
        Log::debug('No narrator segments to overlay', ['sceneIndex' => $sceneIndex]);
        return $shots;
    }

    // Distribute narrator segments across shots
    $shotCount = count($shots);
    $narratorCount = count($narratorSegments);

    // Strategy: Distribute evenly, allowing multiple narrator segments per shot
    $narratorIndex = 0;
    $narratorsPerShot = max(1, ceil($narratorCount / $shotCount));

    foreach ($shots as $shotIdx => $shot) {
        $shotNarrators = [];

        // Collect narrator segments for this shot
        for ($i = 0; $i < $narratorsPerShot && $narratorIndex < $narratorCount; $i++, $narratorIndex++) {
            $shotNarrators[] = $narratorSegments[$narratorIndex];
        }

        // Add as overlay metadata (not primary speech)
        if (!empty($shotNarrators)) {
            $shots[$shotIdx]['narratorOverlay'] = $shotNarrators;
            $shots[$shotIdx]['hasNarratorVoiceover'] = true;

            // Combine narrator text for voiceover generation (separate from dialogue)
            $narratorText = implode(' ', array_column($shotNarrators, 'text'));
            $shots[$shotIdx]['narratorText'] = $narratorText;

            Log::debug('Added narrator overlay to shot', [
                'sceneIndex' => $sceneIndex,
                'shotIndex' => $shotIdx,
                'narratorCount' => count($shotNarrators),
            ]);
        }
    }

    Log::info('Distributed narrator segments as overlays', [
        'sceneIndex' => $sceneIndex,
        'narratorSegments' => $narratorCount,
        'shotsWithNarrator' => count(array_filter($shots, fn($s) => !empty($s['narratorOverlay']))),
        'strategy' => 'overlay (not dedicated shots)',
    ]);

    return $shots;
}
```

**2. Handle narrator-only scenes:**

When scene has ONLY narrator segments (no dialogue/monologue), need to create base visual shots first:

```php
/**
 * Handle narrator-only scenes by creating base visual shots.
 * Narrator overlays require visual shots to play over.
 *
 * @param int $sceneIndex Scene index
 * @param array $scene Scene data
 * @return array Base visual shots for narrator overlay
 */
protected function createBaseVisualShotsForNarrator(int $sceneIndex, array $scene): array
{
    // Use DynamicShotEngine to create 3-5 visual shots based on scene content
    // These are "silent" visual shots that narrator will play over
    $sceneDuration = $scene['duration'] ?? 10;
    $shotCount = max(3, min(5, ceil($sceneDuration / 3))); // 3-5 shots, 3s each

    $shots = [];
    for ($i = 0; $i < $shotCount; $i++) {
        $shots[] = [
            'id' => uniqid('shot_'),
            'type' => $this->selectShotTypeForNarrator($i, $shotCount),
            'duration' => 3,
            'needsLipSync' => false, // No character speaking on-screen
            'visualOnly' => true, // Flag for visual-only shot
            'sceneContext' => $scene['description'] ?? '',
        ];
    }

    Log::info('Created base visual shots for narrator-only scene', [
        'sceneIndex' => $sceneIndex,
        'shotCount' => $shotCount,
    ]);

    return $shots;
}

/**
 * Select appropriate shot type for narrator-only scene progression.
 */
protected function selectShotTypeForNarrator(int $shotIndex, int $totalShots): string
{
    if ($shotIndex === 0) return 'establishing';
    if ($shotIndex === $totalShots - 1) return 'medium';
    return ['wide', 'medium', 'medium-close'][array_rand(['wide', 'medium', 'medium-close'])];
}
```

**3. Integrate into scene decomposition:**

Find where shots are created and add narrator overlay step:

```php
// After creating shots from speech segments (Plan 01):
if (!empty($scene['speechSegments'])) {
    // Create shots from dialogue/monologue
    $shots = $this->createShotsFromSpeechSegments($sceneIndex, $scene['speechSegments']);

    // If no dialogue/monologue shots created, create base visual shots for narrator
    if (empty($shots)) {
        $shots = $this->createBaseVisualShotsForNarrator($sceneIndex, $scene);
    }

    // Overlay narrator segments across shots
    $shots = $this->overlayNarratorSegments($sceneIndex, $shots, $scene['speechSegments']);
}
```
  </action>
  <verify>
```bash
cd "C:\Users\VoltaPsy\Documents\GitHub\artime"
# Verify narrator overlay method exists
grep -n "overlayNarratorSegments" modules/AppVideoWizard/app/Livewire/VideoWizard.php

# Verify narrator segments don't create dedicated shots
grep -A 30 "function overlayNarratorSegments" modules/AppVideoWizard/app/Livewire/VideoWizard.php | grep -i "overlay\|metadata"

# Verify base visual shots for narrator-only scenes
grep -n "createBaseVisualShotsForNarrator" modules/AppVideoWizard/app/Livewire/VideoWizard.php

# Check integration
grep -A 10 "overlayNarratorSegments" modules/AppVideoWizard/app/Livewire/VideoWizard.php | grep "createShotsFromSpeechSegments"
```
  </verify>
  <done>
- `overlayNarratorSegments()` method exists and distributes narrator as metadata
- Narrator segments stored in `narratorOverlay` array on shots (not as dedicated shots)
- `createBaseVisualShotsForNarrator()` handles narrator-only scenes with 3-5 visual shots
- Narrator overlay integrated after dialogue/monologue shot creation
- Logs confirm "overlay (not dedicated shots)" strategy
  </done>
</task>

<task type="auto">
  <name>Handle internal thought segments as voiceover-only</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
**GOAL:** Flag internal thought segments for voiceover generation without creating visual shots.

**1. Create `markInternalThoughtAsVoiceover()` method:**

```php
/**
 * Mark internal thought segments as voiceover-only (no visual shot).
 * Internal thoughts are character thinking - audio only, no lip movement.
 *
 * @param int $sceneIndex Scene index
 * @param array $shots Existing shots
 * @param array $speechSegments All speech segments for the scene
 * @return array Shots with internal thought voiceover flags
 */
protected function markInternalThoughtAsVoiceover(int $sceneIndex, array $shots, array $speechSegments): array
{
    if (empty($shots) || empty($speechSegments)) {
        return $shots;
    }

    // Extract internal thought segments
    $internalSegments = array_filter($speechSegments, function($seg) {
        return strtolower($seg['type'] ?? '') === 'internal';
    });

    if (empty($internalSegments)) {
        return $shots;
    }

    // Distribute internal thoughts across shots (similar to narrator)
    $shotCount = count($shots);
    $internalCount = count($internalSegments);
    $internalIndex = 0;
    $internalsPerShot = max(1, ceil($internalCount / $shotCount));

    foreach ($shots as $shotIdx => $shot) {
        $shotInternals = [];

        for ($i = 0; $i < $internalsPerShot && $internalIndex < $internalCount; $i++, $internalIndex++) {
            $shotInternals[] = $internalSegments[$internalIndex];
        }

        if (!empty($shotInternals)) {
            $shots[$shotIdx]['internalThoughtOverlay'] = $shotInternals;
            $shots[$shotIdx]['hasInternalVoiceover'] = true;

            // Combine internal thought text for voiceover (separate track from dialogue)
            $internalText = implode(' ', array_column($shotInternals, 'text'));
            $shots[$shotIdx]['internalThoughtText'] = $internalText;

            // Get speaker for voice selection
            $speaker = $shotInternals[0]['speaker'] ?? null;
            if ($speaker) {
                $shots[$shotIdx]['internalThoughtSpeaker'] = $speaker;
                $shots[$shotIdx]['internalVoiceId'] = $this->getVoiceForCharacterName($speaker);
            }

            Log::debug('Added internal thought voiceover to shot', [
                'sceneIndex' => $sceneIndex,
                'shotIndex' => $shotIdx,
                'internalCount' => count($shotInternals),
                'speaker' => $speaker,
            ]);
        }
    }

    Log::info('Distributed internal thought segments as voiceover', [
        'sceneIndex' => $sceneIndex,
        'internalSegments' => $internalCount,
        'shotsWithInternal' => count(array_filter($shots, fn($s) => !empty($s['internalThoughtOverlay']))),
        'voiceoverOnly' => true,
    ]);

    return $shots;
}
```

**2. Integrate into scene decomposition:**

Add internal thought processing after narrator overlay:

```php
// After overlaying narrator segments:
$shots = $this->overlayNarratorSegments($sceneIndex, $shots, $scene['speechSegments']);

// Mark internal thought segments as voiceover
$shots = $this->markInternalThoughtAsVoiceover($sceneIndex, $shots, $scene['speechSegments']);
```

**3. Document the processing order:**

Add comment in scene decomposition flow:

```php
/**
 * SPEECH SEGMENT PROCESSING ORDER:
 *
 * 1. Dialogue/Monologue → Create visual shots with lip-sync (1:1 mapping)
 * 2. Narrator → Overlay as voiceover across shots (no dedicated visual)
 * 3. Internal Thought → Overlay as voiceover across shots (no lip-sync)
 *
 * Result: Only dialogue/monologue segments create visual shots.
 * Narrator and internal are voiceover-only tracks.
 */
```
  </action>
  <verify>
```bash
cd "C:\Users\VoltaPsy\Documents\GitHub\artime"
# Verify internal thought method exists
grep -n "markInternalThoughtAsVoiceover" modules/AppVideoWizard/app/Livewire/VideoWizard.php

# Verify voiceover-only flag
grep -A 30 "function markInternalThoughtAsVoiceover" modules/AppVideoWizard/app/Livewire/VideoWizard.php | grep -i "voiceover"

# Verify integration order
grep -B 5 -A 5 "markInternalThoughtAsVoiceover" modules/AppVideoWizard/app/Livewire/VideoWizard.php | grep "overlayNarratorSegments"

# Verify processing order comment
grep -A 8 "SPEECH SEGMENT PROCESSING ORDER" modules/AppVideoWizard/app/Livewire/VideoWizard.php

# Test syntax
php -l modules/AppVideoWizard/app/Livewire/VideoWizard.php
```
  </verify>
  <done>
- `markInternalThoughtAsVoiceover()` method exists and flags internal segments
- Internal thought stored in `internalThoughtOverlay` array (not as dedicated shots)
- Internal thought voiceover integrated after narrator overlay
- Processing order documented: Dialogue/Monologue → Narrator → Internal
- Logs confirm "voiceoverOnly: true" for internal thought segments
- PHP syntax valid
  </done>
</task>

<task type="auto">
  <name>Add segment type filtering to shot creation</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
**GOAL:** Ensure `createShotsFromSpeechSegments()` (from Plan 01) explicitly skips narrator and internal thought segments.

**1. Review Plan 01 implementation:**
- Verify `createShotsFromSpeechSegments()` filters by `$lipSyncTypes = ['dialogue', 'monologue']`
- Confirm narrator and internal are skipped with `continue` statement

**2. Add defensive validation:**

Enhance the method with explicit type checking:

```php
// In createShotsFromSpeechSegments() method:
foreach ($speechSegments as $segmentIndex => $segment) {
    $segType = strtolower($segment['type'] ?? 'narrator');

    // ONLY dialogue and monologue create visual shots
    if (!in_array($segType, $lipSyncTypes)) {
        Log::debug('Skipping non-visual segment in shot creation', [
            'sceneIndex' => $sceneIndex,
            'segmentIndex' => $segmentIndex,
            'type' => $segType,
            'reason' => 'Narrator and internal thought handled as voiceover overlays',
        ]);
        continue;
    }

    // Create shot from dialogue/monologue segment...
}
```

**3. Add validation check after shot creation:**

```php
// After createShotsFromSpeechSegments():
if (!empty($shots)) {
    // Validate: No shot should have narrator/internal as primary segment
    foreach ($shots as $shot) {
        $primarySegment = $shot['speechSegments'][0] ?? null;
        if ($primarySegment) {
            $type = strtolower($primarySegment['type'] ?? '');
            if (in_array($type, ['narrator', 'internal'])) {
                Log::error('INVALID: Visual shot created from non-visual segment', [
                    'sceneIndex' => $sceneIndex,
                    'shotId' => $shot['id'],
                    'segmentType' => $type,
                ]);
            }
        }
    }
}
```

**4. Update method documentation:**

Clarify in PHPDoc:

```php
/**
 * Create shots FROM speech segments (1:1 mapping for dialogue/monologue).
 * Each dialogue or monologue segment becomes its own shot.
 *
 * IMPORTANT: Narrator and internal thought segments are SKIPPED here.
 * They are handled separately as voiceover overlays (Plan 02).
 *
 * @param int $sceneIndex Scene index
 * @param array $speechSegments Scene's speech segments array
 * @return array Array of created shots (dialogue/monologue only)
 */
```
  </action>
  <verify>
```bash
cd "C:\Users\VoltaPsy\Documents\GitHub\artime"
# Verify filtering logic
grep -A 40 "function createShotsFromSpeechSegments" modules/AppVideoWizard/app/Livewire/VideoWizard.php | grep -i "skip\|narrator\|internal"

# Verify validation check
grep -A 10 "INVALID.*Visual shot.*non-visual" modules/AppVideoWizard/app/Livewire/VideoWizard.php

# Verify updated documentation
grep -B 5 "function createShotsFromSpeechSegments" modules/AppVideoWizard/app/Livewire/VideoWizard.php | grep -i "narrator.*internal.*skipped"

# Test syntax
php -l modules/AppVideoWizard/app/Livewire/VideoWizard.php
```
  </verify>
  <done>
- `createShotsFromSpeechSegments()` explicitly skips narrator and internal segments
- Defensive logging added for skipped segments with reason
- Validation check prevents narrator/internal from becoming primary shot segments
- Method documentation clarifies narrator/internal handled as overlays
- PHP syntax valid
  </done>
</task>

</tasks>

<verification>
**Test Scenario 1: Narrator overlay**
1. Create scene with 3 dialogue segments + 2 narrator segments
2. Trigger scene decomposition
3. Verify 3 visual shots created (from dialogue only)
4. Verify 2 narrator segments distributed across the 3 shots
5. Check `narratorOverlay` property exists on shots

**Test Scenario 2: Internal thought**
1. Create scene with 2 dialogue segments + 1 internal thought segment
2. Trigger scene decomposition
3. Verify 2 visual shots created (dialogue only)
4. Verify internal thought distributed as voiceover
5. Check `internalThoughtOverlay` property exists on shots

**Test Scenario 3: Narrator-only scene**
1. Create scene with only narrator segments (no dialogue/monologue)
2. Trigger scene decomposition
3. Verify 3-5 base visual shots created
4. Verify narrator segments overlaid on visual shots
5. Confirm no narrator segments created dedicated visual shots

**Code verification:**
```bash
cd "C:\Users\VoltaPsy\Documents\GitHub\artime"
# Verify narrator as overlay in logs
tail -100 storage/logs/laravel.log | grep "overlay.*not dedicated"

# Verify internal thought as voiceover in logs
tail -100 storage/logs/laravel.log | grep "voiceoverOnly.*true"

# Verify no narrator/internal created visual shots
grep -A 50 "function createShotsFromSpeechSegments" modules/AppVideoWizard/app/Livewire/VideoWizard.php | grep "narrator\|internal"
```
</verification>

<success_criteria>
**Requirements met:**
- ✓ CSA-03: Narrator segments overlay across multiple shots (not dedicated shots)
- ✓ CSA-04: Internal thought segments handled as voiceover (no dedicated shot)

**Observable behaviors:**
1. Narrator text appears in `narratorOverlay` array on shots (not as separate visual shots)
2. Internal thought segments flagged with `hasInternalVoiceover: true`
3. Narrator-only scenes create 3-5 base visual shots with narrator overlaid
4. Logs confirm "overlay (not dedicated shots)" strategy
5. No visual shots created from narrator or internal thought segments
</success_criteria>

<output>
After completion, create:

`C:\Users\VoltaPsy\Documents\GitHub\artime\.planning\phases\11-speech-driven-shot-creation\11-02-SUMMARY.md`

Include:
- One-liner: Narrator and internal thought handled as voiceover overlays, not dedicated visual shots
- Key changes: `overlayNarratorSegments()`, `markInternalThoughtAsVoiceover()`, base visual shot creation
- Code locations: VideoWizard.php (overlay methods ~line 23300-23400)
- Test results: Narrator distributed across shots, internal thought flagged voiceover-only
- Decisions: Narrator/internal = overlay, dialogue/monologue = visual shots, processing order documented
</output>
