---
phase: 04-dialogue-scene-excellence
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php
  - modules/AppVideoWizard/app/Services/DynamicShotEngine.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "OTS shots include foreground blur specification"
    - "OTS shots specify which shoulder is in foreground"
    - "Profile angles (left/right) are explicit in shot data"
    - "Depth-of-field notes included for OTS"
  artifacts:
    - path: "modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php"
      provides: "Enhanced OTS shot generation"
      contains: "foregroundShoulder"
  key_links:
    - from: "DialogueSceneDecomposerService.php"
      to: "visual prompts"
      via: "OTS specifications"
      pattern: "over-the-shoulder"
---

<objective>
Enhance Over-the-Shoulder (OTS) shot generation with proper depth and framing.

**PROBLEM:** Current OTS shots lack specificity:
- No foreground blur specification
- No "which shoulder" indication
- No explicit profile angles (left 3/4 vs right 3/4)
- No depth-of-field guidance
- OTS may render as wide two-shot instead of proper over-shoulder framing

Purpose: Generate proper Hollywood-style OTS shots with clear foreground/background separation.

Output: OTS shots have explicit foreground shoulder, profile angle, and depth specs.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php
@modules/AppVideoWizard/app/Services/DynamicShotEngine.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add OTS-specific shot data structure</name>
  <files>modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php</files>
  <action>
Add enhanced data structure for OTS shots. When shot type is 'over-the-shoulder', include:

```php
/**
 * PHASE 4: Build OTS-specific shot data.
 *
 * @param string $speaker The speaking character (in focus)
 * @param string $listener The listening character (foreground)
 * @param array $spatial Base spatial data
 * @return array Enhanced OTS shot data
 */
protected function buildOTSData(string $speaker, string $listener, array $spatial): array
{
    // Determine which shoulder based on spatial positioning
    // If speaker is screen-right, we see over listener's left shoulder
    // If speaker is screen-left, we see over listener's right shoulder
    $speakerScreenPosition = $spatial['subjectPosition'] ?? 'right';
    $foregroundShoulder = $speakerScreenPosition === 'right' ? 'left' : 'right';

    return [
        'otsData' => [
            'foregroundCharacter' => $listener,
            'foregroundShoulder' => $foregroundShoulder,
            'foregroundBlur' => true,
            'foregroundVisible' => 'shoulder and partial head',
            'backgroundCharacter' => $speaker, // In focus
            'backgroundPosition' => $speakerScreenPosition,
            'depthOfField' => 'shallow', // Blur foreground, focus background
            'focusOn' => $speaker,
            'profileAngle' => $speakerScreenPosition === 'right' ? 'left-three-quarter' : 'right-three-quarter',
        ],
    ];
}
```

WHY: Explicit OTS data enables proper framing in AI image generation.
  </action>
  <verify>
    - `buildOTSData()` method exists
    - Returns foregroundCharacter, foregroundShoulder, depthOfField
    - Profile angle determined by speaker position
    - No PHP syntax errors
  </verify>
  <done>OTS-specific data structure added</done>
</task>

<task type="auto">
  <name>Task 2: Create OTS-specific visual prompt builder</name>
  <files>modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php</files>
  <action>
Add a dedicated prompt builder for OTS shots:

```php
/**
 * PHASE 4: Build visual prompt specifically for OTS shots.
 *
 * @param array $shot Shot data with OTS info
 * @param array $speakerData Speaker character data
 * @param array $listenerData Listener character data
 * @return string OTS-specific visual prompt
 */
protected function buildOTSPrompt(array $shot, array $speakerData, array $listenerData): string
{
    $otsData = $shot['otsData'] ?? [];
    $prompt = [];

    // Shot type declaration
    $prompt[] = 'Over-the-shoulder shot';

    // Foreground description (blurred)
    $listenerName = $otsData['foregroundCharacter'] ?? 'listener';
    $shoulder = $otsData['foregroundShoulder'] ?? 'left';
    $prompt[] = "with {$listenerName}'s {$shoulder} shoulder and partial head in soft-focus foreground";

    // Background (in focus) - the speaker
    $speakerName = $otsData['backgroundCharacter'] ?? $shot['speakingCharacter'];
    $speakerAppearance = $speakerData['appearance'] ?? '';
    $profileAngle = $otsData['profileAngle'] ?? 'three-quarter';

    $prompt[] = "{$speakerName} in sharp focus";

    if (!empty($speakerAppearance)) {
        $prompt[] = "({$speakerAppearance})";
    }

    $prompt[] = "at {$profileAngle} angle";

    // Position in frame
    $position = $otsData['backgroundPosition'] ?? 'right';
    $prompt[] = "positioned {$position} of frame";

    // Expression
    if (!empty($shot['expression'])) {
        $prompt[] = "with {$shot['expression']} expression";
    }

    // Depth of field
    $prompt[] = 'shallow depth of field';
    $prompt[] = 'cinematic lighting';

    // Dialogue context
    if (!empty($shot['dialogue'])) {
        $emotion = $this->detectDialogueEmotion($shot['dialogue']);
        if ($emotion) {
            $prompt[] = $emotion;
        }
    }

    return implode(', ', array_filter($prompt)) . '.';
}

/**
 * Detect emotional tone from dialogue text.
 */
protected function detectDialogueEmotion(string $dialogue): string
{
    $text = strtolower($dialogue);

    // Check for emotional keywords
    if (preg_match('/\b(angry|furious|rage|hate)\b/', $text)) {
        return 'intense confrontational mood';
    }
    if (preg_match('/\b(love|adore|care|tender)\b/', $text)) {
        return 'warm intimate atmosphere';
    }
    if (preg_match('/\b(scared|afraid|terrified|fear)\b/', $text)) {
        return 'tense fearful atmosphere';
    }
    if (preg_match('/\b(sad|cry|tears|grief)\b/', $text)) {
        return 'somber emotional moment';
    }
    if (preg_match('/\b(happy|joy|excited|thrilled)\b/', $text)) {
        return 'uplifting joyful energy';
    }

    // Check punctuation
    if (str_ends_with(trim($dialogue), '!')) {
        return 'emphatic delivery';
    }
    if (str_ends_with(trim($dialogue), '?')) {
        return 'questioning tone';
    }

    return '';
}
```

WHY: OTS shots need specific prompts to achieve proper Hollywood framing.
  </action>
  <verify>
    - `buildOTSPrompt()` method exists
    - Prompt includes foreground blur description
    - Prompt specifies shoulder (left/right)
    - Prompt includes profile angle
    - Prompt mentions depth of field
    - `detectDialogueEmotion()` helper exists
    - No PHP syntax errors
  </verify>
  <done>OTS-specific visual prompt builder created</done>
</task>

<task type="auto">
  <name>Task 3: Integrate OTS detection into shot generation</name>
  <files>modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php</files>
  <action>
Update the main shot generation to use OTS-specific handling:

Find where shots are created and add OTS detection:

```php
// PHASE 4: Detect if this should be an OTS shot based on intensity and pattern
$isOTSShot = $this->shouldUseOTS($shotType, $emotionalIntensity, $exchangeIndex);

if ($isOTSShot) {
    // Get the other character (listener)
    $characters = array_keys($characterLookup);
    $listener = null;
    foreach ($characters as $char) {
        if (strcasecmp($char, $exchange['speaker']) !== 0) {
            $listener = $char;
            break;
        }
    }

    if ($listener) {
        // Build OTS-specific data
        $otsData = $this->buildOTSData($exchange['speaker'], $listener, $spatial);
        $shot = array_merge($shot, $otsData);

        // Use OTS-specific prompt
        $listenerData = $characterLookup[$listener] ?? [];
        $shot['visualDescription'] = $this->buildOTSPrompt($shot, $characterData, $listenerData);

        Log::debug('DialogueSceneDecomposer: Generated OTS shot', [
            'speaker' => $exchange['speaker'],
            'listener' => $listener,
            'shoulder' => $otsData['otsData']['foregroundShoulder'],
        ]);
    }
}
```

Add the helper method:

```php
/**
 * PHASE 4: Determine if shot should be OTS based on context.
 *
 * @param string $shotType Current shot type
 * @param float $intensity Emotional intensity
 * @param int $exchangeIndex Position in dialogue
 * @return bool True if should use OTS framing
 */
protected function shouldUseOTS(string $shotType, float $intensity, int $exchangeIndex): bool
{
    // Explicit OTS shot type
    if ($shotType === 'over-the-shoulder') {
        return true;
    }

    // Medium shots in dialogue often work well as OTS
    if (in_array($shotType, ['medium', 'medium-close']) && $intensity >= 0.3 && $intensity <= 0.7) {
        // Use OTS for alternating shots (creates rhythm)
        return $exchangeIndex % 2 === 1;
    }

    return false;
}
```

WHY: This ensures OTS shots are properly identified and handled with special prompts.
  </action>
  <verify>
    - `shouldUseOTS()` method exists
    - OTS detection integrated into shot generation loop
    - OTS shots get special data and prompts
    - No PHP syntax errors
  </verify>
  <done>OTS detection integrated into shot generation</done>
</task>

<task type="auto">
  <name>Task 4: Update DynamicShotEngine dialogue pattern with OTS specs</name>
  <files>modules/AppVideoWizard/app/Services/DynamicShotEngine.php</files>
  <action>
Enhance the dialogue coverage pattern in DynamicShotEngine to include OTS specifications:

Find the `$dialoguePattern` array in `applyDialogueCoveragePattern()` and update:

```php
$dialoguePattern = [
    0 => [
        'type' => 'wide',
        'purpose' => 'two-shot',
        'focus' => 'both',
        'description' => "Two-shot establishing {$charA} and {$charB} in conversation",
        // PHASE 4: No OTS data for establishing shots
    ],
    1 => [
        'type' => 'medium',
        'purpose' => 'over-the-shoulder',
        'focus' => $charA,
        'description' => "Over-the-shoulder on {$charA}, {$charB}'s shoulder in foreground",
        // PHASE 4: OTS specifications
        'otsSpecs' => [
            'foregroundCharacter' => $charB,
            'foregroundShoulder' => 'right',
            'foregroundBlur' => true,
            'focusCharacter' => $charA,
            'profileAngle' => 'left-three-quarter',
            'depthOfField' => 'shallow',
        ],
    ],
    2 => [
        'type' => 'medium',
        'purpose' => 'over-the-shoulder',
        'focus' => $charB,
        'description' => "Reverse OTS on {$charB}, {$charA}'s shoulder in foreground",
        // PHASE 4: Reverse OTS specifications (mirror of above)
        'otsSpecs' => [
            'foregroundCharacter' => $charA,
            'foregroundShoulder' => 'left',
            'foregroundBlur' => true,
            'focusCharacter' => $charB,
            'profileAngle' => 'right-three-quarter',
            'depthOfField' => 'shallow',
        ],
    ],
    3 => [
        'type' => 'close-up',
        'purpose' => 'emphasis',
        'focus' => 'speaker',
        'description' => "Close-up for emotional emphasis on speaker",
        // PHASE 4: No OTS for close-ups
    ],
    4 => [
        'type' => 'reaction',
        'purpose' => 'reaction',
        'focus' => 'listener',
        'description' => "Reaction shot of listener",
        // PHASE 4: No OTS for reactions
    ],
];
```

Then update where shots are generated from this pattern to include the otsSpecs:

```php
// When creating shot from pattern
if (!empty($patternItem['otsSpecs'])) {
    $shot['otsData'] = $patternItem['otsSpecs'];
}
```

WHY: The pattern template should include OTS specifications for consistent application.
  </action>
  <verify>
    - Dialogue pattern includes `otsSpecs` for OTS shots
    - Pattern items 1 and 2 have proper reverse OTS specs
    - Shoulders are mirrored between OTS and reverse OTS
    - No PHP syntax errors: `php -l modules/AppVideoWizard/app/Services/DynamicShotEngine.php`
  </verify>
  <done>DynamicShotEngine dialogue pattern updated with OTS specs</done>
</task>

</tasks>

<verification>
1. PHP syntax check on both files
2. Grep for OTS methods:
   - `grep -n "buildOTSData" modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php`
   - `grep -n "buildOTSPrompt" modules/AppVideoWizard/app/Services/DialogueSceneDecomposerService.php`
   - `grep -n "otsSpecs" modules/AppVideoWizard/app/Services/DynamicShotEngine.php`
</verification>

<success_criteria>
- OTS shots have foregroundShoulder specified (left/right)
- OTS shots have foregroundBlur: true
- OTS prompts describe "shoulder in soft-focus foreground"
- Profile angles are explicit (left-three-quarter, right-three-quarter)
- Reverse OTS mirrors the original OTS shoulder
- PHP syntax valid
</success_criteria>

<output>
After completion, create `.planning/phases/04-dialogue-scene-excellence/04-02-SUMMARY.md`
</output>
