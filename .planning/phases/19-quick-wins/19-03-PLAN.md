---
phase: 19-quick-wins
plan: 03
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - modules/AppVideoWizard/app/Livewire/VideoWizard.php
  - modules/AppVideoWizard/app/Services/ReferenceImageStorageService.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Base64 image data is NOT stored in Livewire component state"
    - "Base64 images are stored in files on disk"
    - "Images are loaded lazily only when needed for API calls"
    - "Existing functionality (character portraits, location images, style references) still works"
  artifacts:
    - path: "modules/AppVideoWizard/app/Services/ReferenceImageStorageService.php"
      provides: "File-based storage for reference images"
      exports: ["storeBase64", "loadBase64", "deleteBase64"]
    - path: "modules/AppVideoWizard/app/Livewire/VideoWizard.php"
      provides: "Updated component using file storage"
      contains: "ReferenceImageStorageService"
  key_links:
    - from: "VideoWizard.php"
      to: "ReferenceImageStorageService"
      via: "Dependency injection or app() helper"
      pattern: "ReferenceImageStorageService"
    - from: "ReferenceImageStorageService"
      to: "Storage facade"
      via: "Laravel file storage"
      pattern: "Storage::"
---

<objective>
Migrate base64 reference images from component state to file-based storage with lazy loading.

Purpose: Base64 images in component state (referenceImageBase64 for characters, locations, style) add 100KB-500KB per image to the serialization payload. With 5+ characters and 3+ locations, this can be 4MB+ per request. Moving to file storage eliminates this from the payload entirely.

Output: ReferenceImageStorageService for file operations, VideoWizard component updated to use lazy loading.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@modules/AppVideoWizard/app/Livewire/VideoWizard.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ReferenceImageStorageService</name>
  <files>modules/AppVideoWizard/app/Services/ReferenceImageStorageService.php</files>
  <action>
Create a new service to handle reference image file storage:

```php
<?php

namespace Modules\AppVideoWizard\Services;

use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Str;

class ReferenceImageStorageService
{
    /**
     * Storage disk to use for reference images.
     * Uses 'local' disk by default (storage/app/).
     */
    protected string $disk = 'local';

    /**
     * Base path for reference images within the disk.
     */
    protected string $basePath = 'video-wizard/reference-images';

    /**
     * Store base64 image data to file.
     *
     * @param int $projectId The wizard project ID
     * @param string $type Type of reference: 'character', 'location', 'style'
     * @param string|int $identifier Character/location index or 'main' for style
     * @param string $base64Data The base64 encoded image data
     * @param string|null $mimeType The MIME type (e.g., 'image/png')
     * @return string The storage key (path) for retrieval
     */
    public function storeBase64(
        int $projectId,
        string $type,
        string|int $identifier,
        string $base64Data,
        ?string $mimeType = null
    ): string {
        // Generate unique filename
        $extension = $this->getExtensionFromMimeType($mimeType);
        $filename = "{$type}-{$identifier}-" . Str::random(8) . ".{$extension}";
        $path = "{$this->basePath}/{$projectId}/{$filename}";

        // Decode and store
        $binaryData = base64_decode($base64Data);
        Storage::disk($this->disk)->put($path, $binaryData);

        return $path;
    }

    /**
     * Load base64 image data from file.
     *
     * @param string $storageKey The path returned from storeBase64
     * @return string|null Base64 encoded data, or null if not found
     */
    public function loadBase64(string $storageKey): ?string
    {
        if (!Storage::disk($this->disk)->exists($storageKey)) {
            return null;
        }

        $binaryData = Storage::disk($this->disk)->get($storageKey);
        return base64_encode($binaryData);
    }

    /**
     * Delete stored image.
     *
     * @param string $storageKey The path to delete
     * @return bool True if deleted, false otherwise
     */
    public function deleteBase64(string $storageKey): bool
    {
        if (!Storage::disk($this->disk)->exists($storageKey)) {
            return false;
        }

        return Storage::disk($this->disk)->delete($storageKey);
    }

    /**
     * Delete all reference images for a project.
     *
     * @param int $projectId The project ID
     * @return bool True if directory deleted
     */
    public function deleteProjectImages(int $projectId): bool
    {
        $path = "{$this->basePath}/{$projectId}";
        return Storage::disk($this->disk)->deleteDirectory($path);
    }

    /**
     * Check if a storage key exists.
     *
     * @param string $storageKey The path to check
     * @return bool
     */
    public function exists(string $storageKey): bool
    {
        return Storage::disk($this->disk)->exists($storageKey);
    }

    /**
     * Get file extension from MIME type.
     */
    protected function getExtensionFromMimeType(?string $mimeType): string
    {
        return match ($mimeType) {
            'image/jpeg', 'image/jpg' => 'jpg',
            'image/png' => 'png',
            'image/gif' => 'gif',
            'image/webp' => 'webp',
            default => 'png',
        };
    }
}
```
  </action>
  <verify>
Verify service file exists and has correct syntax:
```bash
php -l modules/AppVideoWizard/app/Services/ReferenceImageStorageService.php
```
Should return "No syntax errors detected".
  </verify>
  <done>ReferenceImageStorageService created with storeBase64(), loadBase64(), deleteBase64(), and deleteProjectImages() methods.</done>
</task>

<task type="auto">
  <name>Task 2: Update VideoWizard to use file storage for base64 images</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Modify VideoWizard.php to store base64 in files and load lazily:

**Step 1: Add property for storage keys (replaces base64 in state)**

Change the structure of referenceImageBase64 usage. Instead of storing base64 directly, store a storage key (file path):

In the sceneMemory array structure, the properties become:
- `referenceImageBase64` -> `referenceImageStorageKey` (stores file path, not base64)
- Keep `referenceImageBase64` as a runtime-only value (not persisted in state)

Add the #[Locked] attribute to prevent serialization of runtime base64 data:
```php
#[Locked]
protected array $loadedBase64Cache = []; // Runtime cache, not serialized
```

**Step 2: Create helper methods for lazy loading**

Add these methods to VideoWizard:

```php
/**
 * Store a base64 image to file storage and return the storage key.
 */
protected function storeReferenceImage(string $type, string|int $identifier, string $base64Data, ?string $mimeType = null): ?string
{
    if (empty($base64Data) || empty($this->projectId)) {
        return null;
    }

    $service = app(ReferenceImageStorageService::class);
    return $service->storeBase64($this->projectId, $type, $identifier, $base64Data, $mimeType);
}

/**
 * Load base64 image from storage key (lazy loading with caching).
 */
protected function loadReferenceImage(string $storageKey): ?string
{
    if (empty($storageKey)) {
        return null;
    }

    // Check runtime cache first
    if (isset($this->loadedBase64Cache[$storageKey])) {
        return $this->loadedBase64Cache[$storageKey];
    }

    $service = app(ReferenceImageStorageService::class);
    $base64 = $service->loadBase64($storageKey);

    if ($base64) {
        $this->loadedBase64Cache[$storageKey] = $base64;
    }

    return $base64;
}

/**
 * Get character portrait base64 for API calls (lazy loaded).
 */
public function getCharacterPortraitBase64(int $index): ?string
{
    $character = $this->sceneMemory['characterBible']['characters'][$index] ?? null;
    if (!$character) {
        return null;
    }

    $storageKey = $character['referenceImageStorageKey'] ?? null;
    return $this->loadReferenceImage($storageKey);
}

/**
 * Get location reference base64 for API calls (lazy loaded).
 */
public function getLocationReferenceBase64(int $index): ?string
{
    $location = $this->sceneMemory['locationBible']['locations'][$index] ?? null;
    if (!$location) {
        return null;
    }

    $storageKey = $location['referenceImageStorageKey'] ?? null;
    return $this->loadReferenceImage($storageKey);
}

/**
 * Get style reference base64 for API calls (lazy loaded).
 */
public function getStyleReferenceBase64(): ?string
{
    $storageKey = $this->sceneMemory['styleBible']['referenceImageStorageKey'] ?? null;
    return $this->loadReferenceImage($storageKey);
}
```

**Step 3: Update all places that SET referenceImageBase64**

Search for all occurrences of `['referenceImageBase64'] =` and update them to:
1. Store the base64 to file using storeReferenceImage()
2. Save the storage key instead of the base64

Example transformation:
```php
// BEFORE:
$this->sceneMemory['characterBible']['characters'][$index]['referenceImageBase64'] = $base64Data;

// AFTER:
$storageKey = $this->storeReferenceImage('character', $index, $base64Data, $mimeType);
$this->sceneMemory['characterBible']['characters'][$index]['referenceImageStorageKey'] = $storageKey;
// Do NOT set referenceImageBase64 in state anymore
```

**Step 4: Update all places that READ referenceImageBase64**

Search for all occurrences that read `['referenceImageBase64']` for API calls and replace with the lazy loading methods:

Example transformation:
```php
// BEFORE:
$portraitBase64 = $character['referenceImageBase64'] ?? null;

// AFTER:
$portraitBase64 = $this->getCharacterPortraitBase64($index);
```

**Step 5: Update array initializations**

In the initial array structures, change:
```php
'referenceImageBase64' => null,
```
to:
```php
'referenceImageStorageKey' => null,
```

Keep the old property for backward compatibility during load, but don't persist new data to it.

**IMPORTANT: Backward compatibility**

When loading existing projects that have referenceImageBase64 in stored data:
1. Check if referenceImageBase64 exists and referenceImageStorageKey is null
2. If so, migrate: store the base64 to file, save the key, clear the base64
3. This happens lazily on first access

Add this to mount() or a hydration hook:
```php
protected function migrateBase64ToStorage(): void
{
    // Migrate character portraits
    foreach ($this->sceneMemory['characterBible']['characters'] ?? [] as $index => $char) {
        if (!empty($char['referenceImageBase64']) && empty($char['referenceImageStorageKey'])) {
            $storageKey = $this->storeReferenceImage('character', $index, $char['referenceImageBase64'], $char['referenceImageMimeType'] ?? null);
            $this->sceneMemory['characterBible']['characters'][$index]['referenceImageStorageKey'] = $storageKey;
            $this->sceneMemory['characterBible']['characters'][$index]['referenceImageBase64'] = null; // Clear from state
        }
    }

    // Similar for locations and style...
}
```
  </action>
  <verify>
1. Verify no syntax errors:
```bash
php -l modules/AppVideoWizard/app/Livewire/VideoWizard.php
```

2. Check that referenceImageBase64 is no longer stored in component state (search for direct assignments that persist):
```bash
grep -n "referenceImageBase64.*=" modules/AppVideoWizard/app/Livewire/VideoWizard.php | grep -v "null" | grep -v "StorageKey"
```
Should return minimal results (only backward compat migration code).

3. Check new storage key pattern:
```bash
grep -n "referenceImageStorageKey" modules/AppVideoWizard/app/Livewire/VideoWizard.php
```
Should show the new property being used.
  </verify>
  <done>VideoWizard uses ReferenceImageStorageService for all base64 image storage. Images stored in files, loaded lazily for API calls. Backward compatibility migration included for existing projects.</done>
</task>

</tasks>

<verification>
After both tasks:
1. Create a new wizard project
2. Add a character with a portrait image
3. Add a location with a reference image
4. Add a style reference image
5. Navigate through wizard steps - observe network payload sizes
6. Refresh the page - images should still be accessible
7. Check storage/app/video-wizard/reference-images/ for stored files
8. Payload should NOT contain base64 image data (check Livewire DevTools or network tab)
</verification>

<success_criteria>
1. ReferenceImageStorageService exists with storeBase64(), loadBase64(), deleteBase64() methods
2. VideoWizard no longer stores base64 in component state
3. Images stored in storage/app/video-wizard/reference-images/{projectId}/
4. Images lazy-loaded only when needed for API calls (image generation, etc.)
5. Backward compatibility: existing projects with base64 in state are migrated on first access
6. All character portrait, location reference, and style reference functionality works
</success_criteria>

<output>
After completion, create `.planning/phases/19-quick-wins/19-03-SUMMARY.md`
</output>
