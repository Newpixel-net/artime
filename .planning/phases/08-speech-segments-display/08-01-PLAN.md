---
phase: 08-speech-segments-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/AppVideoWizard/resources/views/livewire/modals/scene-text-inspector.blade.php
autonomous: true

must_haves:
  truths:
    - "User can view ALL speech segments for a scene without truncation"
    - "Each segment shows correct type label (NARRATOR/DIALOGUE/INTERNAL/MONOLOGUE)"
    - "Each segment shows type-specific icon"
    - "Dialogue/monologue segments show speaker name in purple"
    - "Each segment shows lip-sync indicator (YES/NO based on type)"
    - "Each segment shows estimated duration"
    - "Speaker matched to Character Bible shows character indicator"
  artifacts:
    - path: "modules/AppVideoWizard/resources/views/livewire/modals/scene-text-inspector.blade.php"
      provides: "Speech segments display section"
      contains: "speechSegments"
  key_links:
    - from: "scene-text-inspector.blade.php"
      to: "$scene['speechSegments']"
      via: "PHP array iteration"
      pattern: "foreach.*speechSegments"
    - from: "scene-text-inspector.blade.php"
      to: "$sceneMemory['characterBible']"
      via: "Character matching lookup"
      pattern: "characterBible.*characters"
---

<objective>
Implement the speech segments display section in the Scene Text Inspector modal, replacing the Phase 8 placeholder with a fully functional segment list.

Purpose: Users need to view complete speech segment content with proper type identification, speaker attribution, and lip-sync indicators. Currently they only see truncated previews in the storyboard view.

Output: Working speech segments section showing all segments with type badges, icons, speaker names (purple with character indicator), lip-sync badges, and estimated duration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-speech-segments-display/08-RESEARCH.md
@modules/AppVideoWizard/resources/views/livewire/modals/scene-text-inspector.blade.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace speech segments placeholder with type configuration and data access</name>
  <files>modules/AppVideoWizard/resources/views/livewire/modals/scene-text-inspector.blade.php</files>
  <action>
Replace the Phase 8 placeholder section (lines 175-183) with:

1. Keep the section header "Speech Segments" but add segment count badge:
```blade
<h4 style="margin: 0 0 0.75rem 0; color: rgba(255,255,255,0.9); font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">
    Speech Segments
    @if(!empty($scene['speechSegments']))
        <span style="opacity: 0.6; font-weight: normal; font-size: 0.7rem; text-transform: none; margin-left: 0.5rem;">({{ count($scene['speechSegments']) }} segments)</span>
    @endif
</h4>
```

2. Add PHP block with type configuration and data access:
```blade
@php
    $speechSegments = $scene['speechSegments'] ?? [];
    $characterBible = $sceneMemory['characterBible']['characters'] ?? [];

    // Type configuration matching storyboard patterns
    $typeConfig = [
        'narrator' => ['icon' => 'üéôÔ∏è', 'color' => 'rgba(14, 165, 233, 0.4)', 'label' => 'NARRATOR', 'lipSync' => false],
        'dialogue' => ['icon' => 'üí¨', 'color' => 'rgba(16, 185, 129, 0.4)', 'label' => 'DIALOGUE', 'lipSync' => true],
        'internal' => ['icon' => 'üí≠', 'color' => 'rgba(168, 85, 247, 0.4)', 'label' => 'INTERNAL', 'lipSync' => false],
        'monologue' => ['icon' => 'üó£Ô∏è', 'color' => 'rgba(251, 191, 36, 0.4)', 'label' => 'MONOLOGUE', 'lipSync' => true],
    ];
@endphp
```

3. Add scrollable container for segment list with 400px max-height:
```blade
@if(!empty($speechSegments))
    <div style="max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 0.75rem; padding-right: 0.25rem;">
        {{-- Segment cards will go here in Task 2 --}}
    </div>
@elseif(!empty($scene['narration']))
    {{-- Legacy narration fallback --}}
@else
    <div style="padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 0.5rem; text-align: center; color: rgba(255,255,255,0.4); font-size: 0.75rem;">
        {{ __('No speech segments for this scene') }}
    </div>
@endif
```
  </action>
  <verify>Open the Scene Text Inspector modal - header should show "Speech Segments (N segments)" and empty state should appear correctly for scenes without segments.</verify>
  <done>Section header shows segment count, type configuration array is defined, and empty state handling works for both speechSegments and legacy narration cases.</done>
</task>

<task type="auto">
  <name>Task 2: Implement segment card rendering with all required properties</name>
  <files>modules/AppVideoWizard/resources/views/livewire/modals/scene-text-inspector.blade.php</files>
  <action>
Inside the scrollable container from Task 1, add the foreach loop with complete segment card rendering:

```blade
@foreach($speechSegments as $index => $segment)
    @php
        $segType = $segment['type'] ?? 'narrator';
        $typeData = $typeConfig[$segType] ?? $typeConfig['narrator'];
        $needsLipSync = $typeData['lipSync'];

        // Duration estimation (150 WPM)
        $wordCount = str_word_count($segment['text'] ?? '');
        $estDuration = $segment['duration'] ?? round(($wordCount / 150) * 60, 1);
        $durationDisplay = $estDuration >= 60
            ? sprintf('%d:%02d', floor($estDuration / 60), $estDuration % 60)
            : round($estDuration, 1) . 's';

        // Character Bible matching (SPCH-07)
        $speaker = $segment['speaker'] ?? null;
        $matchedChar = null;
        if ($speaker && !empty($characterBible)) {
            $speakerUpper = strtoupper($speaker);
            foreach ($characterBible as $char) {
                $charName = strtoupper($char['name'] ?? '');
                if ($charName === $speakerUpper || str_contains($charName, $speakerUpper) || str_contains($speakerUpper, $charName)) {
                    $matchedChar = $char;
                    break;
                }
            }
        }
    @endphp

    <div style="padding: 0.75rem; background: rgba(255,255,255,0.03); border-left: 3px solid {{ $typeData['color'] }}; border-radius: 0 0.375rem 0.375rem 0;">
        {{-- Header: Type badge, Speaker, Lip-sync, Duration --}}
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
            {{-- Type icon (SPCH-03) --}}
            <span style="font-size: 1rem;">{{ $typeData['icon'] }}</span>

            {{-- Type label (SPCH-02) --}}
            <span style="font-size: 0.65rem; font-weight: 600; color: white; padding: 0.15rem 0.4rem; background: {{ $typeData['color'] }}; border-radius: 0.25rem;">
                {{ $typeData['label'] }}
            </span>

            {{-- Speaker name in purple (SPCH-04) with character indicator (SPCH-07) --}}
            @if($speaker)
                <span style="color: #c4b5fd; font-size: 0.75rem; font-weight: 600;">{{ $speaker }}</span>
                @if($matchedChar)
                    <span title="{{ __('Character exists in Bible') }}" style="font-size: 0.65rem; color: #10b981;">üë§</span>
                @endif
            @endif

            {{-- Spacer --}}
            <span style="flex: 1;"></span>

            {{-- Lip-sync indicator (SPCH-05) --}}
            <span style="font-size: 0.6rem; padding: 0.1rem 0.35rem; border-radius: 0.2rem; font-weight: 500;
                {{ $needsLipSync
                    ? 'background: rgba(16,185,129,0.2); color: #6ee7b7; border: 1px solid rgba(16,185,129,0.3);'
                    : 'background: rgba(100,116,139,0.15); color: rgba(255,255,255,0.5); border: 1px solid rgba(100,116,139,0.2);'
                }}">
                LIP-SYNC: {{ $needsLipSync ? 'YES' : 'NO' }}
            </span>

            {{-- Duration (SPCH-06) --}}
            <span style="font-size: 0.6rem; color: rgba(255,255,255,0.5);" title="{{ __('Estimated duration at 150 WPM') }}">
                ‚è±Ô∏è {{ $durationDisplay }}
            </span>
        </div>

        {{-- Full text content - no truncation (SPCH-01) --}}
        <div style="font-size: 0.8rem; color: rgba(255,255,255,0.85); line-height: 1.6; white-space: pre-wrap; word-break: break-word;">
            {{ $segment['text'] ?? '' }}
        </div>
    </div>
@endforeach
```

IMPORTANT: Use `white-space: pre-wrap; word-break: break-word;` on text container to prevent horizontal overflow with long text.
  </action>
  <verify>Open modal for a scene with multiple speech segments. Verify: (1) All segments visible without truncation, (2) Type icons and labels correct, (3) Speaker names in purple, (4) Character indicator shows for Bible-matched speakers, (5) Lip-sync badge shows YES for dialogue/monologue and NO for narrator/internal, (6) Duration shown for each segment.</verify>
  <done>All 7 SPCH requirements satisfied: full text display (SPCH-01), type labels (SPCH-02), type icons (SPCH-03), speaker names (SPCH-04), lip-sync indicators (SPCH-05), duration display (SPCH-06), and character indicator (SPCH-07).</done>
</task>

<task type="auto">
  <name>Task 3: Add legacy narration fallback for backward compatibility</name>
  <files>modules/AppVideoWizard/resources/views/livewire/modals/scene-text-inspector.blade.php</files>
  <action>
After the main speechSegments foreach loop, add the legacy narration fallback (for scenes that only have the old `narration` field):

```blade
@elseif(!empty($scene['narration']))
    {{-- Legacy narration fallback --}}
    <div style="padding: 0.75rem; background: rgba(255,255,255,0.03); border-left: 3px solid rgba(14, 165, 233, 0.4); border-radius: 0 0.375rem 0.375rem 0;">
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
            <span style="font-size: 1rem;">üéôÔ∏è</span>
            <span style="font-size: 0.65rem; font-weight: 600; color: white; padding: 0.15rem 0.4rem; background: rgba(14, 165, 233, 0.4); border-radius: 0.25rem;">NARRATOR</span>
            <span style="flex: 1;"></span>
            <span style="font-size: 0.6rem; padding: 0.1rem 0.35rem; border-radius: 0.2rem; font-weight: 500; background: rgba(100,116,139,0.15); color: rgba(255,255,255,0.5); border: 1px solid rgba(100,116,139,0.2);">
                LIP-SYNC: NO
            </span>
        </div>
        <div style="font-size: 0.8rem; color: rgba(255,255,255,0.85); line-height: 1.6; white-space: pre-wrap; word-break: break-word;">
            {{ $scene['narration'] }}
        </div>
    </div>
```

This ensures scenes created before Milestone 1.5 (which only had `narration` field) still display correctly.
  </action>
  <verify>If you have access to a legacy scene with only `narration` field (no speechSegments), verify it displays as a single NARRATOR segment. Otherwise verify the conditional logic is correct by checking the @elseif placement.</verify>
  <done>Legacy scenes with only `narration` field display correctly as NARRATOR type with LIP-SYNC: NO badge.</done>
</task>

</tasks>

<verification>
After completing all tasks, verify the full implementation:

1. **SPCH-01 (All segments visible):** Open modal for scene with 5+ segments. All segments should be visible in scrollable list with full text (no truncation). Test with a segment containing 500+ characters to verify line wrapping.

2. **SPCH-02 (Type labels):** Check segments of each type show correct uppercase label:
   - narrator type -> NARRATOR
   - dialogue type -> DIALOGUE
   - internal type -> INTERNAL
   - monologue type -> MONOLOGUE

3. **SPCH-03 (Type icons):** Check each type shows correct icon:
   - narrator -> microphone icon
   - dialogue -> speech bubble icon
   - internal -> thought bubble icon
   - monologue -> speaking icon

4. **SPCH-04 (Speaker names):** Dialogue and monologue segments show speaker name in purple (#c4b5fd).

5. **SPCH-05 (Lip-sync indicator):**
   - dialogue/monologue -> LIP-SYNC: YES (green badge)
   - narrator/internal -> LIP-SYNC: NO (gray badge)

6. **SPCH-06 (Duration):** Each segment shows duration (e.g., "2.4s" or "1:30" for longer segments).

7. **SPCH-07 (Character indicator):** When speaker name matches Character Bible entry, shows person icon next to name.

8. **Scrolling:** Test with 10+ segments - list should scroll smoothly within 400px container.

9. **Empty state:** Scene with no speechSegments or narration shows "No speech segments for this scene".
</verification>

<success_criteria>
1. Modal displays complete speech segment list with no truncation, showing full text content with proper line wrapping
2. Each segment displays correct type badge (NARRATOR/DIALOGUE/INTERNAL/MONOLOGUE) with matching icon
3. Dialogue and monologue segments show speaker name in purple with lip-sync badge showing YES/NO
4. Each segment displays estimated duration and character indicator when speaker exists in Character Bible
5. Scrollable segment list handles 10+ segments smoothly without layout issues
</success_criteria>

<output>
After completion, create `.planning/phases/08-speech-segments-display/08-01-SUMMARY.md`
</output>
